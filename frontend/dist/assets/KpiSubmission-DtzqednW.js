import{j as e,a as oe,h as L,p as be,k as $}from"./index-B_O7GBLG.js";import{r as u,h as ye,u as ke}from"./vendor-react-Bagy_njL.js";import{ac as me,a0 as je,af as fe,g as pe,U as ie,K as _e,A as G,c as ee,o as xe,e as te,ag as ve,_ as le,$ as ue,O as Ne,ah as we,ai as Se,aj as ne,N as Ce,ak as Ee,al as Ae,C as Fe,ad as de,am as se,an as Ie,a1 as Me,r as R,R as Te,a as ge,z as g,ao as ce,a2 as We,a3 as Ke,ap as Pe}from"./vendor-ui-ByylQ01J.js";import{g as he,a as Re,b as Ue,f as ae}from"./weekHelper-DiwCDpdk.js";import{S as re}from"./Select-DRJkHVy9.js";import"./vendor-utils-MYqKZVQ3.js";function De({formData:n,updateFormData:m,projects:i,t}){const r=u.useMemo(()=>he(),[]),h=u.useMemo(()=>{const c=n.report_year||new Date().getFullYear();return Re(c)},[n.report_year]),_=c=>{const j=n.report_year||new Date().getFullYear(),b=Ue(c,j);m("week_number",c),m("start_date",ae(b.start)),m("end_date",ae(b.end)),m("report_date",ae(b.start)),m("report_month",b.start.getMonth()+1)},N=c=>{m("report_year",parseInt(c)),m("week_number",""),m("start_date",""),m("end_date","")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(me,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:t("kpi.projectInfo.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:t("kpi.projectInfo.selectProject")})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("projects.projectName")," *"]}),e.jsxs(re,{value:n.project_id,onChange:c=>m("project_id",c.target.value),children:[e.jsx("option",{value:"",children:t("kpi.projectInfo.selectProject")}),i.map(c=>e.jsxs("option",{value:c.id,children:[c.name," (",c.code,")"]},c.id))]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(je,{className:"w-5 h-5 text-hse-primary"}),t("kpi.projectInfo.reportPeriod")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.reportYear")}),e.jsx(re,{value:n.report_year,onChange:c=>N(c.target.value),children:[...Array(5)].map((c,j)=>{const b=new Date().getFullYear()-2+j;return e.jsx("option",{value:b,children:b},b)})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4"}),t("kpi.projectInfo.weekNumber")," * (Sam-Ven)"]}),e.jsxs(re,{value:n.week_number||"",onChange:c=>_(parseInt(c.target.value)),children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),h.map(c=>e.jsxs("option",{value:c.week,className:c.week===r.week&&c.year===r.year?"font-bold":"",children:["S",String(c.week).padStart(2,"0")," - ",c.year,c.week===r.week&&c.year===r.year?` (${t("kpi.projectInfo.currentWeek")})`:""]},c.week))]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("kpi.projectInfo.startDate")," (Samedi)"]}),e.jsx("div",{className:"input bg-gray-100 dark:bg-gray-600 cursor-not-allowed flex items-center text-sm",children:e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:n.start_date||"-"})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("kpi.projectInfo.endDate")," (Vendredi)"]}),e.jsx("div",{className:"input bg-gray-100 dark:bg-gray-600 cursor-not-allowed flex items-center text-sm",children:e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:n.end_date||"-"})})]})]}),n.start_date&&n.end_date&&e.jsx("div",{className:"mt-4 p-3 bg-hse-primary/10 rounded-lg",children:e.jsxs("p",{className:"text-sm text-hse-primary font-medium",children:["üìÖ Semaine ",n.week_number,": ",new Date(n.start_date).toLocaleDateString("fr-FR")," - ",new Date(n.end_date).toLocaleDateString("fr-FR")]})})]}),n.project_id&&e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-xl",children:[e.jsx("h4",{className:"font-medium text-blue-900 dark:text-blue-300 mb-2",children:t("projects.projectDetails")}),(()=>{const c=i.find(j=>j.id===parseInt(n.project_id));return c?e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[t("projects.projectName"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:c.name})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[t("projects.projectCode"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:c.code})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[t("projects.location"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:c.location||"-"})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[t("projects.clientName"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:c.client_name||"-"})]})]}):null})()]})]})}function Le({formData:n,updateFormData:m,t:i}){const t=(r,h)=>{m(r,h===""?0:parseFloat(h))};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(pe,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:i("kpi.weekly.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"REPORTING HSE"})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5 text-hse-primary"}),i("kpi.weekly.effectif")," & ",i("kpi.weekly.induction")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.effectif")]}),e.jsx("input",{type:"number",min:"0",value:n.hours_worked||"",onChange:r=>t("hours_worked",r.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(_e,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.induction")]}),e.jsx("input",{type:"number",min:"0",value:n.employees_trained||"",onChange:r=>t("employees_trained",r.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5 text-amber-500"}),i("kpi.weekly.ecarts")," & ",i("kpi.weekly.sensibilisation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.ecarts")}),e.jsx("input",{type:"number",min:"0",value:n.unsafe_conditions_reported||"",onChange:r=>t("unsafe_conditions_reported",r.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.sensibilisation")}),e.jsx("input",{type:"number",min:"0",value:n.toolbox_talks||"",onChange:r=>t("toolbox_talks",r.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5 text-red-500"}),i("kpi.weekly.accident"),"s"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.presquAccident")}),e.jsx("input",{type:"number",min:"0",value:n.near_misses||"",onChange:r=>t("near_misses",r.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.premiersSoins")}),e.jsx("input",{type:"number",min:"0",value:n.first_aid_cases||"",onChange:r=>t("first_aid_cases",r.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.accident")}),e.jsx("input",{type:"number",min:"0",value:n.accidents||"",onChange:r=>t("accidents",r.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.joursArret")}),e.jsx("input",{type:"number",min:"0",value:n.lost_workdays||"",onChange:r=>t("lost_workdays",r.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ee,{className:"w-5 h-5 text-green-500"}),i("kpi.weekly.inspections")," & ",i("kpi.weekly.heuresFormation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ee,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.inspections")]}),e.jsx("input",{type:"number",min:"0",value:n.inspections_completed||"",onChange:r=>t("inspections_completed",r.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.heuresFormation")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.5",value:n.training_hours||"",onChange:r=>t("training_hours",r.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"h"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5 text-hse-primary"}),i("kpi.weekly.permisTravail")," & ",i("kpi.weekly.mesuresDisciplinaires")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.permisTravail")]}),e.jsx("input",{type:"number",min:"0",value:n.trainings_conducted||"",onChange:r=>t("trainings_conducted",r.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.mesuresDisciplinaires")}),e.jsx("input",{type:"number",min:"0",value:n.corrective_actions||"",onChange:r=>t("corrective_actions",r.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ee,{className:"w-5 h-5 text-green-600"}),i("kpi.weekly.conformiteHSE")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.conformiteHSE")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",value:n.hse_compliance_rate||"",onChange:r=>t("hse_compliance_rate",r.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"%"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.conformiteMedecine")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",value:n.medical_compliance_rate||"",onChange:r=>t("medical_compliance_rate",r.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"%"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.suiviBruit")]}),e.jsx("input",{type:"number",min:"0",value:n.emergency_drills||"",onChange:r=>t("emergency_drills",r.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-blue-500"}),i("kpi.weekly.consommation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4 text-blue-400"}),i("kpi.weekly.consommationEau")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.1",value:n.water_consumption||"",onChange:r=>t("water_consumption",r.target.value),className:"input pr-12",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"m¬≥"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4 text-yellow-500"}),i("kpi.weekly.consommationElectricite")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.1",value:n.electricity_consumption||"",onChange:r=>t("electricity_consumption",r.target.value),className:"input pr-14",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"kWh"})]})]})]})]})]})}function $e({formData:n,updateFormData:m,t:i}){const t=(r,h)=>{m(r,h===""?0:parseInt(h))};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center",children:e.jsx(G,{className:"w-6 h-6 text-red-600 dark:text-red-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:i("kpi.incidents.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"SUIVI DES INCIDENTS & ACCIDENTS"})]})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-xl p-6 border border-red-200 dark:border-red-700",children:[e.jsxs("h3",{className:"font-semibold text-red-900 dark:text-red-300 mb-4 flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5"}),i("kpi.incidents.fatality")," / Fatality"]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-red-200 dark:border-red-700 max-w-md",children:[e.jsx("label",{className:"font-medium text-red-900 dark:text-red-300 block mb-2",children:i("kpi.incidents.fatality")}),e.jsx("input",{type:"number",min:"0",value:n.accidents_fatal||"",onChange:r=>t("accidents_fatal",r.target.value),className:"input border-red-300",placeholder:"0"})]})]}),e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/30 rounded-xl p-6 border border-orange-200 dark:border-orange-700",children:[e.jsxs("h3",{className:"font-semibold text-orange-900 dark:text-orange-300 mb-4 flex items-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5"}),i("kpi.incidents.lostTimeAccident")," / Lost Time Accident"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700",children:[e.jsx("label",{className:"font-medium text-orange-900 dark:text-orange-300 block mb-2",children:i("kpi.incidents.lostTimeAccident")}),e.jsx("input",{type:"number",min:"0",value:n.accidents_serious||"",onChange:r=>t("accidents_serious",r.target.value),className:"input border-orange-300",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700",children:[e.jsx("label",{className:"font-medium text-orange-900 dark:text-orange-300 block mb-2",children:i("kpi.incidents.lostWorkDays")}),e.jsx("input",{type:"number",min:"0",value:n.lost_workdays||"",onChange:r=>t("lost_workdays",r.target.value),className:"input border-orange-300",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-6 border border-yellow-200 dark:border-yellow-700",children:[e.jsxs("h3",{className:"font-semibold text-yellow-900 dark:text-yellow-300 mb-4 flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),i("kpi.incidents.nonLostTimeAccident")," & ",i("kpi.incidents.firstAidCase")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700",children:[e.jsx("label",{className:"font-medium text-yellow-900 dark:text-yellow-300 block mb-2",children:i("kpi.incidents.nonLostTimeAccident")}),e.jsx("input",{type:"number",min:"0",value:n.accidents_minor||"",onChange:r=>t("accidents_minor",r.target.value),className:"input border-yellow-300",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700",children:[e.jsx("label",{className:"font-medium text-yellow-900 dark:text-yellow-300 block mb-2",children:i("kpi.incidents.firstAidCase")}),e.jsx("input",{type:"number",min:"0",value:n.first_aid_cases||"",onChange:r=>t("first_aid_cases",r.target.value),className:"input border-yellow-300",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/30 rounded-xl p-6 border border-amber-200 dark:border-amber-700",children:[e.jsxs("h3",{className:"font-semibold text-amber-900 dark:text-amber-300 mb-4 flex items-center gap-2",children:[e.jsx(Se,{className:"w-5 h-5"}),i("kpi.incidents.nearMiss")," / Near Miss"]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-amber-200 dark:border-amber-700 max-w-md",children:[e.jsx("label",{className:"font-medium text-amber-900 dark:text-amber-300 block mb-2",children:i("kpi.incidents.nearMiss")}),e.jsx("input",{type:"number",min:"0",value:n.near_misses||"",onChange:r=>t("near_misses",r.target.value),className:"input border-amber-300",placeholder:"0"})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6 border border-gray-200 dark:border-gray-600",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"}),i("kpi.incidents.propertyDamage")," & ",i("kpi.incidents.environmentalImpact")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600",children:[e.jsxs("label",{className:"font-medium text-gray-900 dark:text-gray-100 block mb-2 flex items-center gap-2",children:[e.jsx(ne,{className:"w-4 h-4"}),i("kpi.incidents.propertyDamage")]}),e.jsx("input",{type:"number",min:"0",value:n.findings_open||"",onChange:r=>t("findings_open",r.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600",children:[e.jsxs("label",{className:"font-medium text-gray-900 dark:text-gray-100 block mb-2 flex items-center gap-2",children:[e.jsx(Ce,{className:"w-4 h-4 text-green-600"}),i("kpi.incidents.environmentalImpact")]}),e.jsx("input",{type:"number",min:"0",value:n.findings_closed||"",onChange:r=>t("findings_closed",r.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"}),i("kpi.notes")]}),e.jsx("textarea",{value:n.notes||"",onChange:r=>m("notes",r.target.value),rows:4,className:"input",placeholder:i("kpi.notes")})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-xl p-6 border border-blue-200 dark:border-blue-700",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-300 mb-4",children:"R√©sum√©"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-red-600 dark:text-red-400",children:n.accidents_fatal||0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.fatality")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600 dark:text-orange-400",children:n.accidents_serious||0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:"LTA"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-600 dark:text-yellow-400",children:n.first_aid_cases||0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.firstAidCase")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-amber-600 dark:text-amber-400",children:n.near_misses||0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.nearMiss")})]})]})]})]})}const P=[{key:"effectif",label:"Effectif",labelEn:"Workforce",formula:"MAX",unit:""},{key:"induction",label:"Induction",labelEn:"Induction",formula:"SUM",unit:""},{key:"releve_ecarts",label:"Relev√© des √©carts",labelEn:"Deviations",formula:"SUM",unit:""},{key:"sensibilisation",label:"Sensibilisation (TBM)",labelEn:"Awareness (TBM)",formula:"SUM",unit:""},{key:"presquaccident",label:"Presqu'accident",labelEn:"Near Miss",formula:"SUM",unit:""},{key:"premiers_soins",label:"Premiers soins",labelEn:"First Aid",formula:"SUM",unit:""},{key:"accidents",label:"Accident",labelEn:"Accident",formula:"SUM",unit:""},{key:"jours_arret",label:"Jours d'arr√™t",labelEn:"Lost Days",formula:"SUM",unit:""},{key:"heures_travaillees",label:"Heures travaill√©es",labelEn:"Hours Worked",formula:"SUM",unit:"h"},{key:"inspections",label:"Inspections",labelEn:"Inspections",formula:"SUM",unit:""},{key:"heures_formation",label:"Heures de formation",labelEn:"Training Hours",formula:"SUM",unit:"h"},{key:"permis_travail",label:"Permis de travail",labelEn:"Work Permits",formula:"SUM",unit:""},{key:"mesures_disciplinaires",label:"Mesures disciplinaires",labelEn:"Disciplinary",formula:"SUM",unit:""},{key:"conformite_hse",label:"Conformit√© HSE (%)",labelEn:"HSE Compliance (%)",formula:"AVG",unit:"%"},{key:"conformite_medicale",label:"Conformit√© M√©dicale (%)",labelEn:"Medical Compliance (%)",formula:"AVG",unit:"%"},{key:"suivi_bruit",label:"Suivi du bruit (dB)",labelEn:"Noise (dB)",formula:"AVG",unit:"dB"},{key:"consommation_eau",label:"Eau (m¬≥)",labelEn:"Water (m¬≥)",formula:"SUM",unit:"m¬≥"},{key:"consommation_electricite",label:"√âlectricit√© (kWh)",labelEn:"Electricity (kWh)",formula:"SUM",unit:"kWh"}],Ve={fr:{Saturday:"Sam",Sunday:"Dim",Monday:"Lun",Tuesday:"Mar",Wednesday:"Mer",Thursday:"Jeu",Friday:"Ven"},en:{Saturday:"Sat",Sunday:"Sun",Monday:"Mon",Tuesday:"Tue",Wednesday:"Wed",Thursday:"Thu",Friday:"Fri"}};function He({projectId:n,weekNumber:m,year:i,onDataConfirmed:t}){const{t:r,language:h}=oe(),[_,N]=u.useState("download"),[c,j]=u.useState([]),[b,E]=u.useState([]),[O,w]=u.useState({}),[v,A]=u.useState(!1),[M,V]=u.useState(!1),[F,z]=u.useState(!0),[p,I]=u.useState(!1),T=u.useCallback((d,o)=>({entry_date:d,day_name:o,...P.reduce((a,l)=>({...a,[l.key]:""}),{})}),[]),S=u.useCallback(d=>{const o={};return P.forEach(a=>{const l=d.map(s=>s[a.key]).filter(s=>s!==""&&s!==null&&s!==void 0).map(s=>parseFloat(s)).filter(s=>!isNaN(s));if(l.length===0){o[a.key]=0;return}switch(a.formula){case"MAX":o[a.key]=Math.max(...l);break;case"AVG":o[a.key]=Math.round(l.reduce((s,x)=>s+x,0)/l.length*100)/100;break;case"SUM":default:o[a.key]=Math.round(l.reduce((s,x)=>s+x,0)*100)/100}}),o},[]),[U,Y]=u.useState(null);u.useEffect(()=>{(async()=>{if(!(!n||!m||!i))try{const o=await L.getWeekDates({week_number:m,year:i}),{days:a}=o.data.data;j(a);const l=await L.getAutoFillValues({project_id:n,week_number:m,year:i});Y(l.data.data);const s=await L.getWeekAggregates({project_id:n,week_number:m,year:i}),{aggregates:x,daily_entries:k,has_data:f}=s.data.data;if(f&&k?.length>0){I(!0),w(x);const C=a.map(y=>{const W=k.find(K=>K.entry_date===y.date);return W?{entry_date:y.date,day_name:y.day_name,...P.reduce((K,H)=>({...K,[H.key]:W[H.key]??""}),{})}:T(y.date,y.day_name)});E(C)}else{const C=a.map(y=>{const W=l.data.data?.daily_values?.find(K=>K.entry_date===y.date)?.auto_values||{};return{entry_date:y.date,day_name:y.day_name,...P.reduce((K,H)=>({...K,[H.key]:W[H.key]??""}),{})}});E(C),w(S(C))}}catch(o){console.error("Failed to fetch data:",o)}})()},[n,m,i,T,S]);const q=()=>{if(!U?.daily_values)return;const d=b.map(o=>{const a=U.daily_values.find(l=>l.entry_date===o.entry_date)?.auto_values||{};return{...o,releve_ecarts:a.releve_ecarts||o.releve_ecarts||"",sensibilisation:a.sensibilisation||o.sensibilisation||"",heures_formation:a.heures_formation||o.heures_formation||"",permis_travail:a.permis_travail||o.permis_travail||"",heures_travaillees:o.effectif?o.effectif*10:o.heures_travaillees||""}});E(d),w(S(d)),g.success(r("kpi.dailyKpi.systemDataApplied"))},D=async()=>{A(!0);try{const d=await L.downloadTemplate({project_id:n,week_number:m,year:i}),o=new Blob([d.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),a=window.URL.createObjectURL(o),l=document.createElement("a");l.href=a,l.download=`KPI_Journalier_S${m}_${i}.xlsx`,l.click(),window.URL.revokeObjectURL(a),g.success(r("kpi.dailyKpi.templateDownloaded")),N("upload")}catch(d){console.error("Download failed:",d),g.error(r("kpi.dailyKpi.downloadFailed"))}finally{A(!1)}},J=async d=>{const o=d.target.files?.[0];if(o){V(!0);try{const a=new FormData;a.append("file",o),a.append("project_id",n),a.append("week_number",m),a.append("year",i);const l=await L.parseTemplate(a),{daily_entries:s,aggregates:x}=l.data.data,k=c.map(f=>{const C=s.find(y=>y.entry_date===f.date);return C?{entry_date:f.date,day_name:f.day_name,...P.reduce((y,W)=>({...y,[W.key]:C[W.key]??""}),{})}:T(f.date,f.day_name)});E(k),w(x),N("manual"),g.success(r("kpi.dailyKpi.dataImported"))}catch(a){console.error("Upload failed:",a),g.error(r("kpi.dailyKpi.parseFailed"))}finally{V(!1),d.target.value=""}}},X=(d,o,a)=>{const l=[...b],s=a===""?"":parseFloat(a)||0;l[d]={...l[d],[o]:s},o==="effectif"&&s!==""&&(l[d].heures_travaillees=s*10),E(l),w(S(l))},Z=async()=>{A(!0);try{const d=b.filter(l=>P.some(s=>l[s.key]!==""&&l[s.key]!==null&&l[s.key]!==0));if(d.length===0){g.error(r("kpi.dailyKpi.noDataToSave")),A(!1);return}const o=await L.bulkSave({project_id:n,week_number:m,year:i,entries:d}),{aggregates:a}=o.data.data;w(a),I(!0),t&&t(a),g.success(r("kpi.dailyKpi.dataSaved"))}catch(d){console.error("Save failed:",d),g.error(r("kpi.dailyKpi.saveFailed"))}finally{A(!1)}},Q=(d,o)=>d===0||d===""||d===null||d===void 0?"-":`${d}${o?` ${o}`:""}`;return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gradient-to-r from-hse-primary/5 to-transparent cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",onClick:()=>z(!F),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:e.jsx(Ee,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:r("kpi.dailyKpi.title")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("kpi.dailyKpi.subtitle")})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[p&&e.jsxs("span",{className:"px-2.5 py-1 text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300 rounded-full",children:["‚úì ",r("kpi.dailyKpi.hasData")]}),e.jsx("div",{className:"p-1.5 rounded-full bg-gray-100 dark:bg-gray-700",children:F?e.jsx(Ae,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})})]})]}),F&&e.jsxs("div",{className:"p-4 space-y-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>N("download"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${_==="download"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:r("kpi.dailyKpi.download")})]}),e.jsxs("button",{onClick:()=>N("upload"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${_==="upload"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(se,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:r("kpi.dailyKpi.import")})]}),e.jsxs("button",{onClick:()=>N("manual"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${_==="manual"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(Ie,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:r("kpi.dailyKpi.entry")})]})]}),_==="download"&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("div",{className:"inline-flex p-4 bg-green-50 dark:bg-green-900/20 rounded-full",children:e.jsx(Me,{className:"w-12 h-12 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:r("kpi.dailyKpi.downloadTemplate")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1 max-w-sm mx-auto",children:r("kpi.dailyKpi.downloadDesc")})]}),e.jsxs("button",{onClick:D,disabled:v||!n||!m,className:"btn-primary inline-flex items-center gap-2 px-6",children:[v?e.jsx(R,{className:"w-4 h-4 animate-spin"}):e.jsx(de,{className:"w-4 h-4"}),r("kpi.dailyKpi.download")]})]}),_==="upload"&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("div",{className:"inline-flex p-4 bg-blue-50 dark:bg-blue-900/20 rounded-full",children:e.jsx(se,{className:"w-12 h-12 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:r("kpi.dailyKpi.importFile")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1 max-w-sm mx-auto",children:r("kpi.dailyKpi.importDesc")})]}),e.jsxs("label",{className:"btn-primary inline-flex items-center gap-2 px-6 cursor-pointer",children:[M?e.jsx(R,{className:"w-4 h-4 animate-spin"}):e.jsx(se,{className:"w-4 h-4"}),r("kpi.dailyKpi.selectFile"),e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:J,className:"hidden",disabled:M})]})]}),_==="manual"&&c.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto -mx-4 px-4",children:e.jsx("div",{className:"inline-block min-w-full align-middle",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 dark:bg-gray-900",children:[e.jsx("th",{className:"sticky left-0 z-10 bg-gray-50 dark:bg-gray-900 text-left py-3 px-3 font-semibold text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 min-w-[160px]",children:r("kpi.dailyKpi.indicator")}),c.map((d,o)=>e.jsxs("th",{className:"text-center py-3 px-2 font-medium text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 min-w-[70px]",children:[e.jsx("div",{className:"font-semibold text-gray-800 dark:text-gray-200",children:Ve[h]?.[d.day_name]||d.day_name?.slice(0,3)}),e.jsx("div",{className:"text-[10px] text-gray-500 font-normal",children:d.display})]},o)),e.jsx("th",{className:"text-center py-3 px-3 font-semibold text-hse-primary bg-hse-primary/5 border-b border-gray-200 dark:border-gray-700 min-w-[80px]",children:r("kpi.dailyKpi.total")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:P.map((d,o)=>e.jsxs("tr",{className:"hover:bg-gray-50/50 dark:hover:bg-gray-800/50 transition-colors",children:[e.jsx("td",{className:"sticky left-0 z-10 bg-white dark:bg-gray-800 py-2 px-3 font-medium text-gray-700 dark:text-gray-300 text-xs border-r border-gray-100 dark:border-gray-700",children:h==="fr"?d.label:d.labelEn}),b.map((a,l)=>e.jsx("td",{className:"py-1.5 px-1",children:e.jsx("input",{type:"number",step:d.formula==="AVG"||d.key.includes("heures")?"0.1":"1",min:"0",value:a[d.key]??"",onChange:s=>X(l,d.key,s.target.value),className:"w-full text-center py-1.5 px-1 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-hse-primary/30 focus:border-hse-primary transition-all",placeholder:"-"})},l)),e.jsx("td",{className:"py-2 px-3 text-center font-semibold text-hse-primary bg-hse-primary/5",children:Q(O[d.key],d.unit)})]},d.key))})]})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["* ",r("kpi.dailyKpi.formulaInfo")]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["* ",r("kpi.dailyKpi.workHoursFormula")]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs("button",{onClick:q,disabled:!U,className:"btn-secondary flex items-center gap-2 px-4 w-full sm:w-auto justify-center",children:[e.jsx(Te,{className:"w-4 h-4"}),r("kpi.dailyKpi.autoFill")]}),e.jsxs("button",{onClick:Z,disabled:v,className:"btn-primary flex items-center gap-2 px-6 w-full sm:w-auto justify-center",children:[v?e.jsx(R,{className:"w-4 h-4 animate-spin"}):e.jsx(ge,{className:"w-4 h-4"}),r("kpi.dailyKpi.confirm")]})]})]})]})]})]})}const B="hse-kpi-draft";function Je(){const{projectId:n,reportId:m}=ye(),i=ke(),{t}=oe(),[r,h]=u.useState(0),[_,N]=u.useState([]),[c,j]=u.useState(!0),[b,E]=u.useState(!1),[O,w]=u.useState(!1),[v,A]=u.useState(!1),[M,V]=u.useState(null),[F,z]=u.useState(null),[p,I]=u.useState(()=>{if(m)return T(n);const a=localStorage.getItem(B);if(a)try{return JSON.parse(a)}catch(l){console.error("Error parsing draft:",l)}return T(n)});function T(a){const l=he();return{project_id:a||"",report_date:"",report_month:new Date().getMonth()+1,report_year:l.year,week_number:"",start_date:"",end_date:"",hours_worked:0,employees_trained:0,unsafe_conditions_reported:0,toolbox_talks:0,near_misses:0,first_aid_cases:0,accidents:0,lost_workdays:0,inspections_completed:0,tg_value:0,tf_value:0,training_hours:0,work_permits:0,corrective_actions:0,hse_compliance_rate:0,medical_compliance_rate:0,noise_monitoring:0,water_consumption:0,electricity_consumption:0,accidents_fatal:0,accidents_serious:0,accidents_minor:0,findings_open:0,findings_closed:0,trainings_conducted:0,trainings_planned:0,inspections_planned:0,unsafe_acts_reported:0,emergency_drills:0,notes:"",status:"draft"}}const S=[{id:"project-info",title:t("kpi.steps.projectInfo"),icon:me,description:t("kpi.projectInfo.title")},{id:"weekly-reporting",title:t("kpi.steps.weeklyReporting"),icon:pe,description:t("kpi.weekly.title")},{id:"incident-tracking",title:t("kpi.steps.incidentTracking"),icon:G,description:t("kpi.incidents.title")}];u.useEffect(()=>{(async()=>{try{const s=(await be.getAll({per_page:100})).data.data||[];N(s),s.length===1&&!p.project_id&&D("project_id",s[0].id.toString())}catch(l){console.error("Failed to load projects:",l),g.error(t("errors.somethingWentWrong"))}finally{j(!1)}})()},[t]),u.useEffect(()=>{(async()=>{if(m)try{j(!0);const s=(await $.getById(m)).data.data;if(s.status==="approved"||s.status==="submitted"){g.error("Ce rapport ne peut plus √™tre modifi√©"),i("/dashboard");return}A(!0),V(s.id),s.rejection_reason&&z({reason:s.rejection_reason,rejected_at:s.rejected_at}),I({project_id:s.project_id?.toString()||"",report_date:s.report_date||"",report_month:s.report_month,report_year:s.report_year,week_number:s.week_number||"",start_date:s.start_date||"",end_date:s.end_date||"",hours_worked:s.hours_worked||0,employees_trained:s.employees_trained||0,unsafe_conditions_reported:s.unsafe_conditions_reported||0,toolbox_talks:s.toolbox_talks||0,near_misses:s.near_misses||0,first_aid_cases:s.first_aid_cases||0,accidents:s.accidents||0,lost_workdays:s.lost_workdays||0,inspections_completed:s.inspections_completed||0,tg_value:s.tg_value||0,tf_value:s.tf_value||0,training_hours:s.training_hours||0,work_permits:s.work_permits||0,corrective_actions:s.corrective_actions||0,ppe_compliance_rate:s.ppe_compliance_rate||0,medical_compliance_rate:s.medical_compliance_rate||0,noise_monitoring:s.noise_monitoring||0,water_consumption:s.water_consumption||0,electricity_consumption:s.electricity_consumption||0,accidents_fatal:s.accidents_fatal||0,accidents_serious:s.accidents_serious||0,accidents_minor:s.accidents_minor||0,findings_open:s.findings_open||0,findings_closed:s.findings_closed||0,trainings_conducted:s.trainings_conducted||0,trainings_planned:s.trainings_planned||0,inspections_planned:s.inspections_planned||0,unsafe_acts_reported:s.unsafe_acts_reported||0,emergency_drills:s.emergency_drills||0,notes:s.notes||"",status:"draft"})}catch(l){console.error("Failed to load report:",l),g.error("Erreur lors du chargement du rapport"),i("/dashboard")}finally{j(!1)}})()},[m,i]),u.useEffect(()=>{if(v)return;const a=setTimeout(()=>{localStorage.setItem(B,JSON.stringify(p))},1e3);return()=>clearTimeout(a)},[p,v]);const[U,Y]=u.useState(!1),q=async()=>{if(!p.project_id||!p.week_number||!p.report_year){g.error(t("kpi.selectProjectAndWeek"));return}Y(!0);try{const a=await $.getAutoPopulatedData({project_id:p.project_id,week:p.week_number,year:p.report_year}),{data:l,sources:s}=a.data.data;I(k=>({...k,...l}));const x=[];s.sor_reports>0&&x.push(`${s.sor_reports} √©carts`),s.trainings>0&&x.push(`${s.trainings} formations`),s.awareness_sessions>0&&x.push(`${s.awareness_sessions} sensibilisations`),s.work_permits>0&&x.push(`${s.work_permits} permis`),s.inspections>0&&x.push(`${s.inspections} inspections`),x.length>0?g.success(`${t("kpi.autoPopulated")}: ${x.join(", ")}`):g.info(t("kpi.noDataToPopulate"))}catch(a){console.error("Auto-populate error:",a),g.error(t("errors.somethingWentWrong"))}finally{Y(!1)}},D=(a,l)=>{I(s=>{const x={...s,[a]:l};if(["accidents","lost_workdays","hours_worked"].includes(a)){const k=parseFloat(a==="hours_worked"?l:x.hours_worked)||0,f=parseFloat(a==="accidents"?l:x.accidents)||0,C=parseFloat(a==="lost_workdays"?l:x.lost_workdays)||0;k>0?(x.tf_value=Number((f*1e6/k).toFixed(2)),x.tg_value=Number((C*1e3/k).toFixed(4))):(x.tf_value=0,x.tg_value=0)}return x})},J=async()=>{if(!p.project_id){g.error(t("kpi.projectInfo.selectProject"));return}E(!0);try{const a={...p,status:"draft"};if(M)await $.update(M,a);else{const s=(await $.create(a))?.data?.data;s?.id&&(V(s.id),A(!0))}localStorage.setItem(B,JSON.stringify(a)),g.success(t("kpi.reportSaved"))}catch(a){const l=a?.response?.data?.message||t("errors.somethingWentWrong");g.error(l)}finally{E(!1)}},X=async()=>{if(!p.project_id){g.error(t("kpi.projectInfo.selectProject")),h(0);return}w(!0);try{const a={...p,status:"submitted"};v&&M?(await $.update(M,a),g.success(t("kpi.reportResubmitted"))):(await $.create(a),g.success(t("kpi.reportSubmitted"))),localStorage.removeItem(B),i("/dashboard")}catch(a){const l=a.response?.data?.message||t("errors.somethingWentWrong");g.error(l)}finally{w(!1)}},Z=()=>{localStorage.removeItem(B),I(T("")),h(0),g.success(t("common.success"))},Q=()=>{if(r===0&&!p.project_id){g.error(t("kpi.projectInfo.selectProject"));return}if(r===0&&!p.week_number){g.error("Veuillez s√©lectionner une semaine");return}r<S.length-1&&(h(a=>a+1),window.scrollTo({top:0,behavior:"smooth"}))},d=()=>{r>0&&(h(a=>a-1),window.scrollTo({top:0,behavior:"smooth"}))},o=a=>{if(a>0&&!p.project_id){g.error(t("kpi.projectInfo.selectProject"));return}h(a),window.scrollTo({top:0,behavior:"smooth"})};return c?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(R,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"max-w-5xl mx-auto animate-fade-in",children:[F&&e.jsx("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(G,{className:"w-6 h-6 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-red-900",children:"Rapport rejet√© - Modification requise"}),e.jsx("p",{className:"text-red-700 mt-1",children:F.reason}),F.rejected_at&&e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["Rejet√© le ",new Date(F.rejected_at).toLocaleDateString("fr-FR")]})]})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:v?"Modifier le rapport KPI":t("kpi.submission")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:v?"Corrigez et resoumettez votre rapport":t("kpi.weekly.title")})]}),e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-between",children:S.map((a,l)=>e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsxs("button",{onClick:()=>o(l),className:`flex items-center gap-3 p-3 rounded-xl transition-all w-full ${l===r?"bg-hse-primary text-white shadow-lg":l<r?"bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400":"bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${l===r?"bg-white/20":l<r?"bg-green-200 dark:bg-green-800":"bg-gray-200 dark:bg-gray-600"}`,children:l<r?e.jsx(ge,{className:"w-5 h-5"}):e.jsx(a.icon,{className:"w-5 h-5"})}),e.jsxs("div",{className:"hidden sm:block text-left",children:[e.jsxs("p",{className:"text-xs opacity-75",children:[t("common.step")||"√âtape"," ",l+1]}),e.jsx("p",{className:"font-medium text-sm",children:a.title})]})]}),l<S.length-1&&e.jsx("div",{className:`h-1 flex-1 mx-2 rounded ${l<r?"bg-green-300":"bg-gray-200"}`})]},a.id))})}),p.status==="draft"&&p.project_id&&e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-300",children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm",children:[t("kpi.status.draft")," - ",t("kpi.reportSaved")]})]}),e.jsx("button",{onClick:Z,className:"text-sm text-amber-700 dark:text-amber-300 hover:text-amber-800 dark:hover:text-amber-200 underline",children:t("common.delete")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6",children:[r===0&&e.jsxs(e.Fragment,{children:[e.jsx(De,{formData:p,updateFormData:D,projects:_,t}),p.project_id&&p.week_number&&e.jsx("div",{className:"mt-6 p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900 dark:text-green-300",children:t("kpi.autoPopulateTitle")}),e.jsx("p",{className:"text-sm text-green-700 dark:text-green-400",children:t("kpi.autoPopulateDesc")})]}),e.jsx("button",{onClick:q,disabled:U,className:"btn btn-primary flex items-center gap-2",children:U?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4 animate-spin"}),t("common.loading")]}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"w-4 h-4"}),t("kpi.autoPopulate")]})})]})})]}),r===1&&e.jsxs(e.Fragment,{children:[p.project_id&&p.week_number&&e.jsx(He,{projectId:p.project_id,weekNumber:p.week_number,year:p.report_year,onDataConfirmed:a=>{I(l=>{const s={...l};a.effectif!==void 0&&(s.hours_worked=a.effectif),a.induction!==void 0&&(s.employees_trained=a.induction),a.releve_ecarts!==void 0&&(s.unsafe_conditions_reported=a.releve_ecarts),a.sensibilisation!==void 0&&(s.toolbox_talks=a.sensibilisation),a.presquaccident!==void 0&&(s.near_misses=a.presquaccident),a.premiers_soins!==void 0&&(s.first_aid_cases=a.premiers_soins),a.accidents!==void 0&&(s.accidents=a.accidents),a.jours_arret!==void 0&&(s.lost_workdays=a.jours_arret),a.inspections!==void 0&&(s.inspections_completed=a.inspections),a.heures_formation!==void 0&&(s.training_hours=a.heures_formation),a.permis_travail!==void 0&&(s.work_permits=a.permis_travail),a.mesures_disciplinaires!==void 0&&(s.corrective_actions=a.mesures_disciplinaires),a.conformite_hse!==void 0&&(s.hse_compliance_rate=a.conformite_hse),a.conformite_medicale!==void 0&&(s.medical_compliance_rate=a.conformite_medicale),a.suivi_bruit!==void 0&&(s.noise_monitoring=a.suivi_bruit),a.consommation_eau!==void 0&&(s.water_consumption=a.consommation_eau),a.consommation_electricite!==void 0&&(s.electricity_consumption=a.consommation_electricite);const x=parseFloat(s.hours_worked)||0,k=parseFloat(s.accidents)||0,f=parseFloat(s.lost_workdays)||0;return x>0?(s.tf_value=Number((k*1e6/x).toFixed(2)),s.tg_value=Number((f*1e3/x).toFixed(4))):(s.tf_value=0,s.tg_value=0),s})}}),e.jsx(Le,{formData:p,updateFormData:D,t})]}),r===2&&e.jsx($e,{formData:p,updateFormData:D,t})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:r>0&&e.jsxs("button",{onClick:d,className:"btn-secondary flex items-center gap-2",children:[e.jsx(We,{className:"w-4 h-4"}),t("common.previous")]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:J,disabled:b,className:"btn-secondary flex items-center gap-2",children:[b?e.jsx(R,{className:"w-4 h-4 animate-spin"}):e.jsx(ce,{className:"w-4 h-4"}),t("kpi.saveDraft")]}),r<S.length-1?e.jsxs("button",{onClick:Q,className:"btn-primary flex items-center gap-2",children:[t("common.next"),e.jsx(Ke,{className:"w-4 h-4"})]}):e.jsxs("button",{onClick:X,disabled:O,className:"btn-primary flex items-center gap-2 bg-green-600 hover:bg-green-700",children:[O?e.jsx(R,{className:"w-4 h-4 animate-spin"}):e.jsx(Pe,{className:"w-4 h-4"}),t("kpi.submitReport")]})]})]})]})}export{Je as default};

import{u as be,j as e,a as me,i as H,p as ie,k as $}from"./index.js";import{r as u,h as ye,u as ke}from"./vendor-react.js";import{B as pe,a8 as je,an as fe,f as xe,U as ne,e as _e,A as J,c as se,s as ue,h as te,ao as ve,a2 as le,a3 as Ne,Y as we,ap as Se,aq as Ce,ar as de,V as Ee,as as Ae,at as Me,C as Fe,am as ce,ac as ae,au as Ie,a9 as We,v as q,R as Pe,a as ge,z as h,av as oe,aa as Re,ab as Te,aw as Ke}from"./vendor-ui.js";import{g as he,a as Ue,b as Le,f as re}from"./weekHelper.js";import{S as X}from"./Select.js";import{s as De,g as Ve}from"./projectList.js";import"./vendor-utils.js";function He({formData:l,updateFormData:g,projects:i,t:r,poles:a,selectedPole:y,onPoleChange:v}){const{user:E}=be(),C=u.useMemo(()=>he(),[]),T=E?.project_list_preference??"code",N=u.useMemo(()=>{const d=Array.isArray(i)?i:[];return y?d.filter(_=>_?.pole===y):d},[i,y]),A=u.useMemo(()=>De(N,T),[N,T]),B=u.useMemo(()=>{const d=l.report_year||new Date().getFullYear();return Ue(d)},[l.report_year]),w=d=>{const _=l.report_year||new Date().getFullYear(),j=Le(d,_);g("week_number",d),g("start_date",re(j.start)),g("end_date",re(j.end)),g("report_date",re(j.start)),g("report_month",j.start.getMonth()+1)},M=d=>{g("report_year",parseInt(d)),g("week_number",""),g("start_date",""),g("end_date","")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(pe,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:r("kpi.projectInfo.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("kpi.projectInfo.selectProject")})]})]}),e.jsxs("div",{children:[Array.isArray(a)&&a.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"label",children:"Pole"}),e.jsxs(X,{value:y,onChange:d=>v?.(d.target.value),children:[e.jsx("option",{value:"",children:"All"}),a.map(d=>e.jsx("option",{value:d,children:d},d))]})]}),e.jsxs("label",{className:"label",children:[r("projects.projectName")," *"]}),e.jsxs(X,{value:l.project_id,onChange:d=>g("project_id",d.target.value),children:[e.jsx("option",{value:"",children:r("kpi.projectInfo.selectProject")}),A.map(d=>e.jsx("option",{value:d.id,children:Ve(d)},d.id))]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(je,{className:"w-5 h-5 text-hse-primary"}),r("kpi.projectInfo.reportPeriod")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("kpi.reportYear")}),e.jsx(X,{value:l.report_year,onChange:d=>M(d.target.value),children:[...Array(5)].map((d,_)=>{const j=new Date().getFullYear()-2+_;return e.jsx("option",{value:j,children:j},j)})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4"}),r("kpi.projectInfo.weekNumber")," * (Sam-Ven)"]}),e.jsxs(X,{value:l.week_number??"",onChange:d=>w(parseInt(d.target.value)),children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),B.map(d=>e.jsxs("option",{value:d.week,className:d.week===C.week&&d.year===C.year?"font-bold":"",children:["S",String(d.week).padStart(2,"0")," - ",d.year,d.week===C.week&&d.year===C.year?` (${r("kpi.projectInfo.currentWeek")})`:""]},d.week))]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("kpi.projectInfo.startDate")," (Samedi)"]}),e.jsx("div",{className:"input bg-gray-100 dark:bg-gray-600 cursor-not-allowed flex items-center text-sm",children:e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:l.start_date??""})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("kpi.projectInfo.endDate")," (Vendredi)"]}),e.jsx("div",{className:"input bg-gray-100 dark:bg-gray-600 cursor-not-allowed flex items-center text-sm",children:e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:l.end_date??""})})]})]}),l.start_date&&l.end_date&&e.jsx("div",{className:"mt-4 p-3 bg-hse-primary/10 rounded-lg",children:e.jsxs("p",{className:"text-sm text-hse-primary font-medium",children:["ðŸ“… Semaine ",l.week_number,": ",new Date(l.start_date).toLocaleDateString("fr-FR")," - ",new Date(l.end_date).toLocaleDateString("fr-FR")]})})]}),l.project_id&&e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-xl",children:[e.jsx("h4",{className:"font-medium text-blue-900 dark:text-blue-300 mb-2",children:r("projects.projectDetails")}),(()=>{const d=i.find(_=>_.id===parseInt(l.project_id));return d?e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[r("projects.projectName"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:d.name})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[r("projects.projectCode"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:d.code})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[r("projects.location"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:d.location??""})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[r("projects.clientName"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:d.client_name??""})]})]}):null})()]})]})}function $e({formData:l,updateFormData:g,t:i}){const r=(a,y)=>{g(a,y===""?0:parseFloat(y))};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(xe,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:i("kpi.weekly.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:i("kpi.weekly.subtitle")})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5 text-hse-primary"}),i("kpi.weekly.effectif")," & ",i("kpi.weekly.induction")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ne,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.effectif")]}),e.jsx("input",{type:"number",min:"0",value:l.hours_worked??"",onChange:a=>r("hours_worked",a.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(_e,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.induction")]}),e.jsx("input",{type:"number",min:"0",value:l.employees_trained??"",onChange:a=>r("employees_trained",a.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-amber-500"}),i("kpi.weekly.ecarts")," & ",i("kpi.weekly.sensibilisation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.ecarts")}),e.jsx("input",{type:"number",min:"0",value:l.unsafe_conditions_reported??"",onChange:a=>r("unsafe_conditions_reported",a.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.sensibilisation")}),e.jsx("input",{type:"number",min:"0",value:l.toolbox_talks??"",onChange:a=>r("toolbox_talks",a.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-red-500"}),i("kpi.weekly.accident"),"s"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.presquAccident")}),e.jsx("input",{type:"number",min:"0",value:l.near_misses??"",onChange:a=>r("near_misses",a.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.premiersSoins")}),e.jsx("input",{type:"number",min:"0",value:l.first_aid_cases??"",onChange:a=>r("first_aid_cases",a.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.accident")}),e.jsx("input",{type:"number",min:"0",value:l.accidents??"",onChange:a=>r("accidents",a.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.joursArret")}),e.jsx("input",{type:"number",min:"0",value:l.lost_workdays??"",onChange:a=>r("lost_workdays",a.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-green-500"}),i("kpi.weekly.inspections")," & ",i("kpi.weekly.heuresFormation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.inspections")]}),e.jsx("input",{type:"number",min:"0",value:l.inspections_completed??"",onChange:a=>r("inspections_completed",a.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.heuresFormation")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.5",value:l.training_hours??"",onChange:a=>r("training_hours",a.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"h"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5 text-hse-primary"}),i("kpi.weekly.permisTravail")," & ",i("kpi.weekly.mesuresDisciplinaires")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.permisTravail")]}),e.jsx("input",{type:"number",min:"0",value:l.work_permits??"",onChange:a=>r("work_permits",a.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.mesuresDisciplinaires")}),e.jsx("input",{type:"number",min:"0",value:l.corrective_actions??"",onChange:a=>r("corrective_actions",a.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-green-600"}),i("kpi.weekly.conformiteHSE")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.conformiteHSE")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",value:l.hse_compliance_rate??"",onChange:a=>r("hse_compliance_rate",a.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"%"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.conformiteMedecine")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",value:l.medical_compliance_rate??"",onChange:a=>r("medical_compliance_rate",a.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"%"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.suiviBruit")]}),e.jsx("input",{type:"number",min:"0",value:l.noise_monitoring??"",onChange:a=>r("noise_monitoring",a.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-blue-500"}),i("kpi.weekly.consommation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4 text-blue-400"}),i("kpi.weekly.consommationEau")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.1",value:l.water_consumption??"",onChange:a=>r("water_consumption",a.target.value),className:"input pr-12",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"mÂ³"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4 text-yellow-500"}),i("kpi.weekly.consommationElectricite")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.1",value:l.electricity_consumption??"",onChange:a=>r("electricity_consumption",a.target.value),className:"input pr-14",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"kWh"})]})]})]})]})]})}function qe({formData:l,updateFormData:g,t:i}){const r=(a,y)=>{g(a,y===""?0:parseInt(y))};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center",children:e.jsx(J,{className:"w-6 h-6 text-red-600 dark:text-red-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:i("kpi.incidents.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:i("kpi.incidents.subtitle")})]})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-xl p-6 border border-red-200 dark:border-red-700",children:[e.jsxs("h3",{className:"font-semibold text-red-900 dark:text-red-300 mb-4 flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),i("kpi.incidents.fatality")]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-red-200 dark:border-red-700 max-w-md",children:[e.jsx("label",{className:"font-medium text-red-900 dark:text-red-300 block mb-2",children:i("kpi.incidents.fatality")}),e.jsx("input",{type:"number",min:"0",value:l.accidents_fatal??"",onChange:a=>r("accidents_fatal",a.target.value),className:"input border-red-300",placeholder:"0"})]})]}),e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/30 rounded-xl p-6 border border-orange-200 dark:border-orange-700",children:[e.jsxs("h3",{className:"font-semibold text-orange-900 dark:text-orange-300 mb-4 flex items-center gap-2",children:[e.jsx(ue,{className:"w-5 h-5"}),i("kpi.incidents.lostTimeAccident")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700",children:[e.jsx("label",{className:"font-medium text-orange-900 dark:text-orange-300 block mb-2",children:i("kpi.incidents.lostTimeAccident")}),e.jsx("input",{type:"number",min:"0",value:l.accidents_serious??"",onChange:a=>r("accidents_serious",a.target.value),className:"input border-orange-300",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700",children:[e.jsx("label",{className:"font-medium text-orange-900 dark:text-orange-300 block mb-2",children:i("kpi.incidents.lostWorkDays")}),e.jsx("input",{type:"number",min:"0",value:l.lost_workdays??"",onChange:a=>r("lost_workdays",a.target.value),className:"input border-orange-300",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-6 border border-yellow-200 dark:border-yellow-700",children:[e.jsxs("h3",{className:"font-semibold text-yellow-900 dark:text-yellow-300 mb-4 flex items-center gap-2",children:[e.jsx(Se,{className:"w-5 h-5"}),i("kpi.incidents.nonLostTimeAccident")," & ",i("kpi.incidents.firstAidCase")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700",children:[e.jsx("label",{className:"font-medium text-yellow-900 dark:text-yellow-300 block mb-2",children:i("kpi.incidents.nonLostTimeAccident")}),e.jsx("input",{type:"number",min:"0",value:l.accidents_minor??"",onChange:a=>r("accidents_minor",a.target.value),className:"input border-yellow-300",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700",children:[e.jsx("label",{className:"font-medium text-yellow-900 dark:text-yellow-300 block mb-2",children:i("kpi.incidents.firstAidCase")}),e.jsx("input",{type:"number",min:"0",value:l.first_aid_cases??"",onChange:a=>r("first_aid_cases",a.target.value),className:"input border-yellow-300",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/30 rounded-xl p-6 border border-amber-200 dark:border-amber-700",children:[e.jsxs("h3",{className:"font-semibold text-amber-900 dark:text-amber-300 mb-4 flex items-center gap-2",children:[e.jsx(Ce,{className:"w-5 h-5"}),i("kpi.incidents.nearMiss")]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-amber-200 dark:border-amber-700 max-w-md",children:[e.jsx("label",{className:"font-medium text-amber-900 dark:text-amber-300 block mb-2",children:i("kpi.incidents.nearMiss")}),e.jsx("input",{type:"number",min:"0",value:l.near_misses??"",onChange:a=>r("near_misses",a.target.value),className:"input border-amber-300",placeholder:"0"})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6 border border-gray-200 dark:border-gray-600",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"}),i("kpi.incidents.propertyDamage")," & ",i("kpi.incidents.environmentalImpact")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600",children:[e.jsxs("label",{className:"font-medium text-gray-900 dark:text-gray-100 block mb-2 flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),i("kpi.incidents.propertyDamage")]}),e.jsx("input",{type:"number",min:"0",value:l.findings_open??"",onChange:a=>r("findings_open",a.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600",children:[e.jsxs("label",{className:"font-medium text-gray-900 dark:text-gray-100 block mb-2 flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4 text-green-600"}),i("kpi.incidents.environmentalImpact")]}),e.jsx("input",{type:"number",min:"0",value:l.findings_closed??"",onChange:a=>r("findings_closed",a.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"}),i("kpi.notes")]}),e.jsx("textarea",{value:l.notes??"",onChange:a=>g("notes",a.target.value),rows:4,className:"input",placeholder:i("kpi.notes")})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-xl p-6 border border-blue-200 dark:border-blue-700",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-300 mb-4",children:i("kpi.incidents.summary")}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-red-600 dark:text-red-400",children:l.accidents_fatal??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.fatality")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600 dark:text-orange-400",children:l.accidents_serious??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.ltaShort")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-600 dark:text-yellow-400",children:l.first_aid_cases??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.firstAidCase")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-amber-600 dark:text-amber-400",children:l.near_misses??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.nearMiss")})]})]})]})]})}const U=[{key:"effectif",label:"Effectif",labelEn:"Workforce",formula:"MAX",unit:""},{key:"induction",label:"Induction",labelEn:"Induction",formula:"SUM",unit:""},{key:"releve_ecarts",label:"RelevÃ© des Ã©carts",labelEn:"Deviations",formula:"SUM",unit:""},{key:"sensibilisation",label:"Sensibilisation (TBM)",labelEn:"Awareness (TBM)",formula:"SUM",unit:""},{key:"presquaccident",label:"Presqu'accident",labelEn:"Near Miss",formula:"SUM",unit:""},{key:"premiers_soins",label:"Premiers soins",labelEn:"First Aid",formula:"SUM",unit:""},{key:"accidents",label:"Accident",labelEn:"Accident",formula:"SUM",unit:""},{key:"jours_arret",label:"Jours d'arrÃªt",labelEn:"Lost Days",formula:"SUM",unit:""},{key:"heures_travaillees",label:"Heures travaillÃ©es",labelEn:"Hours Worked",formula:"SUM",unit:"h"},{key:"inspections",label:"Inspections",labelEn:"Inspections",formula:"SUM",unit:""},{key:"heures_formation",label:"Heures de formation",labelEn:"Training Hours",formula:"SUM",unit:"h"},{key:"permis_travail",label:"Permis de travail",labelEn:"Work Permits",formula:"SUM",unit:""},{key:"mesures_disciplinaires",label:"Mesures disciplinaires",labelEn:"Disciplinary",formula:"SUM",unit:""},{key:"conformite_hse",label:"ConformitÃ© HSE (%)",labelEn:"HSE Compliance (%)",formula:"AVG",unit:"%"},{key:"conformite_medicale",label:"ConformitÃ© MÃ©dicale (%)",labelEn:"Medical Compliance (%)",formula:"AVG",unit:"%"},{key:"suivi_bruit",label:"Suivi du bruit (dB)",labelEn:"Noise (dB)",formula:"AVG",unit:"dB"},{key:"consommation_eau",label:"Eau (mÂ³)",labelEn:"Water (mÂ³)",formula:"SUM",unit:"mÂ³"},{key:"consommation_electricite",label:"Ã‰lectricitÃ© (kWh)",labelEn:"Electricity (kWh)",formula:"SUM",unit:"kWh"}],Be={fr:{Saturday:"Sam",Sunday:"Dim",Monday:"Lun",Tuesday:"Mar",Wednesday:"Mer",Thursday:"Jeu",Friday:"Ven"},en:{Saturday:"Sat",Sunday:"Sun",Monday:"Mon",Tuesday:"Tue",Wednesday:"Wed",Thursday:"Thu",Friday:"Fri"}};function Ye({projectId:l,weekNumber:g,year:i,onDataConfirmed:r}){const{t:a,language:y}=me(),[v,E]=u.useState("download"),[C,T]=u.useState([]),[N,A]=u.useState([]),[B,w]=u.useState({}),[M,d]=u.useState(!1),[_,j]=u.useState(!1),[F,Y]=u.useState(!0),[W,L]=u.useState(!1),P=u.useCallback((o,x)=>({entry_date:o,day_name:x,...U.reduce((m,s)=>({...m,[s.key]:""}),{})}),[]),K=u.useCallback(o=>{const x={};return U.forEach(m=>{const s=o.map(t=>t[m.key]).filter(t=>t!==""&&t!==null&&t!==void 0).map(t=>parseFloat(t)).filter(t=>!isNaN(t));if(s.length===0){x[m.key]=0;return}switch(m.formula){case"MAX":x[m.key]=Math.max(...s);break;case"AVG":x[m.key]=Math.round(s.reduce((t,c)=>t+c,0)/s.length*100)/100;break;case"SUM":default:x[m.key]=Math.round(s.reduce((t,c)=>t+c,0)*100)/100}}),x},[]),[p,D]=u.useState(null);u.useEffect(()=>{(async()=>{if(!(!l||!g||!i))try{const x=await H.getWeekDates({week_number:g,year:i}),{days:m}=x.data.data;T(m);const s=await H.getAutoFillValues({project_id:l,week_number:g,year:i});D(s.data.data);const t=await H.getWeekAggregates({project_id:l,week_number:g,year:i}),{aggregates:c,daily_entries:n,has_data:b}=t.data.data;if(b&&n?.length>0){L(!0),w(c);const f=m.map(k=>{const S=n.find(I=>I.entry_date===k.date);return S?{entry_date:k.date,day_name:k.day_name,...U.reduce((I,G)=>({...I,[G.key]:S[G.key]??""}),{})}:P(k.date,k.day_name)});A(f)}else{const f=m.map(k=>{const S=s.data.data?.daily_values?.find(I=>I.entry_date===k.date)?.auto_values||{};return{entry_date:k.date,day_name:k.day_name,...U.reduce((I,G)=>({...I,[G.key]:S[G.key]??""}),{})}});A(f),w(K(f))}}catch(x){console.error("Failed to fetch data:",x)}})()},[l,g,i,P,K]);const O=()=>{if(!p?.daily_values)return;const o=(m,s,t)=>Object.prototype.hasOwnProperty.call(s,t)&&s[t]!==null&&s[t]!==void 0?s[t]:m[t]!==null&&m[t]!==void 0?m[t]:"",x=N.map(m=>{const s=p.daily_values.find(t=>t.entry_date===m.entry_date)?.auto_values||{};return{...m,releve_ecarts:o(m,s,"releve_ecarts"),sensibilisation:o(m,s,"sensibilisation"),heures_formation:o(m,s,"heures_formation"),permis_travail:o(m,s,"permis_travail"),inspections:o(m,s,"inspections"),heures_travaillees:(()=>{const t=Number(m.effectif);return Number.isFinite(t)?t*10:m.heures_travaillees??""})()}});A(x),w(K(x)),h.success(a("kpi.dailyKpi.systemDataApplied"))},V=async()=>{d(!0);try{const o=await H.downloadTemplate({project_id:l,week_number:g,year:i}),x=new Blob([o.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),m=window.URL.createObjectURL(x),s=document.createElement("a");s.href=m,s.download=`KPI_Journalier_S${g}_${i}.xlsx`,s.click(),window.URL.revokeObjectURL(m),h.success(a("kpi.dailyKpi.templateDownloaded")),E("upload")}catch(o){console.error("Download failed:",o),h.error(a("kpi.dailyKpi.downloadFailed"))}finally{d(!1)}},R=async o=>{const x=o.target.files?.[0];if(x){j(!0);try{const m=new FormData;m.append("file",x),m.append("project_id",l),m.append("week_number",g),m.append("year",i);const s=await H.parseTemplate(m),{daily_entries:t,aggregates:c}=s.data.data,n=C.map(b=>{const f=t.find(k=>k.entry_date===b.date);return f?{entry_date:b.date,day_name:b.day_name,...U.reduce((k,S)=>({...k,[S.key]:f[S.key]??""}),{})}:P(b.date,b.day_name)});A(n),w(c),E("manual"),h.success(a("kpi.dailyKpi.dataImported"))}catch(m){console.error("Upload failed:",m),h.error(a("kpi.dailyKpi.parseFailed"))}finally{j(!1),o.target.value=""}}},Z=(o,x,m)=>{const s=[...N],t=Number(m),c=m===""?"":Number.isFinite(t)?t:0;s[o]={...s[o],[x]:c},x==="effectif"&&c!==""&&(s[o].heures_travaillees=c*10),A(s),w(K(s))},Q=async()=>{d(!0);try{const o=N.filter(s=>U.some(t=>s[t.key]!==""&&s[t.key]!==null&&s[t.key]!==0));if(o.length===0){h.error(a("kpi.dailyKpi.noDataToSave")),d(!1);return}const x=await H.bulkSave({project_id:l,week_number:g,year:i,entries:o}),{aggregates:m}=x.data.data;w(m),L(!0),r&&r(m),h.success(a("kpi.dailyKpi.dataSaved"))}catch(o){console.error("Save failed:",o),h.error(a("kpi.dailyKpi.saveFailed"))}finally{d(!1)}},ee=(o,x)=>o==null||o===""?"-":o===0?"0":`${o}${x?` ${x}`:""}`;return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gradient-to-r from-hse-primary/5 to-transparent cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",onClick:()=>Y(!F),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:e.jsx(Ae,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:a("kpi.dailyKpi.title")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("kpi.dailyKpi.subtitle")})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[W&&e.jsxs("span",{className:"px-2.5 py-1 text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300 rounded-full",children:["âœ“ ",a("kpi.dailyKpi.hasData")]}),e.jsx("div",{className:"p-1.5 rounded-full bg-gray-100 dark:bg-gray-700",children:F?e.jsx(Me,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})})]})]}),F&&e.jsxs("div",{className:"p-4 space-y-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>E("download"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${v==="download"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:a("kpi.dailyKpi.download")})]}),e.jsxs("button",{onClick:()=>E("upload"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${v==="upload"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:a("kpi.dailyKpi.import")})]}),e.jsxs("button",{onClick:()=>E("manual"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${v==="manual"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(Ie,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:a("kpi.dailyKpi.entry")})]})]}),v==="download"&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("div",{className:"inline-flex p-4 bg-green-50 dark:bg-green-900/20 rounded-full",children:e.jsx(We,{className:"w-12 h-12 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:a("kpi.dailyKpi.downloadTemplate")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1 max-w-sm mx-auto",children:a("kpi.dailyKpi.downloadDesc")})]}),e.jsxs("button",{onClick:V,disabled:M||!l||!g,className:"btn-primary inline-flex items-center gap-2 px-6",children:[M?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(ce,{className:"w-4 h-4"}),a("kpi.dailyKpi.download")]})]}),v==="upload"&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("div",{className:"inline-flex p-4 bg-blue-50 dark:bg-blue-900/20 rounded-full",children:e.jsx(ae,{className:"w-12 h-12 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:a("kpi.dailyKpi.importFile")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1 max-w-sm mx-auto",children:a("kpi.dailyKpi.importDesc")})]}),e.jsxs("label",{className:"btn-primary inline-flex items-center gap-2 px-6 cursor-pointer",children:[_?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(ae,{className:"w-4 h-4"}),a("kpi.dailyKpi.selectFile"),e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:R,className:"hidden",disabled:_})]})]}),v==="manual"&&C.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto -mx-4 px-4",children:e.jsx("div",{className:"inline-block min-w-full align-middle",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 dark:bg-gray-900",children:[e.jsx("th",{className:"sticky left-0 z-10 bg-gray-50 dark:bg-gray-900 text-left py-3 px-3 font-semibold text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 min-w-[160px]",children:a("kpi.dailyKpi.indicator")}),C.map((o,x)=>e.jsxs("th",{className:"text-center py-3 px-2 font-medium text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 min-w-[70px]",children:[e.jsx("div",{className:"font-semibold text-gray-800 dark:text-gray-200",children:Be[y]?.[o.day_name]||o.day_name?.slice(0,3)}),e.jsx("div",{className:"text-[10px] text-gray-500 font-normal",children:o.display})]},x)),e.jsx("th",{className:"text-center py-3 px-3 font-semibold text-hse-primary bg-hse-primary/5 border-b border-gray-200 dark:border-gray-700 min-w-[80px]",children:a("kpi.dailyKpi.total")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:U.map((o,x)=>e.jsxs("tr",{className:"hover:bg-gray-50/50 dark:hover:bg-gray-800/50 transition-colors",children:[e.jsx("td",{className:"sticky left-0 z-10 bg-white dark:bg-gray-800 py-2 px-3 font-medium text-gray-700 dark:text-gray-300 text-xs border-r border-gray-100 dark:border-gray-700",children:y==="fr"?o.label:o.labelEn}),N.map((m,s)=>e.jsx("td",{className:"py-1.5 px-1",children:e.jsx("input",{type:"number",step:o.formula==="AVG"||o.key.includes("heures")?"0.1":"1",min:"0",value:m[o.key]??"",onChange:t=>Z(s,o.key,t.target.value),className:"w-full text-center py-1.5 px-1 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-hse-primary/30 focus:border-hse-primary transition-all",placeholder:"-"})},s)),e.jsx("td",{className:"py-2 px-3 text-center font-semibold text-hse-primary bg-hse-primary/5",children:ee(B[o.key],o.unit)})]},o.key))})]})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["* ",a("kpi.dailyKpi.formulaInfo")]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["* ",a("kpi.dailyKpi.workHoursFormula")]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs("button",{onClick:O,disabled:!p,className:"btn-secondary flex items-center gap-2 px-4 w-full sm:w-auto justify-center",children:[e.jsx(Pe,{className:"w-4 h-4"}),a("kpi.dailyKpi.autoFill")]}),e.jsxs("button",{onClick:Q,disabled:M,className:"btn-primary flex items-center gap-2 px-6 w-full sm:w-auto justify-center",children:[M?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(ge,{className:"w-4 h-4"}),a("kpi.dailyKpi.confirm")]})]})]})]})]})]})}const z="hse-kpi-draft";function es(){const{projectId:l,reportId:g}=ye(),i=ke(),{t:r}=me(),[a,y]=u.useState(0),[v,E]=u.useState([]),[C,T]=u.useState([]),[N,A]=u.useState(""),[B,w]=u.useState(!0),[M,d]=u.useState(!1),[_,j]=u.useState(!1),[F,Y]=u.useState(!1),[W,L]=u.useState(null),[P,K]=u.useState(null),[p,D]=u.useState(()=>{if(g)return O(l);const s=localStorage.getItem(z);if(s)try{return JSON.parse(s)}catch(t){console.error("Error parsing draft:",t)}return O(l)});function O(s){const t=he();return{project_id:s??"",report_date:"",report_month:new Date().getMonth()+1,report_year:t.year,week_number:"",start_date:"",end_date:"",hours_worked:0,employees_trained:0,unsafe_conditions_reported:0,toolbox_talks:0,near_misses:0,first_aid_cases:0,accidents:0,lost_workdays:0,inspections_completed:0,tg_value:0,tf_value:0,training_hours:0,work_permits:0,corrective_actions:0,hse_compliance_rate:0,medical_compliance_rate:0,noise_monitoring:0,water_consumption:0,electricity_consumption:0,accidents_fatal:0,accidents_serious:0,accidents_minor:0,findings_open:0,findings_closed:0,trainings_conducted:0,trainings_planned:0,inspections_planned:0,unsafe_acts_reported:0,emergency_drills:0,notes:"",status:"draft"}}const V=[{id:"project-info",title:r("kpi.steps.projectInfo"),icon:pe,description:r("kpi.projectInfo.title")},{id:"weekly-reporting",title:r("kpi.steps.weeklyReporting"),icon:xe,description:r("kpi.weekly.title")},{id:"incident-tracking",title:r("kpi.steps.incidentTracking"),icon:J,description:r("kpi.incidents.title")}],R=(s,t)=>{const c=n=>{const b=Number(n);return Number.isFinite(b)?b:0};D(n=>{const b={...n,[s]:t};if(["accidents","lost_workdays","hours_worked"].includes(s)){const f=c(s==="hours_worked"?t:b.hours_worked),k=c(s==="accidents"?t:b.accidents),S=c(s==="lost_workdays"?t:b.lost_workdays);f>0?(b.tf_value=Number((k*1e6/f).toFixed(2)),b.tg_value=Number((S*1e3/f).toFixed(4))):(b.tf_value=0,b.tg_value=0)}return b})};u.useEffect(()=>{(async()=>{try{const t=await ie.getAllList({status:"active"});E(t),t.length===1&&!p.project_id&&R("project_id",t[0].id.toString())}catch(t){console.error("Failed to load projects:",t),h.error(r("errors.somethingWentWrong"))}finally{w(!1)}})()},[r]),u.useEffect(()=>{(async()=>{try{const t=await ie.getPoles(),c=t.data?.data?.poles??t.data?.poles??[];T(Array.isArray(c)?c:[])}catch{T([])}})()},[]),u.useEffect(()=>{if(!N)return;!v.some(t=>String(t.id)===String(p.project_id)&&t?.pole===N)&&p.project_id&&R("project_id","")},[N,v,p.project_id,R]),u.useEffect(()=>{(async()=>{if(g)try{w(!0);const c=(await $.getById(g)).data?.data,n=c?.report||c;if(n.status==="approved"||n.status==="submitted"){h.error(r("kpi.submissionPage.cannotEditReport")),i("/dashboard");return}Y(!0),L(n.id),n.rejection_reason&&K({reason:n.rejection_reason,rejected_at:n.rejected_at}),D({project_id:n.project_id!==null&&n.project_id!==void 0?String(n.project_id):"",report_date:n.report_date??"",report_month:n.report_month,report_year:n.report_year,week_number:n.week_number!==null&&n.week_number!==void 0?String(n.week_number):"",start_date:n.start_date??"",end_date:n.end_date??"",hours_worked:n.hours_worked??0,employees_trained:n.employees_trained??0,unsafe_conditions_reported:n.unsafe_conditions_reported??0,toolbox_talks:n.toolbox_talks??0,near_misses:n.near_misses??0,first_aid_cases:n.first_aid_cases??0,accidents:n.accidents??0,lost_workdays:n.lost_workdays??0,inspections_completed:n.inspections_completed??0,tg_value:n.tg_value??0,tf_value:n.tf_value??0,training_hours:n.training_hours??0,work_permits:n.work_permits??0,corrective_actions:n.corrective_actions??0,hse_compliance_rate:n.hse_compliance_rate??n.ppe_compliance_rate??0,medical_compliance_rate:n.medical_compliance_rate??0,noise_monitoring:n.noise_monitoring??0,water_consumption:n.water_consumption??0,electricity_consumption:n.electricity_consumption??0,accidents_fatal:n.accidents_fatal??0,accidents_serious:n.accidents_serious??0,accidents_minor:n.accidents_minor??0,findings_open:n.findings_open??0,findings_closed:n.findings_closed??0,trainings_conducted:n.trainings_conducted??0,trainings_planned:n.trainings_planned??0,inspections_planned:n.inspections_planned??0,unsafe_acts_reported:n.unsafe_acts_reported??0,emergency_drills:n.emergency_drills??0,notes:n.notes??"",status:"draft"})}catch(t){console.error("Failed to load report:",t),h.error(r("kpi.submissionPage.loadReportFailed")),i("/dashboard")}finally{w(!1)}})()},[g,i]),u.useEffect(()=>{if(F)return;const s=setTimeout(()=>{localStorage.setItem(z,JSON.stringify(p))},1e3);return()=>clearTimeout(s)},[p,F]);const Z=async()=>{if(!p.project_id){h.error(r("kpi.projectInfo.selectProject"));return}d(!0);try{const s={...p,status:"draft"};if(W)await $.update(W,s);else{const c=(await $.create(s))?.data?.data;c?.id&&(L(c.id),Y(!0))}localStorage.setItem(z,JSON.stringify(s)),h.success(r("kpi.reportSaved"))}catch(s){const t=s?.response?.data?.message??r("errors.somethingWentWrong");h.error(t)}finally{d(!1)}},Q=async()=>{if(!p.project_id){h.error(r("kpi.projectInfo.selectProject")),y(0);return}j(!0);try{const s={...p,status:"submitted"};F&&W?(await $.update(W,s),h.success(r("kpi.reportResubmitted"))):(await $.create(s),h.success(r("kpi.reportSubmitted"))),localStorage.removeItem(z),i("/dashboard")}catch(s){const t=s.response?.data?.message??r("errors.somethingWentWrong");h.error(t)}finally{j(!1)}},ee=async()=>{try{W&&await $.delete(W)}catch(s){const t=s?.response?.data?.message??r("errors.somethingWentWrong");h.error(t);return}localStorage.removeItem(z),L(null),Y(!1),K(null),D(O("")),y(0),h.success(r("common.success"))},o=()=>{if(a===0&&!p.project_id){h.error(r("kpi.projectInfo.selectProject"));return}if(a===0&&!p.week_number){h.error(r("kpi.submissionPage.selectWeekRequired"));return}if(a===0&&(!p.start_date||!p.end_date)){h.error(r("kpi.submissionPage.selectWeekRequired"));return}a<V.length-1&&(y(s=>s+1),window.scrollTo({top:0,behavior:"smooth"}))},x=()=>{a>0&&(y(s=>s-1),window.scrollTo({top:0,behavior:"smooth"}))},m=s=>{if(s>0&&!p.project_id){h.error(r("kpi.projectInfo.selectProject"));return}if(s>0&&(!p.week_number||!p.start_date||!p.end_date)){h.error(r("kpi.submissionPage.selectWeekRequired"));return}y(s),window.scrollTo({top:0,behavior:"smooth"})};return B?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(q,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"max-w-5xl mx-auto animate-fade-in",children:[P&&e.jsx("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(J,{className:"w-6 h-6 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-red-900",children:"Rapport rejetÃ© - Modification requise"}),e.jsx("p",{className:"text-red-700 mt-1",children:P.reason}),P.rejected_at&&e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["RejetÃ© le ",new Date(P.rejected_at).toLocaleDateString("fr-FR")]})]})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:F?"Modifier le rapport KPI":r("kpi.submission")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:F?"Corrigez et resoumettez votre rapport":r("kpi.weekly.title")})]}),e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-between",children:V.map((s,t)=>e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsxs("button",{onClick:()=>m(t),className:`flex items-center gap-3 p-3 rounded-xl transition-all w-full ${t===a?"bg-hse-primary text-white shadow-lg":t<a?"bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400":"bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${t===a?"bg-white/20":t<a?"bg-green-200 dark:bg-green-800":"bg-gray-200 dark:bg-gray-600"}`,children:t<a?e.jsx(ge,{className:"w-5 h-5"}):e.jsx(s.icon,{className:"w-5 h-5"})}),e.jsxs("div",{className:"hidden sm:block text-left",children:[e.jsxs("p",{className:"text-xs opacity-75",children:[r("common.step")??"Ã‰tape"," ",t+1]}),e.jsx("p",{className:"font-medium text-sm",children:s.title})]})]}),t<V.length-1&&e.jsx("div",{className:`h-1 flex-1 mx-2 rounded ${t<a?"bg-green-300":"bg-gray-200"}`})]},s.id))})}),p.status==="draft"&&p.project_id&&e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-300",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm",children:[r("kpi.status.draft")," - ",r("kpi.reportSaved")]})]}),e.jsx("button",{onClick:ee,className:"text-sm text-amber-700 dark:text-amber-300 hover:text-amber-800 dark:hover:text-amber-200 underline",children:r("common.delete")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6",children:[a===0&&e.jsx(e.Fragment,{children:e.jsx(He,{formData:p,updateFormData:R,projects:v,t:r,poles:C,selectedPole:N,onPoleChange:s=>A(s)})}),a===1&&e.jsxs(e.Fragment,{children:[p.project_id&&p.week_number&&e.jsx(Ye,{projectId:p.project_id,weekNumber:p.week_number,year:p.report_year,onDataConfirmed:s=>{D(t=>{const c={...t};s.effectif!==void 0&&(c.hours_worked=s.effectif),s.induction!==void 0&&(c.employees_trained=s.induction),s.releve_ecarts!==void 0&&(c.unsafe_conditions_reported=s.releve_ecarts),s.sensibilisation!==void 0&&(c.toolbox_talks=s.sensibilisation),s.presquaccident!==void 0&&(c.near_misses=s.presquaccident),s.premiers_soins!==void 0&&(c.first_aid_cases=s.premiers_soins),s.accidents!==void 0&&(c.accidents=s.accidents),s.jours_arret!==void 0&&(c.lost_workdays=s.jours_arret),s.inspections!==void 0&&(c.inspections_completed=s.inspections),s.heures_formation!==void 0&&(c.training_hours=s.heures_formation),s.permis_travail!==void 0&&(c.work_permits=s.permis_travail),s.mesures_disciplinaires!==void 0&&(c.corrective_actions=s.mesures_disciplinaires),s.conformite_hse!==void 0&&(c.hse_compliance_rate=s.conformite_hse),s.conformite_medicale!==void 0&&(c.medical_compliance_rate=s.conformite_medicale),s.suivi_bruit!==void 0&&(c.noise_monitoring=s.suivi_bruit),s.consommation_eau!==void 0&&(c.water_consumption=s.consommation_eau),s.consommation_electricite!==void 0&&(c.electricity_consumption=s.consommation_electricite);const n=Number(c.hours_worked),b=Number(c.accidents),f=Number(c.lost_workdays),k=Number.isFinite(n)?n:0,S=Number.isFinite(b)?b:0,I=Number.isFinite(f)?f:0;return k>0?(c.tf_value=Number((S*1e6/k).toFixed(2)),c.tg_value=Number((I*1e3/k).toFixed(4))):(c.tf_value=0,c.tg_value=0),c})}}),e.jsx($e,{formData:p,updateFormData:R,t:r})]}),a===2&&e.jsx(qe,{formData:p,updateFormData:R,t:r})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:a>0&&e.jsxs("button",{onClick:x,className:"btn-secondary flex items-center gap-2",children:[e.jsx(Re,{className:"w-4 h-4"}),r("common.previous")]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:Z,disabled:M,className:"btn-secondary flex items-center gap-2",children:[M?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(oe,{className:"w-4 h-4"}),r("kpi.saveDraft")]}),a<V.length-1?e.jsxs("button",{onClick:o,className:"btn-primary flex items-center gap-2",children:[r("common.next"),e.jsx(Te,{className:"w-4 h-4"})]}):e.jsxs("button",{onClick:Q,disabled:_,className:"btn-primary flex items-center gap-2 bg-green-600 hover:bg-green-700",children:[_?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(Ke,{className:"w-4 h-4"}),r("kpi.submitReport")]})]})]})]})}export{es as default};

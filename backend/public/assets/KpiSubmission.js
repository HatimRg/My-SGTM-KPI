import{u as je,j as e,a as pe,i as Y,p as ne,k as D}from"./index.js";import{r as g,h as fe,u as _e}from"./vendor-react.js";import{B as xe,a8 as ve,an as Ne,f as ue,U as le,e as we,A as J,c as ae,s as ge,h as ie,ao as Se,a2 as de,a3 as he,Y as Ce,ap as Ee,aq as Ae,ar as oe,V as Me,as as Fe,at as Pe,C as We,am as ce,ac as re,au as Ie,a9 as Te,v as V,R as Re,a as be,z as y,av as me,aa as Ke,ab as Ue,aw as Le}from"./vendor-ui.js";import{g as ye,a as De,b as $e,f as te}from"./weekHelper.js";import{S as Q}from"./Select.js";import{s as Ve,g as He}from"./projectList.js";import"./vendor-utils.js";function Be({formData:n,updateFormData:b,projects:i,t:a,poles:s,selectedPole:j,onPoleChange:w}){const{user:M}=je(),A=g.useMemo(()=>ye(),[]),K=M?.project_list_preference??"code",S=g.useMemo(()=>{const o=Array.isArray(i)?i:[];return j?o.filter(v=>v?.pole===j):o},[i,j]),F=g.useMemo(()=>Ve(S,K),[S,K]),q=g.useMemo(()=>{const o=n.report_year||new Date().getFullYear();return De(o)},[n.report_year]),C=o=>{const v=n.report_year||new Date().getFullYear(),f=$e(o,v);b("week_number",o),b("start_date",te(f.start)),b("end_date",te(f.end)),b("report_date",te(f.start)),b("report_month",f.start.getMonth()+1)},P=o=>{b("report_year",parseInt(o)),b("week_number",""),b("start_date",""),b("end_date","")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(xe,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:a("kpi.projectInfo.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:a("kpi.projectInfo.selectProject")})]})]}),e.jsxs("div",{children:[Array.isArray(s)&&s.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"label",children:"Pole"}),e.jsxs(Q,{value:j,onChange:o=>w?.(o.target.value),children:[e.jsx("option",{value:"",children:"All"}),s.map(o=>e.jsx("option",{value:o,children:o},o))]})]}),e.jsxs("label",{className:"label",children:[a("projects.projectName")," *"]}),e.jsxs(Q,{value:n.project_id,onChange:o=>b("project_id",o.target.value),children:[e.jsx("option",{value:"",children:a("kpi.projectInfo.selectProject")}),F.map(o=>e.jsx("option",{value:o.id,children:He(o)},o.id))]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ve,{className:"w-5 h-5 text-hse-primary"}),a("kpi.projectInfo.reportPeriod")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("kpi.reportYear")}),e.jsx(Q,{value:n.report_year,onChange:o=>P(o.target.value),children:[...Array(5)].map((o,v)=>{const f=new Date().getFullYear()-2+v;return e.jsx("option",{value:f,children:f},f)})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4"}),a("kpi.projectInfo.weekNumber")," * (Sam-Ven)"]}),e.jsxs(Q,{value:n.week_number??"",onChange:o=>C(parseInt(o.target.value)),children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),q.map(o=>e.jsxs("option",{value:o.week,className:o.week===A.week&&o.year===A.year?"font-bold":"",children:["S",String(o.week).padStart(2,"0")," - ",o.year,o.week===A.week&&o.year===A.year?` (${a("kpi.projectInfo.currentWeek")})`:""]},o.week))]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("kpi.projectInfo.startDate")," (Samedi)"]}),e.jsx("div",{className:"input bg-gray-100 dark:bg-gray-600 cursor-not-allowed flex items-center text-sm",children:e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:n.start_date??""})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("kpi.projectInfo.endDate")," (Vendredi)"]}),e.jsx("div",{className:"input bg-gray-100 dark:bg-gray-600 cursor-not-allowed flex items-center text-sm",children:e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:n.end_date??""})})]})]}),n.start_date&&n.end_date&&e.jsx("div",{className:"mt-4 p-3 bg-hse-primary/10 rounded-lg",children:e.jsxs("p",{className:"text-sm text-hse-primary font-medium",children:["ðŸ“… Semaine ",n.week_number,": ",new Date(n.start_date).toLocaleDateString("fr-FR")," - ",new Date(n.end_date).toLocaleDateString("fr-FR")]})})]}),n.project_id&&e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-xl",children:[e.jsx("h4",{className:"font-medium text-blue-900 dark:text-blue-300 mb-2",children:a("projects.projectDetails")}),(()=>{const o=i.find(v=>v.id===parseInt(n.project_id));return o?e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[a("projects.projectName"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:o.name})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[a("projects.projectCode"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:o.code})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[a("projects.location"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:o.location??""})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[a("projects.clientName"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:o.client_name??""})]})]}):null})()]})]})}function Ye({formData:n,updateFormData:b,t:i}){const a=(s,j)=>{b(s,j===""?0:parseFloat(j))};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(ue,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:i("kpi.weekly.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:i("kpi.weekly.subtitle")})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-hse-primary"}),i("kpi.weekly.effectif")," & ",i("kpi.weekly.induction")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.effectif")]}),e.jsx("input",{type:"number",min:"0",value:n.hours_worked??"",onChange:s=>a("hours_worked",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.induction")]}),e.jsx("input",{type:"number",min:"0",value:n.employees_trained??"",onChange:s=>a("employees_trained",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-amber-500"}),i("kpi.weekly.ecarts")," & ",i("kpi.weekly.sensibilisation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.ecarts")}),e.jsx("input",{type:"number",min:"0",value:n.unsafe_conditions_reported??"",onChange:s=>a("unsafe_conditions_reported",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.sensibilisation")}),e.jsx("input",{type:"number",min:"0",value:n.toolbox_talks??"",onChange:s=>a("toolbox_talks",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-red-500"}),i("kpi.weekly.accident"),"s"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.presquAccident")}),e.jsx("input",{type:"number",min:"0",value:n.near_misses??"",onChange:s=>a("near_misses",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.premiersSoins")}),e.jsx("input",{type:"number",min:"0",value:n.first_aid_cases??"",onChange:s=>a("first_aid_cases",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.accident")}),e.jsx("input",{type:"number",min:"0",value:n.accidents??"",onChange:s=>a("accidents",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.joursArret")}),e.jsx("input",{type:"number",min:"0",value:n.lost_workdays??"",onChange:s=>a("lost_workdays",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-green-500"}),i("kpi.weekly.inspections")," & ",i("kpi.weekly.heuresFormation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ae,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.inspections")]}),e.jsx("input",{type:"number",min:"0",value:n.inspections_completed??"",onChange:s=>a("inspections_completed",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.heuresFormation")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.5",value:n.training_hours??"",onChange:s=>a("training_hours",s.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"h"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5 text-hse-primary"}),i("kpi.weekly.permisTravail")," & ",i("kpi.weekly.mesuresDisciplinaires")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.permisTravail")]}),e.jsx("input",{type:"number",min:"0",value:n.work_permits??"",onChange:s=>a("work_permits",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.mesuresDisciplinaires")}),e.jsx("input",{type:"number",min:"0",value:n.corrective_actions??"",onChange:s=>a("corrective_actions",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-green-600"}),i("kpi.weekly.conformiteHSE")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.conformiteHSE")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",value:n.hse_compliance_rate??"",onChange:s=>a("hse_compliance_rate",s.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"%"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:i("kpi.weekly.conformiteMedecine")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",value:n.medical_compliance_rate??"",onChange:s=>a("medical_compliance_rate",s.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"%"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Se,{className:"w-4 h-4 text-gray-400"}),i("kpi.weekly.suiviBruit")]}),e.jsx("input",{type:"number",min:"0",value:n.noise_monitoring??"",onChange:s=>a("noise_monitoring",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5 text-blue-500"}),i("kpi.weekly.consommation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-blue-400"}),i("kpi.weekly.consommationEau")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.1",value:n.water_consumption??"",onChange:s=>a("water_consumption",s.target.value),className:"input pr-12",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"mÂ³"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(he,{className:"w-4 h-4 text-yellow-500"}),i("kpi.weekly.consommationElectricite")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.1",value:n.electricity_consumption??"",onChange:s=>a("electricity_consumption",s.target.value),className:"input pr-14",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"kWh"})]})]})]})]})]})}function qe({formData:n,updateFormData:b,t:i}){const a=(s,j)=>{b(s,j===""?0:parseInt(j))};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center",children:e.jsx(J,{className:"w-6 h-6 text-red-600 dark:text-red-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:i("kpi.incidents.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:i("kpi.incidents.subtitle")})]})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-xl p-6 border border-red-200 dark:border-red-700",children:[e.jsxs("h3",{className:"font-semibold text-red-900 dark:text-red-300 mb-4 flex items-center gap-2",children:[e.jsx(Ce,{className:"w-5 h-5"}),i("kpi.incidents.fatality")]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-red-200 dark:border-red-700 max-w-md",children:[e.jsx("label",{className:"font-medium text-red-900 dark:text-red-300 block mb-2",children:i("kpi.incidents.fatality")}),e.jsx("input",{type:"number",min:"0",value:n.accidents_fatal??"",onChange:s=>a("accidents_fatal",s.target.value),className:"input border-red-300",placeholder:"0"})]})]}),e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/30 rounded-xl p-6 border border-orange-200 dark:border-orange-700",children:[e.jsxs("h3",{className:"font-semibold text-orange-900 dark:text-orange-300 mb-4 flex items-center gap-2",children:[e.jsx(ge,{className:"w-5 h-5"}),i("kpi.incidents.lostTimeAccident")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700",children:[e.jsx("label",{className:"font-medium text-orange-900 dark:text-orange-300 block mb-2",children:i("kpi.incidents.lostTimeAccident")}),e.jsx("input",{type:"number",min:"0",value:n.accidents_serious??"",onChange:s=>a("accidents_serious",s.target.value),className:"input border-orange-300",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700",children:[e.jsx("label",{className:"font-medium text-orange-900 dark:text-orange-300 block mb-2",children:i("kpi.incidents.lostWorkDays")}),e.jsx("input",{type:"number",min:"0",value:n.lost_workdays??"",onChange:s=>a("lost_workdays",s.target.value),className:"input border-orange-300",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-6 border border-yellow-200 dark:border-yellow-700",children:[e.jsxs("h3",{className:"font-semibold text-yellow-900 dark:text-yellow-300 mb-4 flex items-center gap-2",children:[e.jsx(Ee,{className:"w-5 h-5"}),i("kpi.incidents.nonLostTimeAccident")," & ",i("kpi.incidents.firstAidCase")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700",children:[e.jsx("label",{className:"font-medium text-yellow-900 dark:text-yellow-300 block mb-2",children:i("kpi.incidents.nonLostTimeAccident")}),e.jsx("input",{type:"number",min:"0",value:n.accidents_minor??"",onChange:s=>a("accidents_minor",s.target.value),className:"input border-yellow-300",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700",children:[e.jsx("label",{className:"font-medium text-yellow-900 dark:text-yellow-300 block mb-2",children:i("kpi.incidents.firstAidCase")}),e.jsx("input",{type:"number",min:"0",value:n.first_aid_cases??"",onChange:s=>a("first_aid_cases",s.target.value),className:"input border-yellow-300",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/30 rounded-xl p-6 border border-amber-200 dark:border-amber-700",children:[e.jsxs("h3",{className:"font-semibold text-amber-900 dark:text-amber-300 mb-4 flex items-center gap-2",children:[e.jsx(Ae,{className:"w-5 h-5"}),i("kpi.incidents.nearMiss")]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-amber-200 dark:border-amber-700 max-w-md",children:[e.jsx("label",{className:"font-medium text-amber-900 dark:text-amber-300 block mb-2",children:i("kpi.incidents.nearMiss")}),e.jsx("input",{type:"number",min:"0",value:n.near_misses??"",onChange:s=>a("near_misses",s.target.value),className:"input border-amber-300",placeholder:"0"})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6 border border-gray-200 dark:border-gray-600",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"}),i("kpi.incidents.propertyDamage")," & ",i("kpi.incidents.environmentalImpact")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600",children:[e.jsxs("label",{className:"font-medium text-gray-900 dark:text-gray-100 block mb-2 flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4"}),i("kpi.incidents.propertyDamage")]}),e.jsx("input",{type:"number",min:"0",value:n.findings_open??"",onChange:s=>a("findings_open",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600",children:[e.jsxs("label",{className:"font-medium text-gray-900 dark:text-gray-100 block mb-2 flex items-center gap-2",children:[e.jsx(Me,{className:"w-4 h-4 text-green-600"}),i("kpi.incidents.environmentalImpact")]}),e.jsx("input",{type:"number",min:"0",value:n.findings_closed??"",onChange:s=>a("findings_closed",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"}),i("kpi.notes")]}),e.jsx("textarea",{value:n.notes??"",onChange:s=>b("notes",s.target.value),rows:4,className:"input",placeholder:i("kpi.notes")})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-xl p-6 border border-blue-200 dark:border-blue-700",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-300 mb-4",children:i("kpi.incidents.summary")}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-red-600 dark:text-red-400",children:n.accidents_fatal??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.fatality")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600 dark:text-orange-400",children:n.accidents_serious??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.ltaShort")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-600 dark:text-yellow-400",children:n.first_aid_cases??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.firstAidCase")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-amber-600 dark:text-amber-400",children:n.near_misses??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:i("kpi.incidents.nearMiss")})]})]})]})]})}const $=[{key:"effectif",label:"Effectif",labelEn:"Workforce",formula:"MAX",unit:""},{key:"induction",label:"Induction",labelEn:"Induction",formula:"SUM",unit:""},{key:"releve_ecarts",label:"RelevÃ© des Ã©carts",labelEn:"Deviations",formula:"SUM",unit:""},{key:"sensibilisation",label:"Sensibilisation (TBM)",labelEn:"Awareness (TBM)",formula:"SUM",unit:""},{key:"presquaccident",label:"Presqu'accident",labelEn:"Near Miss",formula:"SUM",unit:""},{key:"premiers_soins",label:"Premiers soins",labelEn:"First Aid",formula:"SUM",unit:""},{key:"accidents",label:"Accident",labelEn:"Accident",formula:"SUM",unit:""},{key:"jours_arret",label:"Jours d'arrÃªt",labelEn:"Lost Days",formula:"SUM",unit:""},{key:"heures_travaillees",label:"Heures travaillÃ©es",labelEn:"Hours Worked",formula:"SUM",unit:"h"},{key:"inspections",label:"Inspections",labelEn:"Inspections",formula:"SUM",unit:""},{key:"heures_formation",label:"Heures de formation",labelEn:"Training Hours",formula:"SUM",unit:"h"},{key:"permis_travail",label:"Permis de travail",labelEn:"Work Permits",formula:"SUM",unit:""},{key:"mesures_disciplinaires",label:"Mesures disciplinaires",labelEn:"Disciplinary",formula:"SUM",unit:""},{key:"conformite_hse",label:"ConformitÃ© HSE (%)",labelEn:"HSE Compliance (%)",formula:"AVG",unit:"%"},{key:"conformite_medicale",label:"ConformitÃ© MÃ©dicale (%)",labelEn:"Medical Compliance (%)",formula:"AVG",unit:"%"},{key:"suivi_bruit",label:"Suivi du bruit (dB)",labelEn:"Noise (dB)",formula:"AVG",unit:"dB"},{key:"consommation_eau",label:"Eau (mÂ³)",labelEn:"Water (mÂ³)",formula:"SUM",unit:"mÂ³"},{key:"consommation_electricite",label:"Ã‰lectricitÃ© (kWh)",labelEn:"Electricity (kWh)",formula:"SUM",unit:"kWh"}],Oe={fr:{Saturday:"Sam",Sunday:"Dim",Monday:"Lun",Tuesday:"Mar",Wednesday:"Mer",Thursday:"Jeu",Friday:"Ven"},en:{Saturday:"Sat",Sunday:"Sun",Monday:"Mon",Tuesday:"Tue",Wednesday:"Wed",Thursday:"Thu",Friday:"Fri"}};function Ge({projectId:n,weekNumber:b,year:i,onDataConfirmed:a}){const{t:s,language:j}=pe(),[w,M]=g.useState("download"),[A,K]=g.useState([]),[S,F]=g.useState([]),[q,C]=g.useState({}),[P,o]=g.useState(!1),[v,f]=g.useState(!1),[W,O]=g.useState(!0),[I,H]=g.useState(!1),T=g.useCallback((c,h)=>({entry_date:c,day_name:h,...$.reduce((m,p)=>({...m,[p.key]:""}),{})}),[]),U=g.useCallback(c=>{const h={};return $.forEach(m=>{const p=c.map(x=>x[m.key]).filter(x=>x!==""&&x!==null&&x!==void 0).map(x=>parseFloat(x)).filter(x=>!isNaN(x));if(p.length===0){h[m.key]=0;return}switch(m.formula){case"MAX":h[m.key]=Math.max(...p);break;case"AVG":h[m.key]=Math.round(p.reduce((x,N)=>x+N,0)/p.length*100)/100;break;case"SUM":default:h[m.key]=Math.round(p.reduce((x,N)=>x+N,0)*100)/100}}),h},[]),[u,L]=g.useState(null);g.useEffect(()=>{(async()=>{if(!(!n||!b||!i))try{const h=await Y.getWeekDates({week_number:b,year:i}),{days:m}=h.data.data;K(m);const p=await Y.getAutoFillValues({project_id:n,week_number:b,year:i});L(p.data.data);const x=await Y.getWeekAggregates({project_id:n,week_number:b,year:i}),{aggregates:N,daily_entries:r,has_data:d}=x.data.data;if(d&&r?.length>0){H(!0),C(N);const l=m.map(t=>{const k=r.find(_=>_.entry_date===t.date);return k?{entry_date:t.date,day_name:t.day_name,...$.reduce((_,E)=>({..._,[E.key]:k[E.key]??""}),{})}:T(t.date,t.day_name)});F(l)}else{const l=m.map(t=>{const k=p.data.data?.daily_values?.find(_=>_.entry_date===t.date)?.auto_values||{};return{entry_date:t.date,day_name:t.day_name,...$.reduce((_,E)=>({..._,[E.key]:k[E.key]??""}),{})}});F(l),C(U(l))}}catch(h){console.error("Failed to fetch data:",h)}})()},[n,b,i,T,U]);const G=()=>{if(!u?.daily_values)return;const c=(m,p,x)=>Object.prototype.hasOwnProperty.call(p,x)&&p[x]!==null&&p[x]!==void 0?p[x]:m[x]!==null&&m[x]!==void 0?m[x]:"",h=S.map(m=>{const p=u.daily_values.find(x=>x.entry_date===m.entry_date)?.auto_values||{};return{...m,releve_ecarts:c(m,p,"releve_ecarts"),sensibilisation:c(m,p,"sensibilisation"),heures_formation:c(m,p,"heures_formation"),permis_travail:c(m,p,"permis_travail"),inspections:c(m,p,"inspections"),heures_travaillees:(()=>{const x=Number(m.effectif);return Number.isFinite(x)?x*10:m.heures_travaillees??""})()}});F(h),C(U(h)),y.success(s("kpi.dailyKpi.systemDataApplied"))},B=async()=>{o(!0);try{const c=await Y.downloadTemplate({project_id:n,week_number:b,year:i}),h=new Blob([c.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),m=window.URL.createObjectURL(h),p=document.createElement("a");p.href=m,p.download=`KPI_Journalier_S${b}_${i}.xlsx`,p.click(),window.URL.revokeObjectURL(m),y.success(s("kpi.dailyKpi.templateDownloaded")),M("upload")}catch(c){console.error("Download failed:",c),y.error(s("kpi.dailyKpi.downloadFailed"))}finally{o(!1)}},R=async c=>{const h=c.target.files?.[0];if(h){f(!0);try{const m=new FormData;m.append("file",h),m.append("project_id",n),m.append("week_number",b),m.append("year",i);const p=await Y.parseTemplate(m),{daily_entries:x,aggregates:N}=p.data.data,r=A.map(d=>{const l=x.find(t=>t.entry_date===d.date);return l?{entry_date:d.date,day_name:d.day_name,...$.reduce((t,k)=>({...t,[k.key]:l[k.key]??""}),{})}:T(d.date,d.day_name)});F(r),C(N),M("manual"),y.success(s("kpi.dailyKpi.dataImported"))}catch(m){console.error("Upload failed:",m),y.error(s("kpi.dailyKpi.parseFailed"))}finally{f(!1),c.target.value=""}}},X=(c,h,m)=>{const p=[...S],x=Number(m),N=m===""?"":Number.isFinite(x)?x:0;p[c]={...p[c],[h]:N},h==="effectif"&&N!==""&&(p[c].heures_travaillees=N*10),F(p),C(U(p))},Z=async()=>{o(!0);try{const c=S.filter(p=>$.some(x=>p[x.key]!==""&&p[x.key]!==null&&p[x.key]!==0));if(c.length===0){y.error(s("kpi.dailyKpi.noDataToSave")),o(!1);return}const h=await Y.bulkSave({project_id:n,week_number:b,year:i,entries:c}),{aggregates:m}=h.data.data;C(m),H(!0),a&&a(m),y.success(s("kpi.dailyKpi.dataSaved"))}catch(c){console.error("Save failed:",c),y.error(s("kpi.dailyKpi.saveFailed"))}finally{o(!1)}},ee=(c,h)=>c==null||c===""?"-":c===0?"0":`${c}${h?` ${h}`:""}`;return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gradient-to-r from-hse-primary/5 to-transparent cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",onClick:()=>O(!W),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:e.jsx(Fe,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("kpi.dailyKpi.title")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s("kpi.dailyKpi.subtitle")})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[I&&e.jsxs("span",{className:"px-2.5 py-1 text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300 rounded-full",children:["âœ“ ",s("kpi.dailyKpi.hasData")]}),e.jsx("div",{className:"p-1.5 rounded-full bg-gray-100 dark:bg-gray-700",children:W?e.jsx(Pe,{className:"w-4 h-4"}):e.jsx(We,{className:"w-4 h-4"})})]})]}),W&&e.jsxs("div",{className:"p-4 space-y-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>M("download"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${w==="download"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("kpi.dailyKpi.download")})]}),e.jsxs("button",{onClick:()=>M("upload"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${w==="upload"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("kpi.dailyKpi.import")})]}),e.jsxs("button",{onClick:()=>M("manual"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${w==="manual"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(Ie,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("kpi.dailyKpi.entry")})]})]}),w==="download"&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("div",{className:"inline-flex p-4 bg-green-50 dark:bg-green-900/20 rounded-full",children:e.jsx(Te,{className:"w-12 h-12 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:s("kpi.dailyKpi.downloadTemplate")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1 max-w-sm mx-auto",children:s("kpi.dailyKpi.downloadDesc")})]}),e.jsxs("button",{onClick:B,disabled:P||!n||!b,className:"btn-primary inline-flex items-center gap-2 px-6",children:[P?e.jsx(V,{className:"w-4 h-4 animate-spin"}):e.jsx(ce,{className:"w-4 h-4"}),s("kpi.dailyKpi.download")]})]}),w==="upload"&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("div",{className:"inline-flex p-4 bg-blue-50 dark:bg-blue-900/20 rounded-full",children:e.jsx(re,{className:"w-12 h-12 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:s("kpi.dailyKpi.importFile")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1 max-w-sm mx-auto",children:s("kpi.dailyKpi.importDesc")})]}),e.jsxs("label",{className:"btn-primary inline-flex items-center gap-2 px-6 cursor-pointer",children:[v?e.jsx(V,{className:"w-4 h-4 animate-spin"}):e.jsx(re,{className:"w-4 h-4"}),s("kpi.dailyKpi.selectFile"),e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:R,className:"hidden",disabled:v})]})]}),w==="manual"&&A.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto -mx-4 px-4",children:e.jsx("div",{className:"inline-block min-w-full align-middle",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 dark:bg-gray-900",children:[e.jsx("th",{className:"sticky left-0 z-10 bg-gray-50 dark:bg-gray-900 text-left py-3 px-3 font-semibold text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 min-w-[160px]",children:s("kpi.dailyKpi.indicator")}),A.map((c,h)=>e.jsxs("th",{className:"text-center py-3 px-2 font-medium text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 min-w-[70px]",children:[e.jsx("div",{className:"font-semibold text-gray-800 dark:text-gray-200",children:Oe[j]?.[c.day_name]||c.day_name?.slice(0,3)}),e.jsx("div",{className:"text-[10px] text-gray-500 font-normal",children:c.display})]},h)),e.jsx("th",{className:"text-center py-3 px-3 font-semibold text-hse-primary bg-hse-primary/5 border-b border-gray-200 dark:border-gray-700 min-w-[80px]",children:s("kpi.dailyKpi.total")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:$.map((c,h)=>e.jsxs("tr",{className:"hover:bg-gray-50/50 dark:hover:bg-gray-800/50 transition-colors",children:[e.jsx("td",{className:"sticky left-0 z-10 bg-white dark:bg-gray-800 py-2 px-3 font-medium text-gray-700 dark:text-gray-300 text-xs border-r border-gray-100 dark:border-gray-700",children:j==="fr"?c.label:c.labelEn}),S.map((m,p)=>e.jsx("td",{className:"py-1.5 px-1",children:e.jsx("input",{type:"number",step:c.formula==="AVG"||c.key.includes("heures")?"0.1":"1",min:"0",value:m[c.key]??"",onChange:x=>X(p,c.key,x.target.value),className:"w-full text-center py-1.5 px-1 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-hse-primary/30 focus:border-hse-primary transition-all",placeholder:"-"})},p)),e.jsx("td",{className:"py-2 px-3 text-center font-semibold text-hse-primary bg-hse-primary/5",children:ee(q[c.key],c.unit)})]},c.key))})]})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["* ",s("kpi.dailyKpi.formulaInfo")]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["* ",s("kpi.dailyKpi.workHoursFormula")]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs("button",{onClick:G,disabled:!u,className:"btn-secondary flex items-center gap-2 px-4 w-full sm:w-auto justify-center",children:[e.jsx(Re,{className:"w-4 h-4"}),s("kpi.dailyKpi.autoFill")]}),e.jsxs("button",{onClick:Z,disabled:P,className:"btn-primary flex items-center gap-2 px-6 w-full sm:w-auto justify-center",children:[P?e.jsx(V,{className:"w-4 h-4 animate-spin"}):e.jsx(be,{className:"w-4 h-4"}),s("kpi.dailyKpi.confirm")]})]})]})]})]})]})}const z="hse-kpi-draft";function as(){const{projectId:n,reportId:b}=fe(),i=_e(),{t:a}=pe(),[s,j]=g.useState(0),[w,M]=g.useState([]),[A,K]=g.useState([]),[S,F]=g.useState(""),[q,C]=g.useState(!0),[P,o]=g.useState(!1),[v,f]=g.useState(!1),[W,O]=g.useState(!1),[I,H]=g.useState(null),[T,U]=g.useState(null),[u,L]=g.useState(()=>{if(b)return G(n);const r=localStorage.getItem(z);if(r)try{return JSON.parse(r)}catch(d){console.error("Error parsing draft:",d)}return G(n)});function G(r){const d=ye();return{project_id:r??"",report_date:"",report_month:new Date().getMonth()+1,report_year:d.year,week_number:"",start_date:"",end_date:"",hours_worked:0,employees_trained:0,unsafe_conditions_reported:0,toolbox_talks:0,near_misses:0,first_aid_cases:0,accidents:0,lost_workdays:0,inspections_completed:0,tg_value:0,tf_value:0,training_hours:0,work_permits:0,corrective_actions:0,hse_compliance_rate:0,medical_compliance_rate:0,noise_monitoring:0,water_consumption:0,electricity_consumption:0,accidents_fatal:0,accidents_serious:0,accidents_minor:0,findings_open:0,findings_closed:0,trainings_conducted:0,trainings_planned:0,inspections_planned:0,unsafe_acts_reported:0,emergency_drills:0,notes:"",status:"draft"}}const B=[{id:"project-info",title:a("kpi.steps.projectInfo"),icon:xe,description:a("kpi.projectInfo.title")},{id:"weekly-reporting",title:a("kpi.steps.weeklyReporting"),icon:ue,description:a("kpi.weekly.title")},{id:"incident-tracking",title:a("kpi.steps.incidentTracking"),icon:J,description:a("kpi.incidents.title")}],R=(r,d)=>{const l=t=>{const k=Number(t);return Number.isFinite(k)?k:0};L(t=>{const k={...t,[r]:d};if(["accidents","lost_workdays","hours_worked"].includes(r)){const _=l(r==="hours_worked"?d:k.hours_worked),E=l(r==="accidents"?d:k.accidents),se=l(r==="lost_workdays"?d:k.lost_workdays);_>0?(k.tf_value=Number((E*1e6/_).toFixed(2)),k.tg_value=Number((se*1e3/_).toFixed(4))):(k.tf_value=0,k.tg_value=0)}return k})};g.useEffect(()=>{(async()=>{try{const d=await ne.getAllList({status:"active"});M(d),d.length===1&&!u.project_id&&R("project_id",d[0].id.toString())}catch(d){console.error("Failed to load projects:",d),y.error(a("errors.somethingWentWrong"))}finally{C(!1)}})()},[a]),g.useEffect(()=>{(async()=>{try{const d=await ne.getPoles(),l=d.data?.data?.poles??d.data?.poles??[];K(Array.isArray(l)?l:[])}catch{K([])}})()},[]),g.useEffect(()=>{if(!S)return;!w.some(d=>String(d.id)===String(u.project_id)&&d?.pole===S)&&u.project_id&&R("project_id","")},[S,w,u.project_id,R]),g.useEffect(()=>{(async()=>{if(b)try{C(!0);const l=(await D.getById(b)).data?.data,t=l?.report||l;if(t.status==="approved"||t.status==="submitted"){y.error(a("kpi.submissionPage.cannotEditReport")),i("/dashboard");return}O(!0),H(t.id),t.rejection_reason&&U({reason:t.rejection_reason,rejected_at:t.rejected_at}),L({project_id:t.project_id!==null&&t.project_id!==void 0?String(t.project_id):"",report_date:t.report_date??"",report_month:t.report_month,report_year:t.report_year,week_number:t.week_number!==null&&t.week_number!==void 0?String(t.week_number):"",start_date:t.start_date??"",end_date:t.end_date??"",hours_worked:t.hours_worked??0,employees_trained:t.employees_trained??0,unsafe_conditions_reported:t.unsafe_conditions_reported??0,toolbox_talks:t.toolbox_talks??0,near_misses:t.near_misses??0,first_aid_cases:t.first_aid_cases??0,accidents:t.accidents??0,lost_workdays:t.lost_workdays??0,inspections_completed:t.inspections_completed??0,tg_value:t.tg_value??0,tf_value:t.tf_value??0,training_hours:t.training_hours??0,work_permits:t.work_permits??0,corrective_actions:t.corrective_actions??0,hse_compliance_rate:t.hse_compliance_rate??t.ppe_compliance_rate??0,medical_compliance_rate:t.medical_compliance_rate??0,noise_monitoring:t.noise_monitoring??0,water_consumption:t.water_consumption??0,electricity_consumption:t.electricity_consumption??0,accidents_fatal:t.accidents_fatal??0,accidents_serious:t.accidents_serious??0,accidents_minor:t.accidents_minor??0,findings_open:t.findings_open??0,findings_closed:t.findings_closed??0,trainings_conducted:t.trainings_conducted??0,trainings_planned:t.trainings_planned??0,inspections_planned:t.inspections_planned??0,unsafe_acts_reported:t.unsafe_acts_reported??0,emergency_drills:t.emergency_drills??0,notes:t.notes??"",status:"draft"})}catch(d){console.error("Failed to load report:",d),y.error(a("kpi.submissionPage.loadReportFailed")),i("/dashboard")}finally{C(!1)}})()},[b,i]),g.useEffect(()=>{if(W)return;const r=setTimeout(()=>{localStorage.setItem(z,JSON.stringify(u))},1e3);return()=>clearTimeout(r)},[u,W]);const[X,Z]=g.useState(!1),ee=async()=>{if(!u.project_id||!u.week_number||!u.report_year){y.error(a("kpi.selectProjectAndWeek"));return}Z(!0);try{const r=await D.getAutoPopulatedData({project_id:u.project_id,week:u.week_number,year:u.report_year}),{data:d,sources:l}=r.data.data;L(k=>({...k,...d}));const t=[];l.sor_reports>0&&t.push(`${l.sor_reports} Ã©carts`),l.trainings>0&&t.push(`${l.trainings} formations`),l.awareness_sessions>0&&t.push(`${l.awareness_sessions} sensibilisations`),l.work_permits>0&&t.push(`${l.work_permits} permis`),l.inspections>0&&t.push(`${l.inspections} inspections`),t.length>0?y.success(`${a("kpi.autoPopulated")}: ${t.join(", ")}`):y.info(a("kpi.noDataToPopulate"))}catch(r){console.error("Auto-populate error:",r),y.error(a("errors.somethingWentWrong"))}finally{Z(!1)}},c=async()=>{if(!u.project_id){y.error(a("kpi.projectInfo.selectProject"));return}o(!0);try{const r={...u,status:"draft"};if(I)await D.update(I,r);else{const l=(await D.create(r))?.data?.data;l?.id&&(H(l.id),O(!0))}localStorage.setItem(z,JSON.stringify(r)),y.success(a("kpi.reportSaved"))}catch(r){const d=r?.response?.data?.message??a("errors.somethingWentWrong");y.error(d)}finally{o(!1)}},h=async()=>{if(!u.project_id){y.error(a("kpi.projectInfo.selectProject")),j(0);return}f(!0);try{const r={...u,status:"submitted"};W&&I?(await D.update(I,r),y.success(a("kpi.reportResubmitted"))):(await D.create(r),y.success(a("kpi.reportSubmitted"))),localStorage.removeItem(z),i("/dashboard")}catch(r){const d=r.response?.data?.message??a("errors.somethingWentWrong");y.error(d)}finally{f(!1)}},m=async()=>{try{I&&await D.delete(I)}catch(r){const d=r?.response?.data?.message??a("errors.somethingWentWrong");y.error(d);return}localStorage.removeItem(z),H(null),O(!1),U(null),L(G("")),j(0),y.success(a("common.success"))},p=()=>{if(s===0&&!u.project_id){y.error(a("kpi.projectInfo.selectProject"));return}if(s===0&&!u.week_number){y.error(a("kpi.submissionPage.selectWeekRequired"));return}s<B.length-1&&(j(r=>r+1),window.scrollTo({top:0,behavior:"smooth"}))},x=()=>{s>0&&(j(r=>r-1),window.scrollTo({top:0,behavior:"smooth"}))},N=r=>{if(r>0&&!u.project_id){y.error(a("kpi.projectInfo.selectProject"));return}j(r),window.scrollTo({top:0,behavior:"smooth"})};return q?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(V,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"max-w-5xl mx-auto animate-fade-in",children:[T&&e.jsx("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(J,{className:"w-6 h-6 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-red-900",children:"Rapport rejetÃ© - Modification requise"}),e.jsx("p",{className:"text-red-700 mt-1",children:T.reason}),T.rejected_at&&e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["RejetÃ© le ",new Date(T.rejected_at).toLocaleDateString("fr-FR")]})]})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:W?"Modifier le rapport KPI":a("kpi.submission")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:W?"Corrigez et resoumettez votre rapport":a("kpi.weekly.title")})]}),e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-between",children:B.map((r,d)=>e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsxs("button",{onClick:()=>N(d),className:`flex items-center gap-3 p-3 rounded-xl transition-all w-full ${d===s?"bg-hse-primary text-white shadow-lg":d<s?"bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400":"bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${d===s?"bg-white/20":d<s?"bg-green-200 dark:bg-green-800":"bg-gray-200 dark:bg-gray-600"}`,children:d<s?e.jsx(be,{className:"w-5 h-5"}):e.jsx(r.icon,{className:"w-5 h-5"})}),e.jsxs("div",{className:"hidden sm:block text-left",children:[e.jsxs("p",{className:"text-xs opacity-75",children:[a("common.step")??"Ã‰tape"," ",d+1]}),e.jsx("p",{className:"font-medium text-sm",children:r.title})]})]}),d<B.length-1&&e.jsx("div",{className:`h-1 flex-1 mx-2 rounded ${d<s?"bg-green-300":"bg-gray-200"}`})]},r.id))})}),u.status==="draft"&&u.project_id&&e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-300",children:[e.jsx(me,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm",children:[a("kpi.status.draft")," - ",a("kpi.reportSaved")]})]}),e.jsx("button",{onClick:m,className:"text-sm text-amber-700 dark:text-amber-300 hover:text-amber-800 dark:hover:text-amber-200 underline",children:a("common.delete")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6",children:[s===0&&e.jsxs(e.Fragment,{children:[e.jsx(Be,{formData:u,updateFormData:R,projects:w,t:a,poles:A,selectedPole:S,onPoleChange:r=>F(r)}),u.project_id&&u.week_number&&e.jsx("div",{className:"mt-6 p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900 dark:text-green-300",children:a("kpi.autoPopulateTitle")}),e.jsx("p",{className:"text-sm text-green-700 dark:text-green-400",children:a("kpi.autoPopulateDesc")})]}),e.jsx("button",{onClick:ee,disabled:X,className:"btn btn-primary flex items-center gap-2",children:X?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"w-4 h-4 animate-spin"}),a("common.loading")]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"w-4 h-4"}),a("kpi.autoPopulate")]})})]})})]}),s===1&&e.jsxs(e.Fragment,{children:[u.project_id&&u.week_number&&e.jsx(Ge,{projectId:u.project_id,weekNumber:u.week_number,year:u.report_year,onDataConfirmed:r=>{L(d=>{const l={...d};r.effectif!==void 0&&(l.hours_worked=r.effectif),r.induction!==void 0&&(l.employees_trained=r.induction),r.releve_ecarts!==void 0&&(l.unsafe_conditions_reported=r.releve_ecarts),r.sensibilisation!==void 0&&(l.toolbox_talks=r.sensibilisation),r.presquaccident!==void 0&&(l.near_misses=r.presquaccident),r.premiers_soins!==void 0&&(l.first_aid_cases=r.premiers_soins),r.accidents!==void 0&&(l.accidents=r.accidents),r.jours_arret!==void 0&&(l.lost_workdays=r.jours_arret),r.inspections!==void 0&&(l.inspections_completed=r.inspections),r.heures_formation!==void 0&&(l.training_hours=r.heures_formation),r.permis_travail!==void 0&&(l.work_permits=r.permis_travail),r.mesures_disciplinaires!==void 0&&(l.corrective_actions=r.mesures_disciplinaires),r.conformite_hse!==void 0&&(l.hse_compliance_rate=r.conformite_hse),r.conformite_medicale!==void 0&&(l.medical_compliance_rate=r.conformite_medicale),r.suivi_bruit!==void 0&&(l.noise_monitoring=r.suivi_bruit),r.consommation_eau!==void 0&&(l.water_consumption=r.consommation_eau),r.consommation_electricite!==void 0&&(l.electricity_consumption=r.consommation_electricite);const t=Number(l.hours_worked),k=Number(l.accidents),_=Number(l.lost_workdays),E=Number.isFinite(t)?t:0,se=Number.isFinite(k)?k:0,ke=Number.isFinite(_)?_:0;return E>0?(l.tf_value=Number((se*1e6/E).toFixed(2)),l.tg_value=Number((ke*1e3/E).toFixed(4))):(l.tf_value=0,l.tg_value=0),l})}}),e.jsx(Ye,{formData:u,updateFormData:R,t:a})]}),s===2&&e.jsx(qe,{formData:u,updateFormData:R,t:a})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:s>0&&e.jsxs("button",{onClick:x,className:"btn-secondary flex items-center gap-2",children:[e.jsx(Ke,{className:"w-4 h-4"}),a("common.previous")]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:c,disabled:P,className:"btn-secondary flex items-center gap-2",children:[P?e.jsx(V,{className:"w-4 h-4 animate-spin"}):e.jsx(me,{className:"w-4 h-4"}),a("kpi.saveDraft")]}),s<B.length-1?e.jsxs("button",{onClick:p,className:"btn-primary flex items-center gap-2",children:[a("common.next"),e.jsx(Ue,{className:"w-4 h-4"})]}):e.jsxs("button",{onClick:h,disabled:v,className:"btn-primary flex items-center gap-2 bg-green-600 hover:bg-green-700",children:[v?e.jsx(V,{className:"w-4 h-4 animate-spin"}):e.jsx(Le,{className:"w-4 h-4"}),a("kpi.submitReport")]})]})]})]})}export{as as default};

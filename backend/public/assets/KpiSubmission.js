import{u as Ne,j as e,a as ye,m as G,n as J,g as ue,k as X}from"./index.js";import{r as g,h as we,u as Se}from"./vendor-react.js";import{B as je,aa as Ce,ap as Ee,g as ke,U as xe,f as Me,A as ae,c as oe,s as _e,e as pe,aq as Ae,a2 as ge,a3 as Fe,Y as Ie,ar as Re,as as Pe,at as he,V as We,au as Ke,av as Te,C as Le,ao as be,ae as de,aw as Ue,ab as De,v as H,R as He,a as fe,z as j,ax as ce,ac as Ve,ad as $e,ay as qe}from"./vendor-ui.js";import{g as ve,a as Ye,b as Be,f as me}from"./weekHelper.js";import{S as le}from"./Select.js";import{s as Oe,g as ze}from"./projectList.js";import"./vendor-utils.js";function Ge({formData:o,updateFormData:b,projects:t,t:a,poles:s,selectedPole:k,onPoleChange:w}){const{user:F}=Ne(),M=g.useMemo(()=>ve(),[]),V=F?.project_list_preference??"code",S=g.useMemo(()=>{const m=Array.isArray(t)?t:[];return k?m.filter(N=>N?.pole===k):m},[t,k]),I=g.useMemo(()=>Oe(S,V),[S,V]),Z=g.useMemo(()=>{const m=o.report_year||new Date().getFullYear();return Ye(m)},[o.report_year]),C=m=>{const N=o.report_year||new Date().getFullYear(),v=Be(m,N);b("week_number",m),b("start_date",me(v.start)),b("end_date",me(v.end)),b("report_date",me(v.start)),b("report_month",v.start.getMonth()+1)},R=m=>{b("report_year",parseInt(m)),b("week_number",""),b("start_date",""),b("end_date","")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(je,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:a("kpi.projectInfo.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:a("kpi.projectInfo.selectProject")})]})]}),e.jsxs("div",{children:[Array.isArray(s)&&s.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"label",children:"Pole"}),e.jsxs(le,{value:k,onChange:m=>w?.(m.target.value),children:[e.jsx("option",{value:"",children:"All"}),s.map(m=>e.jsx("option",{value:m,children:m},m))]})]}),e.jsxs("label",{className:"label",children:[a("projects.projectName")," *"]}),e.jsxs(le,{value:o.project_id,onChange:m=>b("project_id",m.target.value),children:[e.jsx("option",{value:"",children:a("kpi.projectInfo.selectProject")}),I.map(m=>e.jsx("option",{value:m.id,children:ze(m)},m.id))]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(Ce,{className:"w-5 h-5 text-hse-primary"}),a("kpi.projectInfo.reportPeriod")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("kpi.reportYear")}),e.jsx(le,{value:o.report_year,onChange:m=>R(m.target.value),children:[...Array(5)].map((m,N)=>{const v=new Date().getFullYear()-2+N;return e.jsx("option",{value:v,children:v},v)})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),a("kpi.projectInfo.weekNumber")," * (Sam-Ven)"]}),e.jsxs(le,{value:o.week_number??"",onChange:m=>C(parseInt(m.target.value)),children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),Z.map(m=>e.jsxs("option",{value:m.week,className:m.week===M.week&&m.year===M.year?"font-bold":"",children:["S",String(m.week).padStart(2,"0")," - ",m.year,m.week===M.week&&m.year===M.year?` (${a("kpi.projectInfo.currentWeek")})`:""]},m.week))]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("kpi.projectInfo.startDate")," (Samedi)"]}),e.jsx("div",{className:"input bg-gray-100 dark:bg-gray-600 cursor-not-allowed flex items-center text-sm",children:e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:o.start_date??""})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("kpi.projectInfo.endDate")," (Vendredi)"]}),e.jsx("div",{className:"input bg-gray-100 dark:bg-gray-600 cursor-not-allowed flex items-center text-sm",children:e.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:o.end_date??""})})]})]}),o.start_date&&o.end_date&&e.jsx("div",{className:"mt-4 p-3 bg-hse-primary/10 rounded-lg",children:e.jsxs("p",{className:"text-sm text-hse-primary font-medium",children:["ðŸ“… Semaine ",o.week_number,": ",new Date(o.start_date).toLocaleDateString("fr-FR")," - ",new Date(o.end_date).toLocaleDateString("fr-FR")]})})]}),o.project_id&&e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-xl",children:[e.jsx("h4",{className:"font-medium text-blue-900 dark:text-blue-300 mb-2",children:a("projects.projectDetails")}),(()=>{const m=t.find(N=>N.id===parseInt(o.project_id));return m?e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[a("projects.projectName"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:m.name})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[a("projects.projectCode"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:m.code})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[a("projects.location"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:m.location??""})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:[a("projects.clientName"),":"]}),e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-200",children:m.client_name??""})]})]}):null})()]})]})}function Je({formData:o,updateFormData:b,t}){const a=(s,k)=>{b(s,k===""?0:parseFloat(k))};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(ke,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:t("kpi.weekly.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:t("kpi.weekly.subtitle")})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5 text-hse-primary"}),t("kpi.rates.hoursWorked")," & ",t("kpi.weekly.induction")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-gray-400"}),t("kpi.rates.hoursWorked")]}),e.jsx("input",{type:"number",min:"0",value:o.hours_worked??"",onChange:s=>a("hours_worked",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Me,{className:"w-4 h-4 text-gray-400"}),t("kpi.weekly.induction")]}),e.jsx("input",{type:"number",min:"0",value:o.employees_trained??"",onChange:s=>a("employees_trained",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-amber-500"}),t("kpi.weekly.ecarts")," & ",t("kpi.weekly.sensibilisation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.ecarts")}),e.jsx("input",{type:"number",min:"0",value:o.unsafe_conditions_reported??"",onChange:s=>a("unsafe_conditions_reported",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.sensibilisation")}),e.jsx("input",{type:"number",min:"0",value:o.toolbox_talks??"",onChange:s=>a("toolbox_talks",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-red-500"}),t("kpi.weekly.accident"),"s"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.presquAccident")}),e.jsx("input",{type:"number",min:"0",value:o.near_misses??"",onChange:s=>a("near_misses",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.premiersSoins")}),e.jsx("input",{type:"number",min:"0",value:o.first_aid_cases??"",onChange:s=>a("first_aid_cases",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.accident")}),e.jsx("input",{type:"number",min:"0",value:o.accidents??"",onChange:s=>a("accidents",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.joursArret")}),e.jsx("input",{type:"number",min:"0",value:o.lost_workdays??"",onChange:s=>a("lost_workdays",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5 text-green-500"}),t("kpi.weekly.inspections")," & ",t("kpi.weekly.heuresFormation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4 text-gray-400"}),t("kpi.weekly.inspections")]}),e.jsx("input",{type:"number",min:"0",value:o.inspections_completed??"",onChange:s=>a("inspections_completed",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(_e,{className:"w-4 h-4 text-gray-400"}),t("kpi.weekly.heuresFormation")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.5",value:o.training_hours??"",onChange:s=>a("training_hours",s.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"h"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(pe,{className:"w-5 h-5 text-hse-primary"}),t("kpi.weekly.permisTravail")," & ",t("kpi.weekly.mesuresDisciplinaires")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4 text-gray-400"}),t("kpi.weekly.permisTravail")]}),e.jsx("input",{type:"number",min:"0",value:o.work_permits??"",onChange:s=>a("work_permits",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.mesuresDisciplinaires")}),e.jsx("input",{type:"number",min:"0",value:o.corrective_actions??"",onChange:s=>a("corrective_actions",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5 text-green-600"}),t("kpi.weekly.conformiteHSE")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.conformiteHSE")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",value:o.hse_compliance_rate??"",onChange:s=>a("hse_compliance_rate",s.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"%"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("kpi.weekly.conformiteMedecine")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",value:o.medical_compliance_rate??"",onChange:s=>a("medical_compliance_rate",s.target.value),className:"input pr-10",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"%"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Ae,{className:"w-4 h-4 text-gray-400"}),t("kpi.weekly.suiviBruit")]}),e.jsx("input",{type:"number",min:"0",value:o.noise_monitoring??"",onChange:s=>a("noise_monitoring",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(ge,{className:"w-5 h-5 text-blue-500"}),t("kpi.weekly.consommation")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4 text-blue-400"}),t("kpi.weekly.consommationEau")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.1",value:o.water_consumption??"",onChange:s=>a("water_consumption",s.target.value),className:"input pr-12",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"mÂ³"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4 text-yellow-500"}),t("kpi.weekly.consommationElectricite")]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.1",value:o.electricity_consumption??"",onChange:s=>a("electricity_consumption",s.target.value),className:"input pr-14",placeholder:"0"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"kWh"})]})]})]})]})]})}function Xe({formData:o,updateFormData:b,t}){const a=(s,k)=>{b(s,k===""?0:parseInt(k))};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center",children:e.jsx(ae,{className:"w-6 h-6 text-red-600 dark:text-red-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:t("kpi.incidents.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:t("kpi.incidents.subtitle")})]})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-xl p-6 border border-red-200 dark:border-red-700",children:[e.jsxs("h3",{className:"font-semibold text-red-900 dark:text-red-300 mb-4 flex items-center gap-2",children:[e.jsx(Ie,{className:"w-5 h-5"}),t("kpi.incidents.fatality")]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-red-200 dark:border-red-700 max-w-md",children:[e.jsx("label",{className:"font-medium text-red-900 dark:text-red-300 block mb-2",children:t("kpi.incidents.fatality")}),e.jsx("input",{type:"number",min:"0",value:o.accidents_fatal??"",onChange:s=>a("accidents_fatal",s.target.value),className:"input border-red-300",placeholder:"0"})]})]}),e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/30 rounded-xl p-6 border border-orange-200 dark:border-orange-700",children:[e.jsxs("h3",{className:"font-semibold text-orange-900 dark:text-orange-300 mb-4 flex items-center gap-2",children:[e.jsx(_e,{className:"w-5 h-5"}),t("kpi.incidents.lostTimeAccident")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700",children:[e.jsx("label",{className:"font-medium text-orange-900 dark:text-orange-300 block mb-2",children:t("kpi.incidents.lostTimeAccident")}),e.jsx("input",{type:"number",min:"0",value:o.accidents_serious??"",onChange:s=>a("accidents_serious",s.target.value),className:"input border-orange-300",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700",children:[e.jsx("label",{className:"font-medium text-orange-900 dark:text-orange-300 block mb-2",children:t("kpi.incidents.lostWorkDays")}),e.jsx("input",{type:"number",min:"0",value:o.lost_workdays??"",onChange:s=>a("lost_workdays",s.target.value),className:"input border-orange-300",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-6 border border-yellow-200 dark:border-yellow-700",children:[e.jsxs("h3",{className:"font-semibold text-yellow-900 dark:text-yellow-300 mb-4 flex items-center gap-2",children:[e.jsx(Re,{className:"w-5 h-5"}),t("kpi.incidents.nonLostTimeAccident")," & ",t("kpi.incidents.firstAidCase")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700",children:[e.jsx("label",{className:"font-medium text-yellow-900 dark:text-yellow-300 block mb-2",children:t("kpi.incidents.nonLostTimeAccident")}),e.jsx("input",{type:"number",min:"0",value:o.accidents_minor??"",onChange:s=>a("accidents_minor",s.target.value),className:"input border-yellow-300",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700",children:[e.jsx("label",{className:"font-medium text-yellow-900 dark:text-yellow-300 block mb-2",children:t("kpi.incidents.firstAidCase")}),e.jsx("input",{type:"number",min:"0",value:o.first_aid_cases??"",onChange:s=>a("first_aid_cases",s.target.value),className:"input border-yellow-300",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/30 rounded-xl p-6 border border-amber-200 dark:border-amber-700",children:[e.jsxs("h3",{className:"font-semibold text-amber-900 dark:text-amber-300 mb-4 flex items-center gap-2",children:[e.jsx(Pe,{className:"w-5 h-5"}),t("kpi.incidents.nearMiss")]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-amber-200 dark:border-amber-700 max-w-md",children:[e.jsx("label",{className:"font-medium text-amber-900 dark:text-amber-300 block mb-2",children:t("kpi.incidents.nearMiss")}),e.jsx("input",{type:"number",min:"0",value:o.near_misses??"",onChange:s=>a("near_misses",s.target.value),className:"input border-amber-300",placeholder:"0"})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6 border border-gray-200 dark:border-gray-600",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(he,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"}),t("kpi.incidents.propertyDamage")," & ",t("kpi.incidents.environmentalImpact")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600",children:[e.jsxs("label",{className:"font-medium text-gray-900 dark:text-gray-100 block mb-2 flex items-center gap-2",children:[e.jsx(he,{className:"w-4 h-4"}),t("kpi.incidents.propertyDamage")]}),e.jsx("input",{type:"number",min:"0",value:o.findings_open??"",onChange:s=>a("findings_open",s.target.value),className:"input",placeholder:"0"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600",children:[e.jsxs("label",{className:"font-medium text-gray-900 dark:text-gray-100 block mb-2 flex items-center gap-2",children:[e.jsx(We,{className:"w-4 h-4 text-green-600"}),t("kpi.incidents.environmentalImpact")]}),e.jsx("input",{type:"number",min:"0",value:o.findings_closed??"",onChange:s=>a("findings_closed",s.target.value),className:"input",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(pe,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"}),t("kpi.notes")]}),e.jsx("textarea",{value:o.notes??"",onChange:s=>b("notes",s.target.value),rows:4,className:"input",placeholder:t("kpi.notes")})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-xl p-6 border border-blue-200 dark:border-blue-700",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-300 mb-4",children:t("kpi.incidents.summary")}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-red-600 dark:text-red-400",children:o.accidents_fatal??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:t("kpi.incidents.fatality")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600 dark:text-orange-400",children:o.accidents_serious??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:t("kpi.incidents.ltaShort")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-600 dark:text-yellow-400",children:o.first_aid_cases??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:t("kpi.incidents.firstAidCase")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-2xl font-bold text-amber-600 dark:text-amber-400",children:o.near_misses??0}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:t("kpi.incidents.nearMiss")})]})]})]})]})}const q=[{key:"effectif",label:"Effectif",labelEn:"Workforce",formula:"MAX",unit:""},{key:"induction",label:"Induction",labelEn:"Induction",formula:"SUM",unit:""},{key:"releve_ecarts",label:"RelevÃ© des Ã©carts",labelEn:"Deviations",formula:"SUM",unit:""},{key:"sensibilisation",label:"Sensibilisation (TBM)",labelEn:"Awareness (TBM)",formula:"SUM",unit:""},{key:"presquaccident",label:"Presqu'accident",labelEn:"Near Miss",formula:"SUM",unit:""},{key:"premiers_soins",label:"Premiers soins",labelEn:"First Aid",formula:"SUM",unit:""},{key:"accidents",label:"Accident",labelEn:"Accident",formula:"SUM",unit:""},{key:"jours_arret",label:"Jours d'arrÃªt",labelEn:"Lost Days",formula:"SUM",unit:""},{key:"heures_travaillees",label:"Heures travaillÃ©es",labelEn:"Hours Worked",formula:"SUM",unit:"h"},{key:"inspections",label:"Inspections",labelEn:"Inspections",formula:"SUM",unit:""},{key:"heures_formation",label:"Heures de formation",labelEn:"Training Hours",formula:"SUM",unit:"h"},{key:"permis_travail",label:"Permis de travail",labelEn:"Work Permits",formula:"SUM",unit:""},{key:"mesures_disciplinaires",label:"Mesures disciplinaires",labelEn:"Disciplinary",formula:"SUM",unit:""},{key:"conformite_hse",label:"ConformitÃ© HSE (%)",labelEn:"HSE Compliance (%)",formula:"AVG",unit:"%"},{key:"conformite_medicale",label:"ConformitÃ© MÃ©dicale (%)",labelEn:"Medical Compliance (%)",formula:"AVG",unit:"%"}],Ze={fr:{Saturday:"Sam",Sunday:"Dim",Monday:"Lun",Tuesday:"Mar",Wednesday:"Mer",Thursday:"Jeu",Friday:"Ven"},en:{Saturday:"Sat",Sunday:"Sun",Monday:"Mon",Tuesday:"Tue",Wednesday:"Wed",Thursday:"Thu",Friday:"Fri"}};function Qe({projectId:o,weekNumber:b,year:t,onDataConfirmed:a}){const{t:s,language:k}=ye(),[w,F]=g.useState("download"),[M,V]=g.useState([]),[S,I]=g.useState([]),[Z,C]=g.useState({}),[R,m]=g.useState(!1),[N,v]=g.useState(!1),[P,Q]=g.useState(!0),[T,Y]=g.useState(!1),L=g.useCallback((c,h)=>({entry_date:c,day_name:h,...q.reduce((d,u)=>({...d,[u.key]:""}),{})}),[]),$=g.useCallback(c=>{const h={};return q.forEach(d=>{const u=c.map(x=>x[d.key]).filter(x=>x!==""&&x!==null&&x!==void 0).map(x=>parseFloat(x)).filter(x=>!isNaN(x));if(u.length===0){h[d.key]=0;return}switch(d.formula){case"MAX":h[d.key]=Math.max(...u);break;case"AVG":h[d.key]=Math.round(u.reduce((x,E)=>x+E,0)/u.length*100)/100;break;case"SUM":default:h[d.key]=Math.round(u.reduce((x,E)=>x+E,0)*100)/100}}),h},[]),[A,B]=g.useState(null);g.useEffect(()=>{(async()=>{if(!(!o||!b||!t))try{const h=await G.getWeekDates({week_number:b,year:t}),{days:d}=h.data.data;V(d);const u=await G.getAutoFillValues({project_id:o,week_number:b,year:t});B(u.data.data);const x=await G.getWeekAggregates({project_id:o,week_number:b,year:t}),{aggregates:E,daily_entries:O,has_data:W}=x.data.data;if(W&&O?.length>0){Y(!0),C(E);const K=d.map(f=>{const r=O.find(i=>i.entry_date===f.date);return r?{entry_date:f.date,day_name:f.day_name,...q.reduce((i,p)=>({...i,[p.key]:r[p.key]??""}),{})}:L(f.date,f.day_name)});I(K)}else{const K=d.map(f=>{const r=u.data.data?.daily_values?.find(i=>i.entry_date===f.date)?.auto_values||{};return{entry_date:f.date,day_name:f.day_name,...q.reduce((i,p)=>({...i,[p.key]:r[p.key]??""}),{})}});I(K),C($(K))}}catch(h){console.error("Failed to fetch data:",h)}})()},[o,b,t,L,$]);const re=()=>{if(!A?.daily_values)return;const c=(d,u,x)=>Object.prototype.hasOwnProperty.call(u,x)&&u[x]!==null&&u[x]!==void 0?u[x]:d[x]!==null&&d[x]!==void 0?d[x]:"",h=S.map(d=>{const u=A.daily_values.find(x=>x.entry_date===d.entry_date)?.auto_values||{};return{...d,releve_ecarts:c(d,u,"releve_ecarts"),sensibilisation:c(d,u,"sensibilisation"),heures_formation:c(d,u,"heures_formation"),permis_travail:c(d,u,"permis_travail"),inspections:c(d,u,"inspections"),mesures_disciplinaires:c(d,u,"mesures_disciplinaires"),conformite_hse:c(d,u,"conformite_hse")}});I(h),C($(h)),j.success(s("kpi.dailyKpi.systemDataApplied"))},te=async()=>{m(!0);try{const c=await G.downloadTemplate({project_id:o,week_number:b,year:t}),h=new Blob([c.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),d=window.URL.createObjectURL(h),u=document.createElement("a");u.href=d,u.download=`KPI_Journalier_S${b}_${t}.xlsx`,u.click(),window.URL.revokeObjectURL(d),j.success(s("kpi.dailyKpi.templateDownloaded")),F("upload")}catch(c){console.error("Download failed:",c),j.error(s("kpi.dailyKpi.downloadFailed"))}finally{m(!1)}},ie=async c=>{const h=c.target.files?.[0];if(h){v(!0);try{const d=new FormData;d.append("file",h),d.append("project_id",o),d.append("week_number",b),d.append("year",t);const u=await G.parseTemplate(d),{daily_entries:x,aggregates:E}=u.data.data,O=M.map(W=>{const K=x.find(f=>f.entry_date===W.date);return K?{entry_date:W.date,day_name:W.day_name,...q.reduce((f,r)=>({...f,[r.key]:K[r.key]??""}),{})}:L(W.date,W.day_name)});I(O),C(E),F("manual"),j.success(s("kpi.dailyKpi.dataImported"))}catch(d){console.error("Upload failed:",d),j.error(s("kpi.dailyKpi.parseFailed"))}finally{v(!1),c.target.value=""}}},ne=(c,h,d)=>{const u=[...S],x=Number(d),E=d===""?"":Number.isFinite(x)?x:0;u[c]={...u[c],[h]:E},I(u),C($(u))},l=async()=>{m(!0);try{const c=S.filter(u=>q.some(x=>u[x.key]!==""&&u[x.key]!==null&&u[x.key]!==void 0));if(c.length===0){j.error(s("kpi.dailyKpi.noDataToSave")),m(!1);return}const h=await G.bulkSave({project_id:o,week_number:b,year:t,entries:c}),{aggregates:d}=h.data.data;C(d),Y(!0),a&&a(d),j.success(s("kpi.dailyKpi.dataSaved"))}catch(c){console.error("Save failed:",c),j.error(s("kpi.dailyKpi.saveFailed"))}finally{m(!1)}},U=(c,h)=>c==null||c===""?"-":c===0?"0":`${c}${h?` ${h}`:""}`;return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gradient-to-r from-hse-primary/5 to-transparent cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",onClick:()=>Q(!P),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:e.jsx(Ke,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("kpi.dailyKpi.title")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s("kpi.dailyKpi.subtitle")})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[T&&e.jsxs("span",{className:"px-2.5 py-1 text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300 rounded-full",children:["âœ“ ",s("kpi.dailyKpi.hasData")]}),e.jsx("div",{className:"p-1.5 rounded-full bg-gray-100 dark:bg-gray-700",children:P?e.jsx(Te,{className:"w-4 h-4"}):e.jsx(Le,{className:"w-4 h-4"})})]})]}),P&&e.jsxs("div",{className:"p-4 space-y-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>F("download"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${w==="download"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("kpi.dailyKpi.download")})]}),e.jsxs("button",{onClick:()=>F("upload"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${w==="upload"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("kpi.dailyKpi.import")})]}),e.jsxs("button",{onClick:()=>F("manual"),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${w==="manual"?"bg-hse-primary text-white shadow-md":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:[e.jsx(Ue,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("kpi.dailyKpi.entry")})]})]}),w==="download"&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("div",{className:"inline-flex p-4 bg-green-50 dark:bg-green-900/20 rounded-full",children:e.jsx(De,{className:"w-12 h-12 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:s("kpi.dailyKpi.downloadTemplate")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1 max-w-sm mx-auto",children:s("kpi.dailyKpi.downloadDesc")})]}),e.jsxs("button",{onClick:te,disabled:R||!o||!b,className:"btn-primary inline-flex items-center gap-2 px-6",children:[R?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(be,{className:"w-4 h-4"}),s("kpi.dailyKpi.download")]})]}),w==="upload"&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("div",{className:"inline-flex p-4 bg-blue-50 dark:bg-blue-900/20 rounded-full",children:e.jsx(de,{className:"w-12 h-12 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:s("kpi.dailyKpi.importFile")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1 max-w-sm mx-auto",children:s("kpi.dailyKpi.importDesc")})]}),e.jsxs("label",{className:"btn-primary inline-flex items-center gap-2 px-6 cursor-pointer",children:[N?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(de,{className:"w-4 h-4"}),s("kpi.dailyKpi.selectFile"),e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:ie,className:"hidden",disabled:N})]})]}),w==="manual"&&M.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto -mx-4 px-4",children:e.jsx("div",{className:"inline-block min-w-full align-middle",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 dark:bg-gray-900",children:[e.jsx("th",{className:"sticky left-0 z-10 bg-gray-50 dark:bg-gray-900 text-left py-3 px-3 font-semibold text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 min-w-[160px]",children:s("kpi.dailyKpi.indicator")}),M.map((c,h)=>e.jsxs("th",{className:"text-center py-3 px-2 font-medium text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 min-w-[70px]",children:[e.jsx("div",{className:"font-semibold text-gray-800 dark:text-gray-200",children:Ze[k]?.[c.day_name]||c.day_name?.slice(0,3)}),e.jsx("div",{className:"text-[10px] text-gray-500 font-normal",children:c.display})]},h)),e.jsx("th",{className:"text-center py-3 px-3 font-semibold text-hse-primary bg-hse-primary/5 border-b border-gray-200 dark:border-gray-700 min-w-[80px]",children:s("kpi.dailyKpi.total")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:q.map((c,h)=>e.jsxs("tr",{className:"hover:bg-gray-50/50 dark:hover:bg-gray-800/50 transition-colors",children:[e.jsx("td",{className:"sticky left-0 z-10 bg-white dark:bg-gray-800 py-2 px-3 font-medium text-gray-700 dark:text-gray-300 text-xs border-r border-gray-100 dark:border-gray-700",children:k==="fr"?c.label:c.labelEn}),S.map((d,u)=>e.jsx("td",{className:"py-1.5 px-1",children:e.jsx("input",{type:"number",step:c.formula==="AVG"||c.key.includes("heures")?"0.1":"1",min:"0",value:d[c.key]??"",onChange:x=>ne(u,c.key,x.target.value),className:"w-full text-center py-1.5 px-1 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-hse-primary/30 focus:border-hse-primary transition-all",placeholder:"-"})},u)),e.jsx("td",{className:"py-2 px-3 text-center font-semibold text-hse-primary bg-hse-primary/5",children:U(Z[c.key],c.unit)})]},c.key))})]})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["* ",s("kpi.dailyKpi.formulaInfo")]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["* ",s("kpi.dailyKpi.workHoursFormula")]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs("button",{onClick:re,disabled:!A,className:"btn-secondary flex items-center gap-2 px-4 w-full sm:w-auto justify-center",children:[e.jsx(He,{className:"w-4 h-4"}),s("kpi.dailyKpi.autoFill")]}),e.jsxs("button",{onClick:l,disabled:R,className:"btn-primary flex items-center gap-2 px-6 w-full sm:w-auto justify-center",children:[R?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(fe,{className:"w-4 h-4"}),s("kpi.dailyKpi.confirm")]})]})]})]})]})]})}const se="hse-kpi-draft";function ls(){const{projectId:o,reportId:b}=we(),t=Se(),{t:a}=ye(),[s,k]=g.useState(0),[w,F]=g.useState([]),[M,V]=g.useState([]),[S,I]=g.useState(""),[Z,C]=g.useState(!0),[R,m]=g.useState(!1),[N,v]=g.useState(!1),[P,Q]=g.useState(!1),[T,Y]=g.useState(null),[L,$]=g.useState(null),[A,B]=g.useState({noise_monitoring:"",water_consumption:"",electricity_consumption:""}),[re,te]=g.useState(!1),[ie,ne]=g.useState(!1),[l,U]=g.useState(()=>{if(b)return c(o);const r=localStorage.getItem(se);if(r)try{return JSON.parse(r)}catch(i){console.error("Error parsing draft:",i)}return c(o)});function c(r){const i=ve();return{project_id:r??"",report_date:"",report_month:new Date().getMonth()+1,report_year:i.year,week_number:"",start_date:"",end_date:"",hours_worked:0,employees_trained:0,unsafe_conditions_reported:0,toolbox_talks:0,near_misses:0,first_aid_cases:0,accidents:0,lost_workdays:0,inspections_completed:0,tg_value:0,tf_value:0,training_hours:0,work_permits:0,corrective_actions:0,hse_compliance_rate:0,medical_compliance_rate:0,noise_monitoring:0,water_consumption:0,electricity_consumption:0,accidents_fatal:0,accidents_serious:0,accidents_minor:0,findings_open:0,findings_closed:0,trainings_conducted:0,trainings_planned:0,inspections_planned:0,unsafe_acts_reported:0,emergency_drills:0,notes:"",status:"draft"}}const h=[{id:"project-info",title:a("kpi.steps.projectInfo"),icon:je,description:a("kpi.projectInfo.title")},{id:"weekly-reporting",title:a("kpi.steps.weeklyReporting"),icon:ke,description:a("kpi.weekly.title")},{id:"incident-tracking",title:a("kpi.steps.incidentTracking"),icon:ae,description:a("kpi.incidents.title")}],d=(r,i)=>{const p=n=>{const y=Number(n);return Number.isFinite(y)?y:0};U(n=>{const y={...n,[r]:i};if(["accidents","lost_workdays","hours_worked"].includes(r)){const _=p(r==="hours_worked"?i:y.hours_worked),D=p(r==="accidents"?i:y.accidents),ee=p(r==="lost_workdays"?i:y.lost_workdays);_>0?(y.tf_value=Number((D*1e6/_).toFixed(2)),y.tg_value=Number((ee*1e3/_).toFixed(4))):(y.tf_value=0,y.tg_value=0)}return y})};g.useEffect(()=>{(async()=>{if(!(!l.project_id||!l.report_year||!l.report_month)){te(!0);try{const[i,p,n]=await Promise.all([J.getAll({project_id:l.project_id,year:l.report_year,month:l.report_month,indicator:"noise_monitoring",per_page:1}),J.getAll({project_id:l.project_id,year:l.report_year,month:l.report_month,indicator:"water_consumption",per_page:1}),J.getAll({project_id:l.project_id,year:l.report_year,month:l.report_month,indicator:"electricity_consumption",per_page:1})]),y=i.data?.data?.[0],_=p.data?.data?.[0],D=n.data?.data?.[0],ee={noise_monitoring:y?.value??"",water_consumption:_?.value??"",electricity_consumption:D?.value??""};B(ee),U(z=>({...z,noise_monitoring:y?.value??z.noise_monitoring,water_consumption:_?.value??z.water_consumption,electricity_consumption:D?.value??z.electricity_consumption}))}catch(i){console.error("Failed to fetch monthly environmental KPI measurements:",i)}finally{te(!1)}}})()},[l.project_id,l.report_year,l.report_month]);const u=async()=>{if(!l.project_id||!l.report_year||!l.report_month)return;const r=y=>{if(y===""||y===null||y===void 0)return null;const _=Number(y);return Number.isFinite(_)?_:null},i=r(A.noise_monitoring),p=r(A.water_consumption),n=r(A.electricity_consumption);ne(!0);try{const y=[];i!==null&&y.push(J.upsert({project_id:l.project_id,year:l.report_year,month:l.report_month,indicator:"noise_monitoring",value:i})),p!==null&&y.push(J.upsert({project_id:l.project_id,year:l.report_year,month:l.report_month,indicator:"water_consumption",value:p})),n!==null&&y.push(J.upsert({project_id:l.project_id,year:l.report_year,month:l.report_month,indicator:"electricity_consumption",value:n})),await Promise.all(y),U(_=>({..._,noise_monitoring:i!==null?i:_.noise_monitoring,water_consumption:p!==null?p:_.water_consumption,electricity_consumption:n!==null?n:_.electricity_consumption})),j.success(a("common.saved")??"Saved")}catch(y){console.error("Failed to save monthly environmental KPI measurements:",y),j.error(a("common.error")??"Error")}finally{ne(!1)}};g.useEffect(()=>{(async()=>{try{const i=await ue.getAllList({status:"active"});F(i),i.length===1&&!l.project_id&&d("project_id",i[0].id.toString())}catch(i){console.error("Failed to load projects:",i),j.error(a("errors.somethingWentWrong"))}finally{C(!1)}})()},[a]),g.useEffect(()=>{(async()=>{try{const i=await ue.getPoles(),p=i.data?.data?.poles??i.data?.poles??[];V(Array.isArray(p)?p:[])}catch{V([])}})()},[]),g.useEffect(()=>{if(!S)return;!w.some(i=>String(i.id)===String(l.project_id)&&i?.pole===S)&&l.project_id&&d("project_id","")},[S,w,l.project_id,d]),g.useEffect(()=>{(async()=>{if(b)try{C(!0);const p=(await X.getById(b)).data?.data,n=p?.report||p;if(n.status==="approved"||n.status==="submitted"){j.error(a("kpi.submissionPage.cannotEditReport")),t("/dashboard");return}Q(!0),Y(n.id),n.rejection_reason&&$({reason:n.rejection_reason,rejected_at:n.rejected_at}),U({project_id:n.project_id!==null&&n.project_id!==void 0?String(n.project_id):"",report_date:n.report_date??"",report_month:n.report_month,report_year:n.report_year,week_number:n.week_number!==null&&n.week_number!==void 0?String(n.week_number):"",start_date:n.start_date??"",end_date:n.end_date??"",hours_worked:n.hours_worked??0,employees_trained:n.employees_trained??0,unsafe_conditions_reported:n.unsafe_conditions_reported??0,toolbox_talks:n.toolbox_talks??0,near_misses:n.near_misses??0,first_aid_cases:n.first_aid_cases??0,accidents:n.accidents??0,lost_workdays:n.lost_workdays??0,inspections_completed:n.inspections_completed??0,tg_value:n.tg_value??0,tf_value:n.tf_value??0,training_hours:n.training_hours??0,work_permits:n.work_permits??0,corrective_actions:n.corrective_actions??0,hse_compliance_rate:n.hse_compliance_rate??n.ppe_compliance_rate??0,medical_compliance_rate:n.medical_compliance_rate??0,noise_monitoring:n.noise_monitoring??0,water_consumption:n.water_consumption??0,electricity_consumption:n.electricity_consumption??0,accidents_fatal:n.accidents_fatal??0,accidents_serious:n.accidents_serious??0,accidents_minor:n.accidents_minor??0,findings_open:n.findings_open??0,findings_closed:n.findings_closed??0,trainings_conducted:n.trainings_conducted??0,trainings_planned:n.trainings_planned??0,inspections_planned:n.inspections_planned??0,unsafe_acts_reported:n.unsafe_acts_reported??0,emergency_drills:n.emergency_drills??0,notes:n.notes??"",status:"draft"})}catch(i){console.error("Failed to load report:",i),j.error(a("kpi.submissionPage.loadReportFailed")),t("/dashboard")}finally{C(!1)}})()},[b,t]),g.useEffect(()=>{if(P)return;const r=setTimeout(()=>{localStorage.setItem(se,JSON.stringify(l))},1e3);return()=>clearTimeout(r)},[l,P]);const x=async()=>{if(!l.project_id){j.error(a("kpi.projectInfo.selectProject"));return}m(!0);try{const r={...l,status:"draft"};if(T)await X.update(T,r);else{const p=(await X.create(r))?.data?.data;p?.id&&(Y(p.id),Q(!0))}localStorage.setItem(se,JSON.stringify(r)),j.success(a("kpi.reportSaved"))}catch(r){const i=r?.response?.data?.message??a("errors.somethingWentWrong");j.error(i)}finally{m(!1)}},E=async()=>{if(!l.project_id){j.error(a("kpi.projectInfo.selectProject")),k(0);return}v(!0);try{const r={...l,status:"submitted"};P&&T?(await X.update(T,r),j.success(a("kpi.reportResubmitted"))):(await X.create(r),j.success(a("kpi.reportSubmitted"))),localStorage.removeItem(se),t("/dashboard")}catch(r){const i=r.response?.data?.message??a("errors.somethingWentWrong");j.error(i)}finally{v(!1)}},O=async()=>{try{T&&await X.delete(T)}catch(r){const i=r?.response?.data?.message??a("errors.somethingWentWrong");j.error(i);return}localStorage.removeItem(se),Y(null),Q(!1),$(null),U(c("")),k(0),j.success(a("common.success"))},W=()=>{if(s===0&&!l.project_id){j.error(a("kpi.projectInfo.selectProject"));return}if(s===0&&!l.week_number){j.error(a("kpi.submissionPage.selectWeekRequired"));return}if(s===0&&(!l.start_date||!l.end_date)){j.error(a("kpi.submissionPage.selectWeekRequired"));return}s<h.length-1&&(k(r=>r+1),window.scrollTo({top:0,behavior:"smooth"}))},K=()=>{s>0&&(k(r=>r-1),window.scrollTo({top:0,behavior:"smooth"}))},f=r=>{if(r>0&&!l.project_id){j.error(a("kpi.projectInfo.selectProject"));return}if(r>0&&(!l.week_number||!l.start_date||!l.end_date)){j.error(a("kpi.submissionPage.selectWeekRequired"));return}k(r),window.scrollTo({top:0,behavior:"smooth"})};return Z?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(H,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"max-w-5xl mx-auto animate-fade-in",children:[L&&e.jsx("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ae,{className:"w-6 h-6 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-red-900",children:"Rapport rejetÃ© - Modification requise"}),e.jsx("p",{className:"text-red-700 mt-1",children:L.reason}),L.rejected_at&&e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["RejetÃ© le ",new Date(L.rejected_at).toLocaleDateString("fr-FR")]})]})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:P?"Modifier le rapport KPI":a("kpi.submission")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:P?"Corrigez et resoumettez votre rapport":a("kpi.weekly.title")})]}),e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-between",children:h.map((r,i)=>e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsxs("button",{onClick:()=>f(i),className:`flex items-center gap-3 p-3 rounded-xl transition-all w-full ${i===s?"bg-hse-primary text-white shadow-lg":i<s?"bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400":"bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${i===s?"bg-white/20":i<s?"bg-green-200 dark:bg-green-800":"bg-gray-200 dark:bg-gray-600"}`,children:i<s?e.jsx(fe,{className:"w-5 h-5"}):e.jsx(r.icon,{className:"w-5 h-5"})}),e.jsxs("div",{className:"hidden sm:block text-left",children:[e.jsxs("p",{className:"text-xs opacity-75",children:[a("common.step")??"Ã‰tape"," ",i+1]}),e.jsx("p",{className:"font-medium text-sm",children:r.title})]})]}),i<h.length-1&&e.jsx("div",{className:`h-1 flex-1 mx-2 rounded ${i<s?"bg-green-300":"bg-gray-200"}`})]},r.id))})}),l.status==="draft"&&l.project_id&&e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-300",children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm",children:[a("kpi.status.draft")," - ",a("kpi.reportSaved")]})]}),e.jsx("button",{onClick:O,className:"text-sm text-amber-700 dark:text-amber-300 hover:text-amber-800 dark:hover:text-amber-200 underline",children:a("common.delete")})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6",children:[s===0&&e.jsx(e.Fragment,{children:e.jsx(Ge,{formData:l,updateFormData:d,projects:w,t:a,poles:M,selectedPole:S,onPoleChange:r=>I(r)})}),s===1&&e.jsxs(e.Fragment,{children:[l.project_id&&l.week_number&&e.jsx(Qe,{projectId:l.project_id,weekNumber:l.week_number,year:l.report_year,onDataConfirmed:r=>{U(i=>{const p={...i};r.heures_travaillees!==void 0&&(p.hours_worked=r.heures_travaillees),r.induction!==void 0&&(p.employees_trained=r.induction),r.releve_ecarts!==void 0&&(p.unsafe_conditions_reported=r.releve_ecarts),r.sensibilisation!==void 0&&(p.toolbox_talks=r.sensibilisation),r.presquaccident!==void 0&&(p.near_misses=r.presquaccident),r.premiers_soins!==void 0&&(p.first_aid_cases=r.premiers_soins),r.accidents!==void 0&&(p.accidents=r.accidents),r.jours_arret!==void 0&&(p.lost_workdays=r.jours_arret),r.inspections!==void 0&&(p.inspections_completed=r.inspections),r.heures_formation!==void 0&&(p.training_hours=r.heures_formation),r.permis_travail!==void 0&&(p.work_permits=r.permis_travail),r.mesures_disciplinaires!==void 0&&(p.corrective_actions=r.mesures_disciplinaires),r.conformite_hse!==void 0&&(p.hse_compliance_rate=r.conformite_hse),r.conformite_medicale!==void 0&&(p.medical_compliance_rate=r.conformite_medicale);const n=Number(p.hours_worked),y=Number(p.accidents),_=Number(p.lost_workdays),D=Number.isFinite(n)?n:0,ee=Number.isFinite(y)?y:0,z=Number.isFinite(_)?_:0;return D>0?(p.tf_value=Number((ee*1e6/D).toFixed(2)),p.tg_value=Number((z*1e3/D).toFixed(4))):(p.tf_value=0,p.tg_value=0),p})}}),l.project_id&&e.jsxs("div",{className:"mt-6 p-4 bg-gray-50 dark:bg-gray-900/40 border border-gray-200 dark:border-gray-700 rounded-xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-800 dark:text-gray-200",children:a("kpi.monthlyMeasurements")??"Monthly Measurements"}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[a("kpi.monthlyMeasurementsHint")??"Noise / Water / Electricity are monthly-only."," ",l.report_month,"/",l.report_year]})]}),e.jsxs("button",{type:"button",onClick:u,disabled:ie||re,className:"btn-secondary flex items-center gap-2",children:[ie?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(ce,{className:"w-4 h-4"}),a("common.save")??"Save"]})]}),re?e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2",children:[e.jsx(H,{className:"w-4 h-4 animate-spin"}),a("common.loading")??"Loading"]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1",children:a("kpi.noiseMonitoring")??"Noise (dB)"}),e.jsx("input",{type:"number",step:"0.01",className:"input w-full",value:A.noise_monitoring,onChange:r=>B(i=>({...i,noise_monitoring:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1",children:a("kpi.waterConsumption")??"Water (mÂ³)"}),e.jsx("input",{type:"number",step:"0.01",className:"input w-full",value:A.water_consumption,onChange:r=>B(i=>({...i,water_consumption:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1",children:a("kpi.electricityConsumption")??"Electricity (kWh)"}),e.jsx("input",{type:"number",step:"0.01",className:"input w-full",value:A.electricity_consumption,onChange:r=>B(i=>({...i,electricity_consumption:r.target.value}))})]})]})]}),e.jsx(Je,{formData:l,updateFormData:d,t:a})]}),s===2&&e.jsx(Xe,{formData:l,updateFormData:d,t:a})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:s>0&&e.jsxs("button",{onClick:K,className:"btn-secondary flex items-center gap-2",children:[e.jsx(Ve,{className:"w-4 h-4"}),a("common.previous")]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:x,disabled:R,className:"btn-secondary flex items-center gap-2",children:[R?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(ce,{className:"w-4 h-4"}),a("kpi.saveDraft")]}),s<h.length-1?e.jsxs("button",{onClick:W,className:"btn-primary flex items-center gap-2",children:[a("common.next"),e.jsx($e,{className:"w-4 h-4"})]}):e.jsxs("button",{onClick:E,disabled:N,className:"btn-primary flex items-center gap-2 bg-green-600 hover:bg-green-700",children:[N?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(qe,{className:"w-4 h-4"}),a("kpi.submitReport")]})]})]})]})}export{ls as default};

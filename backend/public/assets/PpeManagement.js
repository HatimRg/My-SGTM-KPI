import{a as ye,u as je,j as e,M as v,p as g,g as be,w as fe}from"./index.js";import{r}from"./vendor-react.js";import{S as A}from"./Select.js";import{D as _e}from"./DatePicker.js";import{a3 as ve,b1 as Ne,aG as ke,z as i,w as we,a0 as Se,b0 as qe,aA as Ce}from"./vendor-ui.js";import"./vendor-utils.js";function Oe(){const{t}=ye(),{user:d}=je(),[se,D]=r.useState([]),[te,R]=r.useState(!0),[c,E]=r.useState(""),ae=d?.role==="admin"||d?.role==="dev"||d?.role==="hse_manager"||d?.role==="regional_hse_manager"||d?.role==="hse_director",p=!!c&&!(c==="all"),[O,N]=r.useState([]),[re,$]=r.useState(!0),[k,le]=r.useState(""),[w,ie]=r.useState(""),[T,S]=r.useState(!1),[z,q]=r.useState(null),[F,L]=r.useState(!1),[M,y]=r.useState({name:""}),[u,j]=r.useState(null),[B,G]=r.useState(!1),[H,b]=r.useState(!1),[J,K]=r.useState(!1),[n,h]=r.useState({ppe_item_id:"",ppe_other:"",quantity:1,low_stock_threshold:""}),[Q,U]=r.useState(!1),[V,X]=r.useState(!1),[l,o]=r.useState({worker_query:"",worker_id:"",worker_label:"",ppe_item_id:"",ppe_other:"",quantity:1,received_at:""}),[ne,Y]=r.useState(!1),[Z,m]=r.useState([]),f=r.useRef(0);r.useEffect(()=>{const s=setTimeout(()=>ie(k.trim()),300);return()=>clearTimeout(s)},[k]),r.useEffect(()=>{(async()=>{try{R(!0);const a=await be.getAllList({status:"active"});D(Array.isArray(a)?a:[]),!c&&Array.isArray(a)&&a.length===1&&E(String(a[0].id))}catch(a){D([]),i.error(a.response?.data?.message??t("errors.somethingWentWrong"))}finally{R(!1)}})()},[]);const x=async()=>{try{if($(!0),!c){N([]);return}const s=await g.getItems({project_id:p?Number(c):void 0,search:w||void 0});N(s.data?.data??[])}catch(s){N([]),i.error(s.response?.data?.message??t("errors.somethingWentWrong"))}finally{$(!1)}};r.useEffect(()=>{x()},[w,c]);const ce=()=>{q(null),y({name:""}),S(!0)},oe=s=>{q(s),y({name:s?.name??""}),S(!0)},C=()=>{S(!1),q(null),y({name:""})},de=async s=>{s.preventDefault();try{L(!0);const a={id:z?.id,name:M.name};await g.upsertItem(a),i.success(t("success.saved")),C(),await x()}catch(a){i.error(a.response?.data?.message??t("errors.somethingWentWrong"))}finally{L(!1)}},me=s=>{j(s)},pe=async()=>{if(u)try{G(!0),await g.deleteItem(u.id),i.success(t("success.deleted")),j(null),await x()}catch(s){i.error(s.response?.data?.message??t("errors.somethingWentWrong"))}finally{G(!1)}},ue=()=>{if(!p){i.error(t("ppe.projectRequired"));return}U(!0),o({worker_query:"",worker_id:"",worker_label:"",ppe_item_id:"",ppe_other:"",quantity:1,received_at:""}),m([])},I=()=>{U(!1),o({worker_query:"",worker_id:"",worker_label:"",ppe_item_id:"",ppe_other:"",quantity:1,received_at:""}),m([])},he=async s=>{const a=String(s??"").trim();if(!a){m([]);return}const W=++f.current;try{Y(!0);const ge=await fe.getAll({search:a,project_id:p?Number(c):void 0,is_active:!0,per_page:10});if(W!==f.current)return;const ee=ge.data?.data?.data??[];m(Array.isArray(ee)?ee:[])}catch{if(W!==f.current)return;m([])}finally{W===f.current&&Y(!1)}};r.useEffect(()=>{const s=setTimeout(()=>{he(l.worker_query)},350);return()=>clearTimeout(s)},[l.worker_query]);const xe=async s=>{if(s.preventDefault(),!l.worker_id){i.error(t("ppe.issue.chooseWorker"));return}if(!l.ppe_item_id&&!l.ppe_other.trim()){i.error(t("ppe.issue.chooseItem"));return}try{X(!0);const a={worker_id:Number(l.worker_id),ppe_item_id:l.ppe_item_id?Number(l.ppe_item_id):void 0,ppe_name:l.ppe_item_id?void 0:l.ppe_other.trim(),quantity:Number(l.quantity??1),received_at:l.received_at};await g.issueToWorker(a),i.success(t("ppe.issue.success")),I(),await x()}catch(a){i.error(a.response?.data?.message??t("errors.somethingWentWrong"))}finally{X(!1)}},P=!!d,_=r.useMemo(()=>[...O].sort((s,a)=>String(s.name??"").localeCompare(String(a.name??""))),[O]);return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"w-5 h-5 text-hse-primary"}),e.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:t("ppe.title")})]}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1",children:t("ppe.subtitle")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",className:"btn-outline btn-sm flex items-center gap-2",onClick:ue,disabled:!P,children:[e.jsx(Ne,{className:"w-4 h-4"}),t("ppe.issue.button")]}),e.jsxs("button",{type:"button",className:"btn-primary btn-sm flex items-center gap-2",onClick:ce,disabled:!P,children:[e.jsx(ke,{className:"w-4 h-4"}),t("ppe.items.add")]})]})]})}),e.jsx("div",{className:"card p-3",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-2",children:[e.jsxs("div",{className:"w-full md:max-w-md",children:[e.jsx("label",{className:"label text-xs",children:t("ppe.project")}),e.jsxs(A,{value:c,onChange:s=>E(s.target.value),disabled:te,children:[e.jsx("option",{value:"",children:t("common.select")}),ae&&e.jsx("option",{value:"all",children:t("common.allProjects")}),se.map(s=>e.jsx("option",{value:s.id,children:s.code?`${s.code} - ${s.name}`:s.name},s.id))]})]}),e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx("button",{type:"button",className:"btn-outline btn-sm",onClick:()=>{if(!p){i.error(t("ppe.projectRequired"));return}h({ppe_item_id:"",ppe_other:"",quantity:1,low_stock_threshold:""}),b(!0)},disabled:!P,children:t("ppe.restock.button")})})]})}),e.jsx("div",{className:"card p-3 overflow-visible",children:e.jsx("div",{className:"flex flex-col md:flex-row md:items-center gap-2",children:e.jsxs("div",{className:"relative w-full md:max-w-md",children:[e.jsx(we,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{className:"input pl-9 py-1.5 text-sm",value:k,onChange:s=>le(s.target.value),placeholder:t("common.search")})]})})}),e.jsx("div",{className:"card overflow-hidden",children:c?re?e.jsx("div",{className:"p-6 flex items-center justify-center",children:e.jsx(Se,{className:"w-6 h-6 animate-spin text-hse-primary"})}):_.length===0?e.jsx("div",{className:"p-6 text-sm text-gray-600 dark:text-gray-300",children:t("common.noData")}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsx("th",{className:"py-3 px-4 font-medium text-gray-500 dark:text-gray-400",children:t("ppe.items.name")}),e.jsx("th",{className:"py-3 px-4 font-medium text-gray-500 dark:text-gray-400",children:t("ppe.items.stock")}),e.jsx("th",{className:"py-3 px-4 font-medium text-gray-500 dark:text-gray-400",children:t("ppe.items.threshold")}),e.jsx("th",{className:"py-3 px-4 font-medium text-gray-500 dark:text-gray-400",children:t("common.actions")})]})}),e.jsx("tbody",{children:_.map(s=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsx("td",{className:"py-3 px-4 text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("td",{className:"py-3 px-4 text-gray-700 dark:text-gray-200 font-mono",children:s.stock_quantity??0}),e.jsx("td",{className:"py-3 px-4 text-gray-700 dark:text-gray-200 font-mono",children:s.low_stock_threshold??0}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",className:"btn-outline btn-sm flex items-center gap-2",onClick:()=>oe(s),children:[e.jsx(qe,{className:"w-4 h-4"}),t("common.edit")]}),e.jsxs("button",{type:"button",className:"btn-danger btn-sm flex items-center gap-2",onClick:()=>me(s),children:[e.jsx(Ce,{className:"w-4 h-4"}),t("common.delete")]})]})})]},s.id))})]})}):e.jsx("div",{className:"p-6 text-sm text-gray-600 dark:text-gray-300",children:t("ppe.projectRequired")})}),T&&e.jsx(v,{isOpen:T,onClose:C,title:t(z?"ppe.items.edit":"ppe.items.add"),size:"lg",children:e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.items.name")}),e.jsx("input",{className:"input",value:M.name,onChange:s=>y(a=>({...a,name:s.target.value})),required:!0})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:C,children:t("common.cancel")}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:F,children:t(F?"common.saving":"common.save")})]})]})}),H&&e.jsx(v,{isOpen:H,onClose:()=>b(!1),title:t("ppe.restock.title"),size:"lg",children:e.jsxs("form",{onSubmit:async s=>{if(s.preventDefault(),!p){i.error(t("ppe.projectRequired"));return}if(!n.ppe_item_id&&!n.ppe_other.trim()){i.error(t("ppe.restock.chooseItem"));return}try{K(!0),await g.restock({project_id:Number(c),ppe_item_id:n.ppe_item_id?Number(n.ppe_item_id):void 0,ppe_name:n.ppe_item_id?void 0:n.ppe_other.trim(),quantity:Number(n.quantity??1),low_stock_threshold:String(n.low_stock_threshold??"").trim()!==""?Number(n.low_stock_threshold):void 0}),i.success(t("success.saved")),b(!1),await x()}catch(a){i.error(a.response?.data?.message??t("errors.somethingWentWrong"))}finally{K(!1)}},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.restock.item")}),e.jsxs(A,{value:n.ppe_item_id,onChange:s=>h(a=>({...a,ppe_item_id:s.target.value,ppe_other:""})),children:[e.jsx("option",{value:"",children:t("ppe.issue.other")}),_.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.stock_quantity??0,")"]},s.id))]}),!n.ppe_item_id&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"label text-xs",children:t("ppe.issue.otherSpecify")}),e.jsx("input",{className:"input",value:n.ppe_other,onChange:s=>h(a=>({...a,ppe_other:s.target.value})),placeholder:t("ppe.issue.otherPlaceholder")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.restock.quantity")}),e.jsx("input",{type:"number",min:1,className:"input",value:n.quantity,onChange:s=>h(a=>({...a,quantity:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.restock.threshold")}),e.jsx("input",{type:"number",min:0,className:"input",value:n.low_stock_threshold,onChange:s=>h(a=>({...a,low_stock_threshold:s.target.value})),placeholder:t("ppe.restock.thresholdPlaceholder")})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:()=>b(!1),children:t("common.cancel")}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:J,children:t(J?"common.saving":"ppe.restock.submit")})]})]})}),u&&e.jsx(v,{isOpen:!!u,onClose:()=>j(null),title:t("common.confirm"),size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-700 dark:text-gray-200",children:t("ppe.items.confirmDelete",{name:u.name})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:()=>j(null),children:t("common.cancel")}),e.jsx("button",{type:"button",className:"btn-danger",onClick:pe,disabled:B,children:t(B?"common.deleting":"common.delete")})]})]})}),Q&&e.jsx(v,{isOpen:Q,onClose:I,title:t("ppe.issue.title"),size:"xl",children:e.jsxs("form",{onSubmit:xe,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:t("ppe.issue.worker")}),e.jsx("input",{className:"input",value:l.worker_query,onChange:s=>o(a=>({...a,worker_query:s.target.value,worker_id:"",worker_label:""})),placeholder:t("ppe.issue.workerSearchPlaceholder")}),l.worker_query.trim()&&!l.worker_id&&e.jsx("div",{className:"mt-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 overflow-hidden",children:ne?e.jsx("div",{className:"px-3 py-2 text-xs text-gray-500",children:"..."}):Z.length===0?e.jsx("div",{className:"px-3 py-2 text-xs text-gray-500",children:t("common.noData")}):e.jsx("div",{className:"max-h-56 overflow-auto",children:Z.map(s=>e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800",onClick:()=>{o(a=>({...a,worker_id:String(s.id),worker_label:`${s.full_name}${s.cin?` (${s.cin})`:""}`,worker_query:`${s.full_name}${s.cin?` (${s.cin})`:""}`})),m([])},children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.full_name}),e.jsxs("div",{className:"text-[11px] text-gray-500 dark:text-gray-400",children:[s.cin??""," ",s.fonction?`Â· ${s.fonction}`:""]})]},s.id))})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.issue.item")}),e.jsxs(A,{value:l.ppe_item_id,onChange:s=>o(a=>({...a,ppe_item_id:s.target.value,ppe_other:""})),children:[e.jsx("option",{value:"",children:t("ppe.issue.other")}),_.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.stock_quantity??0,")"]},s.id))]}),!l.ppe_item_id&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"label text-xs",children:t("ppe.issue.otherSpecify")}),e.jsx("input",{className:"input",value:l.ppe_other,onChange:s=>o(a=>({...a,ppe_other:s.target.value})),placeholder:t("ppe.issue.otherPlaceholder")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.issue.quantity")}),e.jsx("input",{type:"number",min:1,className:"input",value:l.quantity,onChange:s=>o(a=>({...a,quantity:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.issue.receivedAt")}),e.jsx(_e,{value:l.received_at,onChange:s=>o(a=>({...a,received_at:s})),required:!0})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:I,children:t("common.cancel")}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:V,children:t(V?"common.saving":"ppe.issue.submit")})]})]})}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:t("ppe.note")})]})}export{Oe as default};

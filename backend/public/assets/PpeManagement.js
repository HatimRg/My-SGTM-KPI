import{a as he,u as ge,j as e,v as x,p as ye,w as je}from"./index.js";import{r}from"./vendor-react.js";import{M as b}from"./Modal.js";import{S as P}from"./Select.js";import{D as fe}from"./DatePicker.js";import{j as be,aK as ve,P as _e,z as i,ae as Ne,v as ke,aJ as we,aj as Se}from"./vendor-ui.js";import"./vendor-utils.js";function Ae(){const{t}=he(),{user:Z}=ge(),[ee,W]=r.useState([]),[se,D]=r.useState(!0),[c,R]=r.useState(""),[A,v]=r.useState([]),[te,E]=r.useState(!0),[_,ae]=r.useState(""),[N,re]=r.useState(""),[O,k]=r.useState(!1),[$,w]=r.useState(null),[T,z]=r.useState(!1),[F,h]=r.useState({name:""}),[m,g]=r.useState(null),[L,M]=r.useState(!1),[B,y]=r.useState(!1),[J,K]=r.useState(!1),[n,p]=r.useState({ppe_item_id:"",ppe_other:"",quantity:1,low_stock_threshold:""}),[G,H]=r.useState(!1),[Q,U]=r.useState(!1),[l,o]=r.useState({worker_query:"",worker_id:"",worker_label:"",ppe_item_id:"",ppe_other:"",quantity:1,received_at:""}),[le,V]=r.useState(!1),[X,d]=r.useState([]),j=r.useRef(0);r.useEffect(()=>{const s=setTimeout(()=>re(_.trim()),300);return()=>clearTimeout(s)},[_]),r.useEffect(()=>{(async()=>{try{D(!0);const a=await ye.getAllList({status:"active"});W(Array.isArray(a)?a:[]),!c&&Array.isArray(a)&&a.length===1&&R(String(a[0].id))}catch(a){W([]),i.error(a.response?.data?.message??t("errors.somethingWentWrong"))}finally{D(!1)}})()},[]);const u=async()=>{try{if(E(!0),!c){v([]);return}const s=await x.getItems({project_id:Number(c),search:N||void 0});v(s.data?.data??[])}catch(s){v([]),i.error(s.response?.data?.message??t("errors.somethingWentWrong"))}finally{E(!1)}};r.useEffect(()=>{u()},[N,c]);const ie=()=>{w(null),h({name:""}),k(!0)},ne=s=>{w(s),h({name:s?.name??""}),k(!0)},S=()=>{k(!1),w(null),h({name:""})},ce=async s=>{s.preventDefault();try{z(!0);const a={id:$?.id,name:F.name};await x.upsertItem(a),i.success(t("success.saved")),S(),await u()}catch(a){i.error(a.response?.data?.message??t("errors.somethingWentWrong"))}finally{z(!1)}},oe=s=>{g(s)},de=async()=>{if(m)try{M(!0),await x.deleteItem(m.id),i.success(t("success.deleted")),g(null),await u()}catch(s){i.error(s.response?.data?.message??t("errors.somethingWentWrong"))}finally{M(!1)}},me=()=>{if(!c){i.error(t("ppe.projectRequired"));return}H(!0),o({worker_query:"",worker_id:"",worker_label:"",ppe_item_id:"",ppe_other:"",quantity:1,received_at:""}),d([])},q=()=>{H(!1),o({worker_query:"",worker_id:"",worker_label:"",ppe_item_id:"",ppe_other:"",quantity:1,received_at:""}),d([])},pe=async s=>{const a=String(s??"").trim();if(!a){d([]);return}const I=++j.current;try{V(!0);const xe=await je.getAll({search:a,project_id:c?Number(c):void 0,is_active:!0,per_page:10});if(I!==j.current)return;const Y=xe.data?.data?.data??[];d(Array.isArray(Y)?Y:[])}catch{if(I!==j.current)return;d([])}finally{I===j.current&&V(!1)}};r.useEffect(()=>{const s=setTimeout(()=>{pe(l.worker_query)},350);return()=>clearTimeout(s)},[l.worker_query]);const ue=async s=>{if(s.preventDefault(),!l.worker_id){i.error(t("ppe.issue.chooseWorker"));return}if(!l.ppe_item_id&&!l.ppe_other.trim()){i.error(t("ppe.issue.chooseItem"));return}try{U(!0);const a={worker_id:Number(l.worker_id),ppe_item_id:l.ppe_item_id?Number(l.ppe_item_id):void 0,ppe_name:l.ppe_item_id?void 0:l.ppe_other.trim(),quantity:Number(l.quantity??1),received_at:l.received_at};await x.issueToWorker(a),i.success(t("ppe.issue.success")),q(),await u()}catch(a){i.error(a.response?.data?.message??t("errors.somethingWentWrong"))}finally{U(!1)}},C=!!Z,f=r.useMemo(()=>[...A].sort((s,a)=>String(s.name??"").localeCompare(String(a.name??""))),[A]);return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5 text-hse-primary"}),e.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:t("ppe.title")})]}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1",children:t("ppe.subtitle")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",className:"btn-outline btn-sm flex items-center gap-2",onClick:me,disabled:!C,children:[e.jsx(ve,{className:"w-4 h-4"}),t("ppe.issue.button")]}),e.jsxs("button",{type:"button",className:"btn-primary btn-sm flex items-center gap-2",onClick:ie,disabled:!C,children:[e.jsx(_e,{className:"w-4 h-4"}),t("ppe.items.add")]})]})]})}),e.jsx("div",{className:"card p-3",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-2",children:[e.jsxs("div",{className:"w-full md:max-w-md",children:[e.jsx("label",{className:"label text-xs",children:t("ppe.project")}),e.jsxs(P,{value:c,onChange:s=>R(s.target.value),disabled:se,children:[e.jsx("option",{value:"",children:t("common.select")}),ee.map(s=>e.jsx("option",{value:s.id,children:s.code?`${s.code} - ${s.name}`:s.name},s.id))]})]}),e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx("button",{type:"button",className:"btn-outline btn-sm",onClick:()=>{if(!c){i.error(t("ppe.projectRequired"));return}p({ppe_item_id:"",ppe_other:"",quantity:1,low_stock_threshold:""}),y(!0)},disabled:!C,children:t("ppe.restock.button")})})]})}),e.jsx("div",{className:"card p-3 overflow-visible",children:e.jsx("div",{className:"flex flex-col md:flex-row md:items-center gap-2",children:e.jsxs("div",{className:"relative w-full md:max-w-md",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{className:"input pl-9 py-1.5 text-sm",value:_,onChange:s=>ae(s.target.value),placeholder:t("common.search")})]})})}),e.jsx("div",{className:"card overflow-hidden",children:c?te?e.jsx("div",{className:"p-6 flex items-center justify-center",children:e.jsx(ke,{className:"w-6 h-6 animate-spin text-hse-primary"})}):f.length===0?e.jsx("div",{className:"p-6 text-sm text-gray-600 dark:text-gray-300",children:t("common.noData")}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsx("th",{className:"py-3 px-4 font-medium text-gray-500 dark:text-gray-400",children:t("ppe.items.name")}),e.jsx("th",{className:"py-3 px-4 font-medium text-gray-500 dark:text-gray-400",children:t("ppe.items.stock")}),e.jsx("th",{className:"py-3 px-4 font-medium text-gray-500 dark:text-gray-400",children:t("ppe.items.threshold")}),e.jsx("th",{className:"py-3 px-4 font-medium text-gray-500 dark:text-gray-400",children:t("common.actions")})]})}),e.jsx("tbody",{children:f.map(s=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsx("td",{className:"py-3 px-4 text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("td",{className:"py-3 px-4 text-gray-700 dark:text-gray-200 font-mono",children:s.stock_quantity??0}),e.jsx("td",{className:"py-3 px-4 text-gray-700 dark:text-gray-200 font-mono",children:s.low_stock_threshold??0}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",className:"btn-outline btn-sm flex items-center gap-2",onClick:()=>ne(s),children:[e.jsx(we,{className:"w-4 h-4"}),t("common.edit")]}),e.jsxs("button",{type:"button",className:"btn-danger btn-sm flex items-center gap-2",onClick:()=>oe(s),children:[e.jsx(Se,{className:"w-4 h-4"}),t("common.delete")]})]})})]},s.id))})]})}):e.jsx("div",{className:"p-6 text-sm text-gray-600 dark:text-gray-300",children:t("ppe.projectRequired")})}),O&&e.jsx(b,{isOpen:O,onClose:S,title:t($?"ppe.items.edit":"ppe.items.add"),size:"lg",children:e.jsxs("form",{onSubmit:ce,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.items.name")}),e.jsx("input",{className:"input",value:F.name,onChange:s=>h(a=>({...a,name:s.target.value})),required:!0})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:S,children:t("common.cancel")}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:T,children:t(T?"common.saving":"common.save")})]})]})}),B&&e.jsx(b,{isOpen:B,onClose:()=>y(!1),title:t("ppe.restock.title"),size:"lg",children:e.jsxs("form",{onSubmit:async s=>{if(s.preventDefault(),!c){i.error(t("ppe.projectRequired"));return}if(!n.ppe_item_id&&!n.ppe_other.trim()){i.error(t("ppe.restock.chooseItem"));return}try{K(!0),await x.restock({project_id:Number(c),ppe_item_id:n.ppe_item_id?Number(n.ppe_item_id):void 0,ppe_name:n.ppe_item_id?void 0:n.ppe_other.trim(),quantity:Number(n.quantity??1),low_stock_threshold:String(n.low_stock_threshold??"").trim()!==""?Number(n.low_stock_threshold):void 0}),i.success(t("success.saved")),y(!1),await u()}catch(a){i.error(a.response?.data?.message??t("errors.somethingWentWrong"))}finally{K(!1)}},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.restock.item")}),e.jsxs(P,{value:n.ppe_item_id,onChange:s=>p(a=>({...a,ppe_item_id:s.target.value,ppe_other:""})),children:[e.jsx("option",{value:"",children:t("ppe.issue.other")}),f.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.stock_quantity??0,")"]},s.id))]}),!n.ppe_item_id&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"label text-xs",children:t("ppe.issue.otherSpecify")}),e.jsx("input",{className:"input",value:n.ppe_other,onChange:s=>p(a=>({...a,ppe_other:s.target.value})),placeholder:t("ppe.issue.otherPlaceholder")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.restock.quantity")}),e.jsx("input",{type:"number",min:1,className:"input",value:n.quantity,onChange:s=>p(a=>({...a,quantity:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.restock.threshold")}),e.jsx("input",{type:"number",min:0,className:"input",value:n.low_stock_threshold,onChange:s=>p(a=>({...a,low_stock_threshold:s.target.value})),placeholder:t("ppe.restock.thresholdPlaceholder")})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:()=>y(!1),children:t("common.cancel")}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:J,children:t(J?"common.saving":"ppe.restock.submit")})]})]})}),m&&e.jsx(b,{isOpen:!!m,onClose:()=>g(null),title:t("common.confirm"),size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-700 dark:text-gray-200",children:t("ppe.items.confirmDelete",{name:m.name})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:()=>g(null),children:t("common.cancel")}),e.jsx("button",{type:"button",className:"btn-danger",onClick:de,disabled:L,children:t(L?"common.deleting":"common.delete")})]})]})}),G&&e.jsx(b,{isOpen:G,onClose:q,title:t("ppe.issue.title"),size:"xl",children:e.jsxs("form",{onSubmit:ue,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:t("ppe.issue.worker")}),e.jsx("input",{className:"input",value:l.worker_query,onChange:s=>o(a=>({...a,worker_query:s.target.value,worker_id:"",worker_label:""})),placeholder:t("ppe.issue.workerSearchPlaceholder")}),l.worker_query.trim()&&!l.worker_id&&e.jsx("div",{className:"mt-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 overflow-hidden",children:le?e.jsx("div",{className:"px-3 py-2 text-xs text-gray-500",children:"..."}):X.length===0?e.jsx("div",{className:"px-3 py-2 text-xs text-gray-500",children:t("common.noData")}):e.jsx("div",{className:"max-h-56 overflow-auto",children:X.map(s=>e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800",onClick:()=>{o(a=>({...a,worker_id:String(s.id),worker_label:`${s.full_name}${s.cin?` (${s.cin})`:""}`,worker_query:`${s.full_name}${s.cin?` (${s.cin})`:""}`})),d([])},children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.full_name}),e.jsxs("div",{className:"text-[11px] text-gray-500 dark:text-gray-400",children:[s.cin??""," ",s.fonction?`Â· ${s.fonction}`:""]})]},s.id))})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.issue.item")}),e.jsxs(P,{value:l.ppe_item_id,onChange:s=>o(a=>({...a,ppe_item_id:s.target.value,ppe_other:""})),children:[e.jsx("option",{value:"",children:t("ppe.issue.other")}),f.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.stock_quantity??0,")"]},s.id))]}),!l.ppe_item_id&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"label text-xs",children:t("ppe.issue.otherSpecify")}),e.jsx("input",{className:"input",value:l.ppe_other,onChange:s=>o(a=>({...a,ppe_other:s.target.value})),placeholder:t("ppe.issue.otherPlaceholder")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.issue.quantity")}),e.jsx("input",{type:"number",min:1,className:"input",value:l.quantity,onChange:s=>o(a=>({...a,quantity:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("ppe.issue.receivedAt")}),e.jsx(fe,{value:l.received_at,onChange:s=>o(a=>({...a,received_at:s})),required:!0})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:q,children:t("common.cancel")}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:Q,children:t(Q?"common.saving":"ppe.issue.submit")})]})]})}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:t("ppe.note")})]})}export{Ae as default};

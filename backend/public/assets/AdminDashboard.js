import{d as we,j as e,p as va,e as le,u as ka,f as Qe,g as Na,h as ia}from"./index.js";import{r as t,u as wa,L as _a}from"./vendor-react.js";import{a9 as Sa,a3 as ma,j as Ye,$ as Ze,p as Ca,A as Ie,aa as Ta,ab as aa,ac as oa,Y as Ve,ad as ha,U as Be,V as Ma,ae as Aa,af as $a,z as De,ag as Ra,ah as Ka,ai as Pa,aj as Da,ak as Ia,al as za,am as Fa,an as La,ao as Wa,a0 as Ba,ap as Ua,aq as Ea,ar as la,F as Ha,T as Oa,as as Ga,at as qa}from"./vendor-ui.js";import{R as L,B as xe,C as G,X as q,Y as B,T as W,L as de,a as H,b as ta,c as fe,S as Ya,d as xa,Z as ga,e as ua,A as Xe,f as ze,P as ba,g as pa,h as $e,i as sa,j as ea,k as Va}from"./vendor-charts.js";import{g as Pe,a as Za}from"./weekHelper.js";import{s as Xa,g as da}from"./projectList.js";import"./vendor-utils.js";const Ja=[{id:"overview",nameKey:"dashboard.themes.overview",icon:Sa,gradient:"from-purple-500 to-purple-700"},{id:"safety",nameKey:"dashboard.themes.safety",icon:ma,gradient:"from-red-500 to-red-700"},{id:"training",nameKey:"dashboard.themes.training",icon:Ye,gradient:"from-blue-500 to-blue-700"},{id:"compliance",nameKey:"dashboard.themes.compliance",icon:Ze,gradient:"from-green-500 to-green-700"},{id:"ppe",nameKey:"dashboard.themes.ppe",icon:Ca,gradient:"from-slate-500 to-slate-700"},{id:"deviations",nameKey:"dashboard.themes.deviations",icon:Ie,gradient:"from-amber-500 to-amber-700"},{id:"environmental",nameKey:"dashboard.themes.environmental",icon:Ta,gradient:"from-emerald-500 to-emerald-700"}],Qa=t.memo(function({activeTheme:b,onThemeChange:l}){const x=we();return e.jsx("div",{className:"relative mb-4",children:e.jsx("div",{className:"flex items-center justify-center gap-1 flex-wrap",children:Ja.map(o=>{const y=o.icon,s=b===o.id;return e.jsxs("button",{onClick:()=>l(o.id),className:`flex items-center gap-1.5 px-3 py-2 rounded-lg border transition-all duration-200 ${s?`bg-gradient-to-r ${o.gradient} text-white border-transparent shadow-md`:"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600 hover:shadow-sm"}`,children:[e.jsx(y,{className:`w-4 h-4 ${s?"text-white":""}`}),e.jsx("span",{className:`font-medium text-xs ${s?"text-white":""}`,children:x(o.nameKey)})]},o.id)})})})}),Me={fatal:"#dc2626",serious:"#f59e0b",minor:"#16a34a",tf:"#f59e0b",tg:"#8b5cf6"},Ne=t.memo(function({title:b,value:l,icon:x,color:o,trend:y}){const s={red:"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/50 text-red-600 dark:text-red-400",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[o]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:b})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:l}),y&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:y})]})}),et=t.memo(function({kpiSummary:b,weeklyTrends:l,projectPerformance:x,safetyPerformance:o,safetyLoading:y}){const s=we(),C=!!o?.kpis,T=t.useMemo(()=>{const m=o?.kpis||{};return{totalEvents:m.total_events??0,severityWeightedIndex:m.severity_weighted_index??0,pctSevere:m.pct_severe??0,totalVictims:m.total_victims??0,totalFatalities:m.total_fatalities??0,pctActionsOverdue:m.pct_actions_overdue??0,worstProject:m.worst_project??null,worstLocation:m.worst_location??null,topActivity:m.top_activity??null,topRootCause:m.top_root_cause??null}},[o]),g=t.useMemo(()=>o?.charts||{},[o]),p=t.useMemo(()=>{const m=g?.project_hotspots;return Array.isArray(m)?m.slice(0,10):[]},[g]),U=t.useMemo(()=>{const m=g?.activity_driver;return Array.isArray(m)?m.slice(0,10):[]},[g]),M=t.useMemo(()=>{const m=g?.conditions_matrix||{},z=Array.isArray(m.data)?m.data:[],D=Array.isArray(m.rows)?m.rows:[],Z=Array.isArray(m.cols)?m.cols:[],R=z.reduce((me,Q)=>Math.max(me,Number(Q?.value??0)),0);return{rows:D,cols:Z,data:z,max:R}},[g]),te=t.useMemo(()=>{const m=g?.cause_path||{},z=Array.isArray(m.nodes)?m.nodes:[],D=Array.isArray(m.links)?m.links:[];return{nodes:z,links:D}},[g]),d=t.useMemo(()=>{const m=g?.severity_vs_victims;return Array.isArray(m)?m.map(z=>({severity:Number(z?.severity_score??0),victims:Number(z?.victims??0),events:Number(z?.events??0),activity:z?.activity??"Unknown"})):[]},[g]),_=t.useMemo(()=>{const m=g?.actions_health;return Array.isArray(m)?m.slice(0,10):[]},[g]),K=t.useMemo(()=>({totalAccidents:b?.total_accidents??0,fatalAccidents:b?.fatal_accidents??0,avgTF:Number(b?.avg_tf??0).toFixed(2),avgTG:Number(b?.avg_tg??0).toFixed(2),lostWorkdays:b?.lost_workdays??0}),[b]),ce=t.useMemo(()=>(l??[]).map(m=>({week:m.week_label,accidents:m.accidents??0})),[l]),O=t.useMemo(()=>{K.totalAccidents;const m=K.fatalAccidents,z=b?.serious_accidents,D=b?.minor_accidents,Z=z!=null&&D!==null&&D!==void 0,R=Z?Number(z??0):(l??[]).reduce((Q,I)=>Q+Number(I?.serious_accidents??0),0),me=Z?Number(D??0):(l??[]).reduce((Q,I)=>Q+Number(I?.minor_accidents??0),0);return[{name:s("dashboard.safety.fatal"),value:Number(m??0),color:Me.fatal},{name:s("dashboard.safety.serious"),value:Number(R??0),color:Me.serious},{name:s("dashboard.safety.minor"),value:Number(me??0),color:Me.minor}].filter(Q=>Q.value>0)},[K,s,b,l]),ge=t.useMemo(()=>(l??[]).map(m=>({week:m.week_label,tf:Number(m.tf??0).toFixed(4),tg:Number(m.tg??0).toFixed(4)})),[l]),J=t.useMemo(()=>(x??[]).slice(0,6).map(m=>({name:m.name?.length>15?m.name.substring(0,15)+"...":m.name,accidents:m.total_accidents??0})),[x]),re=t.memo(function({data:z,rows:D,cols:Z,max:R}){const me=(I,X)=>{const c=(z||[]).find(j=>j.ground_condition===I&&j.lighting===X);return Number(c?.value??0)},Q=I=>!R||R<=0?"rgba(220,38,38,0.05)":`rgba(220,38,38,${.08+Math.max(0,Math.min(1,I/R))*.85})`;return e.jsx("div",{className:"w-full overflow-auto",children:e.jsx("div",{className:"min-w-[640px]",children:e.jsxs("div",{className:"grid",style:{gridTemplateColumns:`160px repeat(${Z.length}, minmax(80px, 1fr))`},children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 dark:text-gray-300 p-2",children:s("dashboard.safety.lighting")||"Lighting"}),Z.map(I=>e.jsx("div",{className:"text-xs font-medium text-gray-600 dark:text-gray-300 p-2 text-center truncate",title:I,children:I},I)),D.map(I=>e.jsxs("div",{className:"contents",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700 dark:text-gray-200 p-2 truncate",title:I,children:I}),Z.map(X=>{const c=me(I,X);return e.jsxs("div",{className:"p-2 border border-gray-100 dark:border-gray-800",title:`${I} / ${X}: ${c}`,children:[e.jsx("div",{className:"w-full h-8 rounded",style:{background:Q(c)}}),e.jsx("div",{className:"text-[11px] text-gray-600 dark:text-gray-300 mt-1 text-center",children:c})]},`${I}|${X}`)})]},I))]})})})});return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[y&&!C&&e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 dark:text-gray-300",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600 dark:border-gray-300"}),e.jsx("span",{className:"text-sm",children:s("common.loading")||"Loading..."})]})})}),C&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Ne,{title:s("dashboard.safety.totalEvents")||"Total events",value:T.totalEvents,icon:Ie,color:T.totalEvents>0?"amber":"green",trend:s("dashboard.safety.yearToDate")||"Year-to-date"}),e.jsx(Ne,{title:s("dashboard.safety.severityWeightedIndex")||"Severity-weighted index",value:T.severityWeightedIndex,icon:aa,color:T.severityWeightedIndex>0?"red":"green",trend:T.worstProject?`${s("dashboard.safety.worstProject")||"Worst project"}: ${T.worstProject.project_name}`:null}),e.jsx(Ne,{title:s("dashboard.safety.severeShare")||"Severe share",value:`${Number(T.pctSevere??0).toFixed(1)}%`,icon:oa,color:T.pctSevere>0?"red":"green",trend:T.totalFatalities>0?`${s("dashboard.safety.fatalAccidents")||"Fatalities"}: ${T.totalFatalities}`:s("dashboard.safety.noFatalities")||"No fatalities"}),e.jsx(Ne,{title:s("dashboard.safety.actionsOverdue")||"Actions overdue",value:`${Number(T.pctActionsOverdue??0).toFixed(1)}%`,icon:Ve,color:T.pctActionsOverdue>0?"amber":"green",trend:T.worstLocation?`${s("dashboard.safety.worstLocation")||"Worst location"}: ${T.worstLocation.location}`:null})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.projectHotspots")||"Project Hotspots (severity-weighted)"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:p,layout:"vertical",children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"project_name",tick:{fontSize:10},width:120}),e.jsx(W,{}),e.jsx(de,{}),e.jsx(H,{dataKey:"fatal",stackId:"a",fill:"#dc2626",name:"fatal"}),e.jsx(H,{dataKey:"serious",stackId:"a",fill:"#f59e0b",name:"serious"}),e.jsx(H,{dataKey:"lta",stackId:"a",fill:"#8b5cf6",name:"lta"}),e.jsx(H,{dataKey:"medical",stackId:"a",fill:"#3b82f6",name:"medical"}),e.jsx(H,{dataKey:"first_aid",stackId:"a",fill:"#16a34a",name:"first_aid"}),e.jsx(H,{dataKey:"near_miss",stackId:"a",fill:"#14b8a6",name:"near_miss"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.activityDriver")||"Activity Driver (Pareto)"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(ta,{data:U,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"activity",tick:{fontSize:10},interval:0,angle:-20,textAnchor:"end",height:60}),e.jsx(B,{yAxisId:"left",allowDecimals:!1,tick:{fontSize:11}}),e.jsx(B,{yAxisId:"right",orientation:"right",domain:[0,100],tick:{fontSize:11}}),e.jsx(W,{}),e.jsx(de,{}),e.jsx(H,{yAxisId:"left",dataKey:"count",fill:"#dc2626",name:"count"}),e.jsx(fe,{yAxisId:"right",type:"monotone",dataKey:"cumulative_pct",stroke:"#3b82f6",strokeWidth:2,dot:{r:3},name:"cumulative %"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.conditionsMatrix")||"Conditions Matrix (severity-weighted)"})}),e.jsx("div",{className:"card-body",children:e.jsx(re,{data:M.data,rows:M.rows,cols:M.cols,max:M.max})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.causePath")||"Cause Path (Immediate → Root)"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:te.nodes.length>0&&te.links.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsx(Ya,{data:te,nodePadding:18,linkCurvature:.6,node:{stroke:"#e5e7eb",strokeWidth:1},children:e.jsx(W,{})})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-400 text-sm",children:s("common.noData")||"No data available"})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.severityVsVictims")||"Severity vs Victims (bubble)"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xa,{children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",dataKey:"severity",name:"severity",domain:[1,6],tick:{fontSize:11}}),e.jsx(B,{type:"number",dataKey:"victims",name:"victims",allowDecimals:!1,tick:{fontSize:11}}),e.jsx(ga,{type:"number",dataKey:"events",range:[80,600],name:"events"}),e.jsx(W,{cursor:{strokeDasharray:"3 3"}}),e.jsx(de,{}),e.jsx(ua,{name:"events",data:d,fill:"#dc2626"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.actionsHealth")||"Actions Health"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:_,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"type",tick:{fontSize:10},interval:0,angle:-20,textAnchor:"end",height:60}),e.jsx(B,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(W,{}),e.jsx(de,{}),e.jsx(H,{dataKey:"overdue",stackId:"a",fill:"#f59e0b",name:"overdue"}),e.jsx(H,{dataKey:"open",stackId:"a",fill:"#dc2626",name:"open"}),e.jsx(H,{dataKey:"in_progress",stackId:"a",fill:"#3b82f6",name:"in_progress"}),e.jsx(H,{dataKey:"closed",stackId:"a",fill:"#16a34a",name:"closed"})]})})})})]})]})]}),!C&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Ne,{title:s("dashboard.safety.totalAccidents"),value:K.totalAccidents,icon:Ie,color:K.totalAccidents>0?"red":"green",trend:s("dashboard.safety.yearToDate")}),e.jsx(Ne,{title:s("dashboard.safety.fatalAccidents"),value:K.fatalAccidents,icon:oa,color:K.fatalAccidents>0?"red":"green",trend:K.fatalAccidents===0?s("dashboard.safety.noFatalities"):s("dashboard.safety.critical")}),e.jsx(Ne,{title:s("dashboard.safety.tfRate"),value:K.avgTF,icon:aa,color:"amber",trend:s("dashboard.safety.avgFrequencyRate")}),e.jsx(Ne,{title:s("dashboard.safety.tgRate"),value:K.avgTG,icon:ha,color:"purple",trend:s("dashboard.safety.avgSeverityRate")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.accidentTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(Xe,{data:ce,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"accidentGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#dc2626",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#dc2626",stopOpacity:.1})]})}),e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week",tick:{fontSize:11}}),e.jsx(B,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(ze,{type:"monotone",dataKey:"accidents",stroke:"#dc2626",fill:"url(#accidentGradient)",name:"Accidents"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.accidentsBySeverity")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:O.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(ba,{children:[e.jsx(pa,{data:O,cx:"50%",cy:"50%",innerRadius:50,outerRadius:80,paddingAngle:5,dataKey:"value",label:({name:m,value:z})=>`${m}: ${z}`,children:O.map((m,z)=>e.jsx($e,{fill:m.color},`cell-${z}`))}),e.jsx(W,{}),e.jsx(de,{})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-green-600 dark:text-green-400",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ie,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"font-medium",children:s("dashboard.safety.noAccidents")}),e.jsx("p",{className:"text-sm text-gray-500",children:s("dashboard.safety.greatSafety")})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.tfVsTg")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(sa,{data:ge,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week",tick:{fontSize:11}}),e.jsx(B,{tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(de,{}),e.jsx(fe,{type:"monotone",dataKey:"tf",stroke:Me.tf,strokeWidth:2,dot:{fill:Me.tf,r:3},name:"TF Rate"}),e.jsx(fe,{type:"monotone",dataKey:"tg",stroke:Me.tg,strokeWidth:2,dot:{fill:Me.tg,r:3},name:"TG Rate"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.safety.accidentsByProject")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:J,layout:"vertical",children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",allowDecimals:!1,tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"name",tick:{fontSize:10},width:100}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(H,{dataKey:"accidents",fill:"#dc2626",radius:[0,4,4,0],name:"Accidents"})]})})})})]})]})]})]})}),Ae=t.memo(function({title:b,value:l,icon:x,color:o,trend:y}){const s={blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[o]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:b})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:l}),y&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:y})]})}),at=t.memo(function({kpiSummary:b,weeklyTrends:l,projectPerformance:x,trainingData:o,awarenessData:y}){const s=we(),C=t.useMemo(()=>{const d=o?.total??b?.total_trainings??0,_=o?.total_participants??b?.employees_trained??0,K=o?.total_hours??b?.total_training_hours??b?.training_hours??0,ce=b?.total_trainings_planned??0,O=ce>0?Math.round(d/ce*100):null;return{totalTrainings:d,employeesTrained:_,trainingHours:K,completionRate:O}},[b,o]),T=t.useMemo(()=>({totalSessions:y?.total??0,totalParticipants:y?.total_participants??0,totalHours:y?.total_hours??0}),[y]),g=t.useMemo(()=>o?.by_week?.length>0?o.by_week.map(d=>({week:"S"+d.week_number,trainings:d.count??0,participants:d.participants??0})):(l??[]).map(d=>({week:d.week_label,trainings:d.trainings??0})),[l,o]),p=t.useMemo(()=>{if(o?.by_theme?.length>0){const d=["#3b82f6","#8b5cf6","#ec4899","#14b8a6","#f59e0b","#ef4444","#10b981","#6366f1"];return o.by_theme.slice(0,8).map((_,K)=>({name:_.theme?.length>20?_.theme.substring(0,20)+"...":_.theme,fullName:_.theme,value:_.count,participants:_.participants??0,color:d[K%d.length]}))}return[]},[o]),U=t.useMemo(()=>o?.by_duration?.length>0?o.by_duration.map(d=>({duration:d.duration,count:d.count,participants:d.participants??0})):[],[o]),M=t.useMemo(()=>{if(y?.by_theme?.length>0){const d=["#16a34a","#0ea5e9","#f97316","#a855f7","#eab308","#06b6d4","#84cc16","#d946ef"];return y.by_theme.slice(0,8).map((_,K)=>({name:_.theme?.length>20?_.theme.substring(0,20)+"...":_.theme,fullName:_.theme,value:_.count,participants:_.participants??0,color:d[K%d.length]}))}return[]},[y]),te=t.useMemo(()=>o?.by_type?.length>0?o.by_type.map(d=>({name:d.type==="internal"?s("dashboard.training.internal"):s("dashboard.training.external"),value:d.count,color:d.type==="internal"?"#3b82f6":"#8b5cf6"})):[],[o,s]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Ae,{title:s("dashboard.training.totalTrainings"),value:C.totalTrainings,icon:Ye,color:"blue",trend:s("dashboard.training.sessionsCompleted")}),e.jsx(Ae,{title:s("dashboard.training.employeesTrained"),value:C.employeesTrained,icon:Be,color:"green",trend:s("dashboard.training.uniqueAttendees")}),e.jsx(Ae,{title:s("dashboard.training.trainingHours"),value:C.trainingHours,icon:Ve,color:"purple",trend:s("dashboard.training.totalHoursDelivered")}),e.jsx(Ae,{title:s("dashboard.training.completionRate"),value:C.completionRate!==null?`${C.completionRate}%`:"—",icon:Ma,color:"amber",trend:`${s("dashboard.training.target")}: 95%`})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.trainingTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(Xe,{data:g,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"trainingGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#3b82f6",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#3b82f6",stopOpacity:.1})]})}),e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week",tick:{fontSize:11}}),e.jsx(B,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(ze,{type:"monotone",dataKey:"trainings",stroke:"#3b82f6",fill:"url(#trainingGradient)",name:"Trainings"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.trainingByTheme")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:p.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:p,layout:"vertical",margin:{left:10,right:20},children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",allowDecimals:!1,tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"name",tick:{fontSize:10},width:120}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:(d,_,K)=>[`${d} sessions (${K.payload.participants} participants)`,"Count"]}),e.jsx(H,{dataKey:"value",radius:[0,4,4,0],children:p.map((d,_)=>e.jsx($e,{fill:d.color},`cell-${_}`))})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ye,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"font-medium",children:s("dashboard.training.noTrainingData")})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.trainingByDuration")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:U.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:U,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"duration",tick:{fontSize:11}}),e.jsx(B,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:(d,_)=>[d,_==="count"?"Sessions":"Participants"]}),e.jsx(H,{dataKey:"count",fill:"#8b5cf6",radius:[4,4,0,0],name:"Sessions"})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsx("p",{className:"font-medium",children:s("dashboard.training.noTrainingData")})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.awarenessByTheme")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:M.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:M,layout:"vertical",margin:{left:10,right:20},children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",allowDecimals:!1,tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"name",tick:{fontSize:10},width:120}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:(d,_,K)=>[`${d} sessions (${K.payload.participants} participants)`,"Count"]}),e.jsx(H,{dataKey:"value",radius:[0,4,4,0],children:M.map((d,_)=>e.jsx($e,{fill:d.color},`cell-${_}`))})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsx("p",{className:"font-medium",children:s("dashboard.training.noTrainingData")})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.trainingByType")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:te.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(ba,{children:[e.jsx(pa,{data:te,cx:"50%",cy:"45%",innerRadius:40,outerRadius:70,paddingAngle:5,dataKey:"value",label:({value:d})=>d,labelLine:!1,children:te.map((d,_)=>e.jsx($e,{fill:d.color},`cell-${_}`))}),e.jsx(W,{formatter:(d,_)=>[d,_]}),e.jsx(de,{verticalAlign:"bottom",height:36,formatter:d=>e.jsx("span",{className:"text-sm",children:d})})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsx("p",{className:"font-medium",children:s("dashboard.training.noTrainingData")})})})})]})]}),T.totalSessions>0&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsx(Ae,{title:s("dashboard.training.totalAwareness"),value:T.totalSessions,icon:Be,color:"green",trend:`${T.totalParticipants} participants`}),e.jsx(Ae,{title:s("dashboard.training.awarenessParticipants"),value:T.totalParticipants,icon:Be,color:"purple"}),e.jsx(Ae,{title:s("dashboard.training.awarenessHours"),value:Math.round(T.totalHours??0),icon:Ve,color:"amber"})]})]})}),tt={compliance:"#16a34a"},Ee=t.memo(function({title:b,value:l,icon:x,color:o,trend:y}){const s={green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[o]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:b})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:l}),y&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:y})]})}),st=t.memo(function({kpiSummary:b,weeklyTrends:l,projectPerformance:x,inspectionData:o,sorData:y,regulatoryWatch:s}){const C=we(),T=t.useMemo(()=>{const U=b?.total_inspections??0,M=Number(s?.avg_overall_score??0).toFixed(1),te=Number(b?.avg_medical_compliance??0).toFixed(1),d=y?.stats?.total??0,_=y?.stats?.closed??0,K=d>0?Math.round(_/d*100):null;return{totalInspections:U,hseCompliance:M,medicalCompliance:te,auditScore:K}},[b,y,s]),g=t.useMemo(()=>(l??[]).map(U=>({week:U.week_label,inspections:U.inspections??0})),[l]),p=t.useMemo(()=>(y?.by_category??[]).map(U=>({category:U.label??U.category,count:U.count??0})),[y]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Ee,{title:C("dashboard.compliance.totalInspections"),value:T.totalInspections,icon:Ze,color:"green",trend:C("dashboard.compliance.completedThisYear")}),e.jsx(Ee,{title:C("dashboard.compliance.hseCompliance"),value:`${T.hseCompliance}%`,icon:ma,color:"blue",trend:C("dashboard.compliance.avgScore")}),e.jsx(Ee,{title:C("dashboard.compliance.medicalCompliance"),value:`${T.medicalCompliance}%`,icon:Aa,color:"purple",trend:C("dashboard.compliance.healthChecks")}),T.auditScore!==null&&e.jsx(Ee,{title:C("dashboard.compliance.auditScore"),value:`${T.auditScore}%`,icon:$a,color:"amber",trend:C("dashboard.compliance.latestAudit")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:C("dashboard.compliance.inspectionTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(Xe,{data:g,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"complianceGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#16a34a",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#16a34a",stopOpacity:.1})]})}),e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week",tick:{fontSize:11}}),e.jsx(B,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(ze,{type:"monotone",dataKey:"inspections",stroke:"#16a34a",fill:"url(#complianceGradient)",name:"Inspections"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:C("dashboard.compliance.auditFindings")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:p,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"category",tick:{fontSize:11}}),e.jsx(B,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(H,{dataKey:"count",fill:tt.compliance,name:C("dashboard.compliance.findings"),radius:[4,4,0,0]})]})})})})]})]})]})}),ca=["#3b82f6","#22c55e","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#ec4899","#14b8a6","#f97316","#84cc16","#0ea5e9","#a855f7"],rt=t.memo(function({active:b,payload:l,label:x,t:o,poleLabelByKey:y}){if(!b||!l||l.length===0)return null;const s=l[0],C=String(s?.dataKey??""),T=C.includes("__p_")?C.split("__p_")[0]:"",g=y?.[T]??"",p=g?`${x} • ${g}`:x,U=l.filter(M=>Number(M?.value??0)>0);return e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-3 shadow-lg",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm mb-2",children:p}),e.jsx("div",{className:"space-y-1",children:U.map(M=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"inline-block w-2.5 h-2.5 rounded",style:{backgroundColor:M.color}}),e.jsx("span",{className:"text-xs text-gray-700 dark:text-gray-200",children:M.name})]}),e.jsx("span",{className:"text-xs font-semibold text-gray-900 dark:text-gray-100",children:M.value})]},M.dataKey))}),e.jsx("p",{className:"mt-2 text-[11px] text-gray-500 dark:text-gray-400",children:o("ppe.analytics.tooltipHint")})]})}),nt=t.memo(function({year:b,projectId:l,pole:x}){const o=we(),y=c=>String(c??"").trim().toLowerCase().replace(/[^a-z0-9]+/g,"_")||"unknown",[s,C]=t.useState(!0),[T,g]=t.useState([]),[p,U]=t.useState([]),[M,te]=t.useState("year"),[d,_]=t.useState(()=>new Date().getMonth()+1),[K,ce]=t.useState(""),[O,ge]=t.useState([]);t.useEffect(()=>{(async()=>{try{const j=await va.getItems(),k=j.data?.data??j.data??[],w=Array.isArray(k)?k:[];g(w),U(w.map(ee=>ee.id))}catch{g([]),U([])}})()},[]),t.useEffect(()=>{const c=async()=>{try{C(!0);const j={year:b,duration:M,item_ids:p};x&&(j.pole=x),l&&l!=="all"&&(j.project_id=l),M==="month"&&(j.month=d),M==="week"&&(j.week=K);const w=(await le.getPpeConsumptionAnalytics(j)).data?.data?.rows??[];ge(Array.isArray(w)?w:[])}catch{De.error(o("errors.failedToLoad")),ge([])}finally{C(!1)}};if(M==="week"&&(!K||String(K).trim()==="")){ge([]),C(!1);return}if(!p||p.length===0){ge([]),C(!1);return}c()},[b,M,d,K,p,l,x,o]);const J=t.useMemo(()=>(T??[]).map(c=>({id:c.id,name:c.name})),[T]),re=t.useMemo(()=>new Set(p.map(c=>Number(c))),[p]),m=t.useMemo(()=>!O||O.length===0?[]:O.filter(c=>re.has(Number(c.item_id))),[O,re]),z=t.useMemo(()=>{const c=new Map;for(const k of m){const w=Number(k.project_id),ee=Number(k.quantity??0);c.set(w,(c.get(w)??0)+ee)}const j=Array.from(c.entries()).map(([k,w])=>{const ee=m.find(ie=>Number(ie.project_id)===Number(k)),ne=ee?.project_code?`${ee.project_code}`:ee?.project_name??`#${k}`;return{projectId:k,total:w,name:ne}});return j.sort((k,w)=>w.total-k.total),j},[m]),D=t.useMemo(()=>{const c=new Map;return z.forEach((j,k)=>{c.set(j.projectId,ca[k%ca.length])}),c},[z]),Z=t.useMemo(()=>{const c=new Set;for(const k of m)c.add(String(k.pole??""));const j=Array.from(c.values());return j.sort((k,w)=>k.localeCompare(w)),j},[m]),R=t.useMemo(()=>{const c={};for(const j of Z)c[y(j)]=j;return c},[Z]),me=t.useMemo(()=>{const c=new Map;for(const k of m){const w=Number(k.item_id),ee=k.item_name;c.has(w)||c.set(w,{item_id:w,label:ee,item_name:ee,byPole:new Map});const ne=c.get(w),ie=String(k.pole??"");ne.byPole.has(ie)||ne.byPole.set(ie,new Map);const oe=Number(k.project_id),je=Number(k.quantity??0),ve=ne.byPole.get(ie);ve.set(oe,(ve.get(oe)??0)+je)}const j=Array.from(c.values());return j.sort((k,w)=>String(k.item_name||"").localeCompare(String(w.item_name||""))),j.map(k=>{const w={label:k.label,item_name:k.item_name};for(const[ee,ne]of k.byPole.entries()){const ie=y(ee);for(const[oe,je]of ne.entries())w[`${ie}__p_${oe}`]=je}return w})},[m]),Q=t.useMemo(()=>Z.flatMap(c=>{const j=y(c);return z.map(k=>({key:`${j}__p_${k.projectId}`,stackId:j,poleLabel:c,name:k.name,color:D.get(k.projectId)??"#3b82f6"}))}),[Z,z,D]),I=c=>{U(c?J.map(j=>j.id):[])},X=p.length>0&&p.length===J.length;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:o("ppe.analytics.title")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:o("ppe.analytics.subtitle")})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{value:M,onChange:c=>te(c.target.value),className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md px-2 py-1 text-sm",children:[e.jsx("option",{value:"year",children:o("ppe.analytics.duration.year")}),e.jsx("option",{value:"month",children:o("ppe.analytics.duration.month")}),e.jsx("option",{value:"week",children:o("ppe.analytics.duration.week")})]}),M==="month"&&e.jsx("input",{type:"number",min:1,max:12,value:d,onChange:c=>_(Number(c.target.value)),className:"w-20 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md px-2 py-1 text-sm"}),M==="week"&&e.jsx("input",{type:"number",min:1,max:52,value:K,onChange:c=>ce(c.target.value),placeholder:"1-52",className:"w-20 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md px-2 py-1 text-sm"})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:o("ppe.analytics.filters.items")}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300",children:[e.jsx("input",{type:"checkbox",checked:X,onChange:c=>I(c.target.checked)}),o("ppe.analytics.filters.selectAll")]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-40 overflow-y-auto pr-1",children:J.map(c=>{const j=re.has(Number(c.id));return e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-200",children:[e.jsx("input",{type:"checkbox",checked:j,onChange:k=>{const w=new Set(re);k.target.checked?w.add(Number(c.id)):w.delete(Number(c.id)),U(Array.from(w.values()))}}),c.name]},c.id)})})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100",children:o("ppe.analytics.chartTitle")})}),e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"h-[520px]",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:me,margin:{top:10,right:20,left:10,bottom:90},barCategoryGap:18,children:[e.jsx(G,{strokeDasharray:"3 3"}),e.jsx(q,{dataKey:"label",interval:0,angle:-45,textAnchor:"end",height:90,tick:{fontSize:11}}),e.jsx(B,{tick:{fontSize:11},width:60,label:{value:o("ppe.analytics.yAxis"),angle:-90,position:"insideLeft"}}),e.jsx(W,{shared:!1,content:c=>e.jsx(rt,{...c,t:o,poleLabelByKey:R})}),Q.map(c=>e.jsx(H,{dataKey:c.key,stackId:c.stackId,fill:c.color,name:c.name,isAnimationActive:!1},c.key))]})})}),!s&&me.length===0&&e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2",children:o("ppe.analytics.noData")}),s&&e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2",children:o("common.loading")})]})]})]})}),se={water:"#0ea5e9",electricity:"#eab308",hse:"#22c55e",medical:"#8b5cf6",training:"#f59e0b",nearMiss:"#ef4444"},He=t.memo(function({title:b,value:l,icon:x,color:o,trend:y,unit:s}){const C={blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400",yellow:"border-yellow-200 bg-yellow-50 dark:border-yellow-700 dark:bg-yellow-900/50 text-yellow-600 dark:text-yellow-400",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${C[o]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:b})]}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:[l,e.jsx("span",{className:"text-sm font-normal ml-1",children:s})]}),y&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:y})]})}),it=t.memo(function({kpiSummary:b,weeklyTrends:l}){const x=we(),o=t.useMemo(()=>({waterConsumption:Number(b?.total_water_consumption??0),electricityUsage:Number(b?.total_electricity_consumption??0),hseCompliance:Math.round(Number(b?.avg_hse_compliance??0)),medicalCompliance:Math.round(Number(b?.avg_medical_compliance??0)),trainingHours:Math.round(Number(b?.total_training_hours??0)),nearMisses:Number(b?.total_near_misses??0),workPermits:Number(b?.total_work_permits??0)}),[b]),y=t.useMemo(()=>(l??[]).map(g=>({week:g.week_label,water:g.water??0,electricity:g.electricity??0,training_hours:g.training_hours??0})),[l]),s=t.useMemo(()=>(l??[]).map(g=>({week:g.week_label,hse:g.hse_compliance??0,medical:g.medical_compliance??0})),[l]),C=t.useMemo(()=>(l??[]).map(g=>({week:g.week_label,near_misses:g.near_misses??0,accidents:g.accidents??0,inspections:g.inspections??0})),[l]),T=t.useMemo(()=>[{name:x("dashboard.environmental.hseCompliance"),current:o.hseCompliance,target:95,color:se.hse},{name:x("dashboard.environmental.medicalCompliance"),current:o.medicalCompliance,target:95,color:se.medical}],[x,o]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(He,{title:x("dashboard.environmental.hseCompliance"),value:o.hseCompliance,icon:Ze,color:"green",unit:"%",trend:x("dashboard.environmental.yearToDate")}),e.jsx(He,{title:x("dashboard.environmental.medicalCompliance"),value:o.medicalCompliance,icon:Ra,color:"purple",unit:"%",trend:x("dashboard.environmental.yearToDate")}),e.jsx(He,{title:x("dashboard.environmental.waterConsumption"),value:o.waterConsumption.toLocaleString(),icon:Ka,color:"blue",unit:"m³",trend:x("dashboard.environmental.yearToDate")}),e.jsx(He,{title:x("dashboard.environmental.electricityUsage"),value:o.electricityUsage.toLocaleString(),icon:Pa,color:"yellow",unit:"kWh",trend:x("dashboard.environmental.yearToDate")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:x("dashboard.environmental.complianceTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(sa,{data:s,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week",tick:{fontSize:11}}),e.jsx(B,{tick:{fontSize:11},domain:[0,100]}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(de,{}),e.jsx(fe,{type:"monotone",dataKey:"hse",stroke:se.hse,strokeWidth:2,dot:{fill:se.hse,r:3},name:x("dashboard.environmental.hseCompliance")}),e.jsx(fe,{type:"monotone",dataKey:"medical",stroke:se.medical,strokeWidth:2,dot:{fill:se.medical,r:3},name:x("dashboard.environmental.medicalCompliance")})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:x("dashboard.environmental.waterVsElectricity")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(ta,{data:y,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week",tick:{fontSize:11}}),e.jsx(B,{yAxisId:"left",tick:{fontSize:11},stroke:se.water}),e.jsx(B,{yAxisId:"right",orientation:"right",tick:{fontSize:11},stroke:se.electricity}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(de,{}),e.jsx(H,{yAxisId:"left",dataKey:"water",fill:se.water,name:`${x("dashboard.environmental.waterConsumption")} (m³)`,radius:[4,4,0,0]}),e.jsx(fe,{yAxisId:"right",type:"monotone",dataKey:"electricity",stroke:se.electricity,strokeWidth:2,name:`${x("dashboard.environmental.electricityUsage")} (kWh)`})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:x("dashboard.environmental.safetyTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(Xe,{data:C,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week",tick:{fontSize:11}}),e.jsx(B,{tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(de,{}),e.jsx(ze,{type:"monotone",dataKey:"inspections",stroke:se.hse,fill:se.hse,fillOpacity:.6,name:x("dashboard.inspections")}),e.jsx(ze,{type:"monotone",dataKey:"near_misses",stroke:se.training,fill:se.training,fillOpacity:.6,name:x("dashboard.nearMisses")}),e.jsx(ze,{type:"monotone",dataKey:"accidents",stroke:se.nearMiss,fill:se.nearMiss,fillOpacity:.6,name:x("dashboard.accidents")})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:x("dashboard.environmental.complianceProgress")})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"space-y-6 py-4",children:[T.map((g,p)=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:g.name}),e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:[g.current,"% / ",g.target,"%"]})]}),e.jsxs("div",{className:"relative h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:[e.jsx("div",{className:"absolute h-full rounded-full transition-all duration-500",style:{width:`${Math.min(g.current,100)}%`,backgroundColor:g.color}}),e.jsx("div",{className:"absolute h-full w-0.5 bg-gray-800 dark:bg-gray-300",style:{left:`${g.target}%`},title:`Target: ${g.target}%`})]}),e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:g.current>=g.target?`✓ ${x("dashboard.environmental.targetAchieved")}`:`${g.target-g.current}% ${x("dashboard.environmental.toTarget")}`})]},g.name)),e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-amber-600",children:o.trainingHours.toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:x("dashboard.environmental.trainingHoursYTD")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-red-600",children:o.nearMisses}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:x("dashboard.environmental.nearMissesYTD")})]})]})})]})})]})]})]})}),Oe={trend:"#3b82f6",resolved:"#16a34a",unresolved:"#dc2626"},Ge=["#2563eb","#7c3aed","#f59e0b","#10b981","#ef4444","#06b6d4","#a855f7","#84cc16"],Le=t.memo(function({title:b,value:l,icon:x,color:o,subtitle:y}){const s={red:"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/50 text-red-600 dark:text-red-400",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400",blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[o]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:b})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:l}),y&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:y})]})}),ot=t.memo(function({year:b,projects:l,projectId:x="all",week:o="all",pole:y=""}){const s=we(),[C,T]=t.useState(!0),[g,p]=t.useState(null),[U,M]=t.useState(null),[te,d]=t.useState(null),[_,K]=t.useState(null),[ce,O]=t.useState(null),[ge,J]=t.useState(null),[re,m]=t.useState(null),[z,D]=t.useState(null),[Z,R]=t.useState(null),me=s("common.hourShort")??"h",Q=s("common.dayShort")??"d",I=i=>{if(i==null)return"—";const r=Number(i);return Number.isNaN(r)?"—":r<48?`${Math.round(r*10)/10}${me}`:`${Math.round(r/24*10)/10}${Q}`},X=t.useMemo(()=>{const i=new Map,r=N=>{const h=String(N??"");let $=0;for(let Y=0;Y<h.length;Y+=1)$=($<<5)-$+h.charCodeAt(Y),$|=0;return Math.abs($)};return[...new Set([...(re?.items??[]).map(N=>N?.pole).filter(Boolean),...(Z?.rows??[]).map(N=>N?.pole).filter(Boolean)])].forEach(N=>{const h=r(N)%Ge.length;i.set(N,Ge[h])}),N=>{const h=N&&String(N).trim()!==""?String(N):"—";if(!i.has(h)){const $=r(h)%Ge.length;i.set(h,Ge[$])}return i.get(h)}},[re?.items,Z?.rows]);t.useEffect(()=>{let i=!0;return(async()=>{T(!0);try{const u={year:b};y&&(u.pole=y),x!=="all"&&(u.project_id=x),o!=="all"&&(u.week=o);const[N,h,$,Y,ae,ue,Ke,Se,Ce]=await Promise.all([le.getSorAnalyticsKpis(u),le.getSorProjectTreemap(u),le.getSorThemeAvgResolution(u),le.getSorThemeResolutionBox(u),le.getSorThemeUnresolvedCount(u),le.getSorThemeResolvedUnresolved(u),le.getSorThemeBubble(u),le.getSorUserThemeAvgResolution(u),le.getSorPoleThemeUnresolvedRate(u)]);if(!i)return;p(N.data.data),M(h.data.data),d($.data.data),K(Y.data.data),O(ae.data.data),J(ue.data.data),m(Ke.data.data),D(Se.data.data),R(Ce.data.data)}finally{i&&T(!1)}})(),()=>{i=!1}},[b,x,o,y]);const c=g?.total??0,j=g?.unresolved_pct??0,k=g?.avg_resolution_hours,w=g?.worst_theme,ee=g?.worst_project,ne=g?.highest_avg_resolution_user,ie=t.useMemo(()=>(U?.items??[]).map(r=>({name:r.name,size:r.count??0,pole:r.pole??"—",count:r.count??0})),[U?.items]),oe=t.useMemo(()=>(te?.items??[]).filter(r=>r?.avg_hours!==null&&r?.avg_hours!==void 0).map(r=>({theme:(r.theme??"").toString().slice(0,28),theme_full:r.theme,avg_hours:Number(r.avg_hours??0),count:r.count??0})),[te?.items]),je=t.useMemo(()=>{const i=Math.max(0,...oe.map(r=>r.avg_hours));return i>0?i:1},[oe]),ve=t.useMemo(()=>(ce?.items??[]).map(r=>({theme:(r.theme??"").toString().slice(0,28),theme_full:r.theme,count:r.count??0})),[ce?.items]),be=t.useMemo(()=>(ge?.items??[]).map(r=>({theme:(r.theme??"").toString().slice(0,26),theme_full:r.theme,resolved:r.resolved??0,unresolved:r.unresolved??0,total:r.total??0})),[ge?.items]),Re=t.useMemo(()=>(re?.items??[]).filter(r=>r?.avg_hours!==null&&r?.avg_hours!==void 0).map(r=>({theme:(r.theme??"").toString().slice(0,26),theme_full:r.theme,avg_hours:Number(r.avg_hours??0),count:Number(r.count??0),pole:r.pole??"—"})),[re?.items]),ke=t.useMemo(()=>{const i=re?.items??[],r=new Map;return i.forEach(u=>{const N=u?.pole&&String(u.pole).trim()!==""?String(u.pole):"—",h=Number(u?.count??0),$=Number(u?.avg_hours??0);r.has(N)||r.set(N,{pole:N,total:0,_weightedHours:0});const Y=r.get(N);Y.total+=h,Y._weightedHours+=h*$}),Array.from(r.values()).map(u=>({pole:u.pole,total:u.total,avg_hours:u.total>0?u._weightedHours/u.total:0})).sort((u,N)=>N.total-u.total)},[re?.items]),pe=t.useMemo(()=>(_?.items??[]).filter(r=>r&&r.count>0).map(r=>({theme:(r.theme??"").toString().slice(0,26),theme_full:r.theme,count:r.count,min:Number(r.min??0),q1:Number(r.q1??0),median:Number(r.median??0),q3:Number(r.q3??0),max:Number(r.max??0)})),[_?.items]),he=t.useMemo(()=>{const i=Math.max(0,...pe.map(r=>r.max));return i>0?i:1},[pe]),_e=(i,r,u)=>{if(i==null)return"transparent";const N=Number(i);if(Number.isNaN(N)||N<=0)return"transparent";const $=.15+Math.min(1,Math.max(0,N/Math.max(1,r)))*.85;return`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${$})`};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(Le,{title:s("dashboard.deviations.total"),value:c,icon:Ie,color:"blue",subtitle:s("dashboard.deviations.yearContext",{year:b})}),e.jsx(Le,{title:s("dashboard.deviations.analytics.unresolvedPct"),value:`${j}%`,icon:Ve,color:"red",subtitle:s("dashboard.deviations.analytics.unresolvedSubtitle")}),e.jsx(Le,{title:s("dashboard.deviations.analytics.avgResolution"),value:k==null?"—":I(k),icon:Da,color:"green",subtitle:s("dashboard.deviations.analytics.avgResolutionSubtitle")}),e.jsx(Le,{title:s("dashboard.deviations.analytics.worstTheme"),value:w?.label??"—",icon:Ia,color:"purple",subtitle:w?`${I(w.avg_resolution_hours)} · ${w.unresolved??0}`:"—"}),e.jsx(Le,{title:s("dashboard.deviations.analytics.worstProject"),value:ee?.code??ee?.name??"—",icon:za,color:"amber",subtitle:ne?`${ne.name} · ${I(ne.avg_resolution_hours)}`:"—"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.poleTotals")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-[420px]",children:ke.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:ke,layout:"vertical",margin:{left:12,right:92,top:10,bottom:10},barCategoryGap:14,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"pole",width:92,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:i=>[i,s("dashboard.deviations.analytics.count")]}),e.jsxs(H,{dataKey:"total",radius:[0,6,6,0],barSize:38,children:[ke.map(i=>e.jsx($e,{fill:X(i.pole)},i.pole)),e.jsx(ea,{dataKey:"total",position:"right",offset:8,fill:"#111827",fontSize:11})]})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:s("common.noData")})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.projectTreemap")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-[420px]",children:ie.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsx(Va,{data:ie,dataKey:"size",nameKey:"name",stroke:"#ffffff",fill:"#93c5fd",content:({depth:i,x:r,y:u,width:N,height:h,name:$,payload:Y})=>{const ae=Y?.pole,ue=Y?.count,Ke=X(ae),Se=N>70&&h>28;return e.jsxs("g",{children:[e.jsx("rect",{x:r,y:u,width:N,height:h,style:{fill:Ke,stroke:"#ffffff",strokeWidth:2}}),Se&&e.jsx("text",{x:r+6,y:u+18,fill:"#ffffff",fontSize:11,fontWeight:700,children:String($).slice(0,18)}),Se&&e.jsx("text",{x:r+6,y:u+34,fill:"#ffffff",fontSize:11,children:ue})]})}})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:s("common.noData")})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.themeAvgResolution")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-80",children:oe.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:oe,layout:"vertical",margin:{left:10,right:20,top:10,bottom:10},children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"theme",width:160,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:(i,r,u)=>[I(i),s("dashboard.deviations.analytics.hours")],labelFormatter:(i,r)=>r?.[0]?.payload?.theme_full??i}),e.jsxs(H,{dataKey:"avg_hours",radius:[0,6,6,0],children:[oe.map(i=>{const r=Math.min(1,Math.max(0,i.avg_hours/je)),u=Math.round(22+r*220),N=Math.round(163-r*120),h=Math.round(74-r*40);return e.jsx($e,{fill:`rgb(${u}, ${N}, ${h})`},i.theme_full)}),e.jsx(ea,{dataKey:"avg_hours",position:"right",formatter:i=>I(i),fill:"#111827",fontSize:11})]})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:s("common.noData")})})})]}),e.jsxs("div",{className:"card lg:col-span-2",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.themeResolutionBox")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"space-y-2",children:pe.length===0?e.jsx("div",{className:"flex items-center justify-center h-72 text-gray-400",children:s("common.noData")}):e.jsx("div",{className:"space-y-2",children:pe.map(i=>{const r=i.min/he*100,u=i.max/he*100,N=i.q1/he*100,h=i.q3/he*100,$=i.median/he*100;return e.jsxs("div",{className:"grid grid-cols-[220px_1fr] gap-3 items-center",children:[e.jsx("div",{className:"text-[11px] text-gray-700 dark:text-gray-200 whitespace-nowrap overflow-hidden text-ellipsis",title:i.theme_full,children:i.theme}),e.jsxs("div",{className:"relative h-7",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 right-0 bg-gray-50 dark:bg-white/5 rounded"}),e.jsx("div",{className:"absolute top-1/2 h-[2px] bg-gray-300 dark:bg-white/20",style:{left:`${r}%`,right:`${100-u}%`,transform:"translateY(-50%)"}}),e.jsx("div",{className:"absolute top-1/2 w-[2px] bg-gray-400 dark:bg-white/40",style:{left:`${r}%`,height:"10px",transform:"translate(-50%, -50%)"}}),e.jsx("div",{className:"absolute top-1/2 w-[2px] bg-gray-400 dark:bg-white/40",style:{left:`${u}%`,height:"10px",transform:"translate(-50%, -50%)"}}),e.jsx("div",{className:"absolute top-1/2 bg-blue-500/70 dark:bg-blue-400/70 rounded",style:{left:`${N}%`,width:`${Math.max(0,h-N)}%`,height:"14px",transform:"translateY(-50%)"}}),e.jsx("div",{className:"absolute top-1/2 w-[2px] bg-white",style:{left:`${$}%`,height:"14px",transform:"translate(-50%, -50%)"}}),e.jsx("div",{className:"absolute -top-0.5 right-0 text-[10px] text-gray-500 dark:text-gray-400",children:I(i.median)})]})]},i.theme_full)})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.unresolvedByTheme")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-80",children:ve.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:ve,layout:"vertical",margin:{left:10,right:20,top:10,bottom:10},children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"theme",width:170,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},labelFormatter:(i,r)=>r?.[0]?.payload?.theme_full??i}),e.jsx(H,{dataKey:"count",fill:Oe.unresolved,radius:[0,6,6,0],children:e.jsx(ea,{dataKey:"count",position:"right",fill:"#111827",fontSize:11})})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:s("common.noData")})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.resolvedVsUnresolved")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-80",children:be.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xe,{data:be,layout:"vertical",margin:{left:10,right:20,top:10,bottom:10},children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"theme",width:170,tick:{fontSize:11}}),e.jsx(W,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},labelFormatter:(i,r)=>r?.[0]?.payload?.theme_full??i}),e.jsx(de,{}),e.jsx(H,{dataKey:"unresolved",stackId:"a",fill:Oe.unresolved,name:s("dashboard.deviations.analytics.unresolved")}),e.jsx(H,{dataKey:"resolved",stackId:"a",fill:Oe.resolved,name:s("dashboard.deviations.analytics.resolved")})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:s("common.noData")})})})]}),e.jsxs("div",{className:"card lg:col-span-2",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.themeBubble")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-96",children:Re.length>0?e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(xa,{margin:{top:10,right:20,left:10,bottom:10},children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{type:"number",dataKey:"avg_hours",name:s("dashboard.deviations.analytics.avgResolution"),tick:{fontSize:11}}),e.jsx(B,{type:"category",dataKey:"theme",name:s("dashboard.deviations.analytics.theme"),width:220,tick:{fontSize:11}}),e.jsx(ga,{type:"number",dataKey:"count",range:[80,600]}),e.jsx(W,{cursor:{strokeDasharray:"3 3"},contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:(i,r,u)=>r==="avg_hours"?[I(i),s("dashboard.deviations.analytics.avgResolution")]:r==="count"?[i,s("dashboard.deviations.analytics.count")]:[i,r],labelFormatter:(i,r)=>r?.[0]?.payload?.theme_full??i}),e.jsx(ua,{name:s("dashboard.deviations.analytics.theme"),data:Re,fill:Oe.trend,children:Re.map(i=>e.jsx($e,{fill:X(i.pole)},i.theme_full))})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:s("common.noData")})})})]}),e.jsxs("div",{className:"card lg:col-span-2",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.userThemeHeatmap")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"overflow-x-auto",children:(()=>{const i=z?.themes??[],r=z?.rows??[],u=r.flatMap(h=>i.map($=>Number(h?.values?.[$.key]??0))).filter(h=>h>0),N=Math.max(0,...u);return i.length===0||r.length===0?e.jsx("div",{className:"flex items-center justify-center h-72 text-gray-400",children:s("common.noData")}):e.jsxs("div",{className:"grid min-w-full",style:{gridTemplateColumns:`220px repeat(${i.length}, minmax(72px, 1fr))`},children:[e.jsxs("div",{className:"text-xs font-semibold text-gray-600 dark:text-gray-300 p-2",children:[e.jsx(Be,{className:"w-4 h-4 inline-block mr-1"}),s("dashboard.deviations.analytics.user")]}),i.map(h=>e.jsx("div",{className:"text-[11px] font-semibold text-gray-600 dark:text-gray-300 p-2 text-center",title:h.label,children:String(h.label).slice(0,12)},h.key)),r.map(h=>e.jsxs(t.Fragment,{children:[e.jsx("div",{className:"text-[11px] text-gray-700 dark:text-gray-200 p-2 whitespace-nowrap overflow-hidden text-ellipsis",title:h.user,children:h.user}),i.map($=>{const Y=h?.values?.[$.key],ae=_e(Y,N,[220,38,38]);return e.jsx("div",{className:"text-[11px] font-semibold text-gray-900 dark:text-gray-100 p-2 text-center border border-gray-100 dark:border-white/10",style:{backgroundColor:ae},title:`${h.user} · ${$.label}: ${I(Y)}`,children:Y?I(Y):""},`${h.user_id}-${$.key}`)})]},h.user_id))]})})()})})]}),e.jsxs("div",{className:"card lg:col-span-2",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.deviations.analytics.poleThemeHeatmap")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"overflow-x-auto",children:(()=>{const i=Z?.themes??[],r=Z?.rows??[],u=r.flatMap(h=>i.map($=>Number(h?.values?.[$.key]??0))).filter(h=>h>0),N=Math.max(0,...u);return i.length===0||r.length===0?e.jsx("div",{className:"flex items-center justify-center h-72 text-gray-400",children:s("common.noData")}):e.jsxs("div",{className:"grid",style:{gridTemplateColumns:`220px repeat(${i.length}, minmax(64px, 1fr))`},children:[e.jsxs("div",{className:"text-xs font-semibold text-gray-600 dark:text-gray-300 p-2",children:[e.jsx(Fa,{className:"w-4 h-4 inline-block mr-1"}),s("dashboard.deviations.analytics.pole")]}),i.map(h=>e.jsx("div",{className:"text-[11px] font-semibold text-gray-600 dark:text-gray-300 p-2 text-center",title:h.label,children:String(h.label).slice(0,12)},h.key)),r.map(h=>e.jsxs(t.Fragment,{children:[e.jsx("div",{className:"text-[11px] font-semibold p-2 whitespace-nowrap overflow-hidden text-ellipsis",style:{color:X(h.pole)},title:h.pole,children:h.pole}),i.map($=>{const Y=h?.values?.[$.key],ae=_e(Y,N,[220,38,38]);return e.jsx("div",{className:"text-[11px] font-semibold text-gray-900 dark:text-gray-100 p-2 text-center border border-gray-100 dark:border-white/10",style:{backgroundColor:ae},title:`${h.pole} · ${$.label}: ${Y??0}%`,children:Y?`${Y}%`:""},`${h.pole}-${$.key}`)})]},h.pole))]})})()})})]})]})]})});function ut(){const n=we(),{user:b}=ka(),[l,x]=t.useState(null),[o,y]=t.useState(!0),[s,C]=t.useState(null),[T,g]=t.useState(!1),[p,U]=t.useState(Pe().year),[M,te]=t.useState(Pe().year-1),[d,_]=t.useState(null),[K,ce]=t.useState(!1),[O,ge]=t.useState("overview"),[J,re]=t.useState(""),[m,z]=t.useState([]),[D,Z]=t.useState("all"),[R,me]=t.useState("all"),[Q,I]=t.useState(null),[X,c]=t.useState("all"),[j,k]=t.useState(null),w=t.useRef(null),ee=wa(),ne=t.useCallback(async()=>{try{y(!0);const a={year:p};J&&(a.pole=J),D!=="all"&&(a.project_id=D),R!=="all"&&(a.week=R);const f=await Qe(le.getAdminDashboard,"/dashboard/admin",a,3e4);x(f.data.data)}catch{De.error(n("dashboard.loadFailed")||n("errors.failedToLoad"))}finally{y(!1)}},[p,J,D,R]),ie=t.useCallback(async()=>{try{const a=await Na.getPoles(),f=a.data?.data?.poles||a.data?.poles||[];z(Array.isArray(f)?f:[])}catch{z([])}},[]),oe=t.useCallback(async()=>{if(!M){_(null);return}try{const a=await Qe(le.getAdminDashboard,"/dashboard/admin",{year:M},3e4);_(a.data.data??null)}catch(a){console.error("Failed to load comparison dashboard data",a),De.error(n("dashboard.compareLoadFailed")??n("errors.failedToLoad"))}},[M]),je=t.useCallback(async()=>{try{g(!0);const a={year:p};J&&(a.pole=J),D!=="all"&&(a.project_id=D),R!=="all"&&(a.week=R);const f=await Qe(le.getSafetyPerformance,"/dashboard/safety-performance",a,3e4);C(f.data.data)}catch{De.error(n("dashboard.loadFailed")||n("errors.failedToLoad"))}finally{g(!1)}},[p,J,D,R]);t.useEffect(()=>{ne(),oe()},[ne,oe]),t.useEffect(()=>{O==="safety"&&je()},[O,je]),t.useEffect(()=>{ie()},[ie]),t.useEffect(()=>{te(p-1)},[p]);const ve=t.useCallback(async a=>{ce(!0);try{const f=a==="excel"?await ia.exportExcel({year:p}):await ia.exportPdf({year:p}),v=new Blob([f.data],{type:a==="excel"?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"application/pdf"}),A=window.URL.createObjectURL(v),P=document.createElement("a");P.href=A,P.download=`kpi_report_${p}.${a==="excel"?"xlsx":"pdf"}`,P.click(),window.URL.revokeObjectURL(A),De.success(n("dashboard.exportSuccess"))}catch{De.error(n("dashboard.exportFailed")||n("errors.somethingWentWrong"))}finally{ce(!1)}},[p]),be=t.useMemo(()=>l?.stats??{},[l?.stats]),Re=t.useMemo(()=>l?.kpi_summary??{},[l?.kpi_summary]),ke=t.useMemo(()=>l?.weekly_trends??[],[l?.weekly_trends]),pe=t.useMemo(()=>l?.project_performance??[],[l?.project_performance]),he=t.useMemo(()=>l?.weekly_status??[],[l?.weekly_status]),_e=t.useMemo(()=>l?.projects??[],[l?.projects]);t.useEffect(()=>{w.current&&(!Array.isArray(he)||he.length===0||requestAnimationFrame(()=>{w.current&&w.current.scrollTo({left:w.current.scrollWidth,behavior:"auto"})}))},[he,p]);const i=t.useMemo(()=>Za(p),[p]),r=t.useMemo(()=>{if(R==="all")return ke;const a=Number(R);return Number.isNaN(a)?ke:(ke||[]).filter(f=>Number(f.week)===a)},[ke,R]),u=t.useMemo(()=>{if(D==="all")return pe;const a=Number(D);return Number.isNaN(a)?pe:(pe||[]).filter(f=>Number(f.id)===a)},[pe,D]),N=t.useCallback((a,f,{higherIsBetter:v})=>{const A=Number(a??0),P=Number(f??0);if(A===P)return null;const S=v?A>P:A<P,F=P===0?100:Math.abs((A-P)/P*100),E=F>=10?Math.round(F):Math.round(F*10)/10,Te=A>P?La:Wa,Ue=S?"bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300":"bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-semibold ${Ue}`,children:[e.jsx(Te,{className:"w-3.5 h-3.5"}),E,"%"]})},[]),h=t.useMemo(()=>l?.training_data||{},[l?.training_data]),$=t.useMemo(()=>l?.awareness_data||{},[l?.awareness_data]),Y=t.useMemo(()=>l?.sor_data||{},[l?.sor_data]);t.useMemo(()=>l?.permit_data||{},[l?.permit_data]);const ae=t.useMemo(()=>l?.inspection_data||{},[l?.inspection_data]),ue=t.useMemo(()=>{const a=Array.isArray(_e)?_e:[];return J?a.filter(f=>f?.pole===J):a},[_e,J]),Ke=b?.project_list_preference||"code",Se=t.useMemo(()=>Xa(ue,Ke),[ue,Ke]);t.useEffect(()=>{if(D==="all")return;ue.some(f=>String(f.id)===String(D))||Z("all")},[ue,D]),t.useEffect(()=>{if(X==="all")return;ue.some(f=>String(f.id)===String(X))||c("all")},[ue,X]);const Ce=t.useMemo(()=>{if(R==="all")return h;const a=Number(R);if(Number.isNaN(a))return h;const v=(Array.isArray(h?.by_week)?h.by_week:[]).filter(F=>Number(F.week_number)===a),A=v.reduce((F,E)=>F+Number(E?.count??0),0),P=v.reduce((F,E)=>F+Number(E?.participants??0),0),S=v.reduce((F,E)=>F+Number(E?.hours??0),0);return{...h,total:A,total_participants:P,total_hours:S,by_week:v}},[h,R]),ra=t.useMemo(()=>{if(R==="all")return ae;const a=Number(R);if(Number.isNaN(a))return ae;const v=(Array.isArray(ae?.by_week)?ae.by_week:[]).filter(P=>Number(P.week_number)===a),A=v.reduce((P,S)=>P+Number(S?.count??0),0);return{...ae,stats:{...ae?.stats||{},total:A},by_week:v}},[ae,R]),ya=t.useMemo(()=>{if(R==="all")return $;const a=Number(R);if(Number.isNaN(a))return $;const v=(Array.isArray($?.by_week)?$.by_week:[]).filter(F=>Number(F.week_number)===a),A=v.reduce((F,E)=>F+Number(E?.count??0),0),P=v.reduce((F,E)=>F+Number(E?.participants??0),0),S=v.reduce((F,E)=>F+Number(E?.hours??0),0);return{...$,total:A,total_participants:P,total_hours:S,by_week:v}},[$,R]),V=t.useMemo(()=>{const a=Re||{},f={...a,total_trainings:h?.total??a.total_trainings??0,employees_trained:h?.total_participants??a.employees_trained??0,total_training_hours:h?.total_hours??a.total_training_hours??0,total_inspections:ae?.stats?.total??a.total_inspections??0};if(R!=="all"){const v=Array.isArray(r)?r:[],A=S=>v.reduce((F,E)=>F+Number(E?.[S]??0),0),P=S=>{if(v.length===0)return 0;const F=v.map(E=>Number(E?.[S]??0));return F.reduce((E,Te)=>E+Te,0)/F.length};return{...f,total_accidents:A("accidents"),fatal_accidents:A("fatal_accidents"),serious_accidents:A("serious_accidents"),minor_accidents:A("minor_accidents"),total_inspections:ra?.stats?.total??A("inspections"),total_near_misses:A("near_misses"),total_work_permits:A("work_permits"),avg_tf:P("tf"),avg_tg:P("tg"),avg_hse_compliance:P("hse_compliance"),avg_medical_compliance:P("medical_compliance"),total_water_consumption:A("water"),total_electricity_consumption:A("electricity"),total_trainings:Ce?.total??0,employees_trained:Ce?.total_participants??0,total_training_hours:Ce?.total_hours??0}}if(D!=="all"){const v=Array.isArray(u)?u[0]:null;if(v)return{...f,total_accidents:Number(v.total_accidents??0),total_trainings:Number(v.total_trainings??0),avg_tf:Number(v.avg_tf??0),avg_tg:Number(v.avg_tg??0)}}return f},[Re,h,ae,Ce,ra,r,R,D,u]),fa=t.useCallback(a=>{if(!a||!a.activeLabel)return;const f=a.activeLabel,v=r.find(A=>A.week_label===f);if(v){I(v);const A=new URLSearchParams;let P=v.week;if(!P&&typeof f=="string"){const F=parseInt(f.replace(/\D/g,""),10);Number.isNaN(F)||(P=F)}P&&A.set("week",P);const S=v.year||p;S&&A.set("year",S),ee(`/admin/kpi?${A.toString()}`)}},[r,p,ee]),ja=t.useMemo(()=>[...Array(6)].map((a,f)=>Pe().year+1-f),[]);return o?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(Ba,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:n("dashboard.adminTitle")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:n("dashboard.overview")})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 px-3 py-2",children:[e.jsx(Ua,{className:"w-4 h-4 text-gray-400"}),e.jsx("select",{value:p,onChange:a=>U(Number(a.target.value)),className:"bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-none focus:ring-0 text-sm font-medium",children:ja.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>ve("excel"),disabled:K,className:"btn-secondary flex items-center gap-2",children:[e.jsx(Ea,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:n("dashboard.exportExcel")})]}),e.jsxs("button",{onClick:()=>ve("pdf"),disabled:K,className:"btn-secondary flex items-center gap-2",children:[e.jsx(la,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:n("dashboard.exportPdf")})]})]})]})]}),e.jsx(Qa,{activeTheme:O,onThemeChange:ge}),e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-end gap-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white/70 dark:bg-gray-900/40 px-3 py-2 w-full sm:w-auto",children:[e.jsxs("select",{value:J,onChange:a=>re(a.target.value),className:"bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-none focus:ring-0 text-sm w-full sm:w-auto",children:[e.jsx("option",{value:"",children:n("common.allPoles")}),m.map(a=>e.jsx("option",{value:a,children:a},a))]}),e.jsx("span",{className:"hidden sm:block w-px h-5 bg-gray-200 dark:bg-gray-700"}),e.jsxs("select",{value:D,onChange:a=>Z(a.target.value),className:"bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-none focus:ring-0 text-sm w-full sm:w-auto",children:[e.jsx("option",{value:"all",children:n("common.allProjects")}),Se.map(a=>e.jsx("option",{value:a.id,children:da(a)},a.id))]}),O!=="ppe"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"hidden sm:block w-px h-5 bg-gray-200 dark:bg-gray-700"}),e.jsxs("select",{value:R,onChange:a=>me(a.target.value),className:"bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-none focus:ring-0 text-sm w-full sm:w-auto",children:[e.jsx("option",{value:"all",children:n("common.all")}),i.map(a=>e.jsx("option",{value:a.week,children:a.label},a.week))]})]})]})}),O==="safety"&&e.jsx(et,{kpiSummary:V,weeklyTrends:r,projectPerformance:u,safetyPerformance:s,safetyLoading:T}),O==="training"&&e.jsx(at,{kpiSummary:V,weeklyTrends:r,projectPerformance:u,trainingData:Ce,awarenessData:ya}),O==="compliance"&&e.jsx(st,{kpiSummary:V,weeklyTrends:r,projectPerformance:u,inspectionData:ae,sorData:Y,regulatoryWatch:l?.regulatory_watch}),O==="ppe"&&e.jsx(nt,{year:p,projectId:D,pole:J}),O==="deviations"&&e.jsx(ot,{year:p,projects:_e,projectId:D,week:R,pole:J}),O==="environmental"&&e.jsx(it,{kpiSummary:V,weeklyTrends:r}),O==="overview"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(qe,{title:n("dashboard.totalProjects"),value:be.total_projects??0,subtitle:`${be.active_projects??0} ${n("dashboard.activeLabel")}`,icon:Ha,color:"blue"}),e.jsx(qe,{title:n("dashboard.totalUsers"),value:be.total_users??0,subtitle:`${be.active_users??0} ${n("dashboard.activeLabel")}`,icon:Be,color:"green"}),e.jsx(qe,{title:n("dashboard.activeMachines"),value:be.active_machines??0,subtitle:n("dashboard.activeMachinesSubtitle"),icon:Oa,color:"amber"}),e.jsx(qe,{title:n("dashboard.totalReports"),value:be.total_reports??0,subtitle:n("dashboard.inYear",{year:p}),icon:la,color:"purple"})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(We,{title:n("dashboard.safety.totalAccidents"),value:V.total_accidents??0,icon:Ie,color:V.total_accidents>0?"red":"green",trend:V.fatal_accidents>0?`${V.fatal_accidents} ${n("dashboard.safety.fatal")}`:n("dashboard.safety.noFatalities")}),e.jsx(We,{title:n("dashboard.training.totalTrainings"),value:V.total_trainings??0,icon:Ye,color:"blue",trend:`${V.employees_trained??0} ${n("dashboard.training.employeesTrained")}`}),e.jsx(We,{title:n("dashboard.compliance.totalInspections"),value:V.total_inspections??0,icon:Ze,color:"green"}),e.jsx(We,{title:n("dashboard.avgTf"),value:Number(V.avg_tf??0).toFixed(2),icon:ha,color:"amber",trend:n("dashboard.rates.frequencyRate")}),e.jsx(We,{title:n("dashboard.avgTg"),value:Number(V.avg_tg??0).toFixed(2),icon:aa,color:"purple",trend:n("dashboard.rates.severityRate")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:n("dashboard.weeklyKpiTrends")})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"h-80",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(sa,{data:r,onClick:fa,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week_label",tick:{fontSize:10},interval:"preserveStartEnd"}),e.jsx(B,{tick:{fontSize:12}}),e.jsx(W,{labelFormatter:a=>`${n("dashboard.weekPrefix")} ${a.replace("S","")}`}),e.jsx(de,{}),e.jsx(fe,{type:"monotone",dataKey:"accidents",stroke:"#dc2626",strokeWidth:2,dot:{fill:"#dc2626",r:3},name:n("dashboard.accidents")}),e.jsx(fe,{type:"monotone",dataKey:"trainings",stroke:"#3b82f6",strokeWidth:2,dot:{fill:"#3b82f6",r:3},name:n("dashboard.training.totalTrainings")}),e.jsx(fe,{type:"monotone",dataKey:"inspections",stroke:"#16a34a",strokeWidth:2,dot:{fill:"#16a34a",r:3},name:n("dashboard.inspections")})]})})}),Q&&e.jsxs("div",{className:"mt-4 text-xs text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"font-semibold",children:n("dashboard.detailsForWeek",{week:Q.week_label})}),e.jsx("button",{type:"button",onClick:()=>ee("/admin/kpi"),className:"btn-secondary btn-sm",children:n("dashboard.viewKpiReports")})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:n("dashboard.accidents")}),e.jsx("p",{className:"font-semibold",children:Q.accidents??0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:n("dashboard.training.totalTrainings")}),e.jsx("p",{className:"font-semibold",children:Q.trainings??0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:n("dashboard.inspections")}),e.jsx("p",{className:"font-semibold",children:Q.inspections??0})]})]})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:n("dashboard.tfTgRates")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-80",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(ta,{data:r,children:[e.jsx(G,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(q,{dataKey:"week_label",tick:{fontSize:10},interval:"preserveStartEnd"}),e.jsx(B,{yAxisId:"left",tick:{fontSize:12},stroke:"#f59e0b",label:{value:n("dashboard.rates.frequencyRate"),angle:-90,position:"insideLeft",style:{fill:"#f59e0b"}}}),e.jsx(B,{yAxisId:"right",orientation:"right",tick:{fontSize:12},stroke:"#8b5cf6",label:{value:n("dashboard.rates.severityRate"),angle:90,position:"insideRight",style:{fill:"#8b5cf6"}}}),e.jsx(W,{labelFormatter:a=>`${n("dashboard.weekPrefix")} ${a.replace("S","")}`,formatter:(a,f)=>[Number(a).toFixed(4),f]}),e.jsx(de,{}),e.jsx(H,{yAxisId:"left",dataKey:"tf",fill:"#f59e0b",name:n("dashboard.rates.frequencyRate"),radius:[4,4,0,0]}),e.jsx(H,{yAxisId:"right",dataKey:"tg",fill:"#8b5cf6",name:n("dashboard.rates.severityRate"),radius:[4,4,0,0]})]})})})})]})]}),he.filter(a=>a.total_projects>0).length>0&&e.jsxs("div",{className:"card mt-6",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:n("dashboard.submissionStatus")}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("select",{value:X,onChange:a=>c(a.target.value),className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-sm font-medium dark:text-gray-200 focus:ring-2 focus:ring-hse-primary",children:[e.jsx("option",{value:"all",children:n("common.allProjects")}),Se.map(a=>e.jsx("option",{value:a.id,children:da(a)},a.id))]})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{type:"button",onClick:()=>w.current?.scrollBy({left:-300,behavior:"smooth"}),className:"absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-gray-700/90 hover:bg-white dark:hover:bg-gray-600 shadow-lg rounded-full p-2 border dark:border-gray-600",children:e.jsx(Ga,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"})}),e.jsx("button",{type:"button",onClick:()=>w.current?.scrollBy({left:300,behavior:"smooth"}),className:"absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-gray-700/90 hover:bg-white dark:hover:bg-gray-600 shadow-lg rounded-full p-2 border dark:border-gray-600",children:e.jsx(qa,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"})}),e.jsx("div",{ref:w,className:"flex gap-2 overflow-x-auto scroll-smooth px-10 py-3 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",style:{scrollbarWidth:"thin"},children:(()=>{const a=Pe(),f=p<a.year?52:a.week;return Array.from({length:f},(v,A)=>A+1)})().map(a=>{const f=he.find(ye=>ye.week===a),v=Pe(),A=p<v.year||p===v.year&&a<v.week,P=a===v.week&&p===v.year;let S="not_submitted";const F=f?.projects||[];X==="all"?S=f?.status||"not_submitted":S=F.find(na=>na.project_id===parseInt(X))?.status||"not_submitted";const E=f?.approved_count??0,Te=f?.submitted_count??0,Ue=f?.draft_count??0,Fe=f?.total_projects??0;if(Fe<=0)return null;let Je="";if(S==="partial"&&Fe>0){const ye=[];E>0&&ye.push("rgb(34, 197, 94)"),Te>0&&ye.push("rgb(251, 191, 36)"),Ue>0&&ye.push("rgb(96, 165, 250)"),Fe-E-Te-Ue>0&&ye.push("rgb(254, 202, 202)"),Je=ye.length>1?`linear-gradient(135deg, ${ye.join(", ")})`:""}return e.jsxs("div",{"data-week":a,className:`relative flex-shrink-0 w-14 p-2 rounded-lg text-center transition-all cursor-pointer ${j===a?"ring-2 ring-gray-900 ring-offset-2 scale-110":""} ${P&&j!==a?"ring-2 ring-hse-primary ring-offset-2":""} ${S==="approved"?"bg-green-500 text-white":S==="partial"?"text-white":S==="submitted"?"bg-amber-400 text-white":S==="draft"?"bg-blue-400 text-white":A?"bg-red-100 text-red-600 hover:bg-red-200":"bg-gray-100 text-gray-500"}`,style:S==="partial"&&Je?{background:Je}:{},onClick:()=>k(j===a?null:a),children:[e.jsxs("p",{className:"text-xs font-medium",children:[n("dashboard.weekShortPrefix"),a]}),X==="all"&&Fe>1?e.jsxs("p",{className:"text-xs font-bold mt-0.5",children:[E+Te,"/",Fe]}):e.jsx("p",{className:"text-lg font-bold mt-0.5",children:S==="approved"?"✓":S==="partial"?"◐":S==="submitted"?"⏳":S==="draft"?"📝":A?"!":"-"})]},`admin-week-${p}-${a}`)})})]}),j&&(()=>{const f=he.find(S=>S.week===j)?.projects||[],v=Pe(),A=j===v.week&&p===v.year,P=p<v.year||p===v.year&&j<v.week;return f.length===0?null:e.jsxs("div",{className:"mt-3 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-700 pb-2 mb-2",children:[e.jsxs("p",{className:"font-semibold",children:[n("dashboard.weekDetailsTitle").replace("{{week}}",j),A&&e.jsxs("span",{className:"ml-2 text-hse-primary",children:["(",n("dashboard.currentWeekLabel"),")"]})]}),e.jsx("button",{type:"button",onClick:()=>k(null),className:"text-gray-400 hover:text-white",children:"✕"})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:f.map(S=>{const E=S.status==="not_submitted"&&P;return e.jsxs("div",{className:"flex items-center justify-between gap-2 bg-gray-800 rounded px-2 py-1.5",children:[e.jsx("span",{className:"truncate font-medium",children:S.project_code}),e.jsx("span",{className:`flex-shrink-0 px-1.5 py-0.5 rounded text-[10px] font-medium ${S.status==="approved"?"bg-green-500":S.status==="submitted"?"bg-amber-400":S.status==="draft"?"bg-blue-400":E?"bg-red-400":"bg-gray-500"}`,children:S.status==="approved"?n("status.approved"):S.status==="submitted"?n("status.pending"):S.status==="draft"?n("status.draft"):n(E?"status.missing":"status.notSubmitted")})]},S.project_id)})})]})})(),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4 pt-4 mt-2 border-t dark:border-gray-700 text-xs text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-green-500"})," ",n("status.approved")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-gradient-to-br from-green-400 to-amber-400"})," ",n("status.partial")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-amber-400"})," ",n("status.pending")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-blue-400"})," ",n("status.draft")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-red-100 border border-red-200"})," ",n("status.missing")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded ring-2 ring-hse-primary ring-offset-1"})," ",n("dashboard.currentWeekLabel")]})]})]})]}),d&&e.jsxs("div",{className:"card mt-6",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:n("dashboard.yearOverYearSummary",{year:p,compareYear:M})})}),e.jsxs("div",{className:"card-body grid grid-cols-1 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx("span",{children:n("dashboard.safety.totalAccidents")}),N(V.total_accidents,d?.kpi_summary?.total_accidents,{higherIsBetter:!1})]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[V.total_accidents??0," ",e.jsxs("span",{className:"text-xs text-gray-400",children:["(",p,")"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[d?.kpi_summary?.total_accidents??0," (",M,")"]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx("span",{children:n("dashboard.training.totalTrainings")}),N(V.total_trainings,d?.training_data?.total??d?.kpi_summary?.total_trainings,{higherIsBetter:!0})]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[V.total_trainings??0," ",e.jsxs("span",{className:"text-xs text-gray-400",children:["(",p,")"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[d?.training_data?.total??d?.kpi_summary?.total_trainings??0," (",M,")"]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx("span",{children:n("dashboard.inspections")}),N(V.total_inspections,d?.inspection_data?.stats?.total??d?.kpi_summary?.total_inspections,{higherIsBetter:!0})]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[V.total_inspections??0," ",e.jsxs("span",{className:"text-xs text-gray-400",children:["(",p,")"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[d?.inspection_data?.stats?.total??d?.kpi_summary?.total_inspections??0," (",M,")"]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx("span",{children:n("dashboard.tfTgRates")}),N(Number(V.avg_tf??0)+Number(V.avg_tg??0),Number(d?.kpi_summary?.avg_tf??0)+Number(d?.kpi_summary?.avg_tg??0),{higherIsBetter:!1})]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[Number(V.avg_tf??0).toFixed(2)," / ",Number(V.avg_tg??0).toFixed(2),e.jsxs("span",{className:"text-xs text-gray-400",children:[" (",p,")"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[Number(d?.kpi_summary?.avg_tf??0).toFixed(2)," / ",Number(d?.kpi_summary?.avg_tg??0).toFixed(2)," (",M,")"]})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:n("dashboard.projectPerformance")}),e.jsx(_a,{to:"/admin/projects",className:"text-sm text-hse-primary hover:underline",children:n("dashboard.viewAllProjects")})]}),u.length===0?e.jsx("div",{className:"p-6 text-center text-sm text-gray-500 dark:text-gray-400",children:n("dashboard.noProjectData")}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 p-4 md:hidden",children:u.slice(0,5).map(a=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a.code})]}),e.jsxs("div",{className:"text-right text-xs text-gray-600 dark:text-gray-300 space-y-1",children:[e.jsxs("p",{children:[e.jsxs("span",{className:"font-semibold",children:[n("dashboard.reports"),":"]})," ",a.reports_count]}),e.jsxs("p",{children:[e.jsxs("span",{className:"font-semibold",children:[n("dashboard.training.totalTrainings"),":"]})," ",a.total_trainings]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{children:[n("dashboard.accidents"),": ",e.jsx("span",{className:a.total_accidents>0?"text-red-600 dark:text-red-400 font-semibold":"text-green-600 dark:text-green-400",children:a.total_accidents})]}),e.jsxs("span",{children:["TF: ",Number(a.avg_tf).toFixed(2)," • TG: ",Number(a.avg_tg).toFixed(2)]})]})]},a.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:n("common.project")}),e.jsx("th",{children:n("dashboard.reports")}),e.jsx("th",{children:n("dashboard.accidents")}),e.jsx("th",{children:n("dashboard.training.totalTrainings")}),e.jsx("th",{children:n("dashboard.avgTf")}),e.jsx("th",{children:n("dashboard.avgTg")})]})}),e.jsx("tbody",{children:u.slice(0,5).map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium dark:text-gray-100",children:a.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a.code})]})}),e.jsx("td",{children:a.reports_count}),e.jsx("td",{children:e.jsx("span",{className:a.total_accidents>0?"text-red-600 dark:text-red-400 font-semibold":"text-green-600 dark:text-green-400",children:a.total_accidents})}),e.jsx("td",{children:a.total_trainings}),e.jsx("td",{children:Number(a.avg_tf).toFixed(2)}),e.jsx("td",{children:Number(a.avg_tg).toFixed(2)})]},a.id))})]})})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:n("dashboard.recentSubmissions")})}),e.jsx("div",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:l?.recent_reports?.filter(a=>a.status!=="draft").slice(0,5).map(a=>e.jsx("div",{className:"p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.project?.name||"Unknown Project"}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[a.report_month,"/",a.report_year," • Submitted by ",a.submitter?.name]})]}),e.jsx("span",{className:`badge ${a.status==="approved"?"badge-success":a.status==="submitted"?"badge-warning":a.status==="rejected"?"badge-danger":"badge-info"}`,children:a.status})]})},a.id))})]})]})]})}const qe=t.memo(function({title:b,value:l,subtitle:x,icon:o,color:y}){const s={blue:"bg-blue-50 text-blue-600",green:"bg-green-50 text-green-600",amber:"bg-amber-50 text-amber-600",purple:"bg-purple-50 text-purple-600",red:"bg-red-50 text-red-600"};return e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:b}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1",children:l}),e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:x})]}),e.jsx("div",{className:`p-3 rounded-lg ${s[y]}`,children:e.jsx(o,{className:"w-5 h-5"})})]})})}),We=t.memo(function({title:b,value:l,icon:x,color:o,trend:y}){const s={red:"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/50",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50",blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50"},C={red:"text-red-600 dark:text-red-400",green:"text-green-600 dark:text-green-400",blue:"text-blue-600 dark:text-blue-400",amber:"text-amber-600 dark:text-amber-400",purple:"text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[o]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{className:`w-5 h-5 ${C[o]}`}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:b})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:l}),y&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:y})]})});export{ut as default};

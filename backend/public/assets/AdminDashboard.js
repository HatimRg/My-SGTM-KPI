import{d as ae,j as e,e as Ke,u as ca,p as ma,f as Ve}from"./index.js";import{r as n,u as xa,L as ha}from"./vendor-react.js";import{I as ga,u as ea,J as Te,c as he,A as ge,K as ba,O as ua,T as aa,Q as ta,U as Ce,p as Pe,o as pa,V as fa,Y as ya,Z as ja,_ as ka,$ as va,a0 as Na,a1 as _a,z as ke,a2 as wa,a3 as Sa,s as Ca,a4 as Ta,a5 as Ma,e as Je,F as Aa,a6 as $a,a7 as Ra}from"./vendor-ui.js";import{R as M,A as be,C as P,X as D,Y as $,T as A,a as ee,P as De,b as Fe,c as xe,L as G,d as We,e as q,B as ie,f as H,g as sa}from"./vendor-charts.js";import{g as Ka,a as Re}from"./weekHelper.js";import{s as Pa,g as Xe}from"./projectList.js";import"./vendor-utils.js";class Da{constructor(){this.cache=new Map,this.timestamps=new Map}generateKey(l,d={}){const o=Object.keys(d).sort().reduce((r,i)=>(r[i]=d[i],r),{});return`${l}:${JSON.stringify(o)}`}get(l,d={},o=3e4){const r=this.generateKey(l,d),i=this.timestamps.get(r);return!i||Date.now()-i>o?(this.delete(r),null):this.cache.get(r)}set(l,d={},o){const r=this.generateKey(l,d);this.cache.set(r,o),this.timestamps.set(r,Date.now())}delete(l){this.cache.delete(l),this.timestamps.delete(l)}clearPattern(l){for(const d of this.cache.keys())d.includes(l)&&this.delete(d)}clear(){this.cache.clear(),this.timestamps.clear()}getStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}const Ze=new Da;async function Qe(t,l,d={},o=3e4){const r=Ze.get(l,d,o);if(r)return Promise.resolve(r);const i=await t(d);return Ze.set(l,d,i),i}const Fa=[{id:"overview",nameKey:"dashboard.themes.overview",icon:ga,gradient:"from-purple-500 to-purple-700"},{id:"safety",nameKey:"dashboard.themes.safety",icon:ea,gradient:"from-red-500 to-red-700"},{id:"training",nameKey:"dashboard.themes.training",icon:Te,gradient:"from-blue-500 to-blue-700"},{id:"compliance",nameKey:"dashboard.themes.compliance",icon:he,gradient:"from-green-500 to-green-700"},{id:"deviations",nameKey:"dashboard.themes.deviations",icon:ge,gradient:"from-amber-500 to-amber-700"},{id:"environmental",nameKey:"dashboard.themes.environmental",icon:ba,gradient:"from-emerald-500 to-emerald-700"}],Wa=n.memo(function({activeTheme:l,onThemeChange:d}){const o=ae();return e.jsx("div",{className:"relative mb-4",children:e.jsx("div",{className:"flex items-center justify-center gap-1 flex-wrap",children:Fa.map(r=>{const i=r.icon,s=l===r.id;return e.jsxs("button",{onClick:()=>d(r.id),className:`flex items-center gap-1.5 px-3 py-2 rounded-lg border transition-all duration-200 ${s?`bg-gradient-to-r ${r.gradient} text-white border-transparent shadow-md`:"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600 hover:shadow-sm"}`,children:[e.jsx(i,{className:`w-4 h-4 ${s?"text-white":""}`}),e.jsx("span",{className:`font-medium text-xs ${s?"text-white":""}`,children:o(r.nameKey)})]},r.id)})})})}),Z={fatal:"#dc2626",serious:"#f59e0b",minor:"#16a34a",tf:"#f59e0b",tg:"#8b5cf6"},ve=n.memo(function({title:l,value:d,icon:o,color:r,trend:i}){const s={red:"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/50 text-red-600 dark:text-red-400",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[r]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(o,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:l})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:d}),i&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:i})]})}),za=n.memo(function({kpiSummary:l,weeklyTrends:d,projectPerformance:o}){const r=ae(),i=n.useMemo(()=>({totalAccidents:l?.total_accidents??0,fatalAccidents:l?.fatal_accidents??0,avgTF:Number(l?.avg_tf??0).toFixed(2),avgTG:Number(l?.avg_tg??0).toFixed(2),lostWorkdays:l?.lost_workdays??0}),[l]),s=n.useMemo(()=>(d??[]).map(m=>({week:m.week_label,accidents:m.accidents??0})),[d]),k=n.useMemo(()=>{i.totalAccidents;const m=i.fatalAccidents,T=l?.serious_accidents,F=l?.minor_accidents,W=T!=null&&F!==null&&F!==void 0,c=W?Number(T??0):(d??[]).reduce((v,N)=>v+Number(N?.serious_accidents??0),0),b=W?Number(F??0):(d??[]).reduce((v,N)=>v+Number(N?.minor_accidents??0),0);return[{name:r("dashboard.safety.fatal"),value:Number(m??0),color:Z.fatal},{name:r("dashboard.safety.serious"),value:Number(c??0),color:Z.serious},{name:r("dashboard.safety.minor"),value:Number(b??0),color:Z.minor}].filter(v=>v.value>0)},[i,r,l,d]),j=n.useMemo(()=>(d??[]).map(m=>({week:m.week_label,tf:Number(m.tf??0).toFixed(4),tg:Number(m.tg??0).toFixed(4)})),[d]),p=n.useMemo(()=>(o??[]).slice(0,6).map(m=>({name:m.name?.length>15?m.name.substring(0,15)+"...":m.name,accidents:m.total_accidents??0})),[o]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(ve,{title:r("dashboard.safety.totalAccidents"),value:i.totalAccidents,icon:ge,color:i.totalAccidents>0?"red":"green",trend:r("dashboard.safety.yearToDate")}),e.jsx(ve,{title:r("dashboard.safety.fatalAccidents"),value:i.fatalAccidents,icon:ua,color:i.fatalAccidents>0?"red":"green",trend:i.fatalAccidents===0?r("dashboard.safety.noFatalities"):r("dashboard.safety.critical")}),e.jsx(ve,{title:r("dashboard.safety.tfRate"),value:i.avgTF,icon:aa,color:"amber",trend:r("dashboard.safety.avgFrequencyRate")}),e.jsx(ve,{title:r("dashboard.safety.tgRate"),value:i.avgTG,icon:ta,color:"purple",trend:r("dashboard.safety.avgSeverityRate")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:r("dashboard.safety.accidentTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(be,{data:s,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"accidentGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#dc2626",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#dc2626",stopOpacity:.1})]})}),e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week",tick:{fontSize:11}}),e.jsx($,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(ee,{type:"monotone",dataKey:"accidents",stroke:"#dc2626",fill:"url(#accidentGradient)",name:"Accidents"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:r("dashboard.safety.accidentsBySeverity")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:k.length>0?e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(De,{children:[e.jsx(Fe,{data:k,cx:"50%",cy:"50%",innerRadius:50,outerRadius:80,paddingAngle:5,dataKey:"value",label:({name:m,value:T})=>`${m}: ${T}`,children:k.map((m,T)=>e.jsx(xe,{fill:m.color},`cell-${T}`))}),e.jsx(A,{}),e.jsx(G,{})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-green-600 dark:text-green-400",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ge,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"font-medium",children:r("dashboard.safety.noAccidents")}),e.jsx("p",{className:"text-sm text-gray-500",children:r("dashboard.safety.greatSafety")})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:r("dashboard.safety.tfVsTg")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(We,{data:j,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week",tick:{fontSize:11}}),e.jsx($,{tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(G,{}),e.jsx(q,{type:"monotone",dataKey:"tf",stroke:Z.tf,strokeWidth:2,dot:{fill:Z.tf,r:3},name:"TF Rate"}),e.jsx(q,{type:"monotone",dataKey:"tg",stroke:Z.tg,strokeWidth:2,dot:{fill:Z.tg,r:3},name:"TG Rate"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:r("dashboard.safety.accidentsByProject")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(ie,{data:p,layout:"vertical",children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{type:"number",allowDecimals:!1,tick:{fontSize:11}}),e.jsx($,{type:"category",dataKey:"name",tick:{fontSize:10},width:100}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(H,{dataKey:"accidents",fill:"#dc2626",radius:[0,4,4,0],name:"Accidents"})]})})})})]})]})]})}),Q=n.memo(function({title:l,value:d,icon:o,color:r,trend:i}){const s={blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[r]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(o,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:l})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:d}),i&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:i})]})}),La=n.memo(function({kpiSummary:l,weeklyTrends:d,projectPerformance:o,trainingData:r,awarenessData:i}){const s=ae(),k=n.useMemo(()=>{const c=r?.total??l?.total_trainings??0,b=r?.total_participants??l?.employees_trained??0,v=r?.total_hours??l?.total_training_hours??l?.training_hours??0,N=l?.total_trainings_planned??0,z=N>0?Math.round(c/N*100):null;return{totalTrainings:c,employeesTrained:b,trainingHours:v,completionRate:z}},[l,r]),j=n.useMemo(()=>({totalSessions:i?.total??0,totalParticipants:i?.total_participants??0,totalHours:i?.total_hours??0}),[i]),p=n.useMemo(()=>r?.by_week?.length>0?r.by_week.map(c=>({week:"S"+c.week_number,trainings:c.count??0,participants:c.participants??0})):(d??[]).map(c=>({week:c.week_label,trainings:c.trainings??0})),[d,r]),m=n.useMemo(()=>{if(r?.by_theme?.length>0){const c=["#3b82f6","#8b5cf6","#ec4899","#14b8a6","#f59e0b","#ef4444","#10b981","#6366f1"];return r.by_theme.slice(0,8).map((b,v)=>({name:b.theme?.length>20?b.theme.substring(0,20)+"...":b.theme,fullName:b.theme,value:b.count,participants:b.participants??0,color:c[v%c.length]}))}return[]},[r]),T=n.useMemo(()=>r?.by_duration?.length>0?r.by_duration.map(c=>({duration:c.duration,count:c.count,participants:c.participants??0})):[],[r]),F=n.useMemo(()=>{if(i?.by_theme?.length>0){const c=["#16a34a","#0ea5e9","#f97316","#a855f7","#eab308","#06b6d4","#84cc16","#d946ef"];return i.by_theme.slice(0,8).map((b,v)=>({name:b.theme?.length>20?b.theme.substring(0,20)+"...":b.theme,fullName:b.theme,value:b.count,participants:b.participants??0,color:c[v%c.length]}))}return[]},[i]),W=n.useMemo(()=>r?.by_type?.length>0?r.by_type.map(c=>({name:c.type==="internal"?s("dashboard.training.internal"):s("dashboard.training.external"),value:c.count,color:c.type==="internal"?"#3b82f6":"#8b5cf6"})):[],[r,s]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Q,{title:s("dashboard.training.totalTrainings"),value:k.totalTrainings,icon:Te,color:"blue",trend:s("dashboard.training.sessionsCompleted")}),e.jsx(Q,{title:s("dashboard.training.employeesTrained"),value:k.employeesTrained,icon:Ce,color:"green",trend:s("dashboard.training.uniqueAttendees")}),e.jsx(Q,{title:s("dashboard.training.trainingHours"),value:k.trainingHours,icon:Pe,color:"purple",trend:s("dashboard.training.totalHoursDelivered")}),e.jsx(Q,{title:s("dashboard.training.completionRate"),value:k.completionRate!==null?`${k.completionRate}%`:"—",icon:pa,color:"amber",trend:`${s("dashboard.training.target")}: 95%`})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.trainingTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(be,{data:p,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"trainingGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#3b82f6",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#3b82f6",stopOpacity:.1})]})}),e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week",tick:{fontSize:11}}),e.jsx($,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(ee,{type:"monotone",dataKey:"trainings",stroke:"#3b82f6",fill:"url(#trainingGradient)",name:"Trainings"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.trainingByTheme")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:m.length>0?e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(ie,{data:m,layout:"vertical",margin:{left:10,right:20},children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{type:"number",allowDecimals:!1,tick:{fontSize:11}}),e.jsx($,{type:"category",dataKey:"name",tick:{fontSize:10},width:120}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:(c,b,v)=>[`${c} sessions (${v.payload.participants} participants)`,"Count"]}),e.jsx(H,{dataKey:"value",radius:[0,4,4,0],children:m.map((c,b)=>e.jsx(xe,{fill:c.color},`cell-${b}`))})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Te,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"font-medium",children:s("dashboard.training.noTrainingData")})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.trainingByDuration")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:T.length>0?e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(ie,{data:T,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"duration",tick:{fontSize:11}}),e.jsx($,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:(c,b)=>[c,b==="count"?"Sessions":"Participants"]}),e.jsx(H,{dataKey:"count",fill:"#8b5cf6",radius:[4,4,0,0],name:"Sessions"})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsx("p",{className:"font-medium",children:s("dashboard.training.noTrainingData")})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.awarenessByTheme")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:F.length>0?e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(ie,{data:F,layout:"vertical",margin:{left:10,right:20},children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{type:"number",allowDecimals:!1,tick:{fontSize:11}}),e.jsx($,{type:"category",dataKey:"name",tick:{fontSize:10},width:120}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"},formatter:(c,b,v)=>[`${c} sessions (${v.payload.participants} participants)`,"Count"]}),e.jsx(H,{dataKey:"value",radius:[0,4,4,0],children:F.map((c,b)=>e.jsx(xe,{fill:c.color},`cell-${b}`))})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsx("p",{className:"font-medium",children:s("dashboard.training.noTrainingData")})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.training.trainingByType")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:W.length>0?e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(De,{children:[e.jsx(Fe,{data:W,cx:"50%",cy:"45%",innerRadius:40,outerRadius:70,paddingAngle:5,dataKey:"value",label:({value:c})=>c,labelLine:!1,children:W.map((c,b)=>e.jsx(xe,{fill:c.color},`cell-${b}`))}),e.jsx(A,{formatter:(c,b)=>[c,b]}),e.jsx(G,{verticalAlign:"bottom",height:36,formatter:c=>e.jsx("span",{className:"text-sm",children:c})})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsx("p",{className:"font-medium",children:s("dashboard.training.noTrainingData")})})})})]})]}),j.totalSessions>0&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsx(Q,{title:s("dashboard.training.totalAwareness"),value:j.totalSessions,icon:Ce,color:"green",trend:`${j.totalParticipants} participants`}),e.jsx(Q,{title:s("dashboard.training.awarenessParticipants"),value:j.totalParticipants,icon:Ce,color:"purple"}),e.jsx(Q,{title:s("dashboard.training.awarenessHours"),value:Math.round(j.totalHours??0),icon:Pe,color:"amber"})]})]})}),Ia={compliance:"#16a34a"},Ne=n.memo(function({title:l,value:d,icon:o,color:r,trend:i}){const s={green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[r]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(o,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:l})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:d}),i&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:i})]})}),Oa=n.memo(function({kpiSummary:l,weeklyTrends:d,projectPerformance:o,inspectionData:r,sorData:i}){const s=ae(),k=n.useMemo(()=>{const m=l?.total_inspections??0,T=Number(l?.avg_hse_compliance??0).toFixed(1),F=Number(l?.avg_medical_compliance??0).toFixed(1),W=i?.stats?.total??0,c=i?.stats?.closed??0,b=W>0?Math.round(c/W*100):null;return{totalInspections:m,hseCompliance:T,medicalCompliance:F,auditScore:b}},[l,i]),j=n.useMemo(()=>(d??[]).map(m=>({week:m.week_label,inspections:m.inspections??0})),[d]),p=n.useMemo(()=>(i?.by_category??[]).map(m=>({category:m.label??m.category,count:m.count??0})),[i]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Ne,{title:s("dashboard.compliance.totalInspections"),value:k.totalInspections,icon:he,color:"green",trend:s("dashboard.compliance.completedThisYear")}),e.jsx(Ne,{title:s("dashboard.compliance.hseCompliance"),value:`${k.hseCompliance}%`,icon:ea,color:"blue",trend:s("dashboard.compliance.avgScore")}),e.jsx(Ne,{title:s("dashboard.compliance.medicalCompliance"),value:`${k.medicalCompliance}%`,icon:fa,color:"purple",trend:s("dashboard.compliance.healthChecks")}),k.auditScore!==null&&e.jsx(Ne,{title:s("dashboard.compliance.auditScore"),value:`${k.auditScore}%`,icon:ya,color:"amber",trend:s("dashboard.compliance.latestAudit")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.compliance.inspectionTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(be,{data:j,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"complianceGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#16a34a",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#16a34a",stopOpacity:.1})]})}),e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week",tick:{fontSize:11}}),e.jsx($,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(ee,{type:"monotone",dataKey:"inspections",stroke:"#16a34a",fill:"url(#complianceGradient)",name:"Inspections"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.compliance.auditFindings")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(ie,{data:p,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"category",tick:{fontSize:11}}),e.jsx($,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(H,{dataKey:"count",fill:Ia.compliance,name:s("dashboard.compliance.findings"),radius:[4,4,0,0]})]})})})})]})]})]})}),K={water:"#0ea5e9",electricity:"#eab308",hse:"#22c55e",medical:"#8b5cf6",training:"#f59e0b",nearMiss:"#ef4444"},_e=n.memo(function({title:l,value:d,icon:o,color:r,trend:i,unit:s}){const k={blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400",yellow:"border-yellow-200 bg-yellow-50 dark:border-yellow-700 dark:bg-yellow-900/50 text-yellow-600 dark:text-yellow-400",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${k[r]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(o,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:l})]}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:[d,e.jsx("span",{className:"text-sm font-normal ml-1",children:s})]}),i&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:i})]})}),Ba=n.memo(function({kpiSummary:l,weeklyTrends:d}){const o=ae(),r=n.useMemo(()=>({waterConsumption:Number(l?.total_water_consumption??0),electricityUsage:Number(l?.total_electricity_consumption??0),hseCompliance:Math.round(Number(l?.avg_hse_compliance??0)),medicalCompliance:Math.round(Number(l?.avg_medical_compliance??0)),trainingHours:Math.round(Number(l?.total_training_hours??0)),nearMisses:Number(l?.total_near_misses??0),workPermits:Number(l?.total_work_permits??0)}),[l]),i=n.useMemo(()=>(d??[]).map(p=>({week:p.week_label,water:p.water??0,electricity:p.electricity??0,training_hours:p.training_hours??0})),[d]),s=n.useMemo(()=>(d??[]).map(p=>({week:p.week_label,hse:p.hse_compliance??0,medical:p.medical_compliance??0})),[d]),k=n.useMemo(()=>(d??[]).map(p=>({week:p.week_label,near_misses:p.near_misses??0,accidents:p.accidents??0,inspections:p.inspections??0})),[d]),j=n.useMemo(()=>[{name:o("dashboard.environmental.hseCompliance"),current:r.hseCompliance,target:95,color:K.hse},{name:o("dashboard.environmental.medicalCompliance"),current:r.medicalCompliance,target:95,color:K.medical}],[o,r]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(_e,{title:o("dashboard.environmental.hseCompliance"),value:r.hseCompliance,icon:he,color:"green",unit:"%",trend:o("dashboard.environmental.yearToDate")}),e.jsx(_e,{title:o("dashboard.environmental.medicalCompliance"),value:r.medicalCompliance,icon:ja,color:"purple",unit:"%",trend:o("dashboard.environmental.yearToDate")}),e.jsx(_e,{title:o("dashboard.environmental.waterConsumption"),value:r.waterConsumption.toLocaleString(),icon:ka,color:"blue",unit:"m³",trend:o("dashboard.environmental.yearToDate")}),e.jsx(_e,{title:o("dashboard.environmental.electricityUsage"),value:r.electricityUsage.toLocaleString(),icon:va,color:"yellow",unit:"kWh",trend:o("dashboard.environmental.yearToDate")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:o("dashboard.environmental.complianceTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(We,{data:s,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week",tick:{fontSize:11}}),e.jsx($,{tick:{fontSize:11},domain:[0,100]}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(G,{}),e.jsx(q,{type:"monotone",dataKey:"hse",stroke:K.hse,strokeWidth:2,dot:{fill:K.hse,r:3},name:o("dashboard.environmental.hseCompliance")}),e.jsx(q,{type:"monotone",dataKey:"medical",stroke:K.medical,strokeWidth:2,dot:{fill:K.medical,r:3},name:o("dashboard.environmental.medicalCompliance")})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:o("dashboard.environmental.waterVsElectricity")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(sa,{data:i,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week",tick:{fontSize:11}}),e.jsx($,{yAxisId:"left",tick:{fontSize:11},stroke:K.water}),e.jsx($,{yAxisId:"right",orientation:"right",tick:{fontSize:11},stroke:K.electricity}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(G,{}),e.jsx(H,{yAxisId:"left",dataKey:"water",fill:K.water,name:"Water (m³)",radius:[4,4,0,0]}),e.jsx(q,{yAxisId:"right",type:"monotone",dataKey:"electricity",stroke:K.electricity,strokeWidth:2,name:"Electricity (kWh)"})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:o("dashboard.environmental.safetyTrends")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(be,{data:k,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week",tick:{fontSize:11}}),e.jsx($,{tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(G,{}),e.jsx(ee,{type:"monotone",dataKey:"inspections",stroke:K.hse,fill:K.hse,fillOpacity:.6,name:o("dashboard.inspections")}),e.jsx(ee,{type:"monotone",dataKey:"near_misses",stroke:K.training,fill:K.training,fillOpacity:.6,name:o("dashboard.nearMisses")}),e.jsx(ee,{type:"monotone",dataKey:"accidents",stroke:K.nearMiss,fill:K.nearMiss,fillOpacity:.6,name:o("dashboard.accidents")})]})})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:o("dashboard.environmental.complianceProgress")})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"space-y-6 py-4",children:[j.map((p,m)=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:p.name}),e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:[p.current,"% / ",p.target,"%"]})]}),e.jsxs("div",{className:"relative h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:[e.jsx("div",{className:"absolute h-full rounded-full transition-all duration-500",style:{width:`${Math.min(p.current,100)}%`,backgroundColor:p.color}}),e.jsx("div",{className:"absolute h-full w-0.5 bg-gray-800 dark:bg-gray-300",style:{left:`${p.target}%`},title:`Target: ${p.target}%`})]}),e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:p.current>=p.target?`✓ ${o("dashboard.environmental.targetAchieved")}`:`${p.target-p.current}% ${o("dashboard.environmental.toTarget")}`})]},m)),e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-amber-600",children:r.trainingHours.toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:o("dashboard.environmental.trainingHoursYTD")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-red-600",children:r.nearMisses}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:o("dashboard.environmental.nearMissesYTD")})]})]})})]})})]})]})]})}),U={open:"#dc2626",in_progress:"#f59e0b",closed:"#16a34a",trend:"#3b82f6"},we=n.memo(function({title:l,value:d,icon:o,color:r,subtitle:i}){const s={red:"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/50 text-red-600 dark:text-red-400",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50 text-green-600 dark:text-green-400",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400",blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[r]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(o,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:l})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:d}),i&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:i})]})}),Ea=n.memo(function({year:l,projects:d,projectId:o="all",week:r="all"}){const i=ae(),[s,k]=n.useState(!0),[j,p]=n.useState(null),m=n.useMemo(()=>{const N=j?.avg_close_days;if(N==null)return"—";const z=Number(N);if(Number.isNaN(z))return"—";if(z<2){const de=Math.max(0,Math.round(z*24*60)),C=Math.floor(de/60),Me=de%60;return`${C.toString().padStart(2,"0")}h${Me.toString().padStart(2,"0")}min`}const w=Math.round(z*10)/10;return`${Number.isInteger(w)?String(w):w.toFixed(1)}d`},[j?.avg_close_days]);n.useEffect(()=>{let N=!0;return(async()=>{k(!0);try{const w={year:l};o!=="all"&&(w.project_id=o),r!=="all"&&(w.week=r);const R=await Ke.getSorCharts(w);if(!N)return;p(R.data.data)}finally{N&&k(!1)}})(),()=>{N=!1}},[l,o,r]);const T=j?.stats??{},F=j?.by_status??[],W=j?.by_category??[],c=j?.by_week??[],b=n.useMemo(()=>{const N=w=>w==="open"?i("dashboard.deviations.status.open"):w==="in_progress"?i("dashboard.deviations.status.inProgress"):w==="closed"?i("dashboard.deviations.status.closed"):w,z=w=>w==="open"?U.open:w==="in_progress"?U.in_progress:w==="closed"?U.closed:U.trend;return F.map(w=>({name:N(w.status),value:w.count,color:z(w.status)})).filter(w=>w.value>0)},[F,i]),v=n.useMemo(()=>W.slice(0,10).map(N=>({category:(N.label??N.category??"").toString().slice(0,28),count:N.count??0})),[W]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(we,{title:i("dashboard.deviations.total"),value:T.total??0,icon:ge,color:"blue",subtitle:i("dashboard.deviations.yearContext",{year:l})}),e.jsx(we,{title:i("dashboard.deviations.open"),value:T.open??0,icon:Pe,color:"red",subtitle:i("dashboard.deviations.inProgressAndOpen")}),e.jsx(we,{title:i("dashboard.deviations.closed"),value:T.closed??0,icon:Na,color:"green",subtitle:i("dashboard.deviations.closedSubtitle")}),e.jsx(we,{title:i("dashboard.deviations.avgCloseDays"),value:m,icon:_a,color:"purple",subtitle:i("dashboard.deviations.avgCloseSubtitle")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:i("dashboard.deviations.trend")})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"h-64",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(be,{data:c,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"devTrendGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:U.trend,stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:U.trend,stopOpacity:.1})]})}),e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week_label",tick:{fontSize:11}}),e.jsx($,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(ee,{type:"monotone",dataKey:"count",stroke:U.trend,fill:"url(#devTrendGradient)",name:i("dashboard.deviations.total")})]})})}),s&&e.jsx("div",{className:"text-xs text-gray-400 mt-2",children:i("common.loading")})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:i("dashboard.deviations.byStatus")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-64",children:b.length>0?e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(De,{children:[e.jsx(Fe,{data:b,cx:"50%",cy:"50%",innerRadius:50,outerRadius:80,paddingAngle:5,dataKey:"value",label:({name:N,value:z})=>`${N}: ${z}`,children:b.map((N,z)=>e.jsx(xe,{fill:N.color},`cell-${z}`))}),e.jsx(A,{}),e.jsx(G,{})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:i("common.noData")})})})]}),e.jsxs("div",{className:"card lg:col-span-2",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:i("dashboard.deviations.byCategory")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-72",children:v.length>0?e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(ie,{data:v,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"category",tick:{fontSize:10},interval:0}),e.jsx($,{allowDecimals:!1,tick:{fontSize:11}}),e.jsx(A,{contentStyle:{backgroundColor:"#1f2937",border:"none",borderRadius:"8px"},labelStyle:{color:"#f3f4f6"}}),e.jsx(H,{dataKey:"count",fill:U.trend,name:i("dashboard.deviations.total"),radius:[4,4,0,0]})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:i("common.noData")})})})]})]})]})});function Xa(){const t=ae(),{user:l}=ca(),[d,o]=n.useState(null),[r,i]=n.useState(!0),[s,k]=n.useState(new Date().getFullYear()),[j,p]=n.useState(new Date().getFullYear()-1),[m,T]=n.useState(null),[F,W]=n.useState(!1),[c,b]=n.useState("overview"),[v,N]=n.useState(""),[z,w]=n.useState([]),[R,de]=n.useState("all"),[C,Me]=n.useState("all"),[le,ra]=n.useState(null),[V,ze]=n.useState("all"),[Y,Le]=n.useState(null),J=n.useRef(null),Ae=xa(),Ie=n.useCallback(async()=>{try{i(!0);const a={year:s};v&&(a.pole=v),R!=="all"&&(a.project_id=R),C!=="all"&&(a.week=C);const x=await Qe(Ke.getAdminDashboard,"/dashboard/admin",a,3e4);o(x.data.data)}catch{ke.error(t("dashboard.loadFailed")||t("errors.failedToLoad"))}finally{i(!1)}},[s,v,R,C]),Oe=n.useCallback(async()=>{try{const a=await ma.getPoles(),x=a.data?.data?.poles||a.data?.poles||[];w(Array.isArray(x)?x:[])}catch{w([])}},[]),Be=n.useCallback(async()=>{if(!j){T(null);return}try{const a=await Qe(Ke.getAdminDashboard,"/dashboard/admin",{year:j},3e4);T(a.data.data??null)}catch(a){console.error("Failed to load comparison dashboard data",a),ke.error(t("dashboard.compareLoadFailed")??t("errors.failedToLoad"))}},[j]);n.useEffect(()=>{Ie(),Be()},[Ie,Be]),n.useEffect(()=>{Oe()},[Oe]),n.useEffect(()=>{p(s-1)},[s]);const Ee=n.useCallback(async a=>{W(!0);try{const x=a==="excel"?await Ve.exportExcel({year:s}):await Ve.exportPdf({year:s}),h=new Blob([x.data],{type:a==="excel"?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"application/pdf"}),u=window.URL.createObjectURL(h),f=document.createElement("a");f.href=u,f.download=`kpi_report_${s}.${a==="excel"?"xlsx":"pdf"}`,f.click(),window.URL.revokeObjectURL(u),ke.success(t("dashboard.exportSuccess"))}catch{ke.error(t("dashboard.exportFailed")||t("errors.somethingWentWrong"))}finally{W(!1)}},[s]),te=n.useMemo(()=>d?.stats??{},[d?.stats]),Ge=n.useMemo(()=>d?.kpi_summary??{},[d?.kpi_summary]),ue=n.useMemo(()=>d?.weekly_trends??[],[d?.weekly_trends]),pe=n.useMemo(()=>d?.project_performance??[],[d?.project_performance]),se=n.useMemo(()=>d?.weekly_status??[],[d?.weekly_status]),fe=n.useMemo(()=>d?.projects??[],[d?.projects]);n.useEffect(()=>{J.current&&(!Array.isArray(se)||se.length===0||requestAnimationFrame(()=>{J.current&&J.current.scrollTo({left:J.current.scrollWidth,behavior:"auto"})}))},[se,s]);const na=n.useMemo(()=>Ka(s),[s]),L=n.useMemo(()=>{if(C==="all")return ue;const a=Number(C);return Number.isNaN(a)?ue:(ue||[]).filter(x=>Number(x.week)===a)},[ue,C]),B=n.useMemo(()=>{if(R==="all")return pe;const a=Number(R);return Number.isNaN(a)?pe:(pe||[]).filter(x=>Number(x.id)===a)},[pe,R]),ye=n.useCallback((a,x,{higherIsBetter:h})=>{const u=Number(a??0),f=Number(x??0);if(u===f)return null;const g=h?u>f:u<f,y=f===0?100:Math.abs((u-f)/f*100),_=y>=10?Math.round(y):Math.round(y*10)/10,X=u>f?wa:Sa,je=g?"bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300":"bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-semibold ${je}`,children:[e.jsx(X,{className:"w-3.5 h-3.5"}),_,"%"]})},[]),I=n.useMemo(()=>d?.training_data||{},[d?.training_data]),re=n.useMemo(()=>d?.awareness_data||{},[d?.awareness_data]),ia=n.useMemo(()=>d?.sor_data||{},[d?.sor_data]);n.useMemo(()=>d?.permit_data||{},[d?.permit_data]);const O=n.useMemo(()=>d?.inspection_data||{},[d?.inspection_data]),ne=n.useMemo(()=>{const a=Array.isArray(fe)?fe:[];return v?a.filter(x=>x?.pole===v):a},[fe,v]),He=l?.project_list_preference||"code",Ye=n.useMemo(()=>Pa(ne,He),[ne,He]);n.useEffect(()=>{if(R==="all")return;ne.some(x=>String(x.id)===String(R))||de("all")},[ne,R]),n.useEffect(()=>{if(V==="all")return;ne.some(x=>String(x.id)===String(V))||ze("all")},[ne,V]);const oe=n.useMemo(()=>{if(C==="all")return I;const a=Number(C);if(Number.isNaN(a))return I;const h=(Array.isArray(I?.by_week)?I.by_week:[]).filter(y=>Number(y.week_number)===a),u=h.reduce((y,_)=>y+Number(_?.count??0),0),f=h.reduce((y,_)=>y+Number(_?.participants??0),0),g=h.reduce((y,_)=>y+Number(_?.hours??0),0);return{...I,total:u,total_participants:f,total_hours:g,by_week:h}},[I,C]),Ue=n.useMemo(()=>{if(C==="all")return O;const a=Number(C);if(Number.isNaN(a))return O;const h=(Array.isArray(O?.by_week)?O.by_week:[]).filter(f=>Number(f.week_number)===a),u=h.reduce((f,g)=>f+Number(g?.count??0),0);return{...O,stats:{...O?.stats||{},total:u},by_week:h}},[O,C]),da=n.useMemo(()=>{if(C==="all")return re;const a=Number(C);if(Number.isNaN(a))return re;const h=(Array.isArray(re?.by_week)?re.by_week:[]).filter(y=>Number(y.week_number)===a),u=h.reduce((y,_)=>y+Number(_?.count??0),0),f=h.reduce((y,_)=>y+Number(_?.participants??0),0),g=h.reduce((y,_)=>y+Number(_?.hours??0),0);return{...re,total:u,total_participants:f,total_hours:g,by_week:h}},[re,C]),S=n.useMemo(()=>{const a=Ge||{},x={...a,total_trainings:I?.total??a.total_trainings??0,employees_trained:I?.total_participants??a.employees_trained??0,total_training_hours:I?.total_hours??a.total_training_hours??0,total_inspections:O?.stats?.total??a.total_inspections??0};if(C!=="all"){const h=Array.isArray(L)?L:[],u=g=>h.reduce((y,_)=>y+Number(_?.[g]??0),0),f=g=>{if(h.length===0)return 0;const y=h.map(_=>Number(_?.[g]??0));return y.reduce((_,X)=>_+X,0)/y.length};return{...x,total_accidents:u("accidents"),fatal_accidents:u("fatal_accidents"),serious_accidents:u("serious_accidents"),minor_accidents:u("minor_accidents"),total_inspections:Ue?.stats?.total??u("inspections"),total_near_misses:u("near_misses"),total_work_permits:u("work_permits"),avg_tf:f("tf"),avg_tg:f("tg"),avg_hse_compliance:f("hse_compliance"),avg_medical_compliance:f("medical_compliance"),total_water_consumption:u("water"),total_electricity_consumption:u("electricity"),total_trainings:oe?.total??0,employees_trained:oe?.total_participants??0,total_training_hours:oe?.total_hours??0}}if(R!=="all"){const h=Array.isArray(B)?B[0]:null;if(h)return{...x,total_accidents:Number(h.total_accidents??0),total_trainings:Number(h.total_trainings??0),avg_tf:Number(h.avg_tf??0),avg_tg:Number(h.avg_tg??0)}}return x},[Ge,I,O,oe,Ue,L,C,R,B]),la=n.useCallback(a=>{if(!a||!a.activeLabel)return;const x=a.activeLabel,h=L.find(u=>u.week_label===x);if(h){ra(h);const u=new URLSearchParams;let f=h.week;if(!f&&typeof x=="string"){const y=parseInt(x.replace(/\D/g,""),10);Number.isNaN(y)||(f=y)}f&&u.set("week",f);const g=h.year||s;g&&u.set("year",g),Ae(`/admin/kpi?${u.toString()}`)}},[L,s,Ae]),oa=n.useMemo(()=>[...Array(5)].map((a,x)=>new Date().getFullYear()-x),[]);return r?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(Ca,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:t("dashboard.adminTitle")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:t("dashboard.overview")})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 px-3 py-2",children:[e.jsx(Ta,{className:"w-4 h-4 text-gray-400"}),e.jsx("select",{value:s,onChange:a=>k(Number(a.target.value)),className:"bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-none focus:ring-0 text-sm font-medium",children:oa.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>Ee("excel"),disabled:F,className:"btn-secondary flex items-center gap-2",children:[e.jsx(Ma,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.exportExcel")})]}),e.jsxs("button",{onClick:()=>Ee("pdf"),disabled:F,className:"btn-secondary flex items-center gap-2",children:[e.jsx(Je,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("dashboard.exportPdf")})]})]})]})]}),e.jsx(Wa,{activeTheme:c,onThemeChange:b}),e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-end gap-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white/70 dark:bg-gray-900/40 px-3 py-2 w-full sm:w-auto",children:[e.jsxs("select",{value:v,onChange:a=>N(a.target.value),className:"bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-none focus:ring-0 text-sm w-full sm:w-auto",children:[e.jsx("option",{value:"",children:t("common.allPoles")}),z.map(a=>e.jsx("option",{value:a,children:a},a))]}),e.jsx("span",{className:"hidden sm:block w-px h-5 bg-gray-200 dark:bg-gray-700"}),e.jsxs("select",{value:R,onChange:a=>de(a.target.value),className:"bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-none focus:ring-0 text-sm w-full sm:w-auto",children:[e.jsx("option",{value:"all",children:t("common.allProjects")}),Ye.map(a=>e.jsx("option",{value:a.id,children:Xe(a)},a.id))]}),e.jsx("span",{className:"hidden sm:block w-px h-5 bg-gray-200 dark:bg-gray-700"}),e.jsxs("select",{value:C,onChange:a=>Me(a.target.value),className:"bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-none focus:ring-0 text-sm w-full sm:w-auto",children:[e.jsx("option",{value:"all",children:t("common.all")}),na.map(a=>e.jsx("option",{value:a.week,children:a.label},a.week))]})]})}),c==="safety"&&e.jsx(za,{kpiSummary:S,weeklyTrends:L,projectPerformance:B}),c==="training"&&e.jsx(La,{kpiSummary:S,weeklyTrends:L,projectPerformance:B,trainingData:oe,awarenessData:da}),c==="compliance"&&e.jsx(Oa,{kpiSummary:S,weeklyTrends:L,projectPerformance:B,inspectionData:O,sorData:ia}),c==="deviations"&&e.jsx(Ea,{year:s,projects:fe,projectId:R,week:C}),c==="environmental"&&e.jsx(Ba,{kpiSummary:S,weeklyTrends:L}),c==="overview"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Se,{title:t("dashboard.totalProjects"),value:te.total_projects??0,subtitle:`${te.active_projects??0} ${t("dashboard.activeLabel")}`,icon:Aa,color:"blue"}),e.jsx(Se,{title:t("dashboard.totalUsers"),value:te.total_users??0,subtitle:`${te.active_users??0} ${t("dashboard.activeLabel")}`,icon:Ce,color:"green"}),e.jsx(Se,{title:t("dashboard.pendingReports"),value:te.pending_reports??0,subtitle:t("dashboard.awaitingApproval"),icon:he,color:"amber"}),e.jsx(Se,{title:t("dashboard.totalReports"),value:te.total_reports??0,subtitle:t("dashboard.inYear",{year:s}),icon:Je,color:"purple"})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(me,{title:t("dashboard.safety.totalAccidents"),value:S.total_accidents??0,icon:ge,color:S.total_accidents>0?"red":"green",trend:S.fatal_accidents>0?`${S.fatal_accidents} ${t("dashboard.safety.fatal")}`:t("dashboard.safety.noFatalities")}),e.jsx(me,{title:t("dashboard.training.totalTrainings"),value:S.total_trainings??0,icon:Te,color:"blue",trend:`${S.employees_trained??0} ${t("dashboard.training.employeesTrained")}`}),e.jsx(me,{title:t("dashboard.compliance.totalInspections"),value:S.total_inspections??0,icon:he,color:"green"}),e.jsx(me,{title:t("dashboard.avgTf"),value:Number(S.avg_tf??0).toFixed(2),icon:ta,color:"amber",trend:t("dashboard.rates.frequencyRate")}),e.jsx(me,{title:t("dashboard.avgTg"),value:Number(S.avg_tg??0).toFixed(2),icon:aa,color:"purple",trend:t("dashboard.rates.severityRate")})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("dashboard.weeklyKpiTrends")})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"h-80",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(We,{data:L,onClick:la,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week_label",tick:{fontSize:10},interval:"preserveStartEnd"}),e.jsx($,{tick:{fontSize:12}}),e.jsx(A,{labelFormatter:a=>`${t("dashboard.weekPrefix")} ${a.replace("S","")}`}),e.jsx(G,{}),e.jsx(q,{type:"monotone",dataKey:"accidents",stroke:"#dc2626",strokeWidth:2,dot:{fill:"#dc2626",r:3},name:t("dashboard.accidents")}),e.jsx(q,{type:"monotone",dataKey:"trainings",stroke:"#3b82f6",strokeWidth:2,dot:{fill:"#3b82f6",r:3},name:t("dashboard.training.totalTrainings")}),e.jsx(q,{type:"monotone",dataKey:"inspections",stroke:"#16a34a",strokeWidth:2,dot:{fill:"#16a34a",r:3},name:t("dashboard.inspections")})]})})}),le&&e.jsxs("div",{className:"mt-4 text-xs text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"font-semibold",children:t("dashboard.detailsForWeek",{week:le.week_label})}),e.jsx("button",{type:"button",onClick:()=>Ae("/admin/kpi"),className:"btn-secondary btn-sm",children:t("dashboard.viewKpiReports")})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:t("dashboard.accidents")}),e.jsx("p",{className:"font-semibold",children:le.accidents??0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:t("dashboard.training.totalTrainings")}),e.jsx("p",{className:"font-semibold",children:le.trainings??0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:t("dashboard.inspections")}),e.jsx("p",{className:"font-semibold",children:le.inspections??0})]})]})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("dashboard.tfTgRates")})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"h-80",children:e.jsx(M,{width:"100%",height:"100%",children:e.jsxs(sa,{data:L,children:[e.jsx(P,{strokeDasharray:"3 3",stroke:"#f0f0f0",className:"dark:opacity-20"}),e.jsx(D,{dataKey:"week_label",tick:{fontSize:10},interval:"preserveStartEnd"}),e.jsx($,{yAxisId:"left",tick:{fontSize:12},stroke:"#f59e0b",label:{value:t("dashboard.rates.frequencyRate"),angle:-90,position:"insideLeft",style:{fill:"#f59e0b"}}}),e.jsx($,{yAxisId:"right",orientation:"right",tick:{fontSize:12},stroke:"#8b5cf6",label:{value:t("dashboard.rates.severityRate"),angle:90,position:"insideRight",style:{fill:"#8b5cf6"}}}),e.jsx(A,{labelFormatter:a=>`${t("dashboard.weekPrefix")} ${a.replace("S","")}`,formatter:(a,x)=>[Number(a).toFixed(4),x]}),e.jsx(G,{}),e.jsx(H,{yAxisId:"left",dataKey:"tf",fill:"#f59e0b",name:t("dashboard.rates.frequencyRate"),radius:[4,4,0,0]}),e.jsx(H,{yAxisId:"right",dataKey:"tg",fill:"#8b5cf6",name:t("dashboard.rates.severityRate"),radius:[4,4,0,0]})]})})})})]})]}),se.filter(a=>a.total_projects>0).length>0&&e.jsxs("div",{className:"card mt-6",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("dashboard.submissionStatus")}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("select",{value:V,onChange:a=>ze(a.target.value),className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-sm font-medium dark:text-gray-200 focus:ring-2 focus:ring-hse-primary",children:[e.jsx("option",{value:"all",children:t("common.allProjects")}),Ye.map(a=>e.jsx("option",{value:a.id,children:Xe(a)},a.id))]})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{type:"button",onClick:()=>J.current?.scrollBy({left:-300,behavior:"smooth"}),className:"absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-gray-700/90 hover:bg-white dark:hover:bg-gray-600 shadow-lg rounded-full p-2 border dark:border-gray-600",children:e.jsx($a,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"})}),e.jsx("button",{type:"button",onClick:()=>J.current?.scrollBy({left:300,behavior:"smooth"}),className:"absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-gray-700/90 hover:bg-white dark:hover:bg-gray-600 shadow-lg rounded-full p-2 border dark:border-gray-600",children:e.jsx(Ra,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"})}),e.jsx("div",{ref:J,className:"flex gap-2 overflow-x-auto scroll-smooth px-10 py-3 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",style:{scrollbarWidth:"thin"},children:(()=>{const a=Re(),x=s<a.year?52:a.week;return Array.from({length:x},(h,u)=>u+1)})().map(a=>{const x=se.find(E=>E.week===a),h=Re(),u=s<h.year||s===h.year&&a<h.week,f=a===h.week&&s===h.year;let g="not_submitted";const y=x?.projects||[];V==="all"?g=x?.status||"not_submitted":g=y.find(qe=>qe.project_id===parseInt(V))?.status||"not_submitted";const _=x?.approved_count??0,X=x?.submitted_count??0,je=x?.draft_count??0,ce=x?.total_projects??0;if(ce<=0)return null;let $e="";if(g==="partial"&&ce>0){const E=[];_>0&&E.push("rgb(34, 197, 94)"),X>0&&E.push("rgb(251, 191, 36)"),je>0&&E.push("rgb(96, 165, 250)"),ce-_-X-je>0&&E.push("rgb(254, 202, 202)"),$e=E.length>1?`linear-gradient(135deg, ${E.join(", ")})`:""}return e.jsxs("div",{"data-week":a,className:`relative flex-shrink-0 w-14 p-2 rounded-lg text-center transition-all cursor-pointer ${Y===a?"ring-2 ring-gray-900 ring-offset-2 scale-110":""} ${f&&Y!==a?"ring-2 ring-hse-primary ring-offset-2":""} ${g==="approved"?"bg-green-500 text-white":g==="partial"?"text-white":g==="submitted"?"bg-amber-400 text-white":g==="draft"?"bg-blue-400 text-white":u?"bg-red-100 text-red-600 hover:bg-red-200":"bg-gray-100 text-gray-500"}`,style:g==="partial"&&$e?{background:$e}:{},onClick:()=>Le(Y===a?null:a),children:[e.jsxs("p",{className:"text-xs font-medium",children:[t("dashboard.weekShortPrefix"),a]}),V==="all"&&ce>1?e.jsxs("p",{className:"text-xs font-bold mt-0.5",children:[_+X,"/",ce]}):e.jsx("p",{className:"text-lg font-bold mt-0.5",children:g==="approved"?"✓":g==="partial"?"◐":g==="submitted"?"⏳":g==="draft"?"📝":u?"!":"-"})]},`admin-week-${s}-${a}`)})})]}),Y&&(()=>{const x=se.find(g=>g.week===Y)?.projects||[],h=Re(),u=Y===h.week&&s===h.year,f=s<h.year||s===h.year&&Y<h.week;return x.length===0?null:e.jsxs("div",{className:"mt-3 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-700 pb-2 mb-2",children:[e.jsxs("p",{className:"font-semibold",children:[t("dashboard.weekDetailsTitle").replace("{{week}}",Y),u&&e.jsxs("span",{className:"ml-2 text-hse-primary",children:["(",t("dashboard.currentWeekLabel"),")"]})]}),e.jsx("button",{type:"button",onClick:()=>Le(null),className:"text-gray-400 hover:text-white",children:"✕"})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:x.map(g=>{const _=g.status==="not_submitted"&&f;return e.jsxs("div",{className:"flex items-center justify-between gap-2 bg-gray-800 rounded px-2 py-1.5",children:[e.jsx("span",{className:"truncate font-medium",children:g.project_code}),e.jsx("span",{className:`flex-shrink-0 px-1.5 py-0.5 rounded text-[10px] font-medium ${g.status==="approved"?"bg-green-500":g.status==="submitted"?"bg-amber-400":g.status==="draft"?"bg-blue-400":_?"bg-red-400":"bg-gray-500"}`,children:g.status==="approved"?t("status.approved"):g.status==="submitted"?t("status.pending"):g.status==="draft"?t("status.draft"):t(_?"status.missing":"status.notSubmitted")})]},g.project_id)})})]})})(),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4 pt-4 mt-2 border-t dark:border-gray-700 text-xs text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-green-500"})," ",t("status.approved")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-gradient-to-br from-green-400 to-amber-400"})," ",t("status.partial")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-amber-400"})," ",t("status.pending")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-blue-400"})," ",t("status.draft")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-red-100 border border-red-200"})," ",t("status.missing")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded ring-2 ring-hse-primary ring-offset-1"})," ",t("dashboard.currentWeekLabel")]})]})]})]}),m&&e.jsxs("div",{className:"card mt-6",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("dashboard.yearOverYearSummary",{year:s,compareYear:j})})}),e.jsxs("div",{className:"card-body grid grid-cols-1 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx("span",{children:t("dashboard.safety.totalAccidents")}),ye(S.total_accidents,m?.kpi_summary?.total_accidents,{higherIsBetter:!1})]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[S.total_accidents??0," ",e.jsxs("span",{className:"text-xs text-gray-400",children:["(",s,")"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[m?.kpi_summary?.total_accidents??0," (",j,")"]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx("span",{children:t("dashboard.training.totalTrainings")}),ye(S.total_trainings,m?.training_data?.total??m?.kpi_summary?.total_trainings,{higherIsBetter:!0})]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[S.total_trainings??0," ",e.jsxs("span",{className:"text-xs text-gray-400",children:["(",s,")"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[m?.training_data?.total??m?.kpi_summary?.total_trainings??0," (",j,")"]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx("span",{children:t("dashboard.inspections")}),ye(S.total_inspections,m?.inspection_data?.stats?.total??m?.kpi_summary?.total_inspections,{higherIsBetter:!0})]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[S.total_inspections??0," ",e.jsxs("span",{className:"text-xs text-gray-400",children:["(",s,")"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[m?.inspection_data?.stats?.total??m?.kpi_summary?.total_inspections??0," (",j,")"]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx("span",{children:t("dashboard.tfTgRates")}),ye(Number(S.avg_tf??0)+Number(S.avg_tg??0),Number(m?.kpi_summary?.avg_tf??0)+Number(m?.kpi_summary?.avg_tg??0),{higherIsBetter:!1})]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[Number(S.avg_tf??0).toFixed(2)," / ",Number(S.avg_tg??0).toFixed(2),e.jsxs("span",{className:"text-xs text-gray-400",children:[" (",s,")"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[Number(m?.kpi_summary?.avg_tf??0).toFixed(2)," / ",Number(m?.kpi_summary?.avg_tg??0).toFixed(2)," (",j,")"]})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("dashboard.projectPerformance")}),e.jsx(ha,{to:"/admin/projects",className:"text-sm text-hse-primary hover:underline",children:t("dashboard.viewAllProjects")})]}),B.length===0?e.jsx("div",{className:"p-6 text-center text-sm text-gray-500 dark:text-gray-400",children:t("dashboard.noProjectData")}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 p-4 md:hidden",children:B.slice(0,5).map(a=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a.code})]}),e.jsxs("div",{className:"text-right text-xs text-gray-600 dark:text-gray-300 space-y-1",children:[e.jsxs("p",{children:[e.jsxs("span",{className:"font-semibold",children:[t("dashboard.reports"),":"]})," ",a.reports_count]}),e.jsxs("p",{children:[e.jsxs("span",{className:"font-semibold",children:[t("dashboard.training.totalTrainings"),":"]})," ",a.total_trainings]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{children:[t("dashboard.accidents"),": ",e.jsx("span",{className:a.total_accidents>0?"text-red-600 dark:text-red-400 font-semibold":"text-green-600 dark:text-green-400",children:a.total_accidents})]}),e.jsxs("span",{children:["TF: ",Number(a.avg_tf).toFixed(2)," • TG: ",Number(a.avg_tg).toFixed(2)]})]})]},a.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:t("common.project")}),e.jsx("th",{children:t("dashboard.reports")}),e.jsx("th",{children:t("dashboard.accidents")}),e.jsx("th",{children:t("dashboard.training.totalTrainings")}),e.jsx("th",{children:t("dashboard.avgTf")}),e.jsx("th",{children:t("dashboard.avgTg")})]})}),e.jsx("tbody",{children:B.slice(0,5).map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium dark:text-gray-100",children:a.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a.code})]})}),e.jsx("td",{children:a.reports_count}),e.jsx("td",{children:e.jsx("span",{className:a.total_accidents>0?"text-red-600 dark:text-red-400 font-semibold":"text-green-600 dark:text-green-400",children:a.total_accidents})}),e.jsx("td",{children:a.total_trainings}),e.jsx("td",{children:Number(a.avg_tf).toFixed(2)}),e.jsx("td",{children:Number(a.avg_tg).toFixed(2)})]},a.id))})]})})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("dashboard.recentSubmissions")})}),e.jsx("div",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:d?.recent_reports?.filter(a=>a.status!=="draft").slice(0,5).map(a=>e.jsx("div",{className:"p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.project?.name||"Unknown Project"}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[a.report_month,"/",a.report_year," • Submitted by ",a.submitter?.name]})]}),e.jsx("span",{className:`badge ${a.status==="approved"?"badge-success":a.status==="submitted"?"badge-warning":a.status==="rejected"?"badge-danger":"badge-info"}`,children:a.status})]})},a.id))})]})]})]})}const Se=n.memo(function({title:l,value:d,subtitle:o,icon:r,color:i}){const s={blue:"bg-blue-50 text-blue-600",green:"bg-green-50 text-green-600",amber:"bg-amber-50 text-amber-600",purple:"bg-purple-50 text-purple-600",red:"bg-red-50 text-red-600"};return e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:l}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1",children:d}),e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:o})]}),e.jsx("div",{className:`p-3 rounded-lg ${s[i]}`,children:e.jsx(r,{className:"w-5 h-5"})})]})})}),me=n.memo(function({title:l,value:d,icon:o,color:r,trend:i}){const s={red:"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/50",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50",blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50"},k={red:"text-red-600 dark:text-red-400",green:"text-green-600 dark:text-green-400",blue:"text-blue-600 dark:text-blue-400",amber:"text-amber-600 dark:text-amber-400",purple:"text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${s[r]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(o,{className:`w-5 h-5 ${k[r]}`}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:l})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:d}),i&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:i})]})});export{Xa as default};

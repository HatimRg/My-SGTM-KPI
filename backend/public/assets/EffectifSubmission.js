import{a as B,u as G,H as v,j as e}from"./index.js";import{r as a}from"./vendor-react.js";import{z as l}from"./vendor-ui.js";import{D as b}from"./DatePicker.js";import{S as W}from"./Select.js";import{u as J}from"./projectStore.js";import{s as O,g as L}from"./projectList.js";import{R as Q,i as U,C as V,X as Z,Y as ee,T as te,c as se}from"./vendor-charts.js";import"./vendor-utils.js";function me(){const{t:s}=B(),y=a.useCallback(t=>{if(!t)return"-";const r=String(t).split("T")[0],c=new Date(`${r}T00:00:00`);if(Number.isNaN(c.getTime()))return r;const I=String(c.getDate()).padStart(2,"0"),K=String(c.getMonth()+1).padStart(2,"0"),X=String(c.getFullYear());return`${I}/${K}/${X}`},[]),{user:T}=G(),{fetchProjects:N}=J(),[S,k]=a.useState([]),[w,D]=a.useState(!1),[i,R]=a.useState(""),[n,M]=a.useState(()=>{const t=new Date,o=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0");return`${o}-${r}-${c}`}),[h,d]=a.useState(""),[_,E]=a.useState(!1),[P,C]=a.useState(!1),[m,z]=a.useState(""),[u,Y]=a.useState(""),[f,j]=a.useState([]),[g,A]=a.useState(!1),F=T?.project_list_preference||"code";a.useEffect(()=>{let t=!0;return(async()=>{D(!0);try{const r=await N({},{force:!0});if(!t)return;k(Array.isArray(r)?r:[])}catch{if(!t)return;k([]),l.error(s("effectif.loadProjectsFailed"))}finally{t&&D(!1)}})(),()=>{t=!1}},[N,s]);const p=a.useMemo(()=>O(S,F),[S,F]),$=a.useMemo(()=>i?p.find(t=>String(t.id)===String(i))??null:null,[p,i]);a.useEffect(()=>{if(!i||!n){d("");return}let t=!0;return(async()=>{E(!0);try{const r=await v.entry({project_id:i,entry_date:n});if(!t)return;const c=r.data?.data?.entry;d(c?.effectif!=null?String(c.effectif):"")}catch{if(!t)return;d("")}finally{t&&E(!1)}})(),()=>{t=!1}},[i,n]);const x=a.useCallback(async()=>{if(!i){j([]);return}A(!0);try{const t={project_id:i};m&&(t.from_date=m),u&&(t.to_date=u);const r=(await v.list(t)).data?.data?.entries??[];j(Array.isArray(r)?r:[])}catch{j([]),l.error(s("effectif.loadFailed"))}finally{A(!1)}},[i,m,u,s]);a.useEffect(()=>{x()},[x]);const q=async()=>{if(!i){l.error(s("effectif.projectRequired"));return}if(!n){l.error(s("effectif.dateRequired"));return}const t=h===""?null:Number(h);if(t===null||Number.isNaN(t)||t<0){l.error(s("effectif.effectifInvalid"));return}C(!0);try{await v.upsert({project_id:i,entry_date:n,effectif:t}),l.success(s("effectif.saveSuccess")),x()}catch{l.error(s("effectif.saveFailed"))}finally{C(!1)}},H=a.useMemo(()=>[...Array.isArray(f)?f:[]].sort((r,c)=>String(r?.entry_date??"").localeCompare(String(c?.entry_date??""))).map(r=>({entry_date:String(r?.entry_date??""),effectif:Number(r?.effectif??0)})),[f]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[s("nav.dashboard")," / ",s("effectif.title")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:s("effectif.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:s("effectif.subtitleHr")})]}),e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:s("effectif.whySubmitTitle")}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:s("effectif.whySubmitBody")})]}),e.jsxs("div",{className:"card p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("effectif.project")}),e.jsxs(W,{value:i,onChange:t=>R(t.target.value),disabled:w,children:[e.jsx("option",{value:"",children:s("common.select")}),p.map(t=>e.jsx("option",{value:String(t.id),children:L(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("effectif.date")}),e.jsx(b,{value:n,onChange:t=>M(t),placeholder:s("effectif.date")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("effectif.effectif")}),e.jsx("input",{type:"number",min:"0",step:"1",className:"input",value:h,onChange:t=>d(t.target.value),disabled:!i||!n||_,placeholder:s("effectif.effectifPlaceholder")}),_?e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:s("common.loading")}):null]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("button",{type:"button",className:"btn-primary",onClick:q,disabled:P||w,children:s(P?"common.saving":"common.save")})})]}),e.jsxs("div",{className:"card p-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:s("effectif.subtitleAnalytics")}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[s("effectif.project")," : ",$?L($):"-"]})]}),e.jsxs("div",{className:"w-full sm:w-40",children:[e.jsx("label",{className:"label text-xs",children:s("effectif.fromDate")}),e.jsx(b,{value:m,onChange:t=>z(t),placeholder:s("effectif.fromDate")})]}),e.jsxs("div",{className:"w-full sm:w-40",children:[e.jsx("label",{className:"label text-xs",children:s("effectif.toDate")}),e.jsx(b,{value:u,onChange:t=>Y(t),placeholder:s("effectif.toDate")})]}),e.jsx("button",{type:"button",className:"btn-secondary w-full sm:w-auto",onClick:x,disabled:g||!i,children:s(g?"common.loading":"common.refresh")})]}),e.jsx("div",{className:"h-64 mt-4",children:g?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-400",children:s("common.loading")}):H.length>0?e.jsx(Q,{width:"100%",height:"100%",children:e.jsxs(U,{data:H,children:[e.jsx(V,{strokeDasharray:"3 3",className:"dark:opacity-20"}),e.jsx(Z,{dataKey:"entry_date",tick:{fontSize:12},className:"dark:text-gray-400",tickFormatter:y}),e.jsx(ee,{tick:{fontSize:12},className:"dark:text-gray-400"}),e.jsx(te,{labelFormatter:t=>y(t)}),e.jsx(se,{type:"monotone",dataKey:"effectif",stroke:"#16a34a",name:s("effectif.effectif"),strokeWidth:2,dot:!1})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-400",children:s(i?"common.noData":"effectif.projectRequired")})}),e.jsx("div",{className:"mt-4 overflow-x-auto",children:e.jsxs("table",{className:"table w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:s("effectif.date")}),e.jsx("th",{children:s("effectif.effectif")})]})}),e.jsx("tbody",{children:(Array.isArray(f)?f:[]).slice(0,50).map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:y(t?.entry_date)}),e.jsx("td",{children:t?.effectif??"-"})]},`${t?.project_id??""}-${String(t?.entry_date??"")}`))})]})})]})]})}export{me as default};

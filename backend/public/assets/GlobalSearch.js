import{a as Z,u as ee,j as e,H as ae,o as H}from"./index.js";import{r as n}from"./vendor-react.js";import{ag as te,k as se,v as F,T as re,I as ne,ao as le,h as ce,z as C}from"./vendor-ui.js";import{M as ie}from"./Modal.js";import"./vendor-utils.js";const de=50,o=new Map;function ue(){const{t}=Z(),{token:p}=ee(),[u,w]=n.useState(""),[k,K]=n.useState(""),[G,$]=n.useState(!1),[E,O]=n.useState(!1),[f,_]=n.useState(null),[D,M]=n.useState(!1),[x,j]=n.useState({info:!0,documents:!0,preview:!0}),[g,S]=n.useState(null),[i,U]=n.useState(null),[X,L]=n.useState(!1),A=a=>!a||typeof a!="string"?null:a.startsWith("/api/")?a.slice(4):a.startsWith("api/")?a.slice(3):a,W=({machineId:a,updatedAt:r,alt:l,className:c})=>{const[h,y]=n.useState(null);return n.useEffect(()=>{if(!a||!p){y(null);return}let m=!1;const R=r?encodeURIComponent(String(r)):"",Y=`/api/heavy-machinery/machines/${a}/image${R?`?v=${R}`:""}`,b=`${p}::${a}::${R}`,v=o.get(b);if(v?.objectUrl)return y(v.objectUrl),()=>{m=!0};if(v?.pending)return v.pending.then(d=>{m||y(d)}).catch(()=>{m||y(null)}),()=>{m=!0};const I=(async()=>{const d=await fetch(Y,{headers:{Authorization:`Bearer ${p}`}});if(!d.ok)throw new Error(`image fetch failed: ${d.status}`);const N=await d.blob();return URL.createObjectURL(N)})();return o.set(b,{pending:I}),(async()=>{try{const d=await I;for(o.set(b,{objectUrl:d});o.size>de;){const N=o.keys().next().value,B=o.get(N);o.delete(N),B?.objectUrl&&URL.revokeObjectURL(B.objectUrl)}m||y(d)}catch{o.delete(b),m||y(null)}})(),()=>{m=!0}},[a,p,r]),h?e.jsx("img",{src:h,alt:l,className:c,loading:"lazy"}):null},q=a=>{if(!a)return null;const r=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(a),l=decodeURIComponent(r?.[1]??r?.[2]??"");return l!==""?l:null},Q=(a,r)=>{const l=URL.createObjectURL(a),c=document.createElement("a");c.href=l,c.download=r??"file.pdf",document.body.appendChild(c),c.click(),c.remove(),setTimeout(()=>URL.revokeObjectURL(l),5e3)};n.useEffect(()=>{const a=setTimeout(()=>{K(u.trim())},350);return()=>clearTimeout(a)},[u]),n.useEffect(()=>{(async()=>{if(!k){O(!1),_(null);return}try{$(!0),O(!0);const r=await ae.globalSearch(k);_(r.data?.data??null)}catch(r){C.error(r.response?.data?.message??t("errors.somethingWentWrong")),_(null)}finally{$(!1)}})()},[k,t]),n.useEffect(()=>()=>{i&&URL.revokeObjectURL(i)},[i]);const s=f?.machine??null,T=n.useMemo(()=>Array.isArray(f?.documents)?f.documents:[],[f]),J=async a=>{if(a?.file_view_url)try{S(a),L(!0),j(h=>({...h,preview:!0})),i&&(URL.revokeObjectURL(i),U(null));const r=A(a.file_view_url),l=await H.get(r,{responseType:"blob"}),c=URL.createObjectURL(l.data);U(c)}catch(r){C.error(r.response?.data?.message??t("errors.somethingWentWrong")),S(null)}finally{L(!1)}},P=()=>{S(null),L(!1),i&&(URL.revokeObjectURL(i),U(null))},V=()=>{M(!1),P()},z=async a=>{if(a?.file_download_url)try{const r=A(a.file_download_url),l=await H.get(r,{responseType:"blob"}),c=q(l.headers?.["content-disposition"]),h=`${a.document_key??"document"}.pdf`;Q(l.data,c??h)}catch(r){C.error(r.response?.data?.message??t("errors.somethingWentWrong"))}};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:t("heavyMachinery.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:t("heavyMachinery.globalSearch.title")})]}),e.jsxs("div",{className:"card p-4 md:p-6 space-y-3",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{className:"input pl-10 pr-10",value:u,onChange:a=>w(a.target.value),placeholder:t("heavyMachinery.globalSearch.searchPlaceholder")}),u&&e.jsx("button",{type:"button",onClick:()=>w(""),className:"absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800",title:t("common.clear")??t("common.reset"),children:e.jsx(se,{className:"w-4 h-4 text-gray-500"})})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{type:"button",className:"btn-outline",onClick:()=>w(""),disabled:!u&&!E,children:t("common.reset")})})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:t("heavyMachinery.globalSearch.help")})]}),e.jsx("div",{className:"card p-4 md:p-6",children:G?e.jsx("div",{className:"flex items-center justify-center py-10",children:e.jsx(F,{className:"w-6 h-6 animate-spin text-hse-primary"})}):E?s?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{role:"button",tabIndex:0,onClick:()=>M(!0),onKeyDown:a=>{a.key==="Enter"&&M(!0)},className:"card p-4 text-left hover:shadow-md transition-shadow cursor-pointer max-w-4xl mx-auto",children:[s.image_url&&e.jsx("div",{className:"mb-3",children:e.jsx("div",{className:"w-full h-48 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 overflow-hidden flex items-center justify-center",children:e.jsx(W,{machineId:s.id,updatedAt:s.updated_at,alt:s.serial_number,className:"w-full h-full object-contain"})})}),e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-100 truncate",children:s.internal_code?`${s.internal_code} · ${s.serial_number}`:s.serial_number}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 truncate",children:(s.machine_type??"")+(s.brand?` · ${s.brand}`:"")+(s.model?` · ${s.model}`:"")}),e.jsx("p",{className:"text-[11px] text-gray-500 dark:text-gray-400 mt-1 truncate",children:s.project?.name??"-"})]}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-[11px] ${s.is_active?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-200":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"}`,children:s.is_active?t("common.active"):t("common.inactive")})]})]}),D&&e.jsx(ie,{isOpen:D,onClose:V,title:t("heavyMachinery.viewMachines.details"),size:"full",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsx("div",{className:"w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 overflow-hidden",children:s.image_url?e.jsx("div",{className:"w-full",children:e.jsx(W,{machineId:s.id,updatedAt:s.updated_at,alt:s.serial_number??"machine",className:"w-full h-72 object-contain"})}):e.jsx("div",{className:"w-full h-72 flex items-center justify-center text-sm text-gray-500",children:t("common.noData")})}),e.jsxs("div",{className:"min-w-0 flex flex-col justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.project?.name??"-"}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 dark:text-gray-100 truncate",children:s.internal_code?`${s.internal_code} · ${s.serial_number}`:s.serial_number}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1",children:(s.machine_type??"")+(s.brand?` · ${s.brand}`:"")+(s.model?` · ${s.model}`:"")}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-[11px] ${s.is_active?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-200":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"}`,children:s.is_active?t("common.active"):t("common.inactive")})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"shrink-0 w-10 h-10 rounded-lg bg-hse-primary/10 flex items-center justify-center",children:e.jsx(re,{className:"w-5 h-5 text-hse-primary"})}),e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-300",children:t("heavyMachinery.viewMachines.tabs.documents")})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"card p-4",children:[e.jsxs("button",{type:"button",onClick:()=>j(a=>({...a,info:!a.info})),className:"w-full flex items-center justify-between gap-3",children:[e.jsx("span",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:t("heavyMachinery.viewMachines.details")}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:x.info?"−":"+"})]}),x.info&&e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.machine.serial")}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100 font-medium",children:s.serial_number??"-"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.machine.internal")}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100 font-medium",children:s.internal_code??"-"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.machine.type")}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100 font-medium",children:s.machine_type??"-"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.machine.brand")}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100 font-medium",children:s.brand??"-"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.machine.model")}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100 font-medium",children:s.model??"-"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.machine.project")}),e.jsx("span",{className:"text-gray-900 dark:text-gray-100 font-medium",children:s.project?.name??"-"})]})]})]}),e.jsxs("div",{className:"card p-4",children:[e.jsxs("button",{type:"button",onClick:()=>j(a=>({...a,documents:!a.documents})),className:"w-full flex items-center justify-between gap-3",children:[e.jsx("span",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:t("heavyMachinery.viewMachines.tabs.documents")}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:x.documents?"−":"+"})]}),x.documents&&e.jsx("div",{className:"mt-4 overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.documents.label")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.documents.startDate")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:t("heavyMachinery.viewMachines.documents.expiryDate")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:t("common.actions")})]})}),e.jsx("tbody",{children:T.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-4 text-center text-gray-500 dark:text-gray-400",children:t("common.noData")})}):T.map(a=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsxs("td",{className:"py-2 pr-3 text-gray-900 dark:text-gray-100",children:[e.jsx("div",{className:"font-medium",children:a.document_label}),e.jsx("div",{className:"text-[11px] text-gray-500 dark:text-gray-400",children:a.document_key})]}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:a.start_date??""}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:a.expiry_date??""}),e.jsx("td",{className:"py-2 pr-3",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[a.file_view_url&&e.jsxs("button",{type:"button",className:"btn-outline btn-sm flex items-center gap-2",onClick:()=>J(a),children:[e.jsx(ne,{className:"w-4 h-4"}),t("common.view")]}),a.file_download_url&&e.jsxs("button",{type:"button",className:"btn-outline btn-sm flex items-center gap-2",onClick:()=>z(a),children:[e.jsx(le,{className:"w-4 h-4"}),t("common.download")]})]})})]},a.id))})]})})]}),e.jsxs("div",{className:"card p-4",children:[e.jsxs("button",{type:"button",onClick:()=>j(a=>({...a,preview:!a.preview})),className:"w-full flex items-center justify-between gap-3",children:[e.jsx("span",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:t("common.view")}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:x.preview?"−":"+"})]}),x.preview&&e.jsx("div",{className:"mt-4 space-y-3",children:g?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 truncate",children:g.document_label}),e.jsx("div",{className:"text-[11px] text-gray-500 dark:text-gray-400 truncate",children:g.document_key})]}),e.jsx("button",{type:"button",onClick:P,className:"btn-outline btn-sm",children:t("common.close")})]}),e.jsx("div",{className:"h-[70vh]",children:X?e.jsx("div",{className:"w-full h-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 flex items-center justify-center",children:e.jsx(F,{className:"w-6 h-6 animate-spin text-hse-primary"})}):i?e.jsx("iframe",{src:i,title:t("common.view"),className:"w-full h-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white"}):e.jsx("div",{className:"w-full h-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 flex items-center justify-center text-sm text-gray-500 dark:text-gray-400",children:t("errors.somethingWentWrong")})}),g?.file_download_url&&e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"button",onClick:()=>z(g),className:"btn-primary inline-flex items-center gap-2 text-sm",children:[e.jsx(ce,{className:"w-4 h-4"}),t("common.download")]})})]}):e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:t("common.noData")})})]})]})]})})]}):e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:t("heavyMachinery.globalSearch.noResult")}):e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:t("heavyMachinery.globalSearch.help")})})]})}export{ue as default};

import{a as pe,u as he,p as Q,v as w,j as e,g as xe}from"./index.js";import{r as l}from"./vendor-react.js";import{C as me}from"./ConfirmDialog.js";import{M as ue}from"./Modal.js";import{D as O}from"./DatePicker.js";import{S as x}from"./Select.js";import{s as je,g as V}from"./projectList.js";import{v as $,c as X,ae as ge,ad as ve,a9 as ye,s as F,q,aB as be,aj as fe,z as o}from"./vendor-ui.js";import"./vendor-utils.js";const Y=[{value:"sst",labelKey:"sst"},{value:"environment",labelKey:"environment"},{value:"third_party",labelKey:"thirdParty"},{value:"equipment",labelKey:"equipment"},{value:"other",labelKey:"other"}],ee=t=>{if(!t)return"-";const m=t.substring(0,10),[u,C,v]=m.split("-");return`${v}/${C}/${u}`};function Ie(){const{t}=pe(),{user:m}=he(),[u,C]=l.useState([]),[v,se]=l.useState([]),[T,_]=l.useState(!0),[te,K]=l.useState(!1),[M,y]=l.useState([]),[i,A]=l.useState(null),[d,ae]=l.useState(""),[p,ne]=l.useState(""),[k,re]=l.useState(""),[b,R]=l.useState(!1),[f,S]=l.useState(null),[a,r]=l.useState(E()),[W,U]=l.useState(!1),[P,L]=l.useState(null),Z=m?.project_list_preference??"code",B=l.useMemo(()=>je(u,Z),[u,Z]);function E(){return{project_id:"",inspection_date:new Date().toISOString().split("T")[0],nature:"sst",nature_other:"",type:"internal",location:"",start_date:new Date().toISOString().split("T")[0],end_date:"",zone:"",inspector:m?.name??"",enterprise:"",status:"open",notes:""}}l.useEffect(()=>{le()},[]),l.useEffect(()=>{const s=n=>{n.key==="Escape"&&b&&N()};if(b)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[b]),l.useEffect(()=>{I(),i&&z(i.id)},[i,d,p]);const le=async()=>{try{const n=(await Q.getAll({per_page:100})).data.data??[];C(n)}catch(s){console.error("Error fetching projects:",s)}finally{_(!1)}},I=async()=>{_(!0);try{const s={per_page:100};i&&(s.project_id=i.id),d&&(s.status=d),p&&(s.nature=p);const c=(await w.getAll(s)).data,h=c.data??c,g=Array.isArray(h)?h:h?.data??[];se(g)}catch(s){console.error("Error fetching inspections:",s)}finally{_(!1)}},z=async s=>{try{const n=await Q.getZones(s);y(n.data?.data?.zones??[])}catch(n){console.error("Error fetching zones:",n),y([])}},D=(s=null)=>{s?(S(s),r({project_id:s.project_id.toString(),inspection_date:s.inspection_date,nature:s.nature,nature_other:s.nature_other??"",type:s.type,location:s.location??"",start_date:s.start_date,end_date:s.end_date??"",zone:s.zone??"",inspector:s.inspector,enterprise:s.enterprise??"",status:s.status,notes:s.notes??""}),z(s.project_id)):(S(null),r({...E(),project_id:i?.id?.toString()??"",inspector:m?.name??""})),R(!0)},N=()=>{R(!1),S(null),r(E())},ie=async s=>{s.preventDefault(),U(!0);try{const n={...a,project_id:parseInt(a.project_id)};f?(await w.update(f.id,n),o.success(t("inspections.updated"))):(await w.create(n),o.success(t("inspections.created"))),N(),I()}catch(n){console.error("Error saving inspection:",n),o.error(t("errors.somethingWentWrong"))}finally{U(!1)}},G=s=>{L(s)},ce=async()=>{if(P)try{await w.delete(P.id),o.success(t("inspections.deleted")),I()}catch{o.error(t("errors.somethingWentWrong"))}finally{L(null)}},H=s=>{if(!s){A(null),y([]),r(c=>({...c,project_id:"",zone:""}));return}const n=u.find(c=>c.id===parseInt(s));A(n??null),r(c=>({...c,project_id:s,zone:""})),n?z(n.id):y([])},j=v.filter(s=>{if(!k)return!0;const n=k.toLowerCase();return s.inspector?.toLowerCase().includes(n)||s.location?.toLowerCase().includes(n)||s.zone?.toLowerCase().includes(n)||s.enterprise?.toLowerCase().includes(n)||s.notes?.toLowerCase().includes(n)}),J=(s,n)=>s==="other"&&n?n:t(`inspections.natures.${s}`),oe=async()=>{if(!i){o.error(t("inspections.selectProjectFirst"));return}try{K(!0);const s={project_id:i.id};d&&(s.status=d),p&&(s.nature=p);const n=await xe.exportInspections(s),c=new Blob([n.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),h=window.URL.createObjectURL(c),g=document.createElement("a");g.href=h;const de=i.code||i.id;g.download=`inspections_${de}.xlsx`,g.click(),window.URL.revokeObjectURL(h)}catch(s){console.error("Error exporting inspections:",s),o.error(t("errors.somethingWentWrong"))}finally{K(!1)}};return T&&v.length===0?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx($,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 dark:bg-blue-900/50 rounded-xl flex items-center justify-center",children:e.jsx(X,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[t("nav.dashboard")," / ",t("inspections.title")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:t("inspections.pageTitle")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:t("inspections.pageSubtitle")})]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("inspections.project")}),e.jsxs(x,{value:i?.id??"",onChange:s=>H(s.target.value),children:[e.jsx("option",{value:"",children:t("common.allProjects")}),B.map(s=>e.jsx("option",{value:s.id,children:V(s)},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("inspections.status")}),e.jsxs(x,{value:d,onChange:s=>ae(s.target.value),children:[e.jsx("option",{value:"",children:t("common.all")}),e.jsx("option",{value:"open",children:t("inspections.statusOpen")}),e.jsx("option",{value:"closed",children:t("inspections.statusClosed")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("inspections.nature")}),e.jsxs(x,{value:p,onChange:s=>ne(s.target.value),children:[e.jsx("option",{value:"",children:t("common.all")}),Y.map(s=>e.jsx("option",{value:s.value,children:t(`inspections.natures.${s.labelKey}`)},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("common.search")}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:k,onChange:s=>re(s.target.value),placeholder:t("inspections.searchPlaceholder"),className:"input pl-10"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("button",{onClick:()=>D(),disabled:!i,className:"btn-primary flex items-center gap-2 w-full justify-center",children:[e.jsx(ve,{className:"w-4 h-4"}),t("inspections.newInspection")]})})]})}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[t("inspections.listTitle")," (",j.length,")"]}),e.jsxs("button",{type:"button",onClick:oe,disabled:!i||te||j.length===0,className:"btn-secondary flex items-center gap-2 text-sm",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{children:t("dashboard.exportExcel")})]})]}),e.jsx("div",{className:"overflow-x-auto",children:T?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx($,{className:"w-6 h-6 animate-spin text-hse-primary"})}):j.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:j.map(s=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:ee(s.inspection_date)}),e.jsx("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-300",children:J(s.nature,s.nature_other)}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-300",children:[s.location??""," Â· ",s.zone??""]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:[t("inspections.inspector"),": ",s.inspector]})]}),e.jsxs("div",{className:"text-right text-xs text-gray-600 dark:text-gray-300 space-y-1",children:[e.jsx("span",{className:`inline-flex items-center gap-1 badge ${s.type==="internal"?"badge-info":"badge-warning"}`,children:t(`inspections.types.${s.type}`)}),e.jsx("span",{className:`inline-flex items-center gap-1 badge ${s.status==="open"?"badge-warning":"badge-success"}`,children:s.status==="open"?e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"w-3 h-3"}),t("inspections.statusOpen")]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-3 h-3"}),t("inspections.statusClosed")]})})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>D(s),className:"px-2 py-1 text-xs rounded-md bg-gray-50 dark:bg-gray-900 text-gray-700 dark:text-gray-200",title:t("common.edit"),children:t("common.edit")}),e.jsx("button",{onClick:()=>G(s),className:"px-2 py-1 text-xs rounded-md bg-red-50 dark:bg-red-900/30 text-red-600",title:t("common.delete"),children:t("common.delete")})]})]},s.id))}),e.jsx("div",{className:"hidden md:block",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:t("inspections.date")}),e.jsx("th",{children:t("inspections.nature")}),e.jsx("th",{children:t("inspections.type")}),e.jsx("th",{children:t("inspections.location")}),e.jsx("th",{children:t("inspections.zone")}),e.jsx("th",{children:t("inspections.inspector")}),e.jsx("th",{children:t("inspections.status")}),e.jsx("th",{children:t("common.actions")})]})}),e.jsx("tbody",{children:j.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"whitespace-nowrap",children:ee(s.inspection_date)}),e.jsx("td",{children:e.jsx("span",{className:"text-sm",children:J(s.nature,s.nature_other)})}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.type==="internal"?"badge-info":"badge-warning"}`,children:t(`inspections.types.${s.type}`)})}),e.jsx("td",{children:s.location??""}),e.jsx("td",{children:s.zone??""}),e.jsx("td",{children:s.inspector}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.status==="open"?"badge-warning":"badge-success"}`,children:s.status==="open"?e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),t("inspections.statusOpen")]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),t("inspections.statusClosed")]})})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>D(s),className:"p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",title:t("common.edit"),children:e.jsx(be,{className:"w-4 h-4 text-gray-500"})}),e.jsx("button",{onClick:()=>G(s),className:"p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded",title:t("common.delete"),children:e.jsx(fe,{className:"w-4 h-4 text-red-500"})})]})})]},s.id))})]})})]}):e.jsxs("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:[e.jsx(X,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:t("inspections.noInspections")})]})})]}),e.jsx(ue,{isOpen:b,onClose:N,title:t(f?"inspections.editInspection":"inspections.newInspection"),size:"lg",children:e.jsxs("form",{onSubmit:ie,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("inspections.project")," *"]}),e.jsxs(x,{value:a.project_id,onChange:s=>H(s.target.value),required:!0,children:[e.jsx("option",{value:"",children:t("inspections.selectProject")}),B.map(s=>e.jsx("option",{value:s.id,children:V(s)},s.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("inspections.date")," *"]}),e.jsx(O,{value:a.inspection_date,onChange:s=>r({...a,inspection_date:s}),required:!0})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("inspections.nature")," *"]}),e.jsx(x,{value:a.nature,onChange:s=>r({...a,nature:s.target.value}),required:!0,children:Y.map(s=>e.jsx("option",{value:s.value,children:t(`inspections.natures.${s.labelKey}`)},s.value))})]}),a.nature==="other"&&e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("inspections.natureOther")," *"]}),e.jsx("input",{type:"text",value:a.nature_other,onChange:s=>r({...a,nature_other:s.target.value}),className:"input",placeholder:t("inspections.natureOtherPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("inspections.type")," *"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"type",value:"internal",checked:a.type==="internal",onChange:s=>r({...a,type:s.target.value}),className:"w-4 h-4 text-hse-primary"}),e.jsx("span",{children:t("inspections.types.internal")})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"type",value:"external",checked:a.type==="external",onChange:s=>r({...a,type:s.target.value}),className:"w-4 h-4 text-hse-primary"}),e.jsx("span",{children:t("inspections.types.external")})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("inspections.location")}),e.jsx("input",{type:"text",value:a.location,onChange:s=>r({...a,location:s.target.value}),className:"input",placeholder:t("inspections.locationPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("inspections.zone")}),e.jsxs(x,{value:a.zone,onChange:s=>r({...a,zone:s.target.value}),disabled:M.length===0,children:[e.jsxs("option",{value:"",children:[t("common.select"),"..."]}),M.map((s,n)=>e.jsx("option",{value:s,children:s},n))]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("inspections.startDate")," *"]}),e.jsx(O,{value:a.start_date,onChange:s=>r({...a,start_date:s}),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("inspections.endDate")}),e.jsx(O,{value:a.end_date,onChange:s=>r({...a,end_date:s})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("inspections.inspector")," *"]}),e.jsx("input",{type:"text",value:a.inspector,onChange:s=>r({...a,inspector:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("inspections.enterprise")}),e.jsx("input",{type:"text",value:a.enterprise,onChange:s=>r({...a,enterprise:s.target.value}),className:"input",placeholder:t("inspections.enterprisePlaceholder")})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[t("inspections.status")," *"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"status",value:"open",checked:a.status==="open",onChange:s=>r({...a,status:s.target.value}),className:"w-4 h-4 text-hse-primary"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(F,{className:"w-4 h-4 text-amber-500"}),t("inspections.statusOpen")]})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"status",value:"closed",checked:a.status==="closed",onChange:s=>r({...a,status:s.target.value}),className:"w-4 h-4 text-hse-primary"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(q,{className:"w-4 h-4 text-green-500"}),t("inspections.statusClosed")]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:t("inspections.notes")}),e.jsx("textarea",{value:a.notes,onChange:s=>r({...a,notes:s.target.value}),className:"input",rows:3,placeholder:t("inspections.notesPlaceholder")})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsx("button",{type:"button",onClick:N,className:"btn-outline",children:t("common.cancel")}),e.jsxs("button",{type:"submit",disabled:W,className:"btn-primary flex items-center gap-2",children:[W&&e.jsx($,{className:"w-4 h-4 animate-spin"}),t(f?"common.save":"inspections.create")]})]})]})}),e.jsx(me,{isOpen:!!P,title:t("common.confirm"),message:t("inspections.confirmDelete"),confirmLabel:t("common.delete"),cancelLabel:t("common.cancel"),variant:"danger",onConfirm:ce,onCancel:()=>L(null)})]})}export{Ie as default};

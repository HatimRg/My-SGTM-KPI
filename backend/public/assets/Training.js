import{a as Ee,u as De,t as O,j as e,g as Fe}from"./index.js";import{r}from"./vendor-react.js";import{u as Re}from"./projectStore.js";import{D as A}from"./DatePicker.js";import{S as T}from"./Select.js";import{M as Ue}from"./Modal.js";import{z as N,ad as Oe,at as Ae,C as Me,ae as Ie,k as He,a as qe,ax as M,af as ge,a9 as Be,v as We,am as $e}from"./vendor-ui.js";import{c as ze}from"./weekHelper.js";import{s as Ge,g as pe}from"./projectList.js";import"./vendor-utils.js";const Ke=["30min","1h","1h30","2h","3h","halfDay","1day","2days","3days"],Ye={"30min":.5,"1h":1,"1h30":1.5,"2h":2,"3h":3,halfDay:12,"1day":24,"2days":48,"3days":72},I=10,ue={"30 Min":"30min","1 H":"1h","1 H 30 Min":"1h30","2 H":"2h","3 H":"3h","Half a day":"halfDay","1 day":"1day","2 days":"2days","3 days":"3days"};function nt(){const{t:a}=Ee(),{user:v}=De(),{projects:C,isLoading:H,fetchProjects:q}=Re(),[x,ye]=r.useState([]),[B,W]=r.useState(!1),[k,$]=r.useState(""),[u,z]=r.useState(""),[o,G]=r.useState(!1),[K,Y]=r.useState(""),[X,J]=r.useState(""),[y,L]=r.useState(""),[i,Q]=r.useState(""),[w,V]=r.useState(""),[j,Z]=r.useState(""),[ee,te]=r.useState(""),[je,ae]=r.useState(null),[re,E]=r.useState(""),[se,ne]=r.useState(null),[n,D]=r.useState(""),[fe,ie]=r.useState(!1),[c,be]=r.useState(""),[d,Ne]=r.useState(""),[m,ve]=r.useState(""),[h,ke]=r.useState(""),[F,we]=r.useState(!1),[f,b]=r.useState(1),[Pe,le]=r.useState(!1),oe=v?.project_list_preference??"code",ce=r.useMemo(()=>Ge(C,oe),[C,oe]);r.useEffect(()=>{v?.name&&Y(v.name)},[v]),r.useEffect(()=>{(async()=>{try{const s=await q({per_page:50});s.length===1&&$(s[0].id.toString())}catch(s){console.error("Failed to load projects for training page",s)}})()},[q]),r.useEffect(()=>()=>{n&&URL.revokeObjectURL(n)},[n]),r.useEffect(()=>{de()},[c,d]);const de=async()=>{try{W(!0);const t={};c&&(t.project_id=c),d&&(t.week=d);const s=await O.getAll(t);ye(s.data.data??[])}catch(t){console.error("Failed to load trainings",t),N.error(a("errors.failedToLoad"))}finally{W(!1)}},R=a("training.themes")??[],Se=r.useMemo(()=>{if(!y.trim())return R;const t=y.toLowerCase();return R.filter(s=>s.toLowerCase().includes(t))},[y,R]),P=Number(ee),xe=Ye[j]??0,U=xe*P,S=r.useMemo(()=>Array.isArray(x)?x.filter(t=>{const s=t.date?t.date.split("T")[0]:"";return!(m&&(!s||s<m)||h&&(!s||s>h))}):[],[x,m,h]),_=Math.max(1,Math.ceil((S.length??0)/I)),me=r.useMemo(()=>{if(!Array.isArray(S))return[];const t=(f-1)*I;return S.slice(t,t+I)},[S,f]);r.useEffect(()=>{b(1)},[c,d]);const _e=async()=>{try{le(!0);const t={};c&&(t.project_id=c),d&&(t.week=d),m&&(t.from_date=m),h&&(t.to_date=h);const s=await Fe.exportTrainings(t),l=new Blob([s.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),g=window.URL.createObjectURL(l),p=document.createElement("a");p.href=g,p.download="trainings.xlsx",p.click(),window.URL.revokeObjectURL(g)}catch(t){console.error("Error exporting trainings:",t),N.error(a("errors.failedToExport"))}finally{le(!1)}},Te=t=>{const s=t.target.files?.[0];if(ae(s??null),s){const l=new FileReader;l.onloadend=()=>{E(l.result.toString())},l.readAsDataURL(s)}else E("")},he=t=>{t?.photo_url&&(ne(t),ie(!0),n&&(URL.revokeObjectURL(n),D("")),O.getPhoto(t.id).then(s=>{const l=s.data,g=URL.createObjectURL(l);D(g)}).catch(s=>{console.error("Failed to load training photo",s),N.error(a("errors.failedToLoad"))}).finally(()=>{ie(!1)}))},Ce=t=>{if(t.preventDefault(),!k||!u||!j||!P||!i||i==="Other"&&!w)return;const{week:s,year:l}=ze(u),g={project_id:k,date:u,week_number:s,week_year:l,by_internal:!o,by_name:o?null:K,external_company:o?X:null,theme:i==="Other"?w:i,duration_label:j,duration_hours:xe,participants:P,training_hours:U,photo:je};O.create(g).then(()=>{N.success(a("training.created")),z(""),G(!1),J(""),L(""),Q(""),V(""),Z(""),te(""),ae(null),E(""),de()}).catch(p=>{console.error("Failed to create training",p);const Le=p.response?.data?.message??a("errors.failedToSave");N.error(Le)})};return e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[a("nav.dashboard")," / ",a("training.navLabel")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:a("training.pageTitle")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:a("training.pageSubtitle")})]}),e.jsxs("div",{className:"card",children:[e.jsxs("button",{type:"button",onClick:()=>we(!F),className:"w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(Oe,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:a("training.addTraining")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("training.clickToExpand")})]})]}),F?e.jsx(Ae,{className:"w-5 h-5 text-gray-400"}):e.jsx(Me,{className:"w-5 h-5 text-gray-400"})]}),F&&e.jsxs("form",{onSubmit:Ce,className:"p-6 pt-2 space-y-6 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.project")}),e.jsxs(T,{value:k,onChange:t=>$(t.target.value),disabled:H||C.length===1,required:!0,children:[e.jsx("option",{value:"",children:a(H?"common.loading":"training.selectProject")}),ce.map(t=>e.jsx("option",{value:t.id,children:pe(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.date")}),e.jsx(A,{value:u,onChange:z,required:!0})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center justify-between",children:[e.jsx("span",{children:a("training.by")}),e.jsxs("label",{className:"flex items-center gap-2 text-xs cursor-pointer select-none",children:[e.jsx("div",{onClick:()=>G(!o),className:`w-4 h-4 rounded border-2 flex items-center justify-center transition-colors cursor-pointer ${o?"bg-hse-primary border-hse-primary":"border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800"}`,children:o&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:3,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})}),e.jsx("span",{children:a("training.external")})]})]}),o?e.jsx("input",{type:"text",className:"input",value:X,onChange:t=>J(t.target.value),placeholder:a("training.externalPlaceholder"),required:!0}):e.jsx("input",{type:"text",className:"input",value:K,onChange:t=>Y(t.target.value),readOnly:!0})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"label",children:a("training.theme")}),e.jsxs("div",{className:"relative mb-2",children:[e.jsx(Ie,{className:"w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{type:"text",className:"input pl-9",placeholder:a("training.searchTheme"),value:y,onChange:t=>L(t.target.value)}),y&&e.jsx("button",{type:"button",onClick:()=>L(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx(He,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg divide-y divide-gray-100 dark:divide-gray-700 bg-white dark:bg-gray-800",children:Se.map(t=>e.jsxs("button",{type:"button",onClick:()=>Q(t),className:`w-full text-left px-3 py-2.5 text-sm flex items-center justify-between gap-2 transition-colors ${i===t?"bg-hse-primary/10 text-hse-primary font-medium border-l-4 border-hse-primary":"text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 border-l-4 border-transparent"}`,children:[e.jsx("span",{children:t}),i===t&&e.jsx(qe,{className:"w-4 h-4 text-hse-primary flex-shrink-0"})]},t))}),i==="Other"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"label",children:a("training.otherTheme")}),e.jsx("input",{type:"text",className:"input",value:w,onChange:t=>V(t.target.value),required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.duration")}),e.jsxs(T,{value:j,onChange:t=>Z(t.target.value),children:[e.jsx("option",{value:"",children:a("training.selectDuration")}),Ke.map(t=>e.jsx("option",{value:t,children:a(`training.durations.${t}`)},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.participants")}),e.jsx("input",{type:"number",min:"1",className:"input",value:ee,onChange:t=>te(t.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.trainingHours")}),e.jsxs("div",{className:"input bg-gray-50 dark:bg-gray-800 flex items-center justify-between",children:[e.jsx("span",{children:Number.isFinite(U)?U:0}),e.jsx("span",{className:"text-xs text-gray-400 ml-2",children:a("training.hoursUnit")})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4"}),a("training.photo")]}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:Te,className:"hidden"}),re?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:re,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:a("training.changePhoto")})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("training.uploadPhoto")})]})]})]}),e.jsx("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{type:"submit",className:"btn-primary",disabled:!k||!u||!j||!P||!i||i==="Other"&&!w,children:a("training.submit")})})]})]}),e.jsxs("div",{className:"card p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4 text-hse-primary"}),a("training.listTitle")]}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap items-center gap-3",children:[e.jsxs(T,{value:c,onChange:t=>be(t.target.value),className:"h-10 text-sm min-w-[140px]",children:[e.jsx("option",{value:"",children:a("training.allProjects")}),ce.map(t=>e.jsx("option",{value:t.id,children:pe(t)},t.id))]}),e.jsxs(T,{value:d,onChange:t=>Ne(t.target.value),className:"h-10 text-sm min-w-[130px]",children:[e.jsx("option",{value:"",children:a("training.allWeeks")}),Array.from({length:52},(t,s)=>s+1).map(t=>e.jsx("option",{value:t,children:a("training.weekLabel").replace("{{week}}",t)},t))]}),e.jsx(A,{value:m,onChange:t=>{ve(t),b(1)},placeholder:"From date",className:"w-40 h-10"}),e.jsx(A,{value:h,onChange:t=>{ke(t),b(1)},placeholder:"To date",className:"w-40 h-10"}),e.jsxs("button",{type:"button",onClick:_e,disabled:Pe||x.length===0,className:"btn-secondary flex items-center gap-2 text-sm",children:[e.jsx(Be,{className:"w-4 h-4"}),e.jsx("span",{children:a("dashboard.exportExcel")})]})]})]}),B?e.jsxs("div",{className:"space-y-3 py-4",children:[e.jsx("div",{className:"hidden md:block space-y-2 animate-pulse",children:Array.from({length:4},(t,s)=>e.jsx("div",{className:"h-10 rounded-md bg-gray-100 dark:bg-gray-800"},s))}),e.jsx("div",{className:"md:hidden space-y-3 animate-pulse",children:Array.from({length:3},(t,s)=>e.jsx("div",{className:"h-24 rounded-lg bg-gray-100 dark:bg-gray-800"},s))})]}):x.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 rounded-full bg-hse-primary/10 mb-3",children:e.jsx(ge,{className:"w-5 h-5 text-hse-primary"})}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:a("training.noTrainings")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:me.map(t=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:t.project?.name??""}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:t.date?t.date.split("T")[0]:""}),e.jsx("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-300",children:t.by_internal?t.by_name:t.external_company??""})]}),e.jsxs("div",{className:"text-right text-xs text-gray-600 dark:text-gray-300 space-y-1",children:[e.jsx("p",{className:"font-medium truncate max-w-[140px]",children:t.theme}),e.jsx("p",{children:a(`training.durations.${ue[t.duration_label]??t.duration_label}`)})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-gray-50 dark:bg-gray-900",children:[a("training.participants"),": ",t.participants]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-hse-primary/10 text-hse-primary",children:[a("training.trainingHours"),": ",t.training_hours]})]}),t.photo_url&&e.jsx("div",{className:"mt-2 flex justify-end",children:e.jsxs("button",{type:"button",onClick:()=>he(t),className:"text-[11px] text-hse-primary hover:underline flex items-center gap-1",children:[e.jsx(M,{className:"w-3 h-3"}),a("training.viewPhoto")]})})]},t.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colDate")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colProject")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colBy")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colTheme")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colDuration")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colParticipants")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colHours")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colPhoto")})]})}),e.jsx("tbody",{children:me.map(t=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsx("td",{className:"py-2 pr-4 text-gray-900 dark:text-gray-100 text-xs",children:t.date?t.date.split("T")[0]:""}),e.jsx("td",{className:"py-2 pr-4 text-gray-900 dark:text-gray-100",children:t.project?.name??""}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.by_internal?t.by_name:t.external_company??""}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.theme}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:a(`training.durations.${ue[t.duration_label]??t.duration_label}`)}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.participants}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.training_hours}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.photo_url?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>he(t),className:"text-xs text-hse-primary hover:underline",children:a("training.viewPhoto")}),e.jsx("a",{href:t.photo_url,download:!0,className:"text-xs text-gray-500 hover:underline",children:a("training.downloadPhoto")})]}):e.jsx("span",{className:"text-xs text-gray-400"})})]},t.id))})]})})]}),!B&&x.length>0&&_>1&&e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-100 dark:border-gray-800",children:[e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[a("common.page")," ",f," ",a("common.of")," ",_]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>b(t=>Math.max(1,t-1)),disabled:f===1,className:"btn-secondary text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:a("common.previous")}),e.jsx("button",{type:"button",onClick:()=>b(t=>Math.min(_,t+1)),disabled:f===_,className:"btn-secondary text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:a("common.next")})]})]})]}),se&&e.jsx(Ue,{isOpen:!!se,onClose:()=>{ne(null),n&&(URL.revokeObjectURL(n),D(""))},title:a("training.photo"),size:"xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:fe?e.jsx("div",{className:"flex items-center justify-center h-48",children:e.jsx(We,{className:"w-6 h-6 animate-spin text-hse-primary"})}):n?e.jsx("img",{src:n,alt:a("training.photo"),className:"max-h-[70vh] w-auto rounded-lg shadow-md object-contain bg-gray-900/5"}):e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("errors.failedToLoad")})}),e.jsx("div",{className:"flex justify-end",children:n&&e.jsxs("a",{href:n,download:!0,className:"btn-primary inline-flex items-center gap-2 text-sm",children:[e.jsx($e,{className:"w-4 h-4"}),a("training.downloadPhoto")]})})]})})]})}export{nt as default};

import{a as Re,u as Ue,t as _,j as e,M as Me,h as Ie}from"./index.js";import{r}from"./vendor-react.js";import{u as He}from"./projectStore.js";import{D as H}from"./DatePicker.js";import{S as C}from"./Select.js";import{C as qe}from"./ConfirmDialog.js";import{z as m,av as Be,aN as We,C as $e,w as ze,c as Ge,a as Ke,aQ as q,aw as ye,aq as Ye,aA as je,a0 as Qe,aF as Xe}from"./vendor-ui.js";import{c as Je}from"./weekHelper.js";import{s as Ve,g as fe}from"./projectList.js";import"./vendor-utils.js";const Ze=["30min","1h","1h30","2h","3h","halfDay","1day","2days","3days"],et={"30min":.5,"1h":1,"1h30":1.5,"2h":2,"3h":3,halfDay:12,"1day":24,"2days":48,"3days":72},B=10,be={"30 Min":"30min","1 H":"1h","1 H 30 Min":"1h30","2 H":"2h","3 H":"3h","Half a day":"halfDay","1 day":"1day","2 days":"2days","3 days":"3days"};function mt(){const{t:a}=Re(),{user:v}=Ue(),{projects:L,isLoading:W,fetchProjects:$}=He(),[x,Ne]=r.useState([]),[z,G]=r.useState(!1),[k,K]=r.useState(""),[y,Y]=r.useState(""),[o,Q]=r.useState(!1),[X,J]=r.useState(""),[V,Z]=r.useState(""),[j,D]=r.useState(""),[i,ee]=r.useState(""),[w,te]=r.useState(""),[f,ae]=r.useState(""),[re,se]=r.useState(""),[ve,ne]=r.useState(null),[ie,E]=r.useState(""),[le,oe]=r.useState(null),[n,F]=r.useState(""),[ke,ce]=r.useState(!1),[c,we]=r.useState(""),[d,Se]=r.useState(""),[h,Pe]=r.useState(""),[g,Te]=r.useState(""),[A,_e]=r.useState(!1),[b,N]=r.useState(1),[Ce,de]=r.useState(!1),[O,R]=r.useState(null),me=v?.project_list_preference??"code",xe=r.useMemo(()=>Ve(L,me),[L,me]);r.useEffect(()=>{v?.name&&J(v.name)},[v]),r.useEffect(()=>{(async()=>{try{const s=await $({per_page:50});s.length===1&&K(s[0].id.toString())}catch(s){console.error("Failed to load projects for training page",s)}})()},[$]),r.useEffect(()=>()=>{n&&URL.revokeObjectURL(n)},[n]),r.useEffect(()=>{U()},[c,d]);const U=async()=>{try{G(!0);const t={};c&&(t.project_id=c),d&&(t.week=d);const s=await _.getAll(t);Ne(s.data.data??[])}catch(t){console.error("Failed to load trainings",t),m.error(a("errors.failedToLoad"))}finally{G(!1)}},M=a("training.themes")??[],Le=r.useMemo(()=>{if(!j.trim())return M;const t=j.toLowerCase();return M.filter(s=>s.toLowerCase().includes(t))},[j,M]),S=Number(re),he=et[f]??0,I=he*S,P=r.useMemo(()=>Array.isArray(x)?x.filter(t=>{const s=t.date?t.date.split("T")[0]:"";return!(h&&(!s||s<h)||g&&(!s||s>g))}):[],[x,h,g]),T=Math.max(1,Math.ceil((P.length??0)/B)),ge=r.useMemo(()=>{if(!Array.isArray(P))return[];const t=(b-1)*B;return P.slice(t,t+B)},[P,b]);r.useEffect(()=>{N(1)},[c,d]);const De=async()=>{try{de(!0);const t={};c&&(t.project_id=c),d&&(t.week=d),h&&(t.from_date=h),g&&(t.to_date=g);const s=await Ie.exportTrainings(t),l=new Blob([s.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),p=window.URL.createObjectURL(l),u=document.createElement("a");u.href=p,u.download="trainings.xlsx",u.click(),window.URL.revokeObjectURL(p)}catch(t){console.error("Error exporting trainings:",t),m.error(a("errors.failedToExport"))}finally{de(!1)}},Ee=t=>{const s=t.target.files?.[0];if(ne(s??null),s){const l=new FileReader;l.onloadend=()=>{E(l.result.toString())},l.readAsDataURL(s)}else E("")},pe=t=>{t?.photo_url&&(oe(t),ce(!0),n&&(URL.revokeObjectURL(n),F("")),_.getPhoto(t.id).then(s=>{const l=s.data,p=URL.createObjectURL(l);F(p)}).catch(s=>{console.error("Failed to load training photo",s),m.error(a("errors.failedToLoad"))}).finally(()=>{ce(!1)}))},ue=t=>{R(t)},Fe=async()=>{if(O?.id)try{await _.delete(O.id),m.success(a("common.saved")??"Saved"),U()}catch(t){console.error("Failed to delete training",t),m.error(a("errors.failedToDelete")??a("common.error")??"Error")}finally{R(null)}},Ae=t=>{if(t.preventDefault(),!k||!y||!f||!S||!i||i==="Other"&&!w)return;const{week:s,year:l}=Je(y),p={project_id:k,date:y,week_number:s,week_year:l,by_internal:!o,by_name:o?null:X,external_company:o?V:null,theme:i==="Other"?w:i,duration_label:f,duration_hours:he,participants:S,training_hours:I,photo:ve};_.create(p).then(()=>{m.success(a("training.created")),Y(""),Q(!1),Z(""),D(""),ee(""),te(""),ae(""),se(""),ne(null),E(""),U()}).catch(u=>{console.error("Failed to create training",u);const Oe=u.response?.data?.message??a("errors.failedToSave");m.error(Oe)})};return e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[a("nav.dashboard")," / ",a("training.navLabel")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:a("training.pageTitle")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:a("training.pageSubtitle")})]}),e.jsxs("div",{className:"card",children:[e.jsxs("button",{type:"button",onClick:()=>_e(!A),className:"w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(Be,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:a("training.addTraining")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("training.clickToExpand")})]})]}),A?e.jsx(We,{className:"w-5 h-5 text-gray-400"}):e.jsx($e,{className:"w-5 h-5 text-gray-400"})]}),A&&e.jsxs("form",{onSubmit:Ae,className:"p-6 pt-2 space-y-6 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.project")}),e.jsxs(C,{value:k,onChange:t=>K(t.target.value),disabled:W||L.length===1,required:!0,children:[e.jsx("option",{value:"",children:a(W?"common.loading":"training.selectProject")}),xe.map(t=>e.jsx("option",{value:t.id,children:fe(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.date")}),e.jsx(H,{value:y,onChange:Y,required:!0})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center justify-between",children:[e.jsx("span",{children:a("training.by")}),e.jsxs("label",{className:"flex items-center gap-2 text-xs cursor-pointer select-none",children:[e.jsx("div",{onClick:()=>Q(!o),className:`w-4 h-4 rounded border-2 flex items-center justify-center transition-colors cursor-pointer ${o?"bg-hse-primary border-hse-primary":"border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800"}`,children:o&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:3,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})}),e.jsx("span",{children:a("training.external")})]})]}),o?e.jsx("input",{type:"text",className:"input",value:V,onChange:t=>Z(t.target.value),placeholder:a("training.externalPlaceholder"),required:!0}):e.jsx("input",{type:"text",className:"input",value:X,onChange:t=>J(t.target.value),readOnly:!0})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"label",children:a("training.theme")}),e.jsxs("div",{className:"relative mb-2",children:[e.jsx(ze,{className:"w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{type:"text",className:"input pl-9",placeholder:a("training.searchTheme"),value:j,onChange:t=>D(t.target.value)}),j&&e.jsx("button",{type:"button",onClick:()=>D(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx(Ge,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg divide-y divide-gray-100 dark:divide-gray-700 bg-white dark:bg-gray-800",children:Le.map(t=>e.jsxs("button",{type:"button",onClick:()=>ee(t),className:`w-full text-left px-3 py-2.5 text-sm flex items-center justify-between gap-2 transition-colors ${i===t?"bg-hse-primary/10 text-hse-primary font-medium border-l-4 border-hse-primary":"text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 border-l-4 border-transparent"}`,children:[e.jsx("span",{children:t}),i===t&&e.jsx(Ke,{className:"w-4 h-4 text-hse-primary flex-shrink-0"})]},t))}),i==="Other"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"label",children:a("training.otherTheme")}),e.jsx("input",{type:"text",className:"input",value:w,onChange:t=>te(t.target.value),required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.duration")}),e.jsxs(C,{value:f,onChange:t=>ae(t.target.value),children:[e.jsx("option",{value:"",children:a("training.selectDuration")}),Ze.map(t=>e.jsx("option",{value:t,children:a(`training.durations.${t}`)},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.participants")}),e.jsx("input",{type:"number",min:"1",className:"input",value:re,onChange:t=>se(t.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("training.trainingHours")}),e.jsxs("div",{className:"input bg-gray-50 dark:bg-gray-800 flex items-center justify-between",children:[e.jsx("span",{children:Number.isFinite(I)?I:0}),e.jsx("span",{className:"text-xs text-gray-400 ml-2",children:a("training.hoursUnit")})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4"}),a("training.photo")]}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:Ee,className:"hidden"}),ie?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:ie,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:a("training.changePhoto")})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(q,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("training.uploadPhoto")})]})]})]}),e.jsx("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{type:"submit",className:"btn-primary",disabled:!k||!y||!f||!S||!i||i==="Other"&&!w,children:a("training.submit")})})]})]}),e.jsxs("div",{className:"card p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2",children:[e.jsx(ye,{className:"w-4 h-4 text-hse-primary"}),a("training.listTitle")]}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap items-center gap-3",children:[e.jsxs(C,{value:c,onChange:t=>we(t.target.value),className:"h-10 text-sm min-w-[140px]",children:[e.jsx("option",{value:"",children:a("training.allProjects")}),xe.map(t=>e.jsx("option",{value:t.id,children:fe(t)},t.id))]}),e.jsxs(C,{value:d,onChange:t=>Se(t.target.value),className:"h-10 text-sm min-w-[130px]",children:[e.jsx("option",{value:"",children:a("training.allWeeks")}),Array.from({length:52},(t,s)=>s+1).map(t=>e.jsx("option",{value:t,children:a("training.weekLabel").replace("{{week}}",t)},t))]}),e.jsx(H,{value:h,onChange:t=>{Pe(t),N(1)},placeholder:"From date",className:"w-40 h-10"}),e.jsx(H,{value:g,onChange:t=>{Te(t),N(1)},placeholder:"To date",className:"w-40 h-10"}),e.jsxs("button",{type:"button",onClick:De,disabled:Ce||x.length===0,className:"btn-secondary flex items-center gap-2 text-sm",children:[e.jsx(Ye,{className:"w-4 h-4"}),e.jsx("span",{children:a("dashboard.exportExcel")})]})]})]}),z?e.jsxs("div",{className:"space-y-3 py-4",children:[e.jsx("div",{className:"hidden md:block space-y-2 animate-pulse",children:Array.from({length:4},(t,s)=>e.jsx("div",{className:"h-10 rounded-md bg-gray-100 dark:bg-gray-800"},s))}),e.jsx("div",{className:"md:hidden space-y-3 animate-pulse",children:Array.from({length:3},(t,s)=>e.jsx("div",{className:"h-24 rounded-lg bg-gray-100 dark:bg-gray-800"},s))})]}):x.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 rounded-full bg-hse-primary/10 mb-3",children:e.jsx(ye,{className:"w-5 h-5 text-hse-primary"})}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:a("training.noTrainings")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:ge.map(t=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:t.project?.name??""}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:t.date?t.date.split("T")[0]:""}),e.jsx("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-300",children:t.by_internal?t.by_name:t.external_company??""})]}),e.jsxs("div",{className:"text-right text-xs text-gray-600 dark:text-gray-300 space-y-1",children:[e.jsx("p",{className:"font-medium truncate max-w-[140px]",children:t.theme}),e.jsx("p",{children:a(`training.durations.${be[t.duration_label]??t.duration_label}`)}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:()=>ue(t),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:a("common.delete")??"Delete",children:e.jsx(je,{className:"w-4 h-4 text-red-600"})})})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-gray-50 dark:bg-gray-900",children:[a("training.participants"),": ",t.participants]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-hse-primary/10 text-hse-primary",children:[a("training.trainingHours"),": ",t.training_hours]})]}),t.photo_url&&e.jsx("div",{className:"mt-2 flex justify-end",children:e.jsxs("button",{type:"button",onClick:()=>pe(t),className:"text-[11px] text-hse-primary hover:underline flex items-center gap-1",children:[e.jsx(q,{className:"w-3 h-3"}),a("training.viewPhoto")]})})]},t.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colDate")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colProject")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colBy")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colTheme")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colDuration")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colParticipants")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colHours")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("training.colPhoto")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("common.actions")??"Actions"})]})}),e.jsx("tbody",{children:ge.map(t=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsx("td",{className:"py-2 pr-4 text-gray-900 dark:text-gray-100 text-xs",children:t.date?t.date.split("T")[0]:""}),e.jsx("td",{className:"py-2 pr-4 text-gray-900 dark:text-gray-100",children:t.project?.name??""}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.by_internal?t.by_name:t.external_company??""}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.theme}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:a(`training.durations.${be[t.duration_label]??t.duration_label}`)}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.participants}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.training_hours}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:t.photo_url?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>pe(t),className:"text-xs text-hse-primary hover:underline",children:a("training.viewPhoto")}),e.jsx("a",{href:t.photo_url,download:!0,className:"text-xs text-gray-500 hover:underline",children:a("training.downloadPhoto")})]}):e.jsx("span",{className:"text-xs text-gray-400"})}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:e.jsx("button",{type:"button",onClick:()=>ue(t),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:a("common.delete")??"Delete",children:e.jsx(je,{className:"w-4 h-4 text-red-600"})})})]},t.id))})]})})]}),!z&&x.length>0&&T>1&&e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-100 dark:border-gray-800",children:[e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[a("common.page")," ",b," ",a("common.of")," ",T]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>N(t=>Math.max(1,t-1)),disabled:b===1,className:"btn-secondary text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:a("common.previous")}),e.jsx("button",{type:"button",onClick:()=>N(t=>Math.min(T,t+1)),disabled:b===T,className:"btn-secondary text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:a("common.next")})]})]})]}),le&&e.jsx(Me,{isOpen:!!le,onClose:()=>{oe(null),n&&(URL.revokeObjectURL(n),F(""))},title:a("training.photo"),size:"xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:ke?e.jsx("div",{className:"flex items-center justify-center h-48",children:e.jsx(Qe,{className:"w-6 h-6 animate-spin text-hse-primary"})}):n?e.jsx("img",{src:n,alt:a("training.photo"),className:"max-h-[70vh] w-auto rounded-lg shadow-md object-contain bg-gray-900/5"}):e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("errors.failedToLoad")})}),e.jsx("div",{className:"flex justify-end",children:n&&e.jsxs("a",{href:n,download:!0,className:"btn-primary inline-flex items-center gap-2 text-sm",children:[e.jsx(Xe,{className:"w-4 h-4"}),a("training.downloadPhoto")]})})]})}),e.jsx(qe,{isOpen:!!O,title:a("common.delete")??"Delete",message:a("common.confirmDelete")??"Are you sure you want to delete this record?",confirmLabel:a("common.delete")??"Delete",cancelLabel:a("common.cancel")??"Cancel",onConfirm:Fe,onCancel:()=>R(null)})]})}export{mt as default};

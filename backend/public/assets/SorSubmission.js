import{j as e,a as Ge,u as Ke,p as fe,w as Ve,m as W,g as Xe,n as Je}from"./index.js";import{r as n}from"./vendor-react.js";import{s as Qe,g as Ne}from"./projectList.js";import{M as Q}from"./Modal.js";import{D as Y}from"./DatePicker.js";import{s as Ee,at as _e,C as ke,z as d,A as we,ad as Ye,ay as Ce,c as Se,a9 as et,v as G,I as tt,ag as rt,q as ee,B as st,a8 as at,ak as ot,n as nt,az as K}from"./vendor-ui.js";import{A as Pe}from"./AutocompleteInput.js";import"./vendor-utils.js";function te({value:r,onChange:l,placeholder:N="HH:MM",className:I="",disabled:w=!1}){const[m,x]=n.useState(!1),E=n.useRef(null),[C,L]=n.useState(()=>r?parseInt(r.split(":")[0]):new Date().getHours()),[S,V]=n.useState(()=>r?parseInt(r.split(":")[1]):Math.floor(new Date().getMinutes()/5)*5);n.useEffect(()=>{if(r){const[o,g]=r.split(":"),i=Number.parseInt(o,10),b=Number.parseInt(g,10);L(Number.isFinite(i)?i:0),V(Number.isFinite(b)?b:0)}},[r]),n.useEffect(()=>{const o=i=>{E.current&&!E.current.contains(i.target)&&x(!1)},g=i=>{i.key==="Escape"&&x(!1)};return m&&(document.addEventListener("mousedown",o),document.addEventListener("keydown",g)),()=>{document.removeEventListener("mousedown",o),document.removeEventListener("keydown",g)}},[m]);const T=(o,g)=>`${String(o).padStart(2,"0")}:${String(g).padStart(2,"0")}`,F=(o,g)=>{const i=Math.max(0,Math.min(23,o)),b=Math.max(0,Math.min(59,g));L(i),V(b),l(T(i,b))},re=()=>F((C+1)%24,S),A=()=>F((C-1+24)%24,S),u=()=>F(C,(S+5)%60),O=()=>F(C,(S-5+60)%60),X=["06:00","08:00","10:00","12:00","14:00","16:00","18:00"];return e.jsxs("div",{ref:E,className:`relative ${I}`,children:[e.jsxs("div",{onClick:()=>!w&&x(!m),className:`input flex items-center justify-between cursor-pointer ${w?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx("span",{className:r?"text-gray-900 dark:text-gray-100":"text-gray-400 dark:text-gray-500",children:r||N}),e.jsx(Ee,{className:"w-4 h-4 text-gray-400"})]}),m&&e.jsxs("div",{className:"absolute z-[100] mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-3 w-56",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:re,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(_e,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(C).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:A,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(ke,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]}),e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:":"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:u,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(_e,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(S).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:O,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(ke,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]})]}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-2",children:e.jsx("div",{className:"flex flex-wrap gap-1 justify-center",children:X.map(o=>e.jsx("button",{type:"button",onClick:()=>{l(o),x(!1)},className:`px-2 py-1 text-xs rounded transition-colors
                    ${r===o?"bg-hse-primary text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:o},o))})}),e.jsx("div",{className:"mt-2 pt-2 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{type:"button",onClick:()=>{l(T(C,S)),x(!1)},className:"w-full py-1.5 bg-hse-primary text-white rounded-lg hover:bg-hse-primary/90 transition-colors text-sm font-medium",children:"OK"})})]})]})}const De=["nettoyage_rangement","protection_chute","echafaudage","epi","excavations","levage","methode_travail","manutention","vehicule_transport","outils_equipements","chute_trebuchement","electricite","protection_incendie","communication_attitude","acces_passage","formation_toolbox","inspection_evaluation","documentation_hse","gestion_sous_traitants","autre"],f=new Map,ct=50,it=r=>{let l=r?.replace(/^https?:\/\/[^/]+/,"");return l?(l.startsWith("/api/")?l=l.replace(/^\/api\//,"/"):l==="/api"&&(l="/"),l):null},Re=async r=>{const l=it(r);if(!l)return null;const N=f.get(l);if(N)return f.delete(l),f.set(l,N),N;const I=await Je.get(l,{responseType:"blob"}),w=window.URL.createObjectURL(I.data);for(f.set(l,w);f.size>ct;){const m=f.keys().next().value,x=f.get(m);x&&window.URL.revokeObjectURL(x),f.delete(m)}return w};function jt(){const{t:r,language:l}=Ge(),{user:N}=Ke(),[I,w]=n.useState(!0),[m,x]=n.useState(!1),[E,C]=n.useState([]),[L,S]=n.useState([]),[V,T]=n.useState([]),[F,re]=n.useState([]),[A,u]=n.useState(!1),[O,X]=n.useState(null),[o,g]=n.useState(null),[i,b]=n.useState({project_id:"",status:"",category:""}),[se,P]=n.useState(!1),[D,U]=n.useState(null),[ae,z]=n.useState(!1),[j,v]=n.useState({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),[M,R]=n.useState(null),[oe,Le]=n.useState([]),[lt,de]=n.useState(1),[Ae,me]=n.useState(!1),xe=N?.project_list_preference??"code",he=n.useMemo(()=>Qe(L,xe),[L,xe]),[c,_]=n.useState({project_id:"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:N?.name??"",non_conformity:"",photo:null,category:"",responsible_person:"",corrective_action:"",corrective_action_date:"",corrective_action_time:"",corrective_action_photo:null}),[ge,ne]=n.useState(null),[ce,pe]=n.useState(null),[ie,ue]=n.useState(null),be=l==="fr"?"fr-FR":"en-GB",q=n.useCallback(t=>{if(!t)return"";try{return new Date(t).toLocaleDateString(be)}catch{return""}},[be]),$=n.useCallback(t=>t?r(`sor.categories.${t}`):"",[r]);n.useEffect(()=>{const t=s=>{s.key==="Escape"&&(A&&(u(!1),y()),se&&(P(!1),k(),y()),ae&&(z(!1),k(),U(null)),o&&g(null))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[A,se,ae,o]),n.useEffect(()=>{let t=!1;return(async()=>{if(pe(null),ue(null),!!o){try{if(o.photo_view_url){const a=await Re(o.photo_view_url);t||pe(a)}}catch(a){console.error("Error loading problem photo:",a)}try{if(o.corrective_action_photo_view_url){const a=await Re(o.corrective_action_photo_view_url);t||ue(a)}}catch(a){console.error("Error loading corrective photo:",a)}}})(),()=>{t=!0}},[o]),n.useEffect(()=>()=>{for(const t of f.values())try{window.URL.revokeObjectURL(t)}catch{}f.clear()},[]),n.useEffect(()=>{H()},[i]),n.useEffect(()=>{Oe(),B()},[]),n.useEffect(()=>{A&&c.project_id&&J(c.project_id)},[A]);const Oe=async()=>{try{const[t,s]=await Promise.all([fe.getAll({per_page:100}),Ve.getEntreprises()]),a=t.data.data??[];if(S(a),re(s.data.data??[]),a.length===1){const h=a[0].id.toString();_(Z=>({...Z,project_id:h})),J(h)}}catch(t){console.error("Error fetching projects:",t)}},B=async()=>{try{const t=await W.getPinned();Le(t.data.data??[])}catch(t){console.error("Error fetching pinned reports:",t)}},J=async t=>{if(!t){T([]);return}try{const s=await fe.getZones(t);T(s.data?.data?.zones??[])}catch(s){console.error("Error fetching project zones:",s),T([])}},H=async()=>{w(!0);try{const t={};i.project_id&&(t.project_id=i.project_id),i.status&&(t.status=i.status),i.category&&(t.category=i.category);const s=await W.getAll(t);C(s.data.data??[])}catch(t){console.error("Error fetching SOR reports:",t),d.error(r("errors.fetchFailed"))}finally{w(!1)}},p=(t,s)=>{_(a=>({...a,[t]:s})),t==="project_id"&&(J(s),_(a=>({...a,zone:""})))},Te=t=>{const s=t.target.files[0];if(s){_(h=>({...h,photo:s}));const a=new FileReader;a.onloadend=()=>ne(a.result),a.readAsDataURL(s)}},Fe=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){d.error(r("errors.invalidFileType"));return}_(h=>({...h,photo:s}));const a=new FileReader;a.onloadend=()=>ne(a.result),a.readAsDataURL(s)},y=()=>{_({project_id:L.length===1?L[0].id.toString():"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:N?.name??"",non_conformity:"",photo:null,category:"",responsible_person:"",corrective_action:"",corrective_action_date:"",corrective_action_time:"",corrective_action_photo:null}),ne(null),R(null),X(null)},Ue=async t=>{if(t.preventDefault(),!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(r("sor.fillRequired"));return}if(O){x(!0);try{await W.update(O.id,c),d.success(r("sor.updateSuccess")),y(),u(!1),H(),B()}catch(s){const a=s.response?.data?.message||r("errors.somethingWentWrong");d.error(a)}finally{x(!1)}}else u(!1),P(!0)},ze=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(r("sor.fillRequired")),P(!1),u(!0);return}x(!0);try{const t={...c,...j,submit_corrective_action:!0};await W.create(t),d.success(r("sor.createClosedSuccess")),y(),k(),P(!1),de(1),H(),B()}catch(t){console.error("SOR submit error:",t.response?.data);const s=t.response?.data?.errors;if(s){const a=Object.values(s)[0];d.error(Array.isArray(a)?a[0]:a)}else d.error(t.response?.data?.message||r("errors.somethingWentWrong"))}finally{x(!1)}},Me=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(r("sor.fillRequired")),P(!1),u(!0);return}x(!0);try{const t={...c,submit_later:!0};console.log("Submitting SOR data:",t),await W.create(t),d.success(r("sor.createPinnedSuccess")),y(),P(!1),de(1),H(),B()}catch(t){console.error("SOR submit later error:",t.response?.data);const s=t.response?.data?.errors;if(s){const a=Object.values(s)[0];d.error(Array.isArray(a)?a[0]:a)}else d.error(t.response?.data?.message||r("errors.somethingWentWrong"))}finally{x(!1)}},We=async t=>{if(t.preventDefault(),!j.corrective_action){d.error(r("sor.correctiveRequired"));return}x(!0);try{await W.submitCorrectiveAction(D.id,j),d.success(r("sor.correctiveSubmitted")),k(),U(null),z(!1),H(),B()}catch(s){const a=s.response?.data?.message||r("errors.somethingWentWrong");d.error(a)}finally{x(!1)}},k=()=>{v({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),R(null)},je=t=>{const s=t.target.files[0];if(s){v(h=>({...h,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>R(a.result),a.readAsDataURL(s)}},ve=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){d.error(r("errors.invalidFileType"));return}v(h=>({...h,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>R(a.result),a.readAsDataURL(s)},Ie=t=>{U(t),v({corrective_action:t?.corrective_action??"",corrective_action_date:t?.corrective_action_date?t.corrective_action_date.split("T")[0]:new Date().toISOString().split("T")[0],corrective_action_time:t?.corrective_action_time??"",corrective_action_photo:null}),R(null),z(!0)},le=t=>{J(t.project_id),_({project_id:t.project_id,company:t.company??"",observation_date:t.observation_date?.split("T")[0]??"",observation_time:t.observation_time??"",zone:t.zone??"",supervisor:t.supervisor??"",non_conformity:t.non_conformity??"",photo:null,category:t.category??"",responsible_person:t.responsible_person??"",corrective_action:t.corrective_action??"",corrective_action_date:t.corrective_action_date?t.corrective_action_date.split("T")[0]:"",corrective_action_time:t.corrective_action_time??"",corrective_action_photo:null}),R(null),X(t),u(!0)},qe=t=>{Fe(t)},$e=t=>{const s=t.target.files[0];if(s){_(h=>({...h,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>R(a.result),a.readAsDataURL(s)}},Be=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){d.error(r("errors.invalidFileType"));return}_(h=>({...h,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>R(a.result),a.readAsDataURL(s)},He=t=>{U(t),k(),z(!0)},ye=t=>{const s={open:"bg-red-100 text-red-700",in_progress:"bg-amber-100 text-amber-700",closed:"bg-green-100 text-green-700"},a={open:r("sor.status.open"),in_progress:r("sor.status.inProgress"),closed:r("sor.status.closed")};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s[t]}`,children:a[t]})},Ze=async()=>{try{me(!0);const t={};i.project_id&&(t.project_id=i.project_id),i.status&&(t.status=i.status),i.category&&(t.category=i.category);const s=await Xe.exportDeviations(t),a=new Blob([s.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),h=window.URL.createObjectURL(a),Z=document.createElement("a");Z.href=h,Z.download="deviations.xlsx",Z.click(),window.URL.revokeObjectURL(h)}catch(t){console.error("Error exporting deviations:",t),d.error(r("errors.somethingWentWrong"))}finally{me(!1)}};return e.jsxs("div",{className:"p-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2",children:[e.jsx(we,{className:"w-7 h-7 text-amber-500"}),r("sor.title")]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:r("sor.subtitle")})]}),e.jsxs("button",{onClick:()=>{y(),u(!0)},className:"btn btn-primary flex items-center gap-2",children:[e.jsx(Ye,{className:"w-5 h-5"}),r("sor.addNew")]})]}),oe.length>0&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Ce,{className:"w-5 h-5 text-amber-600 dark:text-amber-400"}),e.jsx("h3",{className:"font-semibold text-amber-800 dark:text-amber-300",children:r("sor.pendingCorrective")}),e.jsx("span",{className:"bg-amber-200 dark:bg-amber-700 text-amber-800 dark:text-amber-100 text-xs font-bold px-2 py-0.5 rounded-full",children:oe.length})]}),e.jsx("div",{className:"grid gap-2",children:oe.map(t=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 flex items-center justify-between border border-amber-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:q(t.observation_date)})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 truncate max-w-md",children:t.non_conformity})]}),e.jsxs("button",{onClick:()=>Ie(t),className:"btn btn-primary btn-sm flex items-center gap-1",children:[e.jsx(Se,{className:"w-4 h-4"}),r("sor.addCorrective")]})]},t.id))})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.project")}),e.jsxs("select",{value:i.project_id,onChange:t=>b(s=>({...s,project_id:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),he.map(t=>e.jsx("option",{value:t.id,children:Ne(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.status.label")}),e.jsxs("select",{value:i.status,onChange:t=>b(s=>({...s,status:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),e.jsx("option",{value:"open",children:r("sor.status.open")}),e.jsx("option",{value:"in_progress",children:r("sor.status.inProgress")}),e.jsx("option",{value:"closed",children:r("sor.status.closed")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.category")}),e.jsxs("select",{value:i.category,onChange:t=>b(s=>({...s,category:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),De.map(t=>e.jsx("option",{value:t,children:$(t)},t))]})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{onClick:()=>b({project_id:"",status:"",category:""}),className:"btn btn-outline w-full",type:"button",children:r("common.reset")}),e.jsxs("button",{type:"button",onClick:Ze,disabled:Ae||E.length===0,className:"btn-secondary w-full flex items-center justify-center gap-2 text-sm",children:[e.jsx(et,{className:"w-4 h-4"}),e.jsx("span",{children:r("dashboard.exportExcel")})]})]})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden",children:I?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(G,{className:"w-8 h-8 animate-spin text-hse-primary"})}):E.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(we,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:r("sor.noReports")})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.date")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.project")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.zone")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.category")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.nonConformity")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.status.label")}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("common.actions")})]})}),e.jsx("tbody",{className:"divide-y dark:divide-gray-700",children:E.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:q(t.observation_date)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:t.zone??""}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("span",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 rounded text-xs",children:$(t.category)||t.category})}),e.jsx("td",{className:"px-4 py-3 text-sm max-w-xs truncate dark:text-gray-300",children:t.non_conformity}),e.jsx("td",{className:"px-4 py-3",children:ye(t.status)}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>g(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded",title:r("common.view"),children:e.jsx(tt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>le(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-amber-600 hover:bg-amber-50 dark:hover:bg-amber-900/30 rounded",title:r("common.edit"),children:e.jsx(rt,{className:"w-4 h-4"})}),t.status!=="closed"&&e.jsx("button",{onClick:()=>He(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 rounded",title:r("sor.markClosed"),children:e.jsx(ee,{className:"w-4 h-4"})})]})})]},t.id))})]})})}),e.jsx(Q,{isOpen:A,onClose:()=>{u(!1),y()},title:r(O?"sor.editReport":"sor.newReport"),size:"xl",children:e.jsxs("form",{onSubmit:Ue,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.project")," *"]}),e.jsxs("select",{value:c.project_id,onChange:t=>p("project_id",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:r("sor.selectProject")}),he.map(t=>e.jsx("option",{value:t.id,children:Ne(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.company")}),e.jsx(Pe,{value:c.company,onChange:t=>p("company",t),suggestions:F,placeholder:"SGTM, Sous-traitant...",defaultValue:"SGTM",icon:e.jsx(st,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(at,{className:"w-4 h-4"}),r("sor.date")," *"]}),e.jsx(Y,{value:c.observation_date,onChange:t=>p("observation_date",t),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),r("sor.time")]}),e.jsx(te,{value:c.observation_time,onChange:t=>p("observation_time",t)})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(ot,{className:"w-4 h-4"}),r("sor.zone")]}),e.jsx(Pe,{value:c.zone,onChange:t=>p("zone",t),suggestions:V,placeholder:r("sor.zonePlaceholder")||"Zone de travail...",disabled:!c.project_id})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(nt,{className:"w-4 h-4"}),r("sor.supervisor")]}),e.jsx("input",{type:"text",value:c.supervisor,onChange:t=>p("supervisor",t.target.value),className:"input",placeholder:r("sor.supervisorPlaceholder")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.nonConformity")," *"]}),e.jsx("textarea",{value:c.non_conformity,onChange:t=>p("non_conformity",t.target.value),className:"input min-h-[100px]",placeholder:r("sor.nonConformityPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),r("sor.photo")]}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5 transition-colors",onDragOver:t=>t.preventDefault(),onDrop:qe,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:Te,className:"hidden"}),ge?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:ge,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(K,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.category")," *"]}),e.jsxs("select",{value:c.category,onChange:t=>p("category",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:r("sor.selectCategory")}),De.map(t=>e.jsx("option",{value:t,children:$(t)},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.responsiblePerson")}),e.jsx("input",{type:"text",value:c.responsible_person,onChange:t=>p("responsible_person",t.target.value),className:"input",placeholder:r("sor.responsiblePersonPlaceholder")})]}),O&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(Y,{value:c.corrective_action_date,onChange:t=>p("corrective_action_date",t)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(te,{value:c.corrective_action_time,onChange:t=>p("corrective_action_time",t)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveAction")}),e.jsx("textarea",{value:c.corrective_action,onChange:t=>p("corrective_action",t.target.value),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-green-200 dark:border-green-800 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors bg-white/60 dark:bg-gray-900/20",onDragOver:t=>t.preventDefault(),onDrop:Be,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:$e,className:"hidden"}),M?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:M,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{u(!1),y()},className:"btn btn-outline",children:r("common.cancel")}),e.jsx("button",{type:"submit",disabled:m,className:"btn btn-primary flex items-center gap-2",children:m?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-4 h-4 animate-spin"}),r("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4"}),r(O?"common.update":"common.submit")]})})]})]})}),e.jsx(Q,{isOpen:!!o,onClose:()=>g(null),title:r("sor.viewReport"),size:"lg",children:o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:r("sor.status.label")}),ye(o.status)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.project")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.project?.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.company")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.company??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.date")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:q(o.observation_date)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.time")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.observation_time??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.zone")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.zone??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.supervisor")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.supervisor??""})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.category")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:$(o.category)||o.category})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.nonConformity")}),e.jsx("p",{className:"font-medium bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-3 rounded-lg",children:o.non_conformity})]}),ce&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.photo")}),e.jsx("img",{src:ce,alt:"Non-conformity",className:"mt-2 rounded-lg max-h-64 object-contain border dark:border-gray-600 cursor-pointer hover:opacity-90",onClick:()=>window.open(ce,"_blank")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.responsiblePerson")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.responsible_person??""})]}),o.corrective_action&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4",children:[e.jsx("span",{className:"text-green-700 dark:text-green-400 text-sm font-medium",children:r("sor.correctiveAction")}),e.jsx("p",{className:"font-medium text-green-800 dark:text-green-200 mt-1",children:o.corrective_action}),o.corrective_action_date&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-2",children:[r("sor.correctiveDate"),": ",q(o.corrective_action_date),o.corrective_action_time&&` ${r("common.at")} ${o.corrective_action_time}`]}),o.closer_name&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-1",children:[r("sor.closedBy"),": ",e.jsx("span",{className:"font-medium",children:o.closer_name})]}),ie&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:ie,alt:"Corrective action",className:"rounded-lg max-h-48 object-contain border border-green-200 dark:border-green-700 cursor-pointer hover:opacity-90",onClick:()=>window.open(ie,"_blank")})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsx("button",{onClick:()=>g(null),className:"btn btn-outline",children:r("common.close")}),o.status==="closed"&&o.corrective_action&&e.jsx("button",{onClick:()=>{le(o),g(null)},className:"btn btn-outline",children:r("sor.editCorrective")}),e.jsx("button",{onClick:()=>{le(o),g(null)},className:"btn btn-primary",children:r("common.edit")})]})]})}),e.jsx(Q,{isOpen:se,onClose:()=>{P(!1),k(),y()},title:r("sor.correctivePromptTitle"),size:"md",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-amber-100 dark:bg-amber-900/50 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Se,{className:"w-8 h-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h2",{className:"text-xl font-bold mb-2 dark:text-gray-100",children:r("sor.correctivePromptTitle")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:r("sor.correctivePromptMessage")})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(Y,{value:j.corrective_action_date,onChange:t=>v(s=>({...s,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(te,{value:j.corrective_action_time,onChange:t=>v(s=>({...s,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:j.corrective_action,onChange:t=>v(s=>({...s,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",onDragOver:t=>t.preventDefault(),onDrop:ve,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:je,className:"hidden"}),M?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:M,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{P(!1),k(),y()},className:"btn btn-outline flex-1",disabled:m,children:r("common.cancel")}),e.jsxs("button",{onClick:Me,className:"btn bg-amber-500 hover:bg-amber-600 text-white flex-1 flex items-center justify-center gap-2",disabled:m,children:[m?e.jsx(G,{className:"w-4 h-4 animate-spin"}):e.jsx(Ce,{className:"w-4 h-4"}),r("sor.submitLater")]}),e.jsxs("button",{onClick:ze,className:"btn btn-primary flex-1 flex items-center justify-center gap-2",disabled:m||!j.corrective_action,children:[m?e.jsx(G,{className:"w-4 h-4 animate-spin"}):e.jsx(ee,{className:"w-4 h-4"}),r("sor.submitAndClose")]})]})]})}),e.jsx(Q,{isOpen:ae&&!!D,onClose:()=>{z(!1),k(),U(null)},title:r("sor.addCorrectiveTitle"),size:"md",children:D&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-500 dark:text-gray-400 mb-2",children:r("sor.problemSummary")}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.project"),":"]})," ",D.project?.name]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.date"),":"]})," ",q(D.observation_date)]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.category"),":"]})," ",$(D.category)||D.category]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-400 mt-2",children:D.non_conformity})]})]}),e.jsxs("form",{onSubmit:We,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(Y,{value:j.corrective_action_date,onChange:t=>v(s=>({...s,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(te,{value:j.corrective_action_time,onChange:t=>v(s=>({...s,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:j.corrective_action,onChange:t=>v(s=>({...s,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",onDragOver:t=>t.preventDefault(),onDrop:ve,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:je,className:"hidden"}),M?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:M,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{z(!1),k(),U(null)},className:"btn btn-outline",children:r("common.cancel")}),e.jsx("button",{type:"submit",disabled:m,className:"btn btn-primary flex items-center gap-2",children:m?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-4 h-4 animate-spin"}),r("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4"}),r("sor.submitAndClose")]})})]})]})]})})]})}export{jt as default};

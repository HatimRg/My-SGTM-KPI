import{j as e,a as dt,u as mt,g as De,w as xt,q as E,M as J,h as ht,r as pt}from"./index.js";import{r as o}from"./vendor-react.js";import{s as gt,g as Ee}from"./projectList.js";import{D as re}from"./DatePicker.js";import{Y as We,aN as Oe,C as Te,z as l,A as Le,aq as Fe,au as ut,av as bt,aR as Ue,$ as Ae,a0 as X,E as jt,ax as yt,V as se,aA as vt,aE as ft,ap as Nt,aB as _t,J as kt,aS as Y}from"./vendor-ui.js";import{C as wt}from"./ConfirmDialog.js";import{A as Me}from"./AutocompleteInput.js";import"./vendor-utils.js";function ae({value:r,onChange:d,placeholder:w="HH:MM",className:z="",disabled:C=!1}){const[g,u]=o.useState(!1),I=o.useRef(null),[S,Q]=o.useState(()=>r?parseInt(r.split(":")[0]):new Date().getHours()),[P,b]=o.useState(()=>r?parseInt(r.split(":")[1]):Math.floor(new Date().getMinutes()/5)*5);o.useEffect(()=>{if(r){const[x,v]=r.split(":"),h=Number.parseInt(x,10),p=Number.parseInt(v,10);Q(Number.isFinite(h)?h:0),b(Number.isFinite(p)?p:0)}},[r]),o.useEffect(()=>{const x=h=>{I.current&&!I.current.contains(h.target)&&u(!1)},v=h=>{h.key==="Escape"&&u(!1)};return g&&(document.addEventListener("mousedown",x),document.addEventListener("keydown",v)),()=>{document.removeEventListener("mousedown",x),document.removeEventListener("keydown",v)}},[g]);const y=(x,v)=>`${String(x).padStart(2,"0")}:${String(v).padStart(2,"0")}`,O=(x,v)=>{const h=Math.max(0,Math.min(23,x)),p=Math.max(0,Math.min(59,v));Q(h),b(p),d(y(h,p))},oe=()=>O((S+1)%24,P),W=()=>O((S-1+24)%24,P),ne=()=>O(S,(P+5)%60),ce=()=>O(S,(P-5+60)%60),G=["06:00","08:00","10:00","12:00","14:00","16:00","18:00"];return e.jsxs("div",{ref:I,className:`relative ${z}`,children:[e.jsxs("div",{onClick:()=>!C&&u(!g),className:`input flex items-center justify-between cursor-pointer ${C?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx("span",{className:r?"text-gray-900 dark:text-gray-100":"text-gray-400 dark:text-gray-500",children:r||w}),e.jsx(We,{className:"w-4 h-4 text-gray-400"})]}),g&&e.jsxs("div",{className:"absolute z-[100] mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-3 w-56",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:oe,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(Oe,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(S).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:W,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(Te,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]}),e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:":"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:ne,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(Oe,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(P).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:ce,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(Te,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]})]}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-2",children:e.jsx("div",{className:"flex flex-wrap gap-1 justify-center",children:G.map(x=>e.jsx("button",{type:"button",onClick:()=>{d(x),u(!1)},className:`px-2 py-1 text-xs rounded transition-colors
                    ${r===x?"bg-hse-primary text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:x},x))})}),e.jsx("div",{className:"mt-2 pt-2 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{type:"button",onClick:()=>{d(y(S,P)),u(!1)},className:"w-full py-1.5 bg-hse-primary text-white rounded-lg hover:bg-hse-primary/90 transition-colors text-sm font-medium",children:"OK"})})]})]})}const ze=["nettoyage_rangement","protection_chute","echafaudage","epi","excavations","levage","methode_travail","manutention","vehicule_transport","outils_equipements","chute_trebuchement","electricite","protection_incendie","communication_attitude","acces_passage","formation_toolbox","inspection_evaluation","documentation_hse","gestion_sous_traitants","autre"],k=new Map,Ct=50,St=r=>{let d=r?.replace(/^https?:\/\/[^/]+/,"");return d?(d.startsWith("/api/")?d=d.replace(/^\/api\//,"/"):d==="/api"&&(d="/"),d):null},Ie=async r=>{const d=St(r);if(!d)return null;const w=k.get(d);if(w)return k.delete(d),k.set(d,w),w;const z=await pt.get(d,{responseType:"blob"}),C=window.URL.createObjectURL(z.data);for(k.set(d,C);k.size>Ct;){const g=k.keys().next().value,u=k.get(g);u&&window.URL.revokeObjectURL(u),k.delete(g)}return C};function At(){const{t:r,language:d}=dt(),{user:w}=mt(),[z,C]=o.useState(!1),[g,u]=o.useState(null),[I,S]=o.useState(!1),[Q,P]=o.useState(!0),[b,y]=o.useState(!1),[O,oe]=o.useState([]),[W,ne]=o.useState([]),[ce,G]=o.useState([]),[x,v]=o.useState([]),[h,p]=o.useState(!1),[K,be]=o.useState(null),[n,q]=o.useState(null),[m,ee]=o.useState({project_id:"",status:"",category:""}),[le,T]=o.useState(!1),[L,B]=o.useState(null),[ie,$]=o.useState(!1),[f,N]=o.useState({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),[H,F]=o.useState(null),[de,qe]=o.useState([]),[Pt,je]=o.useState(1),[Be,ye]=o.useState(!1),[me,xe]=o.useState(null),$e=t=>{if(!t)return null;const s=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(t),a=decodeURIComponent(s?.[1]??s?.[2]??"");return a!==""?a:null},He=(t,s)=>{const a=URL.createObjectURL(t),i=document.createElement("a");i.href=a,i.download=s??"template.xlsx",document.body.appendChild(i),i.click(),i.remove(),setTimeout(()=>URL.revokeObjectURL(a),5e3)},Ge=()=>{u(null),C(!0)},Ke=async()=>{try{const t=await E.downloadTemplate(),s=$e(t.headers?.["content-disposition"])??"SGTM-SOR-Template.xlsx";He(t.data,s)}catch(t){l.error(t.response?.data?.message??r("common.downloadTemplateFailed"))}},Ve=async()=>{if(!g){l.error(r("common.chooseFile"));return}try{S(!0);const t=new FormData;t.append("file",g);const a=(await E.bulkImport(t)).data?.data??{},i=a.imported??0,M=a.updated??0,Re=a.errors??[];l.success(r("common.importSummary",{imported:i,updated:M})),Re.length>0&&l.error(r("common.importIssues",{count:Re.length})),u(null),C(!1),A(),U()}catch(t){l.error(t.response?.data?.message??r("common.importFailed"))}finally{S(!1)}},ve=w?.project_list_preference??"code",fe=o.useMemo(()=>gt(W,ve),[W,ve]),[c,R]=o.useState({project_id:"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:w?.name??"",non_conformity:"",photo:null,category:"",responsible_person:"",corrective_action:"",corrective_action_date:"",corrective_action_time:"",corrective_action_photo:null}),[Ne,he]=o.useState(null),[pe,_e]=o.useState(null),[ge,ke]=o.useState(null),we=d==="fr"?"fr-FR":"en-GB",V=o.useCallback(t=>{if(!t)return"";try{return new Date(t).toLocaleDateString(we)}catch{return""}},[we]),Z=o.useCallback(t=>t?r(`sor.categories.${t}`):"",[r]),Ze=t=>{xe(t)},Je=async()=>{if(me?.id)try{await E.delete(me.id),l.success(r("common.saved")),A(),U()}catch(t){console.error("Failed to delete SOR report",t),l.error(r("errors.failedToDelete")??r("common.error"))}finally{xe(null)}};o.useEffect(()=>{const t=s=>{s.key==="Escape"&&(h&&(p(!1),_()),le&&(T(!1),D(),_()),ie&&($(!1),D(),B(null)),n&&q(null))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[h,le,ie,n]),o.useEffect(()=>{let t=!1;return(async()=>{if(_e(null),ke(null),!!n){try{if(n.photo_view_url){const a=await Ie(n.photo_view_url);t||_e(a)}}catch(a){console.error("Error loading problem photo:",a)}try{if(n.corrective_action_photo_view_url){const a=await Ie(n.corrective_action_photo_view_url);t||ke(a)}}catch(a){console.error("Error loading corrective photo:",a)}}})(),()=>{t=!0}},[n]),o.useEffect(()=>()=>{for(const t of k.values())try{window.URL.revokeObjectURL(t)}catch{}k.clear()},[]),o.useEffect(()=>{A()},[m]),o.useEffect(()=>{Xe(),U()},[]),o.useEffect(()=>{h&&c.project_id&&te(c.project_id)},[h]);const Xe=async()=>{try{const[t,s]=await Promise.all([De.getAll({per_page:100}),xt.getEntreprises()]),a=t.data.data??[];if(ne(a),v(s.data.data??[]),a.length===1){const i=a[0].id.toString();R(M=>({...M,project_id:i})),te(i)}}catch(t){console.error("Error fetching projects:",t)}},U=async()=>{try{const t=await E.getPinned();qe(t.data.data??[])}catch(t){console.error("Error fetching pinned reports:",t)}},te=async t=>{if(!t){G([]);return}try{const s=await De.getZones(t);G(s.data?.data?.zones??[])}catch(s){console.error("Error fetching project zones:",s),G([])}},A=async()=>{P(!0);try{const t={};m.project_id&&(t.project_id=m.project_id),m.status&&(t.status=m.status),m.category&&(t.category=m.category);const s=await E.getAll(t);oe(s.data.data??[])}catch(t){console.error("Error fetching SOR reports:",t),l.error(r("errors.fetchFailed"))}finally{P(!1)}},j=(t,s)=>{R(a=>({...a,[t]:s})),t==="project_id"&&(te(s),R(a=>({...a,zone:""})))},Ye=t=>{const s=t.target.files[0];if(s){R(i=>({...i,photo:s}));const a=new FileReader;a.onloadend=()=>he(a.result),a.readAsDataURL(s)}},Qe=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){l.error(r("errors.invalidFileType"));return}R(i=>({...i,photo:s}));const a=new FileReader;a.onloadend=()=>he(a.result),a.readAsDataURL(s)},_=()=>{R({project_id:W.length===1?W[0].id.toString():"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:w?.name??"",non_conformity:"",photo:null,category:"",responsible_person:"",corrective_action:"",corrective_action_date:"",corrective_action_time:"",corrective_action_photo:null}),he(null),F(null),be(null)},et=async t=>{if(t.preventDefault(),!c.project_id||!c.observation_date||!c.non_conformity||!c.category){l.error(r("sor.fillRequired"));return}if(K){y(!0);try{await E.update(K.id,c),l.success(r("sor.updateSuccess")),_(),p(!1),A(),U()}catch(s){const a=s.response?.data?.message||r("errors.somethingWentWrong");l.error(a)}finally{y(!1)}}else p(!1),T(!0)},tt=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){l.error(r("sor.fillRequired")),T(!1),p(!0);return}y(!0);try{const t={...c,...f,submit_corrective_action:!0};await E.create(t),l.success(r("sor.createClosedSuccess")),_(),D(),T(!1),je(1),A(),U()}catch(t){console.error("SOR submit error:",t.response?.data);const s=t.response?.data?.errors;if(s){const a=Object.values(s)[0];l.error(Array.isArray(a)?a[0]:a)}else l.error(t.response?.data?.message||r("errors.somethingWentWrong"))}finally{y(!1)}},rt=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){l.error(r("sor.fillRequired")),T(!1),p(!0);return}y(!0);try{const t={...c,submit_later:!0};console.log("Submitting SOR data:",t),await E.create(t),l.success(r("sor.createPinnedSuccess")),_(),T(!1),je(1),A(),U()}catch(t){console.error("SOR submit later error:",t.response?.data);const s=t.response?.data?.errors;if(s){const a=Object.values(s)[0];l.error(Array.isArray(a)?a[0]:a)}else l.error(t.response?.data?.message||r("errors.somethingWentWrong"))}finally{y(!1)}},st=async t=>{if(t.preventDefault(),!f.corrective_action){l.error(r("sor.correctiveRequired"));return}y(!0);try{await E.submitCorrectiveAction(L.id,f),l.success(r("sor.correctiveSubmitted")),D(),B(null),$(!1),A(),U()}catch(s){const a=s.response?.data?.message||r("errors.somethingWentWrong");l.error(a)}finally{y(!1)}},D=()=>{N({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),F(null)},Ce=t=>{const s=t.target.files[0];if(s){N(i=>({...i,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>F(a.result),a.readAsDataURL(s)}},Se=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){l.error(r("errors.invalidFileType"));return}N(i=>({...i,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>F(a.result),a.readAsDataURL(s)},at=t=>{B(t),N({corrective_action:t?.corrective_action??"",corrective_action_date:t?.corrective_action_date?t.corrective_action_date.split("T")[0]:new Date().toISOString().split("T")[0],corrective_action_time:t?.corrective_action_time??"",corrective_action_photo:null}),F(null),$(!0)},ue=t=>{te(t.project_id),R({project_id:t.project_id,company:t.company??"",observation_date:t.observation_date?.split("T")[0]??"",observation_time:t.observation_time??"",zone:t.zone??"",supervisor:t.supervisor??"",non_conformity:t.non_conformity??"",photo:null,category:t.category??"",responsible_person:t.responsible_person??"",corrective_action:t.corrective_action??"",corrective_action_date:t.corrective_action_date?t.corrective_action_date.split("T")[0]:"",corrective_action_time:t.corrective_action_time??"",corrective_action_photo:null}),F(null),be(t),p(!0)},ot=t=>{Qe(t)},nt=t=>{const s=t.target.files[0];if(s){R(i=>({...i,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>F(a.result),a.readAsDataURL(s)}},ct=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){l.error(r("errors.invalidFileType"));return}R(i=>({...i,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>F(a.result),a.readAsDataURL(s)},lt=t=>{B(t),D(),$(!0)},Pe=t=>{const s={open:"bg-red-100 text-red-700",in_progress:"bg-amber-100 text-amber-700",closed:"bg-green-100 text-green-700"},a={open:r("sor.status.open"),in_progress:r("sor.status.inProgress"),closed:r("sor.status.closed")};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s[t]}`,children:a[t]})},it=async()=>{try{ye(!0);const t={};m.project_id&&(t.project_id=m.project_id),m.status&&(t.status=m.status),m.category&&(t.category=m.category);const s=await ht.exportDeviations(t),a=new Blob([s.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=window.URL.createObjectURL(a),M=document.createElement("a");M.href=i,M.download="deviations.xlsx",M.click(),window.URL.revokeObjectURL(i)}catch(t){console.error("Error exporting deviations:",t),l.error(r("errors.somethingWentWrong"))}finally{ye(!1)}};return e.jsxs("div",{className:"p-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2",children:[e.jsx(Le,{className:"w-7 h-7 text-amber-500"}),r("sor.title")]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:r("sor.subtitle")})]}),z&&e.jsx(J,{isOpen:z,onClose:()=>C(!1),title:"Massive Add",size:"xl",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("button",{type:"button",onClick:Ke,className:"btn-secondary flex items-center justify-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4"}),e.jsx("span",{children:r("common.downloadTemplate")??"Download template"})]}),e.jsxs("label",{className:"flex items-center justify-between border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-xs cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-200",children:g?g.name:r("common.chooseFile")??"Choose Excel file"})]}),e.jsx("input",{type:"file",accept:".xlsx,.xls",className:"hidden",onChange:t=>u(t.target.files?.[0]??null)})]}),e.jsx("button",{type:"button",onClick:Ve,disabled:I||!g,className:"btn-primary",children:I?r("common.loading")??"Importing...":r("common.import")??"Import"})]})})}),e.jsxs("button",{onClick:t=>{if(t?.ctrlKey){Ge();return}_(),p(!0)},className:"btn btn-primary flex items-center gap-2",children:[e.jsx(bt,{className:"w-5 h-5"}),r("sor.addNew")]})]}),de.length>0&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Ue,{className:"w-5 h-5 text-amber-600 dark:text-amber-400"}),e.jsx("h3",{className:"font-semibold text-amber-800 dark:text-amber-300",children:r("sor.pendingCorrective")}),e.jsx("span",{className:"bg-amber-200 dark:bg-amber-700 text-amber-800 dark:text-amber-100 text-xs font-bold px-2 py-0.5 rounded-full",children:de.length})]}),e.jsx("div",{className:"grid gap-2",children:de.map(t=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 flex items-center justify-between border border-amber-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:V(t.observation_date)})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 truncate max-w-md",children:t.non_conformity})]}),e.jsxs("button",{onClick:()=>at(t),className:"btn btn-primary btn-sm flex items-center gap-1",children:[e.jsx(Ae,{className:"w-4 h-4"}),r("sor.addCorrective")]})]},t.id))})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.project")}),e.jsxs("select",{value:m.project_id,onChange:t=>ee(s=>({...s,project_id:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),fe.map(t=>e.jsx("option",{value:t.id,children:Ee(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.status.label")}),e.jsxs("select",{value:m.status,onChange:t=>ee(s=>({...s,status:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),e.jsx("option",{value:"open",children:r("sor.status.open")}),e.jsx("option",{value:"in_progress",children:r("sor.status.inProgress")}),e.jsx("option",{value:"closed",children:r("sor.status.closed")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.category")}),e.jsxs("select",{value:m.category,onChange:t=>ee(s=>({...s,category:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),ze.map(t=>e.jsx("option",{value:t,children:Z(t)},t))]})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{onClick:()=>ee({project_id:"",status:"",category:""}),className:"btn btn-outline w-full",type:"button",children:r("common.reset")}),e.jsxs("button",{type:"button",onClick:it,disabled:Be||O.length===0,className:"btn-secondary w-full flex items-center justify-center gap-2 text-sm",children:[e.jsx(Fe,{className:"w-4 h-4"}),e.jsx("span",{children:r("dashboard.exportExcel")})]})]})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden",children:Q?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(X,{className:"w-8 h-8 animate-spin text-hse-primary"})}):O.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Le,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:r("sor.noReports")})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.date")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.project")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.zone")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.category")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.nonConformity")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.status.label")}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("common.actions")})]})}),e.jsx("tbody",{className:"divide-y dark:divide-gray-700",children:O.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:V(t.observation_date)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:t.zone??""}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("span",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 rounded text-xs",children:Z(t.category)||t.category})}),e.jsx("td",{className:"px-4 py-3 text-sm max-w-xs truncate dark:text-gray-300",children:t.non_conformity}),e.jsx("td",{className:"px-4 py-3",children:Pe(t.status)}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>q(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded",title:r("common.view"),children:e.jsx(jt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ue(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-amber-600 hover:bg-amber-50 dark:hover:bg-amber-900/30 rounded",title:r("common.edit"),children:e.jsx(yt,{className:"w-4 h-4"})}),t.status!=="closed"&&e.jsx("button",{onClick:()=>lt(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 rounded",title:r("sor.markClosed"),children:e.jsx(se,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Ze(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded",title:r("common.delete"),children:e.jsx(vt,{className:"w-4 h-4"})})]})})]},t.id))})]})})}),e.jsx(J,{isOpen:h,onClose:()=>{p(!1),_()},title:r(K?"sor.editReport":"sor.newReport"),size:"xl",children:e.jsxs("form",{onSubmit:et,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.project")," *"]}),e.jsxs("select",{value:c.project_id,onChange:t=>j("project_id",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:r("sor.selectProject")}),fe.map(t=>e.jsx("option",{value:t.id,children:Ee(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.company")}),e.jsx(Me,{value:c.company,onChange:t=>j("company",t),suggestions:x,placeholder:"SGTM, Sous-traitant...",defaultValue:"SGTM",icon:e.jsx(ft,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Nt,{className:"w-4 h-4"}),r("sor.date")," *"]}),e.jsx(re,{value:c.observation_date,onChange:t=>j("observation_date",t),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(We,{className:"w-4 h-4"}),r("sor.time")]}),e.jsx(ae,{value:c.observation_time,onChange:t=>j("observation_time",t)})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(_t,{className:"w-4 h-4"}),r("sor.zone")]}),e.jsx(Me,{value:c.zone,onChange:t=>j("zone",t),suggestions:ce,placeholder:r("sor.zonePlaceholder")||"Zone de travail...",disabled:!c.project_id})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(kt,{className:"w-4 h-4"}),r("sor.supervisor")]}),e.jsx("input",{type:"text",value:c.supervisor,onChange:t=>j("supervisor",t.target.value),className:"input",placeholder:r("sor.supervisorPlaceholder")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.nonConformity")," *"]}),e.jsx("textarea",{value:c.non_conformity,onChange:t=>j("non_conformity",t.target.value),className:"input min-h-[100px]",placeholder:r("sor.nonConformityPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),r("sor.photo")]}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5 transition-colors",onDragOver:t=>t.preventDefault(),onDrop:ot,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:Ye,className:"hidden"}),Ne?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:Ne,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(Y,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.category")," *"]}),e.jsxs("select",{value:c.category,onChange:t=>j("category",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:r("sor.selectCategory")}),ze.map(t=>e.jsx("option",{value:t,children:Z(t)},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.responsiblePerson")}),e.jsx("input",{type:"text",value:c.responsible_person,onChange:t=>j("responsible_person",t.target.value),className:"input",placeholder:r("sor.responsiblePersonPlaceholder")})]}),K&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(re,{value:c.corrective_action_date,onChange:t=>j("corrective_action_date",t)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(ae,{value:c.corrective_action_time,onChange:t=>j("corrective_action_time",t)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveAction")}),e.jsx("textarea",{value:c.corrective_action,onChange:t=>j("corrective_action",t.target.value),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-green-200 dark:border-green-800 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors bg-white/60 dark:bg-gray-900/20",onDragOver:t=>t.preventDefault(),onDrop:ct,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:nt,className:"hidden"}),H?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:H,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{p(!1),_()},className:"btn btn-outline",children:r("common.cancel")}),e.jsx("button",{type:"submit",disabled:b,className:"btn btn-primary flex items-center gap-2",children:b?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4 animate-spin"}),r("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4"}),r(K?"common.update":"common.submit")]})})]})]})}),e.jsx(J,{isOpen:!!n,onClose:()=>q(null),title:r("sor.viewReport"),size:"lg",children:n&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:r("sor.status.label")}),Pe(n.status)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.project")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:n.project?.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.company")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:n.company??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.date")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:V(n.observation_date)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.time")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:n.observation_time??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.zone")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:n.zone??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.supervisor")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:n.supervisor??""})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.category")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:Z(n.category)||n.category})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.nonConformity")}),e.jsx("p",{className:"font-medium bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-3 rounded-lg",children:n.non_conformity})]}),pe&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.photo")}),e.jsx("img",{src:pe,alt:"Non-conformity",className:"mt-2 rounded-lg max-h-64 object-contain border dark:border-gray-600 cursor-pointer hover:opacity-90",onClick:()=>window.open(pe,"_blank")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.responsiblePerson")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:n.responsible_person??""})]}),n.corrective_action&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4",children:[e.jsx("span",{className:"text-green-700 dark:text-green-400 text-sm font-medium",children:r("sor.correctiveAction")}),e.jsx("p",{className:"font-medium text-green-800 dark:text-green-200 mt-1",children:n.corrective_action}),n.corrective_action_date&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-2",children:[r("sor.correctiveDate"),": ",V(n.corrective_action_date),n.corrective_action_time&&` ${r("common.at")} ${n.corrective_action_time}`]}),n.closer_name&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-1",children:[r("sor.closedBy"),": ",e.jsx("span",{className:"font-medium",children:n.closer_name})]}),ge&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:ge,alt:"Corrective action",className:"rounded-lg max-h-48 object-contain border border-green-200 dark:border-green-700 cursor-pointer hover:opacity-90",onClick:()=>window.open(ge,"_blank")})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsx("button",{onClick:()=>q(null),className:"btn btn-outline",children:r("common.close")}),n.status==="closed"&&n.corrective_action&&e.jsx("button",{onClick:()=>{ue(n),q(null)},className:"btn btn-outline",children:r("sor.editCorrective")}),e.jsx("button",{onClick:()=>{ue(n),q(null)},className:"btn btn-primary",children:r("common.edit")})]})]})}),e.jsx(J,{isOpen:le,onClose:()=>{T(!1),D(),_()},title:r("sor.correctivePromptTitle"),size:"md",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-amber-100 dark:bg-amber-900/50 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Ae,{className:"w-8 h-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h2",{className:"text-xl font-bold mb-2 dark:text-gray-100",children:r("sor.correctivePromptTitle")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:r("sor.correctivePromptMessage")})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(re,{value:f.corrective_action_date,onChange:t=>N(s=>({...s,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(ae,{value:f.corrective_action_time,onChange:t=>N(s=>({...s,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:f.corrective_action,onChange:t=>N(s=>({...s,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",onDragOver:t=>t.preventDefault(),onDrop:Se,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:Ce,className:"hidden"}),H?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:H,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{T(!1),D(),_()},className:"btn btn-outline flex-1",disabled:b,children:r("common.cancel")}),e.jsxs("button",{onClick:rt,className:"btn bg-amber-500 hover:bg-amber-600 text-white flex-1 flex items-center justify-center gap-2",disabled:b,children:[b?e.jsx(X,{className:"w-4 h-4 animate-spin"}):e.jsx(Ue,{className:"w-4 h-4"}),r("sor.submitLater")]}),e.jsxs("button",{onClick:tt,className:"btn btn-primary flex-1 flex items-center justify-center gap-2",disabled:b||!f.corrective_action,children:[b?e.jsx(X,{className:"w-4 h-4 animate-spin"}):e.jsx(se,{className:"w-4 h-4"}),r("sor.submitAndClose")]})]})]})}),e.jsx(J,{isOpen:ie&&!!L,onClose:()=>{$(!1),D(),B(null)},title:r("sor.addCorrectiveTitle"),size:"lg",children:L&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-500 dark:text-gray-400 mb-2",children:r("sor.problemSummary")}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.project"),":"]})," ",L.project?.name]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.date"),":"]})," ",V(L.observation_date)]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.category"),":"]})," ",Z(L.category)||L.category]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-400 mt-2",children:L.non_conformity})]})]}),e.jsxs("form",{onSubmit:st,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(re,{value:f.corrective_action_date,onChange:t=>N(s=>({...s,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(ae,{value:f.corrective_action_time,onChange:t=>N(s=>({...s,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:f.corrective_action,onChange:t=>N(s=>({...s,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",onDragOver:t=>t.preventDefault(),onDrop:Se,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:Ce,className:"hidden"}),H?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:H,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{$(!1),D(),B(null)},className:"btn btn-outline",children:r("common.cancel")}),e.jsx("button",{type:"submit",disabled:b,className:"btn btn-primary flex items-center gap-2",children:b?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4 animate-spin"}),r("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4"}),r("sor.submitAndClose")]})})]})]})]})}),e.jsx(wt,{isOpen:!!me,title:r("common.delete"),message:r("common.confirmDelete"),confirmLabel:r("common.delete"),cancelLabel:r("common.cancel"),onConfirm:Je,onCancel:()=>xe(null)})]})}export{At as default};

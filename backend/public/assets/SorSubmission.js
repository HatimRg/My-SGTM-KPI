import{j as e,a as Ie,u as qe,p as ve,w as Be,i as z,f as He,l as $e}from"./index.js";import{r as n}from"./vendor-react.js";import{s as Ve,g as fe}from"./projectList.js";import{D as oe}from"./DatePicker.js";import{p as Pe,ap as Ne,C as ke,z as d,A as we,a9 as Ze,au as _e,c as Ce,a5 as Ge,s as q,y as Ke,ac as Xe,o as J,i as ne,B as Je,a4 as Qe,ag as Ye,l as et,av as Q}from"./vendor-ui.js";import{A as Se}from"./AutocompleteInput.js";import"./vendor-utils.js";function ce({value:r,onChange:_,placeholder:Y="HH:MM",className:H="",disabled:g=!1}){const[h,j]=n.useState(!1),U=n.useRef(null),[p,$]=n.useState(()=>r?parseInt(r.split(":")[0]):new Date().getHours()),[k,E]=n.useState(()=>r?parseInt(r.split(":")[1]):Math.floor(new Date().getMinutes()/5)*5);n.useEffect(()=>{if(r){const[l,i]=r.split(":"),x=Number.parseInt(l,10),v=Number.parseInt(i,10);$(Number.isFinite(x)?x:0),E(Number.isFinite(v)?v:0)}},[r]),n.useEffect(()=>{const l=x=>{U.current&&!U.current.contains(x.target)&&j(!1)},i=x=>{x.key==="Escape"&&j(!1)};return h&&(document.addEventListener("mousedown",l),document.addEventListener("keydown",i)),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("keydown",i)}},[h]);const V=(l,i)=>`${String(l).padStart(2,"0")}:${String(i).padStart(2,"0")}`,L=(l,i)=>{const x=Math.max(0,Math.min(23,l)),v=Math.max(0,Math.min(59,i));$(x),E(v),_(V(x,v))},C=()=>L((p+1)%24,k),u=()=>L((p-1+24)%24,k),A=()=>L(p,(k+5)%60),Z=()=>L(p,(k-5+60)%60),o=["06:00","08:00","10:00","12:00","14:00","16:00","18:00"];return e.jsxs("div",{ref:U,className:`relative ${H}`,children:[e.jsxs("div",{onClick:()=>!g&&j(!h),className:`input flex items-center justify-between cursor-pointer ${g?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx("span",{className:r?"text-gray-900 dark:text-gray-100":"text-gray-400 dark:text-gray-500",children:r||Y}),e.jsx(Pe,{className:"w-4 h-4 text-gray-400"})]}),h&&e.jsxs("div",{className:"absolute z-[100] mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-3 w-56",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:C,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(Ne,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(p).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:u,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(ke,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]}),e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:":"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:A,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(Ne,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(k).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:Z,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(ke,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]})]}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-2",children:e.jsx("div",{className:"flex flex-wrap gap-1 justify-center",children:o.map(l=>e.jsx("button",{type:"button",onClick:()=>{_(l),j(!1)},className:`px-2 py-1 text-xs rounded transition-colors
                    ${r===l?"bg-hse-primary text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:l},l))})}),e.jsx("div",{className:"mt-2 pt-2 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{type:"button",onClick:()=>{_(V(p,k)),j(!1)},className:"w-full py-1.5 bg-hse-primary text-white rounded-lg hover:bg-hse-primary/90 transition-colors text-sm font-medium",children:"OK"})})]})]})}const B={nettoyage_rangement:"Nettoyage et Rangement",protection_chute:"Protection contre les chute",echafaudage:"Echafaudage/Echelles/Escaliers",epi:"Equipements de Protection Individuel",excavations:"Excavations",levage:"Levage",methode_travail:"Méthode de travail - SPA",manutention:"Manutention",vehicule_transport:"Vehicule/Transport",outils_equipements:"Outils/Equipements",chute_trebuchement:"Chute & Trébuchement",electricite:"Electricité",protection_incendie:"Protection Incendie",communication_attitude:"Communication/Attitude",acces_passage:"Accès/Passage/Issues de Secours",formation_toolbox:"Formation/Toolbox/Réunion",inspection_evaluation:"Inspection et Evaluation",documentation_hse:"Documentation HSE & Evaluation",gestion_sous_traitants:"Gestion des sous-traitants",autre:"Autre"};function lt(){const{t:r}=Ie(),{user:_}=qe(),[Y,H]=n.useState(!0),[g,h]=n.useState(!1),[j,U]=n.useState([]),[p,$]=n.useState([]),[k,E]=n.useState([]),[V,L]=n.useState([]),[C,u]=n.useState(!1),[A,Z]=n.useState(null),[o,l]=n.useState(null),[i,x]=n.useState({project_id:"",status:"",category:""}),[v,S]=n.useState(!1),[P,F]=n.useState(null),[ee,O]=n.useState(!1),[b,y]=n.useState({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),[G,K]=n.useState(null),[te,Re]=n.useState([]),[tt,ie]=n.useState(1),[De,le]=n.useState(!1),de=_?.project_list_preference??"code",me=n.useMemo(()=>Ve(p,de),[p,de]),[c,R]=n.useState({project_id:"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:_?.name??"",non_conformity:"",photo:null,category:"",responsible_person:""}),[xe,re]=n.useState(null),[se,he]=n.useState(null),[ae,ge]=n.useState(null);n.useEffect(()=>{const t=s=>{s.key==="Escape"&&(C&&(u(!1),N()),v&&(S(!1),w(),N()),ee&&(O(!1),w(),F(null)),o&&l(null))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[C,v,ee,o]),n.useEffect(()=>{let t=null,s=null,a=!1;const m=async I=>{let D=I?.replace(/^https?:\/\/[^/]+/,"");if(!D)return null;D.startsWith("/api/")?D=D.replace(/^\/api\//,"/"):D==="/api"&&(D="/");const We=await $e.get(D,{responseType:"blob"});return window.URL.createObjectURL(We.data)};return(async()=>{if(he(null),ge(null),!!o){try{o.photo_view_url&&(t=await m(o.photo_view_url),a||he(t))}catch(I){console.error("Error loading problem photo:",I)}try{o.corrective_action_photo_view_url&&(s=await m(o.corrective_action_photo_view_url),a||ge(s))}catch(I){console.error("Error loading corrective photo:",I)}}})(),()=>{a=!0,t&&window.URL.revokeObjectURL(t),s&&window.URL.revokeObjectURL(s)}},[o]),n.useEffect(()=>{W()},[i]),n.useEffect(()=>{Ee(),M()},[]),n.useEffect(()=>{C&&c.project_id&&X(c.project_id)},[C]);const Ee=async()=>{try{const[t,s]=await Promise.all([ve.getAll({per_page:100}),Be.getEntreprises()]),a=t.data.data??[];if($(a),L(s.data.data??[]),a.length===1){const m=a[0].id.toString();R(T=>({...T,project_id:m})),X(m)}}catch(t){console.error("Error fetching projects:",t)}},M=async()=>{try{const t=await z.getPinned();Re(t.data.data??[])}catch(t){console.error("Error fetching pinned reports:",t)}},X=async t=>{if(!t){E([]);return}try{const s=await ve.getZones(t);E(s.data?.data?.zones??[])}catch(s){console.error("Error fetching project zones:",s),E([])}},W=async()=>{H(!0);try{const t={};i.project_id&&(t.project_id=i.project_id),i.status&&(t.status=i.status),i.category&&(t.category=i.category);const s=await z.getAll(t);U(s.data.data??[])}catch(t){console.error("Error fetching SOR reports:",t),d.error(r("errors.fetchFailed"))}finally{H(!1)}},f=(t,s)=>{R(a=>({...a,[t]:s})),t==="project_id"&&(X(s),R(a=>({...a,zone:""})))},Le=t=>{const s=t.target.files[0];if(s){R(m=>({...m,photo:s}));const a=new FileReader;a.onloadend=()=>re(a.result),a.readAsDataURL(s)}},Ae=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){d.error(r("errors.invalidFileType")??r("errors.somethingWentWrong"));return}R(m=>({...m,photo:s}));const a=new FileReader;a.onloadend=()=>re(a.result),a.readAsDataURL(s)},N=()=>{R({project_id:p.length===1?p[0].id.toString():"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:_?.name??"",non_conformity:"",photo:null,category:"",responsible_person:""}),re(null),Z(null)},Fe=async t=>{if(t.preventDefault(),!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(r("sor.fillRequired"));return}if(A){h(!0);try{await z.update(A.id,c),d.success(r("sor.updateSuccess")),N(),u(!1),W(),M()}catch(s){const a=s.response?.data?.message||r("errors.somethingWentWrong");d.error(a)}finally{h(!1)}}else u(!1),S(!0)},Oe=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(r("sor.fillRequired")),S(!1),u(!0);return}h(!0);try{const t={...c,...b,submit_corrective_action:!0};await z.create(t),d.success(r("sor.createClosedSuccess")),N(),w(),S(!1),ie(1),W(),M()}catch(t){console.error("SOR submit error:",t.response?.data);const s=t.response?.data?.errors;if(s){const a=Object.values(s)[0];d.error(Array.isArray(a)?a[0]:a)}else d.error(t.response?.data?.message||r("errors.somethingWentWrong"))}finally{h(!1)}},Te=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(r("sor.fillRequired")),S(!1),u(!0);return}h(!0);try{const t={...c,submit_later:!0};console.log("Submitting SOR data:",t),await z.create(t),d.success(r("sor.createPinnedSuccess")),N(),S(!1),ie(1),W(),M()}catch(t){console.error("SOR submit later error:",t.response?.data);const s=t.response?.data?.errors;if(s){const a=Object.values(s)[0];d.error(Array.isArray(a)?a[0]:a)}else d.error(t.response?.data?.message||r("errors.somethingWentWrong"))}finally{h(!1)}},ze=async t=>{if(t.preventDefault(),!b.corrective_action){d.error(r("sor.correctiveRequired"));return}h(!0);try{await z.submitCorrectiveAction(P.id,b),d.success(r("sor.correctiveSubmitted")),w(),F(null),O(!1),W(),M()}catch(s){const a=s.response?.data?.message||r("errors.somethingWentWrong");d.error(a)}finally{h(!1)}},w=()=>{y({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),K(null)},pe=t=>{const s=t.target.files[0];if(s){y(m=>({...m,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>K(a.result),a.readAsDataURL(s)}},ue=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){d.error(r("errors.invalidFileType")||r("errors.somethingWentWrong"));return}y(m=>({...m,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>K(a.result),a.readAsDataURL(s)},be=t=>{F(t),y({corrective_action:t?.corrective_action??"",corrective_action_date:t?.corrective_action_date?t.corrective_action_date.split("T")[0]:new Date().toISOString().split("T")[0],corrective_action_time:t?.corrective_action_time??"",corrective_action_photo:null}),K(null),O(!0)},ye=t=>{X(t.project_id),R({project_id:t.project_id,company:t.company??"",observation_date:t.observation_date?.split("T")[0]??"",observation_time:t.observation_time??"",zone:t.zone??"",supervisor:t.supervisor??"",non_conformity:t.non_conformity??"",photo:null,category:t.category??"",responsible_person:t.responsible_person??""}),Z(t),u(!0)},Ue=t=>{F(t),w(),O(!0)},je=t=>{const s={open:"bg-red-100 text-red-700",in_progress:"bg-amber-100 text-amber-700",closed:"bg-green-100 text-green-700"},a={open:r("sor.status.open"),in_progress:r("sor.status.inProgress"),closed:r("sor.status.closed")};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s[t]}`,children:a[t]})},Me=async()=>{try{le(!0);const t={};i.project_id&&(t.project_id=i.project_id),i.status&&(t.status=i.status),i.category&&(t.category=i.category);const s=await He.exportDeviations(t),a=new Blob([s.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),m=window.URL.createObjectURL(a),T=document.createElement("a");T.href=m,T.download="deviations.xlsx",T.click(),window.URL.revokeObjectURL(m)}catch(t){console.error("Error exporting deviations:",t),d.error(r("errors.somethingWentWrong"))}finally{le(!1)}};return e.jsxs("div",{className:"p-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2",children:[e.jsx(we,{className:"w-7 h-7 text-amber-500"}),r("sor.title")]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:r("sor.subtitle")})]}),e.jsxs("button",{onClick:()=>{N(),u(!0)},className:"btn btn-primary flex items-center gap-2",children:[e.jsx(Ze,{className:"w-5 h-5"}),r("sor.addNew")]})]}),te.length>0&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(_e,{className:"w-5 h-5 text-amber-600 dark:text-amber-400"}),e.jsx("h3",{className:"font-semibold text-amber-800 dark:text-amber-300",children:r("sor.pendingCorrective")}),e.jsx("span",{className:"bg-amber-200 dark:bg-amber-700 text-amber-800 dark:text-amber-100 text-xs font-bold px-2 py-0.5 rounded-full",children:te.length})]}),e.jsx("div",{className:"grid gap-2",children:te.map(t=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 flex items-center justify-between border border-amber-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:new Date(t.observation_date).toLocaleDateString("fr-FR")})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 truncate max-w-md",children:t.non_conformity})]}),e.jsxs("button",{onClick:()=>be(t),className:"btn btn-primary btn-sm flex items-center gap-1",children:[e.jsx(Ce,{className:"w-4 h-4"}),r("sor.addCorrective")]})]},t.id))})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.project")}),e.jsxs("select",{value:i.project_id,onChange:t=>x(s=>({...s,project_id:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),me.map(t=>e.jsx("option",{value:t.id,children:fe(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.status.label")}),e.jsxs("select",{value:i.status,onChange:t=>x(s=>({...s,status:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),e.jsx("option",{value:"open",children:r("sor.status.open")}),e.jsx("option",{value:"in_progress",children:r("sor.status.inProgress")}),e.jsx("option",{value:"closed",children:r("sor.status.closed")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.category")}),e.jsxs("select",{value:i.category,onChange:t=>x(s=>({...s,category:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),Object.entries(B).map(([t,s])=>e.jsx("option",{value:t,children:s},t))]})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{onClick:()=>x({project_id:"",status:"",category:""}),className:"btn btn-outline w-full",type:"button",children:r("common.reset")}),e.jsxs("button",{type:"button",onClick:Me,disabled:De||j.length===0,className:"btn-secondary w-full flex items-center justify-center gap-2 text-sm",children:[e.jsx(Ge,{className:"w-4 h-4"}),e.jsx("span",{children:r("dashboard.exportExcel")})]})]})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden",children:Y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(q,{className:"w-8 h-8 animate-spin text-hse-primary"})}):j.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(we,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:r("sor.noReports")})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.date")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.project")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.zone")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.category")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.nonConformity")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.status.label")}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("common.actions")})]})}),e.jsx("tbody",{className:"divide-y dark:divide-gray-700",children:j.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:new Date(t.observation_date).toLocaleDateString("fr-FR")}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:t.zone??""}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("span",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 rounded text-xs",children:B[t.category]??t.category})}),e.jsx("td",{className:"px-4 py-3 text-sm max-w-xs truncate dark:text-gray-300",children:t.non_conformity}),e.jsx("td",{className:"px-4 py-3",children:je(t.status)}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>l(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded",title:r("common.view"),children:e.jsx(Ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ye(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-amber-600 hover:bg-amber-50 dark:hover:bg-amber-900/30 rounded",title:r("common.edit"),children:e.jsx(Xe,{className:"w-4 h-4"})}),t.status!=="closed"&&e.jsx("button",{onClick:()=>Ue(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 rounded",title:r("sor.markClosed"),children:e.jsx(J,{className:"w-4 h-4"})})]})})]},t.id))})]})})}),C&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"sticky top-0 z-[200] bg-white dark:bg-gray-800 border-b dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold dark:text-gray-100",children:r(A?"sor.editReport":"sor.newReport")}),e.jsx("button",{onClick:()=>{u(!1),N()},className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full dark:text-gray-300",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:Fe,className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.project")," *"]}),e.jsxs("select",{value:c.project_id,onChange:t=>f("project_id",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:r("sor.selectProject")}),me.map(t=>e.jsx("option",{value:t.id,children:fe(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.company")}),e.jsx(Se,{value:c.company,onChange:t=>f("company",t),suggestions:V,placeholder:"SGTM, Sous-traitant...",defaultValue:"SGTM",icon:e.jsx(Je,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Qe,{className:"w-4 h-4"}),r("sor.date")," *"]}),e.jsx(oe,{value:c.observation_date,onChange:t=>f("observation_date",t),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Pe,{className:"w-4 h-4"}),r("sor.time")]}),e.jsx(ce,{value:c.observation_time,onChange:t=>f("observation_time",t)})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Ye,{className:"w-4 h-4"}),r("sor.zone")]}),e.jsx(Se,{value:c.zone,onChange:t=>f("zone",t),suggestions:k,placeholder:r("sor.zonePlaceholder")||"Zone de travail...",disabled:!c.project_id})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(et,{className:"w-4 h-4"}),r("sor.supervisor")]}),e.jsx("input",{type:"text",value:c.supervisor,onChange:t=>f("supervisor",t.target.value),className:"input",placeholder:r("sor.supervisorPlaceholder")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.nonConformity")," *"]}),e.jsx("textarea",{value:c.non_conformity,onChange:t=>f("non_conformity",t.target.value),className:"input min-h-[100px]",placeholder:r("sor.nonConformityPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4"}),r("sor.photo")]}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5 transition-colors",onDragOver:t=>t.preventDefault(),onDrop:Ae,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:Le,className:"hidden"}),xe?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:xe,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(Q,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.category")," *"]}),e.jsxs("select",{value:c.category,onChange:t=>f("category",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:r("sor.selectCategory")}),Object.entries(B).map(([t,s])=>e.jsx("option",{value:t,children:s},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.responsiblePerson")}),e.jsx("input",{type:"text",value:c.responsible_person,onChange:t=>f("responsible_person",t.target.value),className:"input",placeholder:r("sor.responsiblePersonPlaceholder")})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{u(!1),N()},className:"btn btn-outline",children:r("common.cancel")}),e.jsx("button",{type:"submit",disabled:g,className:"btn btn-primary flex items-center gap-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4 animate-spin"}),r("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4"}),r(A?"common.update":"common.submit")]})})]})]})]})}),o&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"sticky top-0 z-[200] bg-white dark:bg-gray-800 border-b dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold dark:text-gray-100",children:r("sor.viewReport")}),e.jsx("button",{onClick:()=>l(null),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full dark:text-gray-300",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:r("sor.status.label")}),je(o.status)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.project")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.project?.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.company")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.company??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.date")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:new Date(o.observation_date).toLocaleDateString("fr-FR")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.time")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.observation_time??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.zone")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.zone??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.supervisor")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.supervisor??""})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.category")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:B[o.category]??o.category})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.nonConformity")}),e.jsx("p",{className:"font-medium bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-3 rounded-lg",children:o.non_conformity})]}),se&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.photo")}),e.jsx("img",{src:se,alt:"Non-conformity",className:"mt-2 rounded-lg max-h-64 object-contain border dark:border-gray-600 cursor-pointer hover:opacity-90",onClick:()=>window.open(se,"_blank")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.responsiblePerson")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.responsible_person??""})]}),o.corrective_action&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4",children:[e.jsx("span",{className:"text-green-700 dark:text-green-400 text-sm font-medium",children:r("sor.correctiveAction")}),e.jsx("p",{className:"font-medium text-green-800 dark:text-green-200 mt-1",children:o.corrective_action}),o.corrective_action_date&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-2",children:[r("sor.correctiveDate"),": ",new Date(o.corrective_action_date).toLocaleDateString("fr-FR"),o.corrective_action_time&&` à ${o.corrective_action_time}`]}),o.closer_name&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-1",children:[r("sor.closedBy"),": ",e.jsx("span",{className:"font-medium",children:o.closer_name})]}),ae&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:ae,alt:"Corrective action",className:"rounded-lg max-h-48 object-contain border border-green-200 dark:border-green-700 cursor-pointer hover:opacity-90",onClick:()=>window.open(ae,"_blank")})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsx("button",{onClick:()=>l(null),className:"btn btn-outline",children:r("common.close")}),o.status==="closed"&&o.corrective_action&&e.jsx("button",{onClick:()=>{be(o),l(null)},className:"btn btn-outline",children:r("sor.editCorrective")}),e.jsx("button",{onClick:()=>{ye(o),l(null)},className:"btn btn-primary",children:r("common.edit")})]})]})]})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-2xl w-full max-w-lg",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-amber-100 dark:bg-amber-900/50 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Ce,{className:"w-8 h-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h2",{className:"text-xl font-bold mb-2 dark:text-gray-100",children:r("sor.correctivePromptTitle")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:r("sor.correctivePromptMessage")})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(oe,{value:b.corrective_action_date,onChange:t=>y(s=>({...s,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(ce,{value:b.corrective_action_time,onChange:t=>y(s=>({...s,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:b.corrective_action,onChange:t=>y(s=>({...s,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",onDragOver:t=>t.preventDefault(),onDrop:ue,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:pe,className:"hidden"}),G?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:G,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{S(!1),w(),N()},className:"btn btn-outline flex-1",disabled:g,children:r("common.cancel")}),e.jsxs("button",{onClick:Te,className:"btn bg-amber-500 hover:bg-amber-600 text-white flex-1 flex items-center justify-center gap-2",disabled:g,children:[g?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(_e,{className:"w-4 h-4"}),r("sor.submitLater")]}),e.jsxs("button",{onClick:Oe,className:"btn btn-primary flex-1 flex items-center justify-center gap-2",disabled:g||!b.corrective_action,children:[g?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(J,{className:"w-4 h-4"}),r("sor.submitAndClose")]})]})]})})}),ee&&P&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl w-full max-w-lg",children:[e.jsxs("div",{className:"sticky top-0 z-[200] bg-white dark:bg-gray-800 border-b dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold dark:text-gray-100",children:r("sor.addCorrectiveTitle")}),e.jsx("button",{onClick:()=>{O(!1),w(),F(null)},className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full dark:text-gray-300",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-500 dark:text-gray-400 mb-2",children:r("sor.problemSummary")}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.project"),":"]})," ",P.project?.name]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.date"),":"]})," ",new Date(P.observation_date).toLocaleDateString("fr-FR")]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.category"),":"]})," ",B[P.category]||P.category]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-400 mt-2",children:P.non_conformity})]})]}),e.jsxs("form",{onSubmit:ze,className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(oe,{value:b.corrective_action_date,onChange:t=>y(s=>({...s,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(ce,{value:b.corrective_action_time,onChange:t=>y(s=>({...s,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:b.corrective_action,onChange:t=>y(s=>({...s,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",onDragOver:t=>t.preventDefault(),onDrop:ue,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:pe,className:"hidden"}),G?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:G,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{O(!1),w(),F(null)},className:"btn btn-outline",children:r("common.cancel")}),e.jsx("button",{type:"submit",disabled:g,className:"btn btn-primary flex items-center gap-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4 animate-spin"}),r("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4"}),r("sor.submitAndClose")]})})]})]})]})})]})}export{lt as default};

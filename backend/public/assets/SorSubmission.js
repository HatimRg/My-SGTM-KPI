import{j as e,a as He,u as $e,p as ve,w as Ve,l as z,f as Ze,m as Ge}from"./index.js";import{r as n}from"./vendor-react.js";import{s as Ke,g as ye}from"./projectList.js";import{M as X}from"./Modal.js";import{D as Y}from"./DatePicker.js";import{p as Se,ap as fe,C as Ne,z as m,A as _e,a9 as Je,au as ke,c as we,a5 as Qe,s as H,y as Xe,ac as Ye,o as ee,B as et,a4 as tt,ag as rt,l as st,av as $}from"./vendor-ui.js";import{A as Ce}from"./AutocompleteInput.js";import"./vendor-utils.js";function te({value:r,onChange:D,placeholder:re="HH:MM",className:Z="",disabled:g=!1}){const[h,f]=n.useState(!1),W=n.useRef(null),[u,G]=n.useState(()=>r?parseInt(r.split(":")[0]):new Date().getHours()),[w,A]=n.useState(()=>r?parseInt(r.split(":")[1]):Math.floor(new Date().getMinutes()/5)*5);n.useEffect(()=>{if(r){const[l,i]=r.split(":"),x=Number.parseInt(l,10),N=Number.parseInt(i,10);G(Number.isFinite(x)?x:0),A(Number.isFinite(N)?N:0)}},[r]),n.useEffect(()=>{const l=x=>{W.current&&!W.current.contains(x.target)&&f(!1)},i=x=>{x.key==="Escape"&&f(!1)};return h&&(document.addEventListener("mousedown",l),document.addEventListener("keydown",i)),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("keydown",i)}},[h]);const K=(l,i)=>`${String(l).padStart(2,"0")}:${String(i).padStart(2,"0")}`,F=(l,i)=>{const x=Math.max(0,Math.min(23,l)),N=Math.max(0,Math.min(59,i));G(x),A(N),D(K(x,N))},R=()=>F((u+1)%24,w),b=()=>F((u-1+24)%24,w),E=()=>F(u,(w+5)%60),J=()=>F(u,(w-5+60)%60),o=["06:00","08:00","10:00","12:00","14:00","16:00","18:00"];return e.jsxs("div",{ref:W,className:`relative ${Z}`,children:[e.jsxs("div",{onClick:()=>!g&&f(!h),className:`input flex items-center justify-between cursor-pointer ${g?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx("span",{className:r?"text-gray-900 dark:text-gray-100":"text-gray-400 dark:text-gray-500",children:r||re}),e.jsx(Se,{className:"w-4 h-4 text-gray-400"})]}),h&&e.jsxs("div",{className:"absolute z-[100] mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-3 w-56",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:R,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(fe,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(u).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:b,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(Ne,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]}),e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:":"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:E,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(fe,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(w).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:J,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(Ne,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]})]}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-2",children:e.jsx("div",{className:"flex flex-wrap gap-1 justify-center",children:o.map(l=>e.jsx("button",{type:"button",onClick:()=>{D(l),f(!1)},className:`px-2 py-1 text-xs rounded transition-colors
                    ${r===l?"bg-hse-primary text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:l},l))})}),e.jsx("div",{className:"mt-2 pt-2 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{type:"button",onClick:()=>{D(K(u,w)),f(!1)},className:"w-full py-1.5 bg-hse-primary text-white rounded-lg hover:bg-hse-primary/90 transition-colors text-sm font-medium",children:"OK"})})]})]})}const V={nettoyage_rangement:"Nettoyage et Rangement",protection_chute:"Protection contre les chute",echafaudage:"Echafaudage/Echelles/Escaliers",epi:"Equipements de Protection Individuel",excavations:"Excavations",levage:"Levage",methode_travail:"Méthode de travail - SPA",manutention:"Manutention",vehicule_transport:"Vehicule/Transport",outils_equipements:"Outils/Equipements",chute_trebuchement:"Chute & Trébuchement",electricite:"Electricité",protection_incendie:"Protection Incendie",communication_attitude:"Communication/Attitude",acces_passage:"Accès/Passage/Issues de Secours",formation_toolbox:"Formation/Toolbox/Réunion",inspection_evaluation:"Inspection et Evaluation",documentation_hse:"Documentation HSE & Evaluation",gestion_sous_traitants:"Gestion des sous-traitants",autre:"Autre"};function ht(){const{t:r}=He(),{user:D}=$e(),[re,Z]=n.useState(!0),[g,h]=n.useState(!1),[f,W]=n.useState([]),[u,G]=n.useState([]),[w,A]=n.useState([]),[K,F]=n.useState([]),[R,b]=n.useState(!1),[E,J]=n.useState(null),[o,l]=n.useState(null),[i,x]=n.useState({project_id:"",status:"",category:""}),[N,C]=n.useState(!1),[S,O]=n.useState(null),[se,T]=n.useState(!1),[j,v]=n.useState({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),[U,P]=n.useState(null),[ae,Pe]=n.useState([]),[at,le]=n.useState(1),[De,de]=n.useState(!1),me=D?.project_list_preference??"code",xe=n.useMemo(()=>Ke(u,me),[u,me]),[c,_]=n.useState({project_id:"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:D?.name??"",non_conformity:"",photo:null,category:"",responsible_person:"",corrective_action:"",corrective_action_date:"",corrective_action_time:"",corrective_action_photo:null}),[he,oe]=n.useState(null),[ne,ge]=n.useState(null),[ce,pe]=n.useState(null);n.useEffect(()=>{const t=s=>{s.key==="Escape"&&(R&&(b(!1),y()),N&&(C(!1),k(),y()),se&&(T(!1),k(),O(null)),o&&l(null))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[R,N,se,o]),n.useEffect(()=>{let t=null,s=null,a=!1;const d=async B=>{let L=B?.replace(/^https?:\/\/[^/]+/,"");if(!L)return null;L.startsWith("/api/")?L=L.replace(/^\/api\//,"/"):L==="/api"&&(L="/");const Be=await Ge.get(L,{responseType:"blob"});return window.URL.createObjectURL(Be.data)};return(async()=>{if(ge(null),pe(null),!!o){try{o.photo_view_url&&(t=await d(o.photo_view_url),a||ge(t))}catch(B){console.error("Error loading problem photo:",B)}try{o.corrective_action_photo_view_url&&(s=await d(o.corrective_action_photo_view_url),a||pe(s))}catch(B){console.error("Error loading corrective photo:",B)}}})(),()=>{a=!0,t&&window.URL.revokeObjectURL(t),s&&window.URL.revokeObjectURL(s)}},[o]),n.useEffect(()=>{q()},[i]),n.useEffect(()=>{Re(),I()},[]),n.useEffect(()=>{R&&c.project_id&&Q(c.project_id)},[R]);const Re=async()=>{try{const[t,s]=await Promise.all([ve.getAll({per_page:100}),Ve.getEntreprises()]),a=t.data.data??[];if(G(a),F(s.data.data??[]),a.length===1){const d=a[0].id.toString();_(M=>({...M,project_id:d})),Q(d)}}catch(t){console.error("Error fetching projects:",t)}},I=async()=>{try{const t=await z.getPinned();Pe(t.data.data??[])}catch(t){console.error("Error fetching pinned reports:",t)}},Q=async t=>{if(!t){A([]);return}try{const s=await ve.getZones(t);A(s.data?.data?.zones??[])}catch(s){console.error("Error fetching project zones:",s),A([])}},q=async()=>{Z(!0);try{const t={};i.project_id&&(t.project_id=i.project_id),i.status&&(t.status=i.status),i.category&&(t.category=i.category);const s=await z.getAll(t);W(s.data.data??[])}catch(t){console.error("Error fetching SOR reports:",t),m.error(r("errors.fetchFailed"))}finally{Z(!1)}},p=(t,s)=>{_(a=>({...a,[t]:s})),t==="project_id"&&(Q(s),_(a=>({...a,zone:""})))},Ee=t=>{const s=t.target.files[0];if(s){_(d=>({...d,photo:s}));const a=new FileReader;a.onloadend=()=>oe(a.result),a.readAsDataURL(s)}},Le=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){m.error(r("errors.invalidFileType")??r("errors.somethingWentWrong"));return}_(d=>({...d,photo:s}));const a=new FileReader;a.onloadend=()=>oe(a.result),a.readAsDataURL(s)},y=()=>{_({project_id:u.length===1?u[0].id.toString():"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:D?.name??"",non_conformity:"",photo:null,category:"",responsible_person:"",corrective_action:"",corrective_action_date:"",corrective_action_time:"",corrective_action_photo:null}),oe(null),P(null),J(null)},Ae=async t=>{if(t.preventDefault(),!c.project_id||!c.observation_date||!c.non_conformity||!c.category){m.error(r("sor.fillRequired"));return}if(E){h(!0);try{await z.update(E.id,c),m.success(r("sor.updateSuccess")),y(),b(!1),q(),I()}catch(s){const a=s.response?.data?.message||r("errors.somethingWentWrong");m.error(a)}finally{h(!1)}}else b(!1),C(!0)},Fe=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){m.error(r("sor.fillRequired")),C(!1),b(!0);return}h(!0);try{const t={...c,...j,submit_corrective_action:!0};await z.create(t),m.success(r("sor.createClosedSuccess")),y(),k(),C(!1),le(1),q(),I()}catch(t){console.error("SOR submit error:",t.response?.data);const s=t.response?.data?.errors;if(s){const a=Object.values(s)[0];m.error(Array.isArray(a)?a[0]:a)}else m.error(t.response?.data?.message||r("errors.somethingWentWrong"))}finally{h(!1)}},Oe=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){m.error(r("sor.fillRequired")),C(!1),b(!0);return}h(!0);try{const t={...c,submit_later:!0};console.log("Submitting SOR data:",t),await z.create(t),m.success(r("sor.createPinnedSuccess")),y(),C(!1),le(1),q(),I()}catch(t){console.error("SOR submit later error:",t.response?.data);const s=t.response?.data?.errors;if(s){const a=Object.values(s)[0];m.error(Array.isArray(a)?a[0]:a)}else m.error(t.response?.data?.message||r("errors.somethingWentWrong"))}finally{h(!1)}},Te=async t=>{if(t.preventDefault(),!j.corrective_action){m.error(r("sor.correctiveRequired"));return}h(!0);try{await z.submitCorrectiveAction(S.id,j),m.success(r("sor.correctiveSubmitted")),k(),O(null),T(!1),q(),I()}catch(s){const a=s.response?.data?.message||r("errors.somethingWentWrong");m.error(a)}finally{h(!1)}},k=()=>{v({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),P(null)},ue=t=>{const s=t.target.files[0];if(s){v(d=>({...d,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>P(a.result),a.readAsDataURL(s)}},be=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){m.error(r("errors.invalidFileType")||r("errors.somethingWentWrong"));return}v(d=>({...d,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>P(a.result),a.readAsDataURL(s)},Ue=t=>{O(t),v({corrective_action:t?.corrective_action??"",corrective_action_date:t?.corrective_action_date?t.corrective_action_date.split("T")[0]:new Date().toISOString().split("T")[0],corrective_action_time:t?.corrective_action_time??"",corrective_action_photo:null}),P(null),T(!0)},ie=t=>{Q(t.project_id),_({project_id:t.project_id,company:t.company??"",observation_date:t.observation_date?.split("T")[0]??"",observation_time:t.observation_time??"",zone:t.zone??"",supervisor:t.supervisor??"",non_conformity:t.non_conformity??"",photo:null,category:t.category??"",responsible_person:t.responsible_person??"",corrective_action:t.corrective_action??"",corrective_action_date:t.corrective_action_date?t.corrective_action_date.split("T")[0]:"",corrective_action_time:t.corrective_action_time??"",corrective_action_photo:null}),P(null),J(t),b(!0)},Me=t=>{Le(t)},ze=t=>{const s=t.target.files[0];if(s){_(d=>({...d,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>P(a.result),a.readAsDataURL(s)}},We=t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer?.files?.[0];if(!s)return;if(!s.type?.startsWith("image/")){m.error(r("errors.invalidFileType")||r("errors.somethingWentWrong"));return}_(d=>({...d,corrective_action_photo:s}));const a=new FileReader;a.onloadend=()=>P(a.result),a.readAsDataURL(s)},Ie=t=>{O(t),k(),T(!0)},je=t=>{const s={open:"bg-red-100 text-red-700",in_progress:"bg-amber-100 text-amber-700",closed:"bg-green-100 text-green-700"},a={open:r("sor.status.open"),in_progress:r("sor.status.inProgress"),closed:r("sor.status.closed")};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s[t]}`,children:a[t]})},qe=async()=>{try{de(!0);const t={};i.project_id&&(t.project_id=i.project_id),i.status&&(t.status=i.status),i.category&&(t.category=i.category);const s=await Ze.exportDeviations(t),a=new Blob([s.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),d=window.URL.createObjectURL(a),M=document.createElement("a");M.href=d,M.download="deviations.xlsx",M.click(),window.URL.revokeObjectURL(d)}catch(t){console.error("Error exporting deviations:",t),m.error(r("errors.somethingWentWrong"))}finally{de(!1)}};return e.jsxs("div",{className:"p-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2",children:[e.jsx(_e,{className:"w-7 h-7 text-amber-500"}),r("sor.title")]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:r("sor.subtitle")})]}),e.jsxs("button",{onClick:()=>{y(),b(!0)},className:"btn btn-primary flex items-center gap-2",children:[e.jsx(Je,{className:"w-5 h-5"}),r("sor.addNew")]})]}),ae.length>0&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(ke,{className:"w-5 h-5 text-amber-600 dark:text-amber-400"}),e.jsx("h3",{className:"font-semibold text-amber-800 dark:text-amber-300",children:r("sor.pendingCorrective")}),e.jsx("span",{className:"bg-amber-200 dark:bg-amber-700 text-amber-800 dark:text-amber-100 text-xs font-bold px-2 py-0.5 rounded-full",children:ae.length})]}),e.jsx("div",{className:"grid gap-2",children:ae.map(t=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 flex items-center justify-between border border-amber-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:new Date(t.observation_date).toLocaleDateString("fr-FR")})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 truncate max-w-md",children:t.non_conformity})]}),e.jsxs("button",{onClick:()=>Ue(t),className:"btn btn-primary btn-sm flex items-center gap-1",children:[e.jsx(we,{className:"w-4 h-4"}),r("sor.addCorrective")]})]},t.id))})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.project")}),e.jsxs("select",{value:i.project_id,onChange:t=>x(s=>({...s,project_id:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),xe.map(t=>e.jsx("option",{value:t.id,children:ye(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.status.label")}),e.jsxs("select",{value:i.status,onChange:t=>x(s=>({...s,status:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),e.jsx("option",{value:"open",children:r("sor.status.open")}),e.jsx("option",{value:"in_progress",children:r("sor.status.inProgress")}),e.jsx("option",{value:"closed",children:r("sor.status.closed")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.category")}),e.jsxs("select",{value:i.category,onChange:t=>x(s=>({...s,category:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:r("common.all")}),Object.entries(V).map(([t,s])=>e.jsx("option",{value:t,children:s},t))]})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{onClick:()=>x({project_id:"",status:"",category:""}),className:"btn btn-outline w-full",type:"button",children:r("common.reset")}),e.jsxs("button",{type:"button",onClick:qe,disabled:De||f.length===0,className:"btn-secondary w-full flex items-center justify-center gap-2 text-sm",children:[e.jsx(Qe,{className:"w-4 h-4"}),e.jsx("span",{children:r("dashboard.exportExcel")})]})]})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden",children:re?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(H,{className:"w-8 h-8 animate-spin text-hse-primary"})}):f.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(_e,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:r("sor.noReports")})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.date")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.project")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.zone")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.category")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.nonConformity")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("sor.status.label")}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:r("common.actions")})]})}),e.jsx("tbody",{className:"divide-y dark:divide-gray-700",children:f.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:new Date(t.observation_date).toLocaleDateString("fr-FR")}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:t.zone??""}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("span",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 rounded text-xs",children:V[t.category]??t.category})}),e.jsx("td",{className:"px-4 py-3 text-sm max-w-xs truncate dark:text-gray-300",children:t.non_conformity}),e.jsx("td",{className:"px-4 py-3",children:je(t.status)}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>l(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded",title:r("common.view"),children:e.jsx(Xe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ie(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-amber-600 hover:bg-amber-50 dark:hover:bg-amber-900/30 rounded",title:r("common.edit"),children:e.jsx(Ye,{className:"w-4 h-4"})}),t.status!=="closed"&&e.jsx("button",{onClick:()=>Ie(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 rounded",title:r("sor.markClosed"),children:e.jsx(ee,{className:"w-4 h-4"})})]})})]},t.id))})]})})}),e.jsx(X,{isOpen:R,onClose:()=>{b(!1),y()},title:r(E?"sor.editReport":"sor.newReport"),size:"xl",children:e.jsxs("form",{onSubmit:Ae,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.project")," *"]}),e.jsxs("select",{value:c.project_id,onChange:t=>p("project_id",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:r("sor.selectProject")}),xe.map(t=>e.jsx("option",{value:t.id,children:ye(t)},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.company")}),e.jsx(Ce,{value:c.company,onChange:t=>p("company",t),suggestions:K,placeholder:"SGTM, Sous-traitant...",defaultValue:"SGTM",icon:e.jsx(et,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(tt,{className:"w-4 h-4"}),r("sor.date")," *"]}),e.jsx(Y,{value:c.observation_date,onChange:t=>p("observation_date",t),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Se,{className:"w-4 h-4"}),r("sor.time")]}),e.jsx(te,{value:c.observation_time,onChange:t=>p("observation_time",t)})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(rt,{className:"w-4 h-4"}),r("sor.zone")]}),e.jsx(Ce,{value:c.zone,onChange:t=>p("zone",t),suggestions:w,placeholder:r("sor.zonePlaceholder")||"Zone de travail...",disabled:!c.project_id})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(st,{className:"w-4 h-4"}),r("sor.supervisor")]}),e.jsx("input",{type:"text",value:c.supervisor,onChange:t=>p("supervisor",t.target.value),className:"input",placeholder:r("sor.supervisorPlaceholder")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.nonConformity")," *"]}),e.jsx("textarea",{value:c.non_conformity,onChange:t=>p("non_conformity",t.target.value),className:"input min-h-[100px]",placeholder:r("sor.nonConformityPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4"}),r("sor.photo")]}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5 transition-colors",onDragOver:t=>t.preventDefault(),onDrop:Me,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:Ee,className:"hidden"}),he?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:he,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs("div",{className:"text-center",children:[e.jsx($,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.category")," *"]}),e.jsxs("select",{value:c.category,onChange:t=>p("category",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:r("sor.selectCategory")}),Object.entries(V).map(([t,s])=>e.jsx("option",{value:t,children:s},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.responsiblePerson")}),e.jsx("input",{type:"text",value:c.responsible_person,onChange:t=>p("responsible_person",t.target.value),className:"input",placeholder:r("sor.responsiblePersonPlaceholder")})]}),E&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(Y,{value:c.corrective_action_date,onChange:t=>p("corrective_action_date",t)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(te,{value:c.corrective_action_time,onChange:t=>p("corrective_action_time",t)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveAction")}),e.jsx("textarea",{value:c.corrective_action,onChange:t=>p("corrective_action",t.target.value),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-green-200 dark:border-green-800 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors bg-white/60 dark:bg-gray-900/20",onDragOver:t=>t.preventDefault(),onDrop:We,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:ze,className:"hidden"}),U?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:U,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{b(!1),y()},className:"btn btn-outline",children:r("common.cancel")}),e.jsx("button",{type:"submit",disabled:g,className:"btn btn-primary flex items-center gap-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4 animate-spin"}),r("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4"}),r(E?"common.update":"common.submit")]})})]})]})}),e.jsx(X,{isOpen:!!o,onClose:()=>l(null),title:r("sor.viewReport"),size:"lg",children:o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:r("sor.status.label")}),je(o.status)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.project")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.project?.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.company")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.company??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.date")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:new Date(o.observation_date).toLocaleDateString("fr-FR")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.time")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.observation_time??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.zone")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.zone??""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.supervisor")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.supervisor??""})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.category")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:V[o.category]??o.category})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.nonConformity")}),e.jsx("p",{className:"font-medium bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-3 rounded-lg",children:o.non_conformity})]}),ne&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.photo")}),e.jsx("img",{src:ne,alt:"Non-conformity",className:"mt-2 rounded-lg max-h-64 object-contain border dark:border-gray-600 cursor-pointer hover:opacity-90",onClick:()=>window.open(ne,"_blank")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:r("sor.responsiblePerson")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:o.responsible_person??""})]}),o.corrective_action&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4",children:[e.jsx("span",{className:"text-green-700 dark:text-green-400 text-sm font-medium",children:r("sor.correctiveAction")}),e.jsx("p",{className:"font-medium text-green-800 dark:text-green-200 mt-1",children:o.corrective_action}),o.corrective_action_date&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-2",children:[r("sor.correctiveDate"),": ",new Date(o.corrective_action_date).toLocaleDateString("fr-FR"),o.corrective_action_time&&` à ${o.corrective_action_time}`]}),o.closer_name&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-1",children:[r("sor.closedBy"),": ",e.jsx("span",{className:"font-medium",children:o.closer_name})]}),ce&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:ce,alt:"Corrective action",className:"rounded-lg max-h-48 object-contain border border-green-200 dark:border-green-700 cursor-pointer hover:opacity-90",onClick:()=>window.open(ce,"_blank")})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsx("button",{onClick:()=>l(null),className:"btn btn-outline",children:r("common.close")}),o.status==="closed"&&o.corrective_action&&e.jsx("button",{onClick:()=>{ie(o),l(null)},className:"btn btn-outline",children:r("sor.editCorrective")}),e.jsx("button",{onClick:()=>{ie(o),l(null)},className:"btn btn-primary",children:r("common.edit")})]})]})}),e.jsx(X,{isOpen:N,onClose:()=>{C(!1),k(),y()},title:r("sor.correctivePromptTitle"),size:"md",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-amber-100 dark:bg-amber-900/50 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(we,{className:"w-8 h-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h2",{className:"text-xl font-bold mb-2 dark:text-gray-100",children:r("sor.correctivePromptTitle")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:r("sor.correctivePromptMessage")})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(Y,{value:j.corrective_action_date,onChange:t=>v(s=>({...s,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(te,{value:j.corrective_action_time,onChange:t=>v(s=>({...s,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:j.corrective_action,onChange:t=>v(s=>({...s,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",onDragOver:t=>t.preventDefault(),onDrop:be,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:ue,className:"hidden"}),U?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:U,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{C(!1),k(),y()},className:"btn btn-outline flex-1",disabled:g,children:r("common.cancel")}),e.jsxs("button",{onClick:Oe,className:"btn bg-amber-500 hover:bg-amber-600 text-white flex-1 flex items-center justify-center gap-2",disabled:g,children:[g?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(ke,{className:"w-4 h-4"}),r("sor.submitLater")]}),e.jsxs("button",{onClick:Fe,className:"btn btn-primary flex-1 flex items-center justify-center gap-2",disabled:g||!j.corrective_action,children:[g?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(ee,{className:"w-4 h-4"}),r("sor.submitAndClose")]})]})]})}),e.jsx(X,{isOpen:se&&!!S,onClose:()=>{T(!1),k(),O(null)},title:r("sor.addCorrectiveTitle"),size:"md",children:S&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-500 dark:text-gray-400 mb-2",children:r("sor.problemSummary")}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.project"),":"]})," ",S.project?.name]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.date"),":"]})," ",new Date(S.observation_date).toLocaleDateString("fr-FR")]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[r("sor.category"),":"]})," ",V[S.category]||S.category]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-400 mt-2",children:S.non_conformity})]})]}),e.jsxs("form",{onSubmit:Te,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveDate")}),e.jsx(Y,{value:j.corrective_action_date,onChange:t=>v(s=>({...s,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctiveTime")}),e.jsx(te,{value:j.corrective_action_time,onChange:t=>v(s=>({...s,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[r("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:j.corrective_action,onChange:t=>v(s=>({...s,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:r("sor.correctiveActionPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:r("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",onDragOver:t=>t.preventDefault(),onDrop:be,children:[e.jsx("input",{type:"file",accept:"image/*",onChange:ue,className:"hidden"}),U?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:U,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:r("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{T(!1),k(),O(null)},className:"btn btn-outline",children:r("common.cancel")}),e.jsx("button",{type:"submit",disabled:g,className:"btn btn-primary flex items-center gap-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4 animate-spin"}),r("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4"}),r("sor.submitAndClose")]})})]})]})]})})]})}export{ht as default};

import{a as ke,u as _e,g as u,i as Se,j as e,M as Ce}from"./index.js";import{r as t,L as Pe}from"./vendor-react.js";import{D as H}from"./DatePicker.js";import{C as De}from"./ConfirmDialog.js";import{S as F}from"./Select.js";import{A as Me}from"./AutocompleteInput.js";import{Z as Ae}from"./ZonesManager.js";import{z as i,F as Y,au as Fe,a0 as E,av as Ee,w as Te,aw as Ue,aB as Le,ap as Oe,U as Re,E as Ze,aC as Be,ax as ze,aA as Ie}from"./vendor-ui.js";import"./vendor-utils.js";function Qe(){const{t:o}=ke(),{user:d}=_e(),J=d?.role==="admin"||d?.role==="responsable"||d?.role==="hse_manager"||d?.role==="works_director"||d?.role==="hse_director"||d?.role==="hr_director"||d?.role==="pole_director",[Q,W]=t.useState([]),[ee,se]=t.useState([]),[ae,T]=t.useState(!0),[j,te]=t.useState(""),[U,re]=t.useState(""),[N,le]=t.useState(""),[y,ne]=t.useState(""),[oe,L]=t.useState(!1),[b,w]=t.useState(null),[O,R]=t.useState([]),[ce,k]=t.useState(!1),[x,_]=t.useState(null),[Z,B]=t.useState(!1),S=t.useRef(null),v=t.useRef(null),[ie,z]=t.useState(!1),[I,$]=t.useState(null),[r,c]=t.useState({name:"",code:"",description:"",location:"",start_date:"",end_date:"",status:"active",pole:"",client_name:"",user_ids:[]}),[q,G]=t.useState(!1),[m,de]=t.useState({current_page:1,last_page:1}),[h,C]=t.useState(null);t.useEffect(()=>{const s=setTimeout(()=>{re(j.trim())},350);return()=>clearTimeout(s)},[j]),t.useEffect(()=>{g(1,U)},[U,N,y]),t.useEffect(()=>{pe()},[]),t.useEffect(()=>{P()},[]),t.useEffect(()=>{const s=a=>{S.current&&!S.current.contains(a.target)&&k(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const P=async()=>{try{const s=await u.getPoles(),a=s.data?.data?.poles??s.data?.poles??[];R(Array.isArray(a)?a:[])}catch{R([])}},me=s=>{$(s),z(!0)},K=s=>{if(!s)return null;const a=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(s),l=decodeURIComponent(a?.[1]??a?.[2]??"");return l!==""?l:null},V=(s,a)=>{const l=URL.createObjectURL(s),n=document.createElement("a");n.href=l,n.download=a??"template.xlsx",document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>URL.revokeObjectURL(l),5e3)},ue=async()=>{try{const s=await u.downloadTemplate(),a=K(s.headers?.["content-disposition"])??"SGTM-Projects-Template.xlsx";V(s.data,a)}catch{i.error(o("projects.bulk.downloadTemplateFailed"))}},xe=async()=>{try{const s=new Date().getFullYear(),a=await u.managementExport({year:s}),l=K(a.headers?.["content-disposition"])??`SGTM-Project-Management-Export_${s}.xlsx`;V(a.data,l)}catch{i.error(o("errors.exportFailed"))}},ge=async()=>{if(!x){i.error(o("projects.bulk.chooseFile"));return}try{B(!0);const s=new FormData;s.append("file",x);const l=(await u.bulkImport(s)).data?.data??{},n=l.imported??0,p=l.updated??0,f=l.errors??[];i.success(o("projects.bulk.importSummary",{imported:n,updated:p})),f.length>0&&i.error(o("projects.bulk.importIssues",{count:f.length})),_(null),k(!1),g(),P()}catch(s){i.error(s.response?.data?.message??o("projects.bulk.importFailed"))}finally{B(!1)}},g=async(s=1,a=j)=>{try{T(!0);const l=await u.getAll({page:s,search:a,status:N,pole:y||void 0,per_page:10});W(l.data.data??[]),de(l.data.meta??{current_page:1,last_page:1})}catch{i.error(o("errors.failedToLoad"))}finally{T(!1)}},pe=async()=>{try{const s=await Se.getAll({per_page:100,role:"responsable"});se(s.data.data??[])}catch{console.error("Failed to load users")}},X=(s=null)=>{s?(w(s),c({name:s.name,code:s.code,description:s.description??"",location:s.location??"",start_date:s.start_date?.split("T")[0]??"",end_date:s.end_date?.split("T")[0]??"",status:s.status,pole:s.pole??"",client_name:s.client_name??"",user_ids:s.users?.map(a=>a.id)??[]})):(w(null),c({name:"",code:"",description:"",location:"",start_date:"",end_date:"",status:"active",pole:"",client_name:"",user_ids:[]})),P(),L(!0)},D=()=>{L(!1),w(null)},he=s=>{const a=Array.isArray(s.user_ids)?s.user_ids.map(n=>Number(n)).filter(n=>Number.isFinite(n)):[];return{...s,name:(s.name??"").trim(),code:(s.code??"").trim(),start_date:s.start_date?s.start_date:null,end_date:s.end_date?s.end_date:null,status:s.status?s.status:"active",pole:(s.pole??"").trim()||null,client_name:(s.client_name??"").trim()||null,location:(s.location??"").trim()||null,description:(s.description??"").trim()||null,user_ids:a}},fe=s=>{const a=s?.response?.data,l=[a?.errors,a?.data?.errors,a?.error?.errors];for(const p of l)if(p&&typeof p=="object"){const f=Object.keys(p);if(f.length>0){const we=f[0],M=p[we],A=Array.isArray(M)?M[0]:M;if(typeof A=="string"&&A.trim()!=="")return A}}const n=a?.message??a?.data?.message;return typeof n=="string"&&n.trim()!==""?n:o("errors.failedToSave")},je=async s=>{s.preventDefault(),G(!0);try{const a=he(r);b?(await u.update(b.id,a),i.success(o("projects.projectUpdated"))):(await u.create(a),i.success(o("projects.projectCreated"))),D(),g()}catch(a){i.error(fe(a))}finally{G(!1)}},ye=s=>{C(s)},be=async()=>{if(h)try{await u.delete(h.id),i.success(o("projects.projectDeleted")),g()}catch(s){i.error(s.response?.data?.message??o("errors.failedToDelete"))}finally{C(null)}},ve=s=>{c(a=>({...a,user_ids:a.user_ids.includes(s)?a.user_ids.filter(l=>l!==s):[...a.user_ids,s]}))},Ne={active:"badge-success",completed:"badge-info",on_hold:"badge-warning",cancelled:"badge-danger"};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Project Management"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"Manage projects and assign responsible users"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[d?.role==="admin"&&e.jsxs("button",{type:"button",onClick:xe,className:"btn-secondary flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),"Export"]}),e.jsxs("div",{ref:S,className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>k(s=>!s),className:"btn-secondary flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4"}),"Massive Add"]}),ce&&e.jsx("div",{className:"absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-4 z-50",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{type:"button",onClick:ue,className:"btn-secondary w-full",children:"Download Template"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{ref:v,type:"file",accept:".xlsx,.xls",onChange:s=>_(s.target.files?.[0]??null),className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>v.current?.click(),className:"w-full rounded-lg border border-dashed border-gray-300 dark:border-gray-600 px-3 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700/50 transition",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:"Select XLSX file"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:x?x.name:"Choose the filled template (.xlsx)"})]}),e.jsx("div",{className:"text-xs font-semibold px-2 py-1 rounded-md bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",children:"Browse"})]})}),x&&e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-300 truncate",children:["Selected: ",e.jsx("span",{className:"font-semibold",children:x.name})]}),e.jsx("button",{type:"button",onClick:()=>{_(null),v.current&&(v.current.value="")},className:"text-xs font-semibold text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100",children:"Clear"})]})]}),e.jsx("button",{type:"button",onClick:ge,disabled:Z||!x,className:"btn-primary w-full",children:Z?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 animate-spin"}),"Uploading..."]}):"Upload"})]})})]}),e.jsxs("button",{onClick:()=>X(),className:"btn-primary flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Add Project"]})]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search projects...",value:j,onChange:s=>te(s.target.value),className:"input pl-10"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2",children:[e.jsx(Ue,{className:"hidden sm:block w-4 h-4 text-gray-400"}),e.jsxs(F,{value:N,onChange:s=>le(s.target.value),className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"on_hold",children:"On Hold"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]}),e.jsxs(F,{value:y,onChange:s=>ne(s.target.value),className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:o("common.allPoles")}),O.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]})}),ae?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(E,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:Q.map(s=>e.jsx("div",{className:"card hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(Y,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s.code})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx("span",{className:`badge ${Ne[s.status]}`,children:s.status.replace("_"," ")}),s.pole&&e.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200",children:s.pole})]})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-4 line-clamp-2",children:s.description}),e.jsxs("div",{className:"space-y-2 text-sm",children:[s.location&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(Le,{className:"w-4 h-4"}),e.jsx("span",{children:s.location})]}),s.start_date&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsxs("span",{children:[new Date(s.start_date).toLocaleDateString(),s.end_date&&` - ${new Date(s.end_date).toLocaleDateString()}`]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(Re,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.users?.length??0," assigned users"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex -space-x-2",children:[s.users?.slice(0,3).map(a=>e.jsx("div",{className:"w-8 h-8 bg-hse-secondary rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800",title:a.name,children:e.jsx("span",{className:"text-white text-xs font-medium",children:a.name.charAt(0)})},a.id)),s.users?.length>3&&e.jsx("div",{className:"w-8 h-8 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800",children:e.jsxs("span",{className:"text-gray-600 dark:text-gray-300 text-xs font-medium",children:["+",s.users.length-3]})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Pe,{to:`/admin/projects/${s.id}`,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"View",children:e.jsx(Ze,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),J&&e.jsx("button",{type:"button",onClick:()=>me(s),className:"p-2 hover:bg-amber-50 dark:hover:bg-amber-900/20 rounded-lg",title:o("projects.manageZones"),children:e.jsx(Be,{className:"w-4 h-4 text-amber-600 dark:text-amber-400"})}),e.jsx("button",{onClick:()=>X(s),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"Edit",children:e.jsx(ze,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("button",{onClick:()=>ye(s),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"Delete",children:e.jsx(Ie,{className:"w-4 h-4 text-red-600"})})]})]})]})},s.id))}),m.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Page ",m.current_page," of ",m.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>g(m.current_page-1),disabled:m.current_page===1,className:"btn-secondary text-sm",children:"Previous"}),e.jsx("button",{onClick:()=>g(m.current_page+1),disabled:m.current_page===m.last_page,className:"btn-secondary text-sm",children:"Next"})]})]}),e.jsx(Ce,{isOpen:oe,onClose:D,title:b?"Modifier le projet":"Nouveau projet",size:"lg",children:e.jsxs("form",{onSubmit:je,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nom du projet *"}),e.jsx("input",{type:"text",value:r.name,onChange:s=>c({...r,name:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Code projet *"}),e.jsx("input",{type:"text",value:r.code,onChange:s=>c({...r,code:s.target.value.toUpperCase()}),className:"input",required:!0,placeholder:"ex: SGTM-001"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description"}),e.jsx("textarea",{value:r.description,onChange:s=>c({...r,description:s.target.value}),className:"input",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Localisation"}),e.jsx("input",{type:"text",value:r.location,onChange:s=>c({...r,location:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nom du client"}),e.jsx("input",{type:"text",value:r.client_name,onChange:s=>c({...r,client_name:s.target.value}),className:"input"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Date de début"}),e.jsx(H,{value:r.start_date,onChange:s=>c({...r,start_date:s})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Date de fin"}),e.jsx(H,{value:r.end_date,onChange:s=>c({...r,end_date:s})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Statut"}),e.jsxs(F,{value:r.status,onChange:s=>c({...r,status:s.target.value}),children:[e.jsx("option",{value:"active",children:"Actif"}),e.jsx("option",{value:"completed",children:"Terminé"}),e.jsx("option",{value:"on_hold",children:"En pause"}),e.jsx("option",{value:"cancelled",children:"Annulé"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Pole"}),e.jsx(Me,{value:r.pole,onChange:s=>c({...r,pole:s}),suggestions:O,placeholder:"Pole...",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Assigner des responsables"}),e.jsx("div",{className:"max-h-40 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg p-2 space-y-1 bg-white dark:bg-gray-700",children:ee.map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-600 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:r.user_ids.includes(s.id),onChange:()=>ve(s.id),className:"w-4 h-4 text-hse-primary border-gray-300 dark:border-gray-500 rounded focus:ring-hse-primary"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-gray-100",children:s.name}),e.jsxs("span",{className:"text-xs text-gray-400",children:["(",s.email,")"]})]},s.id))})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:D,className:"btn-secondary w-full sm:w-auto",children:"Annuler"}),e.jsx("button",{type:"submit",disabled:q,className:"btn-primary w-full sm:w-auto",children:q?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 animate-spin"}),"Enregistrement..."]}):b?"Mettre à jour":"Créer le projet"})]})]})}),e.jsx(De,{isOpen:!!h,title:"Confirm",message:h?`Are you sure you want to delete ${h.name}?`:"",confirmLabel:"Delete",cancelLabel:"Cancel",variant:"danger",onConfirm:be,onCancel:()=>C(null)}),e.jsx(Ae,{projectId:I?.id,projectName:I?.name,isOpen:ie,onClose:()=>{z(!1),$(null)}})]})}export{Qe as default};

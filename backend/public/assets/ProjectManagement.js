import{p as m,g as de,j as e}from"./index.js";import{r as l,L as ie}from"./vendor-react.js";import{M as ce}from"./Modal.js";import{D as R}from"./DatePicker.js";import{C as oe}from"./ConfirmDialog.js";import{S as C}from"./Select.js";import{A as me}from"./AutocompleteInput.js";import{z as d,a8 as xe,s as S,a9 as ue,aa as ge,ab as he,F as pe,ag as je,a4 as ye,U as fe,y as be,ac as ve,af as Ne}from"./vendor-ui.js";import"./vendor-utils.js";function Ae(){const[$,B]=l.useState([]),[z,I]=l.useState([]),[q,P]=l.useState(!0),[j,G]=l.useState(""),[y,X]=l.useState(""),[g,H]=l.useState(""),[K,D]=l.useState(!1),[h,f]=l.useState(null),[F,U]=l.useState([]),[V,b]=l.useState(!1),[c,v]=l.useState(null),[A,L]=l.useState(!1),N=l.useRef(null),p=l.useRef(null),[t,n]=l.useState({name:"",code:"",description:"",location:"",start_date:"",end_date:"",status:"active",pole:"",client_name:"",user_ids:[]}),[M,E]=l.useState(!1),[i,J]=l.useState({current_page:1,last_page:1}),[u,w]=l.useState(null);l.useEffect(()=>{x(),ee()},[j,y,g]),l.useEffect(()=>{k()},[]),l.useEffect(()=>{const s=a=>{N.current&&!N.current.contains(a.target)&&b(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const k=async()=>{try{const s=await m.getPoles(),a=s.data?.data?.poles??s.data?.poles??[];U(Array.isArray(a)?a:[])}catch{U([])}},Q=s=>{if(!s)return null;const a=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(s),r=decodeURIComponent(a?.[1]??a?.[2]??"");return r!==""?r:null},W=(s,a)=>{const r=URL.createObjectURL(s),o=document.createElement("a");o.href=r,o.download=a??"template.xlsx",document.body.appendChild(o),o.click(),o.remove(),setTimeout(()=>URL.revokeObjectURL(r),5e3)},Y=async()=>{try{const s=await m.downloadTemplate(),a=Q(s.headers?.["content-disposition"])??"SGTM-Projects-Template.xlsx";W(s.data,a)}catch{d.error("Failed to download template")}},Z=async()=>{if(!c){d.error("Please choose a file");return}try{L(!0);const s=new FormData;s.append("file",c);const r=(await m.bulkImport(s)).data?.data??{},o=r.imported??0,ne=r.updated??0,O=r.errors??[];d.success(`Imported: ${o} / Updated: ${ne}`),O.length>0&&d.error(`${O.length} row(s) had issues`),v(null),b(!1),x(),k()}catch(s){d.error(s.response?.data?.message??"Failed to import projects")}finally{L(!1)}},x=async(s=1)=>{try{P(!0);const a=await m.getAll({page:s,search:j,status:y,pole:g||void 0,per_page:10});B(a.data.data??[]),J(a.data.meta??{current_page:1,last_page:1})}catch{d.error("Failed to load projects")}finally{P(!1)}},ee=async()=>{try{const s=await de.getAll({per_page:100,role:"responsable"});I(s.data.data??[])}catch{console.error("Failed to load users")}},T=(s=null)=>{s?(f(s),n({name:s.name,code:s.code,description:s.description??"",location:s.location??"",start_date:s.start_date?.split("T")[0]??"",end_date:s.end_date?.split("T")[0]??"",status:s.status,pole:s.pole??"",client_name:s.client_name??"",user_ids:s.users?.map(a=>a.id)??[]})):(f(null),n({name:"",code:"",description:"",location:"",start_date:"",end_date:"",status:"active",pole:"",client_name:"",user_ids:[]})),k(),D(!0)},_=()=>{D(!1),f(null)},se=async s=>{s.preventDefault(),E(!0);try{h?(await m.update(h.id,t),d.success("Project updated successfully")):(await m.create(t),d.success("Project created successfully")),_(),x()}catch(a){const r=a.response?.data?.message??"Failed to save project";d.error(r)}finally{E(!1)}},ae=s=>{w(s)},te=async()=>{if(u)try{await m.delete(u.id),d.success("Project deleted successfully"),x()}catch(s){d.error(s.response?.data?.message??"Failed to delete project")}finally{w(null)}},le=s=>{n(a=>({...a,user_ids:a.user_ids.includes(s)?a.user_ids.filter(r=>r!==s):[...a.user_ids,s]}))},re={active:"badge-success",completed:"badge-info",on_hold:"badge-warning",cancelled:"badge-danger"};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Project Management"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"Manage projects and assign responsible users"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{ref:N,className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>b(s=>!s),className:"btn-secondary flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4"}),"Massive Add"]}),V&&e.jsx("div",{className:"absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-4 z-50",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{type:"button",onClick:Y,className:"btn-secondary w-full",children:"Download Template"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{ref:p,type:"file",accept:".xlsx,.xls",onChange:s=>v(s.target.files?.[0]??null),className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>p.current?.click(),className:"w-full rounded-lg border border-dashed border-gray-300 dark:border-gray-600 px-3 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700/50 transition",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:"Select XLSX file"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:c?c.name:"Choose the filled template (.xlsx)"})]}),e.jsx("div",{className:"text-xs font-semibold px-2 py-1 rounded-md bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",children:"Browse"})]})}),c&&e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-300 truncate",children:["Selected: ",e.jsx("span",{className:"font-semibold",children:c.name})]}),e.jsx("button",{type:"button",onClick:()=>{v(null),p.current&&(p.current.value="")},className:"text-xs font-semibold text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100",children:"Clear"})]})]}),e.jsx("button",{type:"button",onClick:Z,disabled:A||!c,className:"btn-primary w-full",children:A?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(S,{className:"w-4 h-4 animate-spin"}),"Uploading..."]}):"Upload"})]})})]}),e.jsxs("button",{onClick:()=>T(),className:"btn-primary flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),"Add Project"]})]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search projects...",value:j,onChange:s=>G(s.target.value),className:"input pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"w-4 h-4 text-gray-400"}),e.jsxs(C,{value:y,onChange:s=>X(s.target.value),className:"w-40",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"on_hold",children:"On Hold"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]}),e.jsxs(C,{value:g,onChange:s=>H(s.target.value),className:"w-40",children:[e.jsx("option",{value:"",children:"All Poles"}),F.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]})}),q?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(S,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:$.map(s=>e.jsx("div",{className:"card hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(pe,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s.code})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx("span",{className:`badge ${re[s.status]}`,children:s.status.replace("_"," ")}),s.pole&&e.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200",children:s.pole})]})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-4 line-clamp-2",children:s.description}),e.jsxs("div",{className:"space-y-2 text-sm",children:[s.location&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsx("span",{children:s.location})]}),s.start_date&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsxs("span",{children:[new Date(s.start_date).toLocaleDateString(),s.end_date&&` - ${new Date(s.end_date).toLocaleDateString()}`]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(fe,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.users?.length??0," assigned users"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex -space-x-2",children:[s.users?.slice(0,3).map(a=>e.jsx("div",{className:"w-8 h-8 bg-hse-secondary rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800",title:a.name,children:e.jsx("span",{className:"text-white text-xs font-medium",children:a.name.charAt(0)})},a.id)),s.users?.length>3&&e.jsx("div",{className:"w-8 h-8 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800",children:e.jsxs("span",{className:"text-gray-600 dark:text-gray-300 text-xs font-medium",children:["+",s.users.length-3]})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{to:`/admin/projects/${s.id}`,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"View",children:e.jsx(be,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("button",{onClick:()=>T(s),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"Edit",children:e.jsx(ve,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("button",{onClick:()=>ae(s),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"Delete",children:e.jsx(Ne,{className:"w-4 h-4 text-red-600"})})]})]})]})},s.id))}),i.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Page ",i.current_page," of ",i.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>x(i.current_page-1),disabled:i.current_page===1,className:"btn-secondary text-sm",children:"Previous"}),e.jsx("button",{onClick:()=>x(i.current_page+1),disabled:i.current_page===i.last_page,className:"btn-secondary text-sm",children:"Next"})]})]}),e.jsx(ce,{isOpen:K,onClose:_,title:h?"Modifier le projet":"Nouveau projet",size:"lg",children:e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nom du projet *"}),e.jsx("input",{type:"text",value:t.name,onChange:s=>n({...t,name:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Code projet *"}),e.jsx("input",{type:"text",value:t.code,onChange:s=>n({...t,code:s.target.value.toUpperCase()}),className:"input",required:!0,placeholder:"ex: SGTM-001"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description"}),e.jsx("textarea",{value:t.description,onChange:s=>n({...t,description:s.target.value}),className:"input",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Localisation"}),e.jsx("input",{type:"text",value:t.location,onChange:s=>n({...t,location:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nom du client"}),e.jsx("input",{type:"text",value:t.client_name,onChange:s=>n({...t,client_name:s.target.value}),className:"input"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Date de début"}),e.jsx(R,{value:t.start_date,onChange:s=>n({...t,start_date:s})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Date de fin"}),e.jsx(R,{value:t.end_date,onChange:s=>n({...t,end_date:s})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Statut"}),e.jsxs(C,{value:t.status,onChange:s=>n({...t,status:s.target.value}),children:[e.jsx("option",{value:"active",children:"Actif"}),e.jsx("option",{value:"completed",children:"Terminé"}),e.jsx("option",{value:"on_hold",children:"En pause"}),e.jsx("option",{value:"cancelled",children:"Annulé"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Pole"}),e.jsx(me,{value:t.pole,onChange:s=>n({...t,pole:s}),suggestions:F,placeholder:"Pole...",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Assigner des responsables"}),e.jsx("div",{className:"max-h-40 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg p-2 space-y-1 bg-white dark:bg-gray-700",children:z.map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-600 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.user_ids.includes(s.id),onChange:()=>le(s.id),className:"w-4 h-4 text-hse-primary border-gray-300 dark:border-gray-500 rounded focus:ring-hse-primary"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-gray-100",children:s.name}),e.jsxs("span",{className:"text-xs text-gray-400",children:["(",s.email,")"]})]},s.id))})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:_,className:"btn-secondary w-full sm:w-auto",children:"Annuler"}),e.jsx("button",{type:"submit",disabled:M,className:"btn-primary w-full sm:w-auto",children:M?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(S,{className:"w-4 h-4 animate-spin"}),"Enregistrement..."]}):h?"Mettre à jour":"Créer le projet"})]})]})}),e.jsx(oe,{isOpen:!!u,title:"Confirm deletion",message:u?`Are you sure you want to delete ${u.name}?`:"",confirmLabel:"Delete",cancelLabel:"Cancel",variant:"danger",onConfirm:te,onCancel:()=>w(null)})]})}export{Ae as default};

import{p as x,g as ce,j as e}from"./index.js";import{r,L as ie}from"./vendor-react.js";import{M as oe}from"./Modal.js";import{D as $}from"./DatePicker.js";import{C as me}from"./ConfirmDialog.js";import{S}from"./Select.js";import{A as xe}from"./AutocompleteInput.js";import{z as c,a8 as ue,s as P,a9 as ge,aa as he,ab as pe,F as fe,ag as je,a4 as ye,U as be,y as ve,ac as Ne,af as we}from"./vendor-ui.js";import"./vendor-utils.js";function Le(){const[B,z]=r.useState([]),[I,q]=r.useState([]),[G,D]=r.useState(!0),[j,X]=r.useState(""),[y,H]=r.useState(""),[h,K]=r.useState(""),[V,F]=r.useState(!1),[p,b]=r.useState(null),[U,A]=r.useState([]),[J,v]=r.useState(!1),[o,N]=r.useState(null),[L,M]=r.useState(!1),w=r.useRef(null),f=r.useRef(null),[l,d]=r.useState({name:"",code:"",description:"",location:"",start_date:"",end_date:"",status:"active",pole:"",client_name:"",user_ids:[]}),[E,T]=r.useState(!1),[i,Q]=r.useState({current_page:1,last_page:1}),[g,k]=r.useState(null);r.useEffect(()=>{u(),se()},[j,y,h]),r.useEffect(()=>{_()},[]),r.useEffect(()=>{const s=a=>{w.current&&!w.current.contains(a.target)&&v(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const _=async()=>{try{const s=await x.getPoles(),a=s.data?.data?.poles??s.data?.poles??[];A(Array.isArray(a)?a:[])}catch{A([])}},W=s=>{if(!s)return null;const a=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(s),n=decodeURIComponent(a?.[1]??a?.[2]??"");return n!==""?n:null},Y=(s,a)=>{const n=URL.createObjectURL(s),m=document.createElement("a");m.href=n,m.download=a??"template.xlsx",document.body.appendChild(m),m.click(),m.remove(),setTimeout(()=>URL.revokeObjectURL(n),5e3)},Z=async()=>{try{const s=await x.downloadTemplate(),a=W(s.headers?.["content-disposition"])??"SGTM-Projects-Template.xlsx";Y(s.data,a)}catch{c.error("Failed to download template")}},ee=async()=>{if(!o){c.error("Please choose a file");return}try{M(!0);const s=new FormData;s.append("file",o);const n=(await x.bulkImport(s)).data?.data??{},m=n.imported??0,de=n.updated??0,R=n.errors??[];c.success(`Imported: ${m} / Updated: ${de}`),R.length>0&&c.error(`${R.length} row(s) had issues`),N(null),v(!1),u(),_()}catch(s){c.error(s.response?.data?.message??"Failed to import projects")}finally{M(!1)}},u=async(s=1)=>{try{D(!0);const a=await x.getAll({page:s,search:j,status:y,pole:h||void 0,per_page:10});z(a.data.data??[]),Q(a.data.meta??{current_page:1,last_page:1})}catch{c.error("Failed to load projects")}finally{D(!1)}},se=async()=>{try{const s=await ce.getAll({per_page:100,role:"responsable"});q(s.data.data??[])}catch{console.error("Failed to load users")}},O=(s=null)=>{s?(b(s),d({name:s.name,code:s.code,description:s.description??"",location:s.location??"",start_date:s.start_date?.split("T")[0]??"",end_date:s.end_date?.split("T")[0]??"",status:s.status,pole:s.pole??"",client_name:s.client_name??"",user_ids:s.users?.map(a=>a.id)??[]})):(b(null),d({name:"",code:"",description:"",location:"",start_date:"",end_date:"",status:"active",pole:"",client_name:"",user_ids:[]})),_(),F(!0)},C=()=>{F(!1),b(null)},ae=async s=>{s.preventDefault(),T(!0);try{p?(await x.update(p.id,l),c.success("Project updated successfully")):(await x.create(l),c.success("Project created successfully")),C(),u()}catch(a){const n=a.response?.data?.message??"Failed to save project";c.error(n)}finally{T(!1)}},te=s=>{k(s)},le=async()=>{if(g)try{await x.delete(g.id),c.success("Project deleted successfully"),u()}catch(s){c.error(s.response?.data?.message??"Failed to delete project")}finally{k(null)}},re=s=>{d(a=>({...a,user_ids:a.user_ids.includes(s)?a.user_ids.filter(n=>n!==s):[...a.user_ids,s]}))},ne={active:"badge-success",completed:"badge-info",on_hold:"badge-warning",cancelled:"badge-danger"};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Project Management"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"Manage projects and assign responsible users"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{ref:w,className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>v(s=>!s),className:"btn-secondary flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),"Massive Add"]}),J&&e.jsx("div",{className:"absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-4 z-50",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{type:"button",onClick:Z,className:"btn-secondary w-full",children:"Download Template"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{ref:f,type:"file",accept:".xlsx,.xls",onChange:s=>N(s.target.files?.[0]??null),className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>f.current?.click(),className:"w-full rounded-lg border border-dashed border-gray-300 dark:border-gray-600 px-3 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700/50 transition",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:"Select XLSX file"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:o?o.name:"Choose the filled template (.xlsx)"})]}),e.jsx("div",{className:"text-xs font-semibold px-2 py-1 rounded-md bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",children:"Browse"})]})}),o&&e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-300 truncate",children:["Selected: ",e.jsx("span",{className:"font-semibold",children:o.name})]}),e.jsx("button",{type:"button",onClick:()=>{N(null),f.current&&(f.current.value="")},className:"text-xs font-semibold text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100",children:"Clear"})]})]}),e.jsx("button",{type:"button",onClick:ee,disabled:L||!o,className:"btn-primary w-full",children:L?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(P,{className:"w-4 h-4 animate-spin"}),"Uploading..."]}):"Upload"})]})})]}),e.jsxs("button",{onClick:()=>O(),className:"btn-primary flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4"}),"Add Project"]})]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search projects...",value:j,onChange:s=>X(s.target.value),className:"input pl-10"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2",children:[e.jsx(pe,{className:"hidden sm:block w-4 h-4 text-gray-400"}),e.jsxs(S,{value:y,onChange:s=>H(s.target.value),className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"on_hold",children:"On Hold"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]}),e.jsxs(S,{value:h,onChange:s=>K(s.target.value),className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:t("common.allPoles")}),U.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]})}),G?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(P,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:B.map(s=>e.jsx("div",{className:"card hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(fe,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s.code})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx("span",{className:`badge ${ne[s.status]}`,children:s.status.replace("_"," ")}),s.pole&&e.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200",children:s.pole})]})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-4 line-clamp-2",children:s.description}),e.jsxs("div",{className:"space-y-2 text-sm",children:[s.location&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsx("span",{children:s.location})]}),s.start_date&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsxs("span",{children:[new Date(s.start_date).toLocaleDateString(),s.end_date&&` - ${new Date(s.end_date).toLocaleDateString()}`]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.users?.length??0," assigned users"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex -space-x-2",children:[s.users?.slice(0,3).map(a=>e.jsx("div",{className:"w-8 h-8 bg-hse-secondary rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800",title:a.name,children:e.jsx("span",{className:"text-white text-xs font-medium",children:a.name.charAt(0)})},a.id)),s.users?.length>3&&e.jsx("div",{className:"w-8 h-8 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800",children:e.jsxs("span",{className:"text-gray-600 dark:text-gray-300 text-xs font-medium",children:["+",s.users.length-3]})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{to:`/admin/projects/${s.id}`,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"View",children:e.jsx(ve,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("button",{onClick:()=>O(s),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"Edit",children:e.jsx(Ne,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("button",{onClick:()=>te(s),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"Delete",children:e.jsx(we,{className:"w-4 h-4 text-red-600"})})]})]})]})},s.id))}),i.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Page ",i.current_page," of ",i.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>u(i.current_page-1),disabled:i.current_page===1,className:"btn-secondary text-sm",children:"Previous"}),e.jsx("button",{onClick:()=>u(i.current_page+1),disabled:i.current_page===i.last_page,className:"btn-secondary text-sm",children:"Next"})]})]}),e.jsx(oe,{isOpen:V,onClose:C,title:p?"Modifier le projet":"Nouveau projet",size:"lg",children:e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nom du projet *"}),e.jsx("input",{type:"text",value:l.name,onChange:s=>d({...l,name:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Code projet *"}),e.jsx("input",{type:"text",value:l.code,onChange:s=>d({...l,code:s.target.value.toUpperCase()}),className:"input",required:!0,placeholder:"ex: SGTM-001"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description"}),e.jsx("textarea",{value:l.description,onChange:s=>d({...l,description:s.target.value}),className:"input",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Localisation"}),e.jsx("input",{type:"text",value:l.location,onChange:s=>d({...l,location:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nom du client"}),e.jsx("input",{type:"text",value:l.client_name,onChange:s=>d({...l,client_name:s.target.value}),className:"input"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Date de début"}),e.jsx($,{value:l.start_date,onChange:s=>d({...l,start_date:s})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Date de fin"}),e.jsx($,{value:l.end_date,onChange:s=>d({...l,end_date:s})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Statut"}),e.jsxs(S,{value:l.status,onChange:s=>d({...l,status:s.target.value}),children:[e.jsx("option",{value:"active",children:"Actif"}),e.jsx("option",{value:"completed",children:"Terminé"}),e.jsx("option",{value:"on_hold",children:"En pause"}),e.jsx("option",{value:"cancelled",children:"Annulé"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Pole"}),e.jsx(xe,{value:l.pole,onChange:s=>d({...l,pole:s}),suggestions:U,placeholder:"Pole...",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Assigner des responsables"}),e.jsx("div",{className:"max-h-40 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg p-2 space-y-1 bg-white dark:bg-gray-700",children:I.map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-600 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:l.user_ids.includes(s.id),onChange:()=>re(s.id),className:"w-4 h-4 text-hse-primary border-gray-300 dark:border-gray-500 rounded focus:ring-hse-primary"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-gray-100",children:s.name}),e.jsxs("span",{className:"text-xs text-gray-400",children:["(",s.email,")"]})]},s.id))})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:C,className:"btn-secondary w-full sm:w-auto",children:"Annuler"}),e.jsx("button",{type:"submit",disabled:E,className:"btn-primary w-full sm:w-auto",children:E?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(P,{className:"w-4 h-4 animate-spin"}),"Enregistrement..."]}):p?"Mettre à jour":"Créer le projet"})]})]})}),e.jsx(me,{isOpen:!!g,title:"Confirm deletion",message:g?`Are you sure you want to delete ${g.name}?`:"",confirmLabel:"Delete",cancelLabel:"Cancel",variant:"danger",onConfirm:le,onCancel:()=>k(null)})]})}export{Le as default};

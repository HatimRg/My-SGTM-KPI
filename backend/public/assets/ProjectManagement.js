import{a as Ne,u as ke,p as x,g as we,j as e}from"./index.js";import{r as t,L as _e}from"./vendor-react.js";import{M as Se}from"./Modal.js";import{D as V}from"./DatePicker.js";import{C as Ce}from"./ConfirmDialog.js";import{S as F}from"./Select.js";import{A as Pe}from"./AutocompleteInput.js";import{Z as De}from"./ZonesManager.js";import{z as o,ac as Ae,v as T,ad as Me,ae as Fe,af as Te,F as Ue,ak as Le,a8 as Ee,U as Oe,I as Re,al as Ze,ag as Ie,aj as ze}from"./vendor-ui.js";import"./vendor-utils.js";function We(){const{t:c}=Ne(),{user:m}=ke(),X=m?.role==="admin"||m?.role==="responsable"||m?.role==="hse_manager"||m?.role==="works_director"||m?.role==="hse_director"||m?.role==="hr_director"||m?.role==="pole_director",[H,J]=t.useState([]),[Q,W]=t.useState([]),[Y,U]=t.useState(!0),[j,ee]=t.useState(""),[L,se]=t.useState(""),[N,ae]=t.useState(""),[y,te]=t.useState(""),[re,E]=t.useState(!1),[b,k]=t.useState(null),[O,R]=t.useState([]),[le,w]=t.useState(!1),[u,_]=t.useState(null),[Z,I]=t.useState(!1),S=t.useRef(null),v=t.useRef(null),[ne,z]=t.useState(!1),[B,$]=t.useState(null),[r,i]=t.useState({name:"",code:"",description:"",location:"",start_date:"",end_date:"",status:"active",pole:"",client_name:"",user_ids:[]}),[q,G]=t.useState(!1),[d,ce]=t.useState({current_page:1,last_page:1}),[h,C]=t.useState(null);t.useEffect(()=>{const s=setTimeout(()=>{se(j.trim())},350);return()=>clearTimeout(s)},[j]),t.useEffect(()=>{g(1,L)},[L,N,y]),t.useEffect(()=>{xe()},[]),t.useEffect(()=>{P()},[]),t.useEffect(()=>{const s=a=>{S.current&&!S.current.contains(a.target)&&w(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const P=async()=>{try{const s=await x.getPoles(),a=s.data?.data?.poles??s.data?.poles??[];R(Array.isArray(a)?a:[])}catch{R([])}},ie=s=>{$(s),z(!0)},oe=s=>{if(!s)return null;const a=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(s),l=decodeURIComponent(a?.[1]??a?.[2]??"");return l!==""?l:null},de=(s,a)=>{const l=URL.createObjectURL(s),n=document.createElement("a");n.href=l,n.download=a??"template.xlsx",document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>URL.revokeObjectURL(l),5e3)},me=async()=>{try{const s=await x.downloadTemplate(),a=oe(s.headers?.["content-disposition"])??"SGTM-Projects-Template.xlsx";de(s.data,a)}catch{o.error(c("projects.bulk.downloadTemplateFailed"))}},ue=async()=>{if(!u){o.error(c("projects.bulk.chooseFile"));return}try{I(!0);const s=new FormData;s.append("file",u);const l=(await x.bulkImport(s)).data?.data??{},n=l.imported??0,p=l.updated??0,f=l.errors??[];o.success(c("projects.bulk.importSummary",{imported:n,updated:p})),f.length>0&&o.error(c("projects.bulk.importIssues",{count:f.length})),_(null),w(!1),g(),P()}catch(s){o.error(s.response?.data?.message??c("projects.bulk.importFailed"))}finally{I(!1)}},g=async(s=1,a=j)=>{try{U(!0);const l=await x.getAll({page:s,search:a,status:N,pole:y||void 0,per_page:10});J(l.data.data??[]),ce(l.data.meta??{current_page:1,last_page:1})}catch{o.error(c("errors.failedToLoad"))}finally{U(!1)}},xe=async()=>{try{const s=await we.getAll({per_page:100,role:"responsable"});W(s.data.data??[])}catch{console.error("Failed to load users")}},K=(s=null)=>{s?(k(s),i({name:s.name,code:s.code,description:s.description??"",location:s.location??"",start_date:s.start_date?.split("T")[0]??"",end_date:s.end_date?.split("T")[0]??"",status:s.status,pole:s.pole??"",client_name:s.client_name??"",user_ids:s.users?.map(a=>a.id)??[]})):(k(null),i({name:"",code:"",description:"",location:"",start_date:"",end_date:"",status:"active",pole:"",client_name:"",user_ids:[]})),P(),E(!0)},D=()=>{E(!1),k(null)},ge=s=>{const a=Array.isArray(s.user_ids)?s.user_ids.map(n=>Number(n)).filter(n=>Number.isFinite(n)):[];return{...s,name:(s.name??"").trim(),code:(s.code??"").trim(),start_date:s.start_date?s.start_date:null,end_date:s.end_date?s.end_date:null,status:s.status?s.status:"active",pole:(s.pole??"").trim()||null,client_name:(s.client_name??"").trim()||null,location:(s.location??"").trim()||null,description:(s.description??"").trim()||null,user_ids:a}},pe=s=>{const a=s?.response?.data,l=[a?.errors,a?.data?.errors,a?.error?.errors];for(const p of l)if(p&&typeof p=="object"){const f=Object.keys(p);if(f.length>0){const ve=f[0],A=p[ve],M=Array.isArray(A)?A[0]:A;if(typeof M=="string"&&M.trim()!=="")return M}}const n=a?.message??a?.data?.message;return typeof n=="string"&&n.trim()!==""?n:c("errors.failedToSave")},he=async s=>{s.preventDefault(),G(!0);try{const a=ge(r);b?(await x.update(b.id,a),o.success(c("projects.projectUpdated"))):(await x.create(a),o.success(c("projects.projectCreated"))),D(),g()}catch(a){o.error(pe(a))}finally{G(!1)}},fe=s=>{C(s)},je=async()=>{if(h)try{await x.delete(h.id),o.success(c("projects.projectDeleted")),g()}catch(s){o.error(s.response?.data?.message??c("errors.failedToDelete"))}finally{C(null)}},ye=s=>{i(a=>({...a,user_ids:a.user_ids.includes(s)?a.user_ids.filter(l=>l!==s):[...a.user_ids,s]}))},be={active:"badge-success",completed:"badge-info",on_hold:"badge-warning",cancelled:"badge-danger"};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Project Management"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"Manage projects and assign responsible users"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{ref:S,className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>w(s=>!s),className:"btn-secondary flex items-center gap-2",children:[e.jsx(Ae,{className:"w-4 h-4"}),"Massive Add"]}),le&&e.jsx("div",{className:"absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-4 z-50",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{type:"button",onClick:me,className:"btn-secondary w-full",children:"Download Template"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{ref:v,type:"file",accept:".xlsx,.xls",onChange:s=>_(s.target.files?.[0]??null),className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>v.current?.click(),className:"w-full rounded-lg border border-dashed border-gray-300 dark:border-gray-600 px-3 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700/50 transition",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:"Select XLSX file"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:u?u.name:"Choose the filled template (.xlsx)"})]}),e.jsx("div",{className:"text-xs font-semibold px-2 py-1 rounded-md bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",children:"Browse"})]})}),u&&e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-300 truncate",children:["Selected: ",e.jsx("span",{className:"font-semibold",children:u.name})]}),e.jsx("button",{type:"button",onClick:()=>{_(null),v.current&&(v.current.value="")},className:"text-xs font-semibold text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100",children:"Clear"})]})]}),e.jsx("button",{type:"button",onClick:ue,disabled:Z||!u,className:"btn-primary w-full",children:Z?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(T,{className:"w-4 h-4 animate-spin"}),"Uploading..."]}):"Upload"})]})})]}),e.jsxs("button",{onClick:()=>K(),className:"btn-primary flex items-center gap-2",children:[e.jsx(Me,{className:"w-4 h-4"}),"Add Project"]})]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search projects...",value:j,onChange:s=>ee(s.target.value),className:"input pl-10"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2",children:[e.jsx(Te,{className:"hidden sm:block w-4 h-4 text-gray-400"}),e.jsxs(F,{value:N,onChange:s=>ae(s.target.value),className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"on_hold",children:"On Hold"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]}),e.jsxs(F,{value:y,onChange:s=>te(s.target.value),className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:c("common.allPoles")}),O.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]})}),Y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(T,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:H.map(s=>e.jsx("div",{className:"card hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-hse-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(Ue,{className:"w-6 h-6 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s.code})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx("span",{className:`badge ${be[s.status]}`,children:s.status.replace("_"," ")}),s.pole&&e.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200",children:s.pole})]})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-4 line-clamp-2",children:s.description}),e.jsxs("div",{className:"space-y-2 text-sm",children:[s.location&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(Le,{className:"w-4 h-4"}),e.jsx("span",{children:s.location})]}),s.start_date&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(Ee,{className:"w-4 h-4"}),e.jsxs("span",{children:[new Date(s.start_date).toLocaleDateString(),s.end_date&&` - ${new Date(s.end_date).toLocaleDateString()}`]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.users?.length??0," assigned users"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex -space-x-2",children:[s.users?.slice(0,3).map(a=>e.jsx("div",{className:"w-8 h-8 bg-hse-secondary rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800",title:a.name,children:e.jsx("span",{className:"text-white text-xs font-medium",children:a.name.charAt(0)})},a.id)),s.users?.length>3&&e.jsx("div",{className:"w-8 h-8 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800",children:e.jsxs("span",{className:"text-gray-600 dark:text-gray-300 text-xs font-medium",children:["+",s.users.length-3]})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_e,{to:`/admin/projects/${s.id}`,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"View",children:e.jsx(Re,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),X&&e.jsx("button",{type:"button",onClick:()=>ie(s),className:"p-2 hover:bg-amber-50 dark:hover:bg-amber-900/20 rounded-lg",title:c("projects.manageZones"),children:e.jsx(Ze,{className:"w-4 h-4 text-amber-600 dark:text-amber-400"})}),e.jsx("button",{onClick:()=>K(s),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"Edit",children:e.jsx(Ie,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("button",{onClick:()=>fe(s),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",title:"Delete",children:e.jsx(ze,{className:"w-4 h-4 text-red-600"})})]})]})]})},s.id))}),d.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Page ",d.current_page," of ",d.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>g(d.current_page-1),disabled:d.current_page===1,className:"btn-secondary text-sm",children:"Previous"}),e.jsx("button",{onClick:()=>g(d.current_page+1),disabled:d.current_page===d.last_page,className:"btn-secondary text-sm",children:"Next"})]})]}),e.jsx(Se,{isOpen:re,onClose:D,title:b?"Modifier le projet":"Nouveau projet",size:"lg",children:e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nom du projet *"}),e.jsx("input",{type:"text",value:r.name,onChange:s=>i({...r,name:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Code projet *"}),e.jsx("input",{type:"text",value:r.code,onChange:s=>i({...r,code:s.target.value.toUpperCase()}),className:"input",required:!0,placeholder:"ex: SGTM-001"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description"}),e.jsx("textarea",{value:r.description,onChange:s=>i({...r,description:s.target.value}),className:"input",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Localisation"}),e.jsx("input",{type:"text",value:r.location,onChange:s=>i({...r,location:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nom du client"}),e.jsx("input",{type:"text",value:r.client_name,onChange:s=>i({...r,client_name:s.target.value}),className:"input"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Date de début"}),e.jsx(V,{value:r.start_date,onChange:s=>i({...r,start_date:s})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Date de fin"}),e.jsx(V,{value:r.end_date,onChange:s=>i({...r,end_date:s})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Statut"}),e.jsxs(F,{value:r.status,onChange:s=>i({...r,status:s.target.value}),children:[e.jsx("option",{value:"active",children:"Actif"}),e.jsx("option",{value:"completed",children:"Terminé"}),e.jsx("option",{value:"on_hold",children:"En pause"}),e.jsx("option",{value:"cancelled",children:"Annulé"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Pole"}),e.jsx(Pe,{value:r.pole,onChange:s=>i({...r,pole:s}),suggestions:O,placeholder:"Pole...",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Assigner des responsables"}),e.jsx("div",{className:"max-h-40 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg p-2 space-y-1 bg-white dark:bg-gray-700",children:Q.map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-600 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:r.user_ids.includes(s.id),onChange:()=>ye(s.id),className:"w-4 h-4 text-hse-primary border-gray-300 dark:border-gray-500 rounded focus:ring-hse-primary"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-gray-100",children:s.name}),e.jsxs("span",{className:"text-xs text-gray-400",children:["(",s.email,")"]})]},s.id))})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:D,className:"btn-secondary w-full sm:w-auto",children:"Annuler"}),e.jsx("button",{type:"submit",disabled:q,className:"btn-primary w-full sm:w-auto",children:q?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(T,{className:"w-4 h-4 animate-spin"}),"Enregistrement..."]}):b?"Mettre à jour":"Créer le projet"})]})]})}),e.jsx(Ce,{isOpen:!!h,title:"Confirm",message:h?`Are you sure you want to delete ${h.name}?`:"",confirmLabel:"Delete",cancelLabel:"Cancel",variant:"danger",onConfirm:je,onCancel:()=>C(null)}),e.jsx(De,{projectId:B?.id,projectName:B?.name,isOpen:ne,onClose:()=>{z(!1),$(null)}})]})}export{We as default};

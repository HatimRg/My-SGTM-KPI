import{a as Q,k as w,j as e,f as W}from"./index-Cj_Nywl_.js";import{r as l}from"./vendor-react-Bagy_njL.js";import{u as Z}from"./projectStore-CMn07yVh.js";import{M as ee}from"./Modal-CFdjfuaB.js";import{D as I}from"./DatePicker-CFkBKDFz.js";import{C as se}from"./ConfirmDialog-R0bb8T7D.js";import{S}from"./Select-D_zVsBMD.js";import{D as ae}from"./DailyKpiPreview-Du_OgNqL.js";import{z as h,a1 as te,e as L,a0 as M,D as K,a7 as O,aa as U,r as re,X as le,n as ne,o as de}from"./vendor-ui-ByylQ01J.js";import"./vendor-utils-MYqKZVQ3.js";function ye(){const{t:x}=Q(),[m,p]=l.useState([]),{projects:H,fetchProjects:C}=Z(),[V,D]=l.useState(!0),[n,y]=l.useState({project_id:"",status:"",year:new Date().getFullYear()}),[i,$]=l.useState({current_page:1,last_page:1}),[a,g]=l.useState(null),[J,f]=l.useState([]),[z,F]=l.useState(!1),[b,v]=l.useState(null),[c,q]=l.useState(""),[o,B]=l.useState(""),[G,P]=l.useState(!1);l.useEffect(()=>{C({per_page:100}).catch(()=>{})},[C]),l.useEffect(()=>{u()},[n]);const u=async(s=1)=>{try{D(!0);const t=await w.getAll({page:s,...n,per_page:10});p(t.data.data||[]),$(t.data.meta||{current_page:1,last_page:1})}catch{h.error("Failed to load reports")}finally{D(!1)}},R=async s=>{F(!0),g(s),f([]);try{const d=(await w.getById(s.id)).data.data;g(d.report||d),f(d.daily_snapshots||[])}catch(t){console.error("Failed to load report details:",t)}finally{F(!1)}},A=s=>{if(s.status!=="draft"){h.error("Only draft reports can be deleted");return}v(s)},X=async()=>{if(b)try{await w.delete(b.id),h.success("Report deleted successfully"),u()}catch{h.error("Failed to delete report")}finally{v(null)}},N=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],E={draft:e.jsx(L,{className:"w-4 h-4 text-gray-500"}),submitted:e.jsx(de,{className:"w-4 h-4 text-amber-500"}),approved:e.jsx(ne,{className:"w-4 h-4 text-green-500"}),rejected:e.jsx(le,{className:"w-4 h-4 text-red-500"})},_={draft:"badge-info",submitted:"badge-warning",approved:"badge-success",rejected:"badge-danger"},j=l.useMemo(()=>Array.isArray(m)?!c&&!o?m:m.filter(s=>{let t="";if(s.start_date)t=s.start_date.substring(0,10);else if(s.created_at){const d=new Date(s.created_at);Number.isNaN(d.getTime())||(t=d.toISOString().substring(0,10))}return!(c&&(!t||t<c)||o&&(!t||t>o))}):[],[m,c,o]),Y=async()=>{try{P(!0);const s={project_id:n.project_id||void 0,status:n.status||void 0,year:n.year||void 0};c&&(s.from_date=c),o&&(s.to_date=o);const t=await W.exportKpiHistory(s),d=new Blob([t.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),T=window.URL.createObjectURL(d),k=document.createElement("a");k.href=T,k.download=`kpi_history_${n.year}.xlsx`,k.click(),window.URL.revokeObjectURL(T)}catch(s){console.error("Error exporting KPI history:",s),h.error("Failed to export reports")}finally{P(!1)}};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[x("nav.dashboard")," / ",x("kpi.history")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:x("kpi.history")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"View and manage your submitted KPI reports"})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row flex-wrap gap-4",children:[e.jsx("div",{className:"flex-1 min-w-[180px]",children:e.jsxs(S,{value:n.project_id,onChange:s=>y({...n,project_id:s.target.value}),children:[e.jsx("option",{value:"",children:"All Projects"}),H.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("div",{className:"w-40",children:e.jsxs(S,{value:n.status,onChange:s=>y({...n,status:s.target.value}),children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"submitted",children:"Submitted"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"rejected",children:"Rejected"})]})}),e.jsx("div",{className:"w-32",children:e.jsx(S,{value:n.year,onChange:s=>y({...n,year:s.target.value}),children:[...Array(5)].map((s,t)=>{const d=new Date().getFullYear()-t;return e.jsx("option",{value:d,children:d},d)})})}),e.jsx("div",{className:"w-40",children:e.jsx(I,{value:c,onChange:s=>q(s),placeholder:"From date"})}),e.jsx("div",{className:"w-40",children:e.jsx(I,{value:o,onChange:s=>B(s),placeholder:"To date"})}),e.jsxs("button",{type:"button",onClick:Y,disabled:G||j.length===0,className:"btn-secondary flex items-center gap-2 text-sm",children:[e.jsx(te,{className:"w-4 h-4"}),e.jsx("span",{children:x("dashboard.exportExcel")})]})]})}),e.jsxs("div",{className:"card",children:[V?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("div",{className:"hidden md:block space-y-2 animate-pulse",children:Array.from({length:5},(s,t)=>e.jsx("div",{className:"h-10 rounded-md bg-gray-100 dark:bg-gray-800"},t))}),e.jsx("div",{className:"md:hidden space-y-3 animate-pulse",children:Array.from({length:3},(s,t)=>e.jsx("div",{className:"h-24 rounded-lg bg-gray-100 dark:bg-gray-800"},t))})]}):j.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx(L,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2",children:"No reports found"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Try adjusting your filters or submit a new KPI report."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:j.map(s=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.project?.name||"Unknown"}),s.project?.code&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.project.code}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-gray-600 dark:text-gray-300",children:[e.jsx(M,{className:"w-3 h-3 text-gray-400"}),e.jsxs("span",{children:[N[s.report_month-1]," ",s.report_year]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[E[s.status],e.jsx("span",{className:`badge ${_[s.status]}`,children:s.status})]}),e.jsxs("div",{className:"mt-1 flex flex-wrap gap-1 justify-end text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{className:s.accidents>0?"text-red-600 dark:text-red-400 font-semibold":"text-green-600",children:[s.accidents," acc."]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300",children:[s.trainings_conducted," tr."]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300",children:[s.inspections_completed," insp."]})]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>R(s),className:"inline-flex items-center gap-1 text-xs text-hse-primary hover:underline",title:"View Details",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:"View details"})]}),s.status==="draft"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700",title:"Edit",children:e.jsx(O,{className:"w-4 h-4 text-gray-600 dark:text-gray-300"})}),e.jsx("button",{onClick:()=>A(s),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:"Delete",children:e.jsx(U,{className:"w-4 h-4 text-red-600"})})]})]})]},s.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"table w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Project"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Accidents"}),e.jsx("th",{children:"Trainings"}),e.jsx("th",{children:"Inspections"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:j.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.project?.name||"Unknown"}),e.jsx("p",{className:"text-xs text-gray-500",children:s.project?.code})]})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{children:[N[s.report_month-1]," ",s.report_year]})]})}),e.jsx("td",{children:e.jsx("span",{className:s.accidents>0?"text-red-600 font-semibold":"text-green-600",children:s.accidents})}),e.jsx("td",{children:s.trainings_conducted}),e.jsx("td",{children:s.inspections_completed}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[E[s.status],e.jsx("span",{className:`badge ${_[s.status]}`,children:s.status})]})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>R(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:"View Details",children:e.jsx(K,{className:"w-4 h-4 text-gray-600"})}),s.status==="draft"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"p-2 hover:bg-gray-100 rounded-lg",title:"Edit",children:e.jsx(O,{className:"w-4 h-4 text-gray-600"})}),e.jsx("button",{onClick:()=>A(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:"Delete",children:e.jsx(U,{className:"w-4 h-4 text-red-600"})})]})]})})]},s.id))})]})})]}),i.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-gray-100",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Page ",i.current_page," of ",i.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>u(i.current_page-1),disabled:i.current_page===1,className:"btn-secondary text-sm",children:"Previous"}),e.jsx("button",{onClick:()=>u(i.current_page+1),disabled:i.current_page===i.last_page,className:"btn-secondary text-sm",children:"Next"})]})]})]}),e.jsx(ee,{isOpen:!!a,onClose:()=>g(null),title:a?.project?.name||"Détails du rapport",size:"lg",children:a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[N[a.report_month-1]," ",a.report_year]}),e.jsx("span",{className:`badge ${_[a.status]}`,children:a.status})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs d'accidents"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:[e.jsx(r,{label:"Total",value:a.accidents,danger:a.accidents>0}),e.jsx(r,{label:"Mortels",value:a.accidents_fatal,danger:a.accidents_fatal>0}),e.jsx(r,{label:"Graves",value:a.accidents_serious}),e.jsx(r,{label:"Mineurs",value:a.accidents_minor}),e.jsx(r,{label:"Presqu'accidents",value:a.near_misses}),e.jsx(r,{label:"Premiers soins",value:a.first_aid_cases})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs de formation"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:[e.jsx(r,{label:"Réalisées",value:a.trainings_conducted}),e.jsx(r,{label:"Planifiées",value:a.trainings_planned}),e.jsx(r,{label:"Employés",value:a.employees_trained}),e.jsx(r,{label:"Heures",value:a.training_hours}),e.jsx(r,{label:"Sensibilisations",value:a.toolbox_talks})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs d'inspection"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[e.jsx(r,{label:"Réalisées",value:a.inspections_completed}),e.jsx(r,{label:"Planifiées",value:a.inspections_planned}),e.jsx(r,{label:"Écarts ouverts",value:a.findings_open}),e.jsx(r,{label:"Écarts fermés",value:a.findings_closed})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Taux de sécurité"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(r,{label:"TF",value:Number(a.tf_value).toFixed(4)}),e.jsx(r,{label:"TG",value:Number(a.tg_value).toFixed(4)}),e.jsx(r,{label:"Heures travaillées",value:Number(a.hours_worked).toLocaleString()}),e.jsx(r,{label:"Jours perdus",value:a.lost_workdays})]})]}),a.notes&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-2",children:"Notes"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg",children:a.notes})]}),z?e.jsxs("div",{className:"flex items-center justify-center py-4",children:[e.jsx(re,{className:"w-5 h-5 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-sm text-gray-500",children:"Chargement des données journalières..."})]}):e.jsx(ae,{dailySnapshots:J}),e.jsx("div",{className:"pt-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{onClick:()=>{g(null),f([])},className:"btn-secondary w-full",children:"Fermer"})})]})}),e.jsx(se,{isOpen:!!b,title:"Confirm deletion",message:"Are you sure you want to delete this report?",confirmLabel:"Delete",cancelLabel:"Cancel",variant:"danger",onConfirm:X,onCancel:()=>v(null)})]})}function r({label:x,value:m,danger:p=!1}){return e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:x}),e.jsx("p",{className:`text-lg font-semibold ${p?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-gray-100"}`,children:m})]})}export{ye as default};

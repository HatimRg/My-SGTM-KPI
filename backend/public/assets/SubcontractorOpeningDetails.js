import{a as te,j as e,M as R,G as w,r as W}from"./index.js";import{b as se,u as ae,h as re,r as c}from"./vendor-react.js";import{D as T}from"./DatePicker.js";import{a0 as _,aE as ne,a7 as oe,aA as le,X as ce,A as ie,V as de,aF as $,au as me,ar as ue,z as i}from"./vendor-ui.js";import"./vendor-utils.js";const A={valid:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",expiring:"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",expired:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300",no_expiry:"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300",no_file:"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"},xe={valid:de,expiring:ie,expired:ce};function fe(){const{t:s}=te(),B=se(),D=ae(),{id:S}=re(),[E,F]=c.useState(!1),[U,z]=c.useState(!1),[n,M]=c.useState(null),[I,G]=c.useState([]),[u,C]=c.useState(null),[g,b]=c.useState(null),[d,y]=c.useState(null),[H,h]=c.useState(!1),[x,p]=c.useState(null),[f,j]=c.useState(""),[N,v]=c.useState(""),L=t=>!t||typeof t!="string"?null:t.startsWith("/api/")?t.slice(4):t.startsWith("api/")?t.slice(3):t,q=t=>{if(!t)return null;const a=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(t),r=decodeURIComponent(a?.[1]??a?.[2]??"");return r!==""?r:null},X=(t,a)=>{const r=URL.createObjectURL(t),o=document.createElement("a");o.href=r,o.download=a??"document.pdf",document.body.appendChild(o),o.click(),o.remove(),setTimeout(()=>URL.revokeObjectURL(r),5e3)},O=async()=>{try{F(!0);const a=(await w.getById(S)).data,r=a.data??a;M(r.opening),G(r.documents??[])}catch(t){console.error("Failed to load opening details",t),i.error(t.response?.data?.message??s("errors.somethingWentWrong")??"Failed to load")}finally{F(!1)}},K=async t=>{if(t?.file_view_url)try{b(t),h(!0),d&&(URL.revokeObjectURL(d),y(null));const a=L(t.file_view_url),o=(await W.get(a,{responseType:"blob"})).data,l=URL.createObjectURL(o);y(l)}catch(a){console.error("Failed to preview PDF",a),i.error(a.response?.data?.message??s("errors.somethingWentWrong")??"Failed to preview"),b(null)}finally{h(!1)}},V=()=>{b(null),h(!1),d&&(URL.revokeObjectURL(d),y(null))},P=async t=>{if(t?.file_download_url)try{const a=L(t.file_download_url),r=await W.get(a,{responseType:"blob"}),l=q(r.headers?.["content-disposition"])??`${t.document_key??"document"}.pdf`;X(r.data,l)}catch(a){console.error("Failed to download PDF",a),i.error(a.response?.data?.message??s("errors.somethingWentWrong")??"Failed to download")}};c.useEffect(()=>{O()},[S]),c.useEffect(()=>()=>{d&&URL.revokeObjectURL(d)},[d]);const J=c.useMemo(()=>{if(!n)return"";const t=n.project?.name?` · ${n.project.name}`:"";return`${n.contractor_name}${t}`},[n]),Q=t=>{const a=t.target.files?.[0];if(!a){p(null);return}if(a.type!=="application/pdf"){i.error(s("subcontractors.pdfOnly")??"PDF only");return}p(a)},Y=t=>{C(t),p(null),j(t.start_date??""),v(t.expiry_date??"")},k=()=>{C(null),p(null),j(""),v("")},Z=async t=>{if(t.preventDefault(),!(!n||!u||!x)){z(!0);try{const r=(await w.uploadDocument(n.id,{document_key:u.document_key,document_label:u.document_label,start_date:f||void 0,expiry_date:N||void 0,file:x})).data,l=(r.data??r).document;l?.was_compressed&&l.file_size&&l.compressed_size?i.success(s("subcontractors.documentSavedCompressed",{original:m(l.file_size),compressed:m(l.compressed_size)})):l?.file_size?i.success(s("subcontractors.documentSavedWithSize",{size:m(l.file_size)})):i.success(s("subcontractors.documentSaved")),k(),O()}catch(a){console.error("Upload failed",a),i.error(a.response?.data?.message??s("subcontractors.uploadFailed")??"Upload failed")}finally{z(!1)}}},ee=async()=>{if(!(!n||!window.confirm(s("subcontractors.confirmDeleteOpening",{name:n.contractor_name}))))try{await w.delete(n.id),i.success(s("subcontractors.openingDeleted"));const a=(B.pathname??"").startsWith("/admin");D(a?"/admin/subcontractors":"/subcontractors",{replace:!0})}catch(a){console.error("Failed to delete opening",a),i.error(a.response?.data?.message??s("errors.somethingWentWrong")??"Failed to delete")}};if(E||!n)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(_,{className:"w-6 h-6 animate-spin text-hse-primary"})});function m(t){if(t==null||Number.isNaN(Number(t)))return"";const a=Number(t);if(a<1024)return`${a} B`;const r=a/1024;if(r<1024)return`${r.toFixed(1)} KB`;const o=r/1024;return o<1024?`${o.toFixed(2)} MB`:`${(o/1024).toFixed(2)} GB`}return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[s("nav.dashboard")," / ",s("subcontractors.title")," / ",s("subcontractors.opening")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5 text-hse-primary"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 truncate",children:J})]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1",children:s("subcontractors.openingSummary",{start:n.contractor_start_date??"",workers:n.workers_count??0,uploaded:n.documents_uploaded??0,required:n.required_documents_count??0})}),n.work_type&&e.jsxs("p",{className:"text-gray-600 dark:text-gray-400 mt-1 text-sm",children:[s("subcontractors.workType"),": ",n.work_type]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",className:"btn-outline flex items-center gap-2",onClick:()=>D(-1),children:[e.jsx(oe,{className:"w-4 h-4"}),s("common.back")]}),e.jsxs("button",{type:"button",className:"btn-outline flex items-center gap-2 text-red-600 dark:text-red-400 border-red-200 dark:border-red-800 hover:bg-red-50 dark:hover:bg-red-900/20",onClick:ee,children:[e.jsx(le,{className:"w-4 h-4"}),s("common.delete")]})]})]}),e.jsx("div",{className:"card p-4",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:s("subcontractors.table.document")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:s("subcontractors.table.startDate")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:s("subcontractors.table.expiryDate")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:s("common.status")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:s("subcontractors.table.file")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:s("common.actions")})]})}),e.jsx("tbody",{children:I.map(t=>{const a=t.status??(t.expiry_date?"valid":"no_expiry"),r=A[a]??A.no_file,o=xe[a],l=s(`subcontractors.docStatus.${a}`);return e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsx("td",{className:"py-2 pr-3 text-gray-900 dark:text-gray-100",children:t.document_label}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:t.start_date??""}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:t.expiry_date??""}),e.jsx("td",{className:"py-2 pr-3",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] ${r}`,children:[o&&e.jsx(o,{className:"w-3 h-3"}),l]})}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:t.file_view_url?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"text-[11px] text-hse-primary hover:underline",onClick:()=>K(t),children:s("common.view")}),e.jsxs("button",{type:"button",onClick:()=>P(t),className:"text-[11px] text-gray-500 hover:underline flex items-center gap-1",children:[e.jsx($,{className:"w-3 h-3"}),s("common.download")]}),(t.file_size!=null||t.compressed_size!=null)&&e.jsx("span",{className:"text-[11px] text-gray-400 dark:text-gray-500",children:t.was_compressed&&t.file_size&&t.compressed_size?`${m(t.file_size)} → ${m(t.compressed_size)}`:t.file_size?m(t.file_size):m(t.compressed_size)})]}):e.jsx("span",{className:"text-[11px] text-gray-400"})}),e.jsx("td",{className:"py-2 pr-3",children:e.jsxs("button",{type:"button",className:"btn-outline btn-sm flex items-center gap-2",onClick:()=>Y(t),children:[e.jsx(me,{className:"w-4 h-4"}),t.file_view_url?s("subcontractors.replace"):s("subcontractors.add")]})})]},t.document_key)})})]})})}),u&&e.jsx(R,{isOpen:!!u,onClose:k,title:s("subcontractors.uploadTitle",{label:u.document_label}),size:"xl",children:e.jsxs("form",{onSubmit:Z,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:s("subcontractors.table.startDate")}),e.jsx(T,{value:f,onChange:j,placeholder:s("datePicker.select")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:s("subcontractors.table.expiryDate")}),e.jsx(T,{value:N,onChange:v,placeholder:s("datePicker.select")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:s("subcontractors.pdfFile")}),e.jsxs("label",{className:"flex items-center justify-between border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-xs cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-200",children:x?x.name:s("subcontractors.choosePdf")})]}),e.jsx("input",{type:"file",accept:"application/pdf",onChange:Q,className:"hidden"})]}),e.jsx("p",{className:"text-[11px] text-gray-500 dark:text-gray-400 mt-2",children:s("subcontractors.compressionHint")})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2 border-t border-gray-100 dark:border-gray-700",children:[e.jsx("button",{type:"button",className:"btn-outline",onClick:k,children:s("common.cancel")}),e.jsxs("button",{type:"submit",className:"btn-primary flex items-center gap-2",disabled:U||!x,children:[U&&e.jsx(_,{className:"w-4 h-4 animate-spin"}),s("subcontractors.send")]})]})]})}),g&&e.jsx(R,{isOpen:!!g,onClose:V,title:s("subcontractors.viewDocument"),size:"xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-[70vh]",children:H?e.jsx("div",{className:"w-full h-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 flex items-center justify-center",children:e.jsx(_,{className:"w-6 h-6 animate-spin text-hse-primary"})}):d?e.jsx("iframe",{src:d,title:s("subcontractors.viewDocument"),className:"w-full h-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white"}):e.jsx("div",{className:"w-full h-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 flex items-center justify-center text-sm text-gray-500 dark:text-gray-400",children:s("errors.somethingWentWrong")})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"button",onClick:()=>P(g),className:"btn-primary inline-flex items-center gap-2 text-sm",children:[e.jsx($,{className:"w-4 h-4"}),s("common.download")]})})]})})]})}export{fe as default};

import{a as Y,u as Z,j as e,g as ee,w as te,F as N}from"./index.js";import{u as se,b as ae,r}from"./vendor-react.js";import{S as M}from"./Select.js";import{M as re}from"./Modal.js";import{D as ne}from"./DatePicker.js";import{P as ce,ag as oe,ah as le,v as W,B as ie,al as de,z as x}from"./vendor-ui.js";import{s as me,g as xe}from"./projectList.js";import"./vendor-utils.js";const $={green:"bg-green-500",yellow:"bg-amber-500",red:"bg-red-500"};function fe(){const{t:s}=Y(),{user:z}=Z(),g=se(),w=ae(),[k,I]=r.useState([]),[l,_]=r.useState(""),[R,q]=r.useState([]),[h,B]=r.useState([]),[U,C]=r.useState(!1),[u,H]=r.useState(""),[S,p]=r.useState(!1),[P,L]=r.useState(!1),O=z?.project_list_preference??"code",K=r.useMemo(()=>me(k,O),[k,O]),[d,D]=r.useState(""),[j,T]=r.useState(""),[y,F]=r.useState(""),[b,A]=r.useState("");r.useEffect(()=>{const a=new URLSearchParams(w.search).get("project_id");a&&_(a)},[w.search]),r.useEffect(()=>{(async()=>{try{const[a,n]=await Promise.all([ee.getAllList({status:"active"}),te.getEntreprises()]);I(Array.isArray(a)?a:[]),q(n.data?.data??[])}catch(a){console.error("Failed to load subcontractor openings bootstrap data",a)}})()},[]);const E=r.useMemo(()=>{if(!u.trim())return h;const t=u.trim().toLowerCase();return h.filter(a=>(a.contractor_name??"").toLowerCase().includes(t))},[h,u]),v=async()=>{try{C(!0);const t={};l&&(t.project_id=l);const n=(await N.getAll(t)).data,c=n.data??n;B(Array.isArray(c)?c:c.data??[])}catch(t){console.error("Failed to load subcontractor openings",t),x.error(t.response?.data?.message??s("errors.somethingWentWrong")??"Failed to load")}finally{C(!1)}};r.useEffect(()=>{v()},[l]);const G=async(t,a)=>{if(window.confirm(s("subcontractors.confirmDeleteOpening",{name:a})))try{await N.delete(t),x.success(s("subcontractors.openingDeleted")),v()}catch(c){console.error("Failed to delete opening",c),x.error(c.response?.data?.message??s("errors.somethingWentWrong")??"Failed to delete")}},J=async t=>{t.preventDefault();const a=d==="__other__"?j.trim():d;if(!(!l||!a)){L(!0);try{const n=await N.create({project_id:l,contractor_name:a,work_type:y.trim()?y.trim():void 0,contractor_start_date:b||void 0});x.success(s("subcontractors.openingCreated")),p(!1),D(""),T(""),F(""),A("");const c=n.data?.data??n.data;if(c?.id){g(`/subcontractors/openings/${c.id}`);return}v()}catch(n){console.error("Failed to create opening",n),x.error(n.response?.data?.message??s("errors.somethingWentWrong")??"Failed to create")}finally{L(!1)}}},f=r.useMemo(()=>{const t=[...E];return t.sort((a,n)=>{const c=(a.contractor_name??"").trim().toLowerCase()==="sgtm",i=(n.contractor_name??"").trim().toLowerCase()==="sgtm";return c===i?(a.contractor_name??"").localeCompare(n.contractor_name??""):c?-1:1}),t},[E]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[s("nav.dashboard")," / ",s("subcontractors.title")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:s("subcontractors.title")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:s("subcontractors.subtitle")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsxs(M,{value:l,onChange:t=>_(t.target.value),className:"min-w-[220px]",children:[e.jsx("option",{value:"",children:s("workers.allProjects")}),K.map(t=>e.jsx("option",{value:t.id,children:xe(t)},t.id))]}),e.jsxs("button",{type:"button",onClick:()=>p(!0),className:"btn-primary flex items-center gap-2",disabled:!l,title:l?"":s("subcontractors.chooseProjectFirst"),children:[e.jsx(ce,{className:"w-4 h-4"}),s("subcontractors.addOpening")]})]})]}),e.jsx("div",{className:"card p-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"md:col-span-2 relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:u,onChange:t=>H(t.target.value),placeholder:s("subcontractors.searchPlaceholder"),className:"input pl-9"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{children:s("subcontractors.companiesCount",{count:f.length})})]})]})}),U?e.jsx("div",{className:"flex items-center justify-center py-10",children:e.jsx(W,{className:"w-6 h-6 animate-spin text-hse-primary"})}):f.length===0?e.jsxs("div",{className:"card p-8 text-center",children:[e.jsx(ie,{className:"w-10 h-10 text-gray-300 dark:text-gray-700 mx-auto mb-3"}),e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:s("subcontractors.noCompanies")}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:s("subcontractors.noCompaniesHelp")})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:f.map(t=>{const a=$[t.status]??$.red,n=t.documents_uploaded??0,c=t.required_documents_count??0,i=t.expired_documents??[],m=t.expiring_documents??[],Q=i.length>0||m.length>0,V=t.project?.name??"",X=t.status==="green"?s("subcontractors.statusSummary.green"):t.status==="yellow"?s("subcontractors.statusSummary.yellow"):s("subcontractors.statusSummary.red");return e.jsxs("div",{role:"button",tabIndex:0,onClick:()=>g(`/subcontractors/openings/${t.id}`),onKeyDown:o=>{o.key==="Enter"&&g(`/subcontractors/openings/${t.id}`)},className:"card p-4 text-left hover:shadow-md transition-shadow cursor-pointer",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-100 truncate",children:t.contractor_name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:s("subcontractors.cardMeta",{project:V,start:t.contractor_start_date??"",workers:t.workers_count??0})}),t.work_type&&e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[s("subcontractors.workType"),": ",t.work_type]})]}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsxs("div",{className:"relative group",children:[e.jsx("span",{className:`w-3 h-3 rounded-full ${a} block`}),Q&&e.jsx("div",{className:"pointer-events-none absolute right-0 top-5 hidden group-hover:block z-50",children:e.jsxs("div",{className:"w-[360px] max-w-[80vw] rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 shadow-lg p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-900 dark:text-gray-100 mb-2",children:s("subcontractors.popoverTitle")}),i.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-red-600 dark:text-red-300 mb-1",children:s("subcontractors.expired")}),e.jsxs("div",{className:"space-y-1",children:[i.slice(0,6).map(o=>e.jsxs("div",{className:"text-[11px] text-gray-700 dark:text-gray-200",children:[e.jsx("span",{className:"font-medium",children:o.label}),e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:[" · ",o.expiry_date]})]},o.key)),i.length>6&&e.jsx("div",{className:"text-[11px] text-gray-500 dark:text-gray-400",children:s("subcontractors.othersCount",{count:i.length-6})})]})]}),m.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-amber-600 dark:text-amber-300 mb-1",children:s("subcontractors.expiring")}),e.jsxs("div",{className:"space-y-1",children:[m.slice(0,6).map(o=>e.jsxs("div",{className:"text-[11px] text-gray-700 dark:text-gray-200",children:[e.jsx("span",{className:"font-medium",children:o.label}),e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:[" · ",o.expiry_date]})]},o.key)),m.length>6&&e.jsx("div",{className:"text-[11px] text-gray-500 dark:text-gray-400",children:s("subcontractors.othersCount",{count:m.length-6})})]})]})]})})]}),e.jsx("button",{type:"button",className:"btn-outline btn-sm",onClick:o=>{o.stopPropagation(),G(t.id,t.contractor_name)},title:s("common.delete"),children:e.jsx(de,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-600 dark:text-gray-300",children:[e.jsx("span",{children:s("subcontractors.documentsCount",{uploaded:n,required:c})}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:X})]}),e.jsx("div",{className:"mt-2 h-2 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-hse-primary",style:{width:c>0?`${Math.min(100,n/c*100)}%`:"0%"}})})]})]},t.id)})}),S&&e.jsx(re,{isOpen:S,onClose:()=>p(!1),title:s("subcontractors.newOpening"),size:"lg",children:e.jsxs("form",{onSubmit:J,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:s("subcontractors.company")}),e.jsxs(M,{value:d,onChange:t=>D(t.target.value),children:[e.jsx("option",{value:"",children:s("common.select")}),R.map(t=>e.jsx("option",{value:t,children:t},t)),e.jsx("option",{value:"__other__",children:s("subcontractors.other")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:s("subcontractors.workType")}),e.jsx("input",{type:"text",className:"input",value:y,onChange:t=>F(t.target.value),placeholder:s("subcontractors.workTypePlaceholder")})]}),d==="__other__"&&e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:s("subcontractors.newCompany")}),e.jsx("input",{type:"text",className:"input",value:j,onChange:t=>T(t.target.value),placeholder:s("subcontractors.companyPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:s("subcontractors.startDate")}),e.jsx(ne,{value:b,onChange:A,placeholder:s("datePicker.select")})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2 border-t border-gray-100 dark:border-gray-700",children:[e.jsx("button",{type:"button",className:"btn-outline",onClick:()=>p(!1),children:s("common.cancel")}),e.jsxs("button",{type:"submit",className:"btn-primary flex items-center gap-2",disabled:P||!l||!(d==="__other__"?j.trim():d),children:[P&&e.jsx(W,{className:"w-4 h-4 animate-spin"}),s("common.create")]})]})]})})]})}export{fe as default};

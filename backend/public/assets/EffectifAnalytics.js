import{a as ae,u as se,F as w,j as e,p as re}from"./index.js";import{r as s}from"./vendor-react.js";import{z as y}from"./vendor-ui.js";import{D as M}from"./DatePicker.js";import{S as V}from"./Select.js";import{u as ce}from"./projectStore.js";import{s as ie,g as le}from"./projectList.js";import{R as Y,d as oe,C as I,X,Y as G,T as W,e as ne,B as fe,L as de,f as me}from"./vendor-charts.js";import"./vendor-utils.js";function Ne(){const{t:a}=ae(),u=s.useCallback(t=>{if(!t)return"-";const r=String(t).split("T")[0],f=new Date(`${r}T00:00:00`);if(Number.isNaN(f.getTime()))return r;const h=String(f.getDate()).padStart(2,"0"),ee=String(f.getMonth()+1).padStart(2,"0"),te=String(f.getFullYear());return`${h}/${ee}/${te}`},[]),{user:q}=se(),{fetchProjects:_}=ce(),[J,A]=s.useState([]),[P,D]=s.useState([]),[C,E]=s.useState(!1),[c,O]=s.useState(""),[i,p]=s.useState(""),[o,Q]=s.useState(""),[n,U]=s.useState(""),[g,F]=s.useState([]),[S,L]=s.useState(!1),[d,$]=s.useState([]),[b,R]=s.useState(!1),[N,B]=s.useState([]),[v,z]=s.useState(!1),T=q?.project_list_preference||"code";s.useEffect(()=>{let t=!0;return(async()=>{E(!0);try{const[r,f]=await Promise.all([re.getPoles(),_({},{force:!0})]);if(!t)return;const h=r.data?.data?.poles||r.data?.poles||[];A(Array.isArray(h)?h:[]),D(Array.isArray(f)?f:[])}catch{if(!t)return;A([]),D([]),y.error(a("effectif.loadFailed"))}finally{t&&E(!1)}})(),()=>{t=!1}},[_,a]);const k=s.useMemo(()=>{const t=ie(P,T);return c?t.filter(l=>String(l?.pole??"")===c):t},[c,P,T]),m=s.useCallback(async()=>{L(!0);try{const t={};o&&(t.from_date=o),n&&(t.to_date=n),c&&(t.pole=c),i&&(t.project_id=i);const r=(await w.series(t)).data?.data?.series||[];F(Array.isArray(r)?r:[])}catch{F([]),y.error(a("effectif.loadFailed"))}finally{L(!1)}},[o,n,c,i,a]),x=s.useCallback(async()=>{R(!0);try{const t={limit:200};o&&(t.from_date=o),n&&(t.to_date=n),c&&(t.pole=c),i&&(t.project_id=i);const r=(await w.history(t)).data?.data?.entries||[];$(Array.isArray(r)?r:[])}catch{$([]),y.error(a("effectif.loadFailed"))}finally{R(!1)}},[o,n,c,i,a]),j=s.useCallback(async()=>{z(!0);try{const t={};o&&(t.from_date=o),n&&(t.to_date=n),c&&(t.pole=c),i&&(t.project_id=i);const r=(await w.byProject(t)).data?.data?.projects||[];B(Array.isArray(r)?r:[])}catch{B([]),y.error(a("effectif.loadFailed"))}finally{z(!1)}},[o,n,c,i,a]),Z=s.useCallback(()=>{m(),x(),j()},[m,x,j]);s.useEffect(()=>{m()},[m]),s.useEffect(()=>{x()},[x]),s.useEffect(()=>{j()},[j]);const H=s.useMemo(()=>(Array.isArray(g)?g:[]).map(t=>({entry_date:t.entry_date,total_effectif:Number(t.total_effectif??0)})),[g]),K=s.useMemo(()=>(Array.isArray(N)?N:[]).map(t=>{const l=String(t?.project_code??"").trim(),r=String(t?.project_name??"").trim();return{project:l&&r?`${l} - ${r}`:l||r||String(t?.project_id??""),total_effectif:Number(t?.total_effectif??0)}}),[N]);return s.useEffect(()=>{c&&i&&(k.some(l=>String(l.id)===String(i))||p(""))},[c,i,k]),e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[a("nav.dashboard")," / ",a("effectif.title")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:a("effectif.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:a("effectif.subtitleAnalytics")})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row flex-wrap gap-4",children:[e.jsxs("div",{className:"w-full sm:w-44",children:[e.jsx("label",{className:"label text-xs",children:a("effectif.pole")}),e.jsxs(V,{value:c,onChange:t=>{O(t.target.value),p("")},disabled:C,children:[e.jsx("option",{value:"",children:a("common.allPoles")}),J.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{className:"w-full sm:flex-1 sm:min-w-[180px]",children:[e.jsx("label",{className:"label text-xs",children:a("effectif.project")}),e.jsxs(V,{value:i,onChange:t=>p(t.target.value),disabled:C,children:[e.jsx("option",{value:"",children:a("common.allProjects")}),k.map(t=>e.jsx("option",{value:String(t.id),children:le(t)},t.id))]})]}),e.jsxs("div",{className:"w-full sm:w-40",children:[e.jsx("label",{className:"label text-xs",children:a("effectif.fromDate")}),e.jsx(M,{value:o,onChange:t=>Q(t),placeholder:a("effectif.fromDate")})]}),e.jsxs("div",{className:"w-full sm:w-40",children:[e.jsx("label",{className:"label text-xs",children:a("effectif.toDate")}),e.jsx(M,{value:n,onChange:t=>U(t),placeholder:a("effectif.toDate")})]}),e.jsx("div",{className:"w-full sm:w-auto sm:self-end",children:e.jsx("button",{type:"button",className:"btn-primary",onClick:Z,disabled:S||b||v,children:a(S||b||v?"common.loading":"common.refresh")})})]})}),e.jsx("div",{className:"card p-4",children:e.jsx("div",{className:"h-80",children:S?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-400",children:a("common.loading")}):H.length>0?e.jsx(Y,{width:"100%",height:"100%",children:e.jsxs(oe,{data:H,children:[e.jsx(I,{strokeDasharray:"3 3",className:"dark:opacity-20"}),e.jsx(X,{dataKey:"entry_date",tick:{fontSize:12},className:"dark:text-gray-400",tickFormatter:u}),e.jsx(G,{tick:{fontSize:12},className:"dark:text-gray-400"}),e.jsx(W,{labelFormatter:t=>u(t)}),e.jsx(ne,{type:"monotone",dataKey:"total_effectif",stroke:"#16a34a",name:a("effectif.effectif"),strokeWidth:2,dot:!1})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-400",children:a("common.noData")})})}),e.jsxs("div",{className:"card p-4",children:[e.jsxs("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:[a("effectif.effectif")," ",a("common.by")," ",a("effectif.project")]}),e.jsx("div",{className:"h-80 mt-3",children:v?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-400",children:a("common.loading")}):K.length>0?e.jsx(Y,{width:"100%",height:"100%",children:e.jsxs(fe,{data:K,children:[e.jsx(I,{strokeDasharray:"3 3",className:"dark:opacity-20"}),e.jsx(X,{dataKey:"project",tick:{fontSize:11},interval:0,angle:-15,textAnchor:"end",height:60}),e.jsx(G,{tick:{fontSize:12}}),e.jsx(W,{}),e.jsx(de,{}),e.jsx(me,{dataKey:"total_effectif",fill:"#16a34a",name:a("effectif.effectif")})]})}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-400",children:a("common.noData")})})]}),e.jsxs("div",{className:"card p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:a("common.history")??"History"}),e.jsx("div",{className:"mt-3 overflow-x-auto",children:e.jsxs("table",{className:"table w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:a("effectif.date")}),e.jsx("th",{children:a("effectif.project")}),e.jsx("th",{children:a("effectif.effectif")})]})}),e.jsx("tbody",{children:b?e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"text-center text-gray-500 dark:text-gray-400",children:a("common.loading")})}):(Array.isArray(d)?d:[]).length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"text-center text-gray-500 dark:text-gray-400",children:a("common.noData")})}):(Array.isArray(d)?d:[]).slice(0,200).map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:u(t?.entry_date)}),e.jsx("td",{children:t?.project?.code?`${t.project.code} - ${t.project?.name??""}`:t?.project?.name??t?.project_id??"-"}),e.jsx("td",{children:t?.effectif??"-"})]},`${t?.project_id??""}-${String(t?.entry_date??"")}`))})]})})]})]})}export{Ne as default};

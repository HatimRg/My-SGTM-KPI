import{a as Ne,w as ee,r as C,j as e,p as E}from"./index-Cj_Nywl_.js";import{b as ve,r as s}from"./vendor-react-Bagy_njL.js";import{D as ae}from"./DatePicker-CFkBKDFz.js";import{S as re}from"./Select-D_zVsBMD.js";import{M as ke}from"./Modal-CFdjfuaB.js";import{z as x,A as f,h as A,a5 as we,r as P,i as Pe,P as qe,e as te,n as se,ad as ie,a6 as _e}from"./vendor-ui-ByylQ01J.js";import"./vendor-utils-MYqKZVQ3.js";const le=[{value:"induction_hse",labelKey:"qualifiedPersonnel.types.inductionHse"},{value:"aptitude_physique",labelKey:"qualifiedPersonnel.types.aptitudePhysique"},{value:"travail_en_hauteur",labelKey:"qualifiedPersonnel.types.travailHauteur"},{value:"elinguage",labelKey:"qualifiedPersonnel.types.elinguage"},{value:"outillage_electrique",labelKey:"qualifiedPersonnel.types.outillageElectrique"},{value:"inspecteur_echafaudage",labelKey:"qualifiedPersonnel.types.inspecteurEchafaudage"},{value:"monteur_echafaudage",labelKey:"qualifiedPersonnel.types.monteurEchafaudage"},{value:"incendie",labelKey:"qualifiedPersonnel.types.incendie"},{value:"secourisme",labelKey:"qualifiedPersonnel.types.secourisme"},{value:"reconnaissance_hse",labelKey:"qualifiedPersonnel.types.reconnaissanceHse"},{value:"other",labelKey:"qualifiedPersonnel.types.other"}],Se=le.reduce((r,m)=>(r[m.value]=m.labelKey,r),{}),q={valid:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",expiring:"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",expired:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300",no_expiry:"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"};function Fe(){const{t:r}=Ne(),m=ve(),[ne,de]=s.useState([]),[j,W]=s.useState(""),[b,ce]=s.useState(""),[D,oe]=s.useState([]),[p,g]=s.useState(1),[N,xe]=s.useState(1),[me,L]=s.useState(!1),[n,v]=s.useState(null),[_,F]=s.useState([]),[pe,K]=s.useState(!1),[c,M]=s.useState(""),[k,U]=s.useState(""),[o,H]=s.useState(""),[y,B]=s.useState(""),[S,I]=s.useState(null),[R,z]=s.useState(!1),[w,Y]=s.useState(null),[u,ge]=s.useState(!1),[$,ye]=s.useState([]),[ue,G]=s.useState(!1),O=o&&y&&typeof o=="string"&&typeof y=="string"?y<o:!1;s.useEffect(()=>{(async()=>{try{const t=E.getMyProjects?await E.getMyProjects():await E.getAll(),l=t.data?.data||t.data||[],i=Array.isArray(l)?l:l.data||[];de(i)}catch(t){console.error("Failed to load projects for qualified personnel page",t)}})()},[]),s.useEffect(()=>{const a=new URLSearchParams(m.search),t=a.get("project_id"),l=a.get("worker_id");t&&(W(t),g(1)),l&&ee.getById(l).then(i=>{const d=i.data,h=d.data||d;v(h)}).catch(i=>{console.error("Failed to load worker for qualified personnel deep-link",i)})},[m.search]),s.useEffect(()=>{he()},[j,b,p]),s.useEffect(()=>{n?Q(n.id):F([])},[n]),s.useEffect(()=>{u&&V()},[u]);const he=async()=>{try{L(!0);const a={page:p,per_page:25,is_active:!0};j&&(a.project_id=j),b&&(a.search=b);const l=(await ee.getAll(a)).data,i=l.data||l,d=Array.isArray(i)?i:i.data||[],h=l.meta||i.meta||{};oe(d),xe(h.last_page||1),!n&&d.length>0&&v(d[0])}catch(a){console.error("Failed to load workers for qualified personnel",a),x.error(r("errors.somethingWentWrong")||"Failed to load workers")}finally{L(!1)}},Q=async a=>{try{K(!0);const t={worker_id:a,per_page:100},i=(await C.getAll(t)).data,d=i.data||i,h=Array.isArray(d)?d:d.data||[];F(h)}catch(t){console.error("Failed to load worker trainings",t),x.error(r("errors.somethingWentWrong")||"Failed to load trainings")}finally{K(!1)}},V=async()=>{try{G(!0);const a={status:"expiring_or_expired",for_my_projects:!0,per_page:100},l=(await C.getAll(a)).data,i=l.data||l,d=Array.isArray(i)?i:i.data||[];ye(d)}catch(a){console.error("Failed to load expiring trainings",a),x.error(r("errors.somethingWentWrong")||"Failed to load trainings")}finally{G(!1)}},fe=a=>{v(a)},je=a=>{const t=a.target.files?.[0];if(t&&t.type!=="application/pdf"){x.error("PDF only");return}I(t||null)},be=async a=>{if(a.preventDefault(),!!n&&!(!c||!o)&&!(c==="other"&&!k.trim())){if(O){x.error(r("qualifiedPersonnel.invalidExpiry")||"Expiry date can't be before training date");return}z(!0);try{const t={worker_id:n.id,training_type:c,training_label:c==="other"?k.trim():void 0,training_date:o,expiry_date:y||void 0,certificate:S||void 0};await C.create(t),x.success(r("qualifiedPersonnel.trainingCreated")||"Worker training saved"),M(""),U(""),H(""),B(""),I(null),Q(n.id),u&&V()}catch(t){console.error("Failed to save worker training",t);const l=t.response?.data?.message||r("errors.somethingWentWrong")||"Failed to save training";x.error(l)}finally{z(!1)}}},T=a=>a?new Date(a).toLocaleDateString("fr-FR"):"-",X=a=>{const t=Se[a.training_type];return t?r(t):a.training_label?a.training_label:a.training_type},J=a=>r(a==="expiring"?"qualifiedPersonnel.statusExpiring":a==="expired"?"qualifiedPersonnel.statusExpired":a==="no_expiry"?"qualifiedPersonnel.statusNoExpiry":"qualifiedPersonnel.statusValid"),Z=s.useMemo(()=>Array.isArray(_)?[..._].sort((a,t)=>a.expiry_date&&t.expiry_date?a.expiry_date.localeCompare(t.expiry_date):a.expiry_date?-1:t.expiry_date?1:(t.training_date||"").localeCompare(a.training_date||"")):[],[_]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[r("nav.dashboard")," / ",r("qualifiedPersonnel.navLabel")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:r("qualifiedPersonnel.pageTitle")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:r("qualifiedPersonnel.pageSubtitle")})]}),e.jsx("div",{className:"flex flex-wrap gap-2 items-center",children:e.jsxs("button",{type:"button",onClick:()=>ge(a=>!a),className:"btn-outline btn-sm flex items-center gap-2",children:[e.jsx(f,{className:"w-4 h-4 text-amber-500"}),r(u?"qualifiedPersonnel.viewAllButton":"qualifiedPersonnel.viewExpiringButton")]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-4 lg:col-span-1",children:[e.jsxs("div",{className:"card p-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-hse-primary"}),e.jsx("h2",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:r("qualifiedPersonnel.workerCardTitle")})]}),e.jsxs(re,{value:j,onChange:a=>{W(a.target.value),g(1)},children:[e.jsx("option",{value:"",children:r("workers.allProjects")}),ne.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsxs("div",{className:"relative",children:[e.jsx(we,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:b,onChange:a=>{ce(a.target.value),g(1)},placeholder:r("qualifiedPersonnel.filters.searchPlaceholder"),className:"input pl-9 py-1.5 text-sm"})]})]}),e.jsxs("div",{className:"card p-3 max-h-[520px] overflow-y-auto",children:[me?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(P,{className:"w-5 h-5 animate-spin text-hse-primary"})}):D.length===0?e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center py-4",children:r("workers.noWorkers")}):e.jsx("div",{className:"space-y-2",children:D.map(a=>{const t=n?.id===a.id;return e.jsx("button",{type:"button",onClick:()=>fe(a),className:`w-full text-left border rounded-lg px-3 py-2 text-xs transition-colors ${t?"border-hse-primary bg-hse-primary/5":"border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:[a.prenom," ",a.nom]}),e.jsx("p",{className:"text-[11px] text-gray-500 dark:text-gray-400 font-mono",children:a.cin?.toUpperCase()})]}),e.jsxs("div",{className:"text-right text-[11px] text-gray-500 dark:text-gray-400",children:[e.jsx("p",{className:"truncate max-w-[120px]",children:a.fonction||"-"}),e.jsx("p",{className:"truncate max-w-[120px]",children:a.project?.name||"-"})]})]})},a.id)})}),N>1&&e.jsxs("div",{className:"mt-3 flex items-center justify-between text-[11px] text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{children:[r("common.page")," ",p," ",r("common.of")," ",N]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{type:"button",onClick:()=>g(a=>Math.max(1,a-1)),disabled:p===1,className:"px-2 py-1 rounded border border-gray-300 dark:border-gray-600 disabled:opacity-50 disabled:cursor-not-allowed",children:r("common.previous")}),e.jsx("button",{type:"button",onClick:()=>g(a=>Math.min(N,a+1)),disabled:p===N,className:"px-2 py-1 rounded border border-gray-300 dark:border-gray-600 disabled:opacity-50 disabled:cursor-not-allowed",children:r("common.next")})]})]})]})]}),e.jsxs("div",{className:"space-y-4 lg:col-span-2",children:[n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-hse-primary/10 flex items-center justify-center",children:e.jsx(A,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[n.prenom," ",n.nom]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 font-mono",children:n.cin?.toUpperCase()}),e.jsxs("p",{className:"text-[11px] text-gray-500 dark:text-gray-400 mt-1",children:[n.fonction||"-"," · ",n.entreprise||"-"," ·"," ",n.project?.name||"-"]})]})]}),e.jsxs("button",{type:"button",onClick:()=>v(null),className:"btn-outline btn-sm flex items-center gap-2",title:r("common.unselect")||"Unselect",children:[e.jsx(Pe,{className:"w-4 h-4"}),r("common.unselect")||"Unselect"]})]}),e.jsxs("div",{className:"card p-4 space-y-4 overflow-visible",children:[e.jsx("div",{className:"flex items-center justify-between gap-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 h-4 text-hse-primary"}),e.jsx("h2",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:r("qualifiedPersonnel.addTrainingTitle")})]})}),e.jsxs("form",{onSubmit:be,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:r("qualifiedPersonnel.trainingType")}),e.jsxs(re,{value:c,onChange:a=>M(a.target.value),children:[e.jsx("option",{value:"",children:r("common.select")}),le.map(a=>e.jsx("option",{value:a.value,children:r(a.labelKey)},a.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:r("qualifiedPersonnel.trainingDate")}),e.jsx(ae,{value:o,onChange:H,placeholder:r("qualifiedPersonnel.trainingDate")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:r("qualifiedPersonnel.expiryDate")}),e.jsx(ae,{value:y,onChange:B,placeholder:r("qualifiedPersonnel.expiryDate")})]})]}),c==="other"&&e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:r("qualifiedPersonnel.trainingLabel")}),e.jsx("input",{type:"text",value:k,onChange:a=>U(a.target.value),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-xs",children:r("qualifiedPersonnel.certificate")}),e.jsxs("label",{className:"flex items-center justify-between border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-xs cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-200",children:S?S.name:r("qualifiedPersonnel.chooseFile")})]}),e.jsx("input",{type:"file",accept:"application/pdf",onChange:je,className:"hidden"})]})]}),e.jsx("div",{className:"flex justify-end gap-2 pt-2 border-t border-gray-100 dark:border-gray-700",children:e.jsxs("button",{type:"submit",disabled:R||!c||!o||c==="other"&&!k.trim()||O,className:"btn-primary flex items-center gap-2 text-sm",children:[R&&e.jsx(P,{className:"w-4 h-4 animate-spin"}),r("qualifiedPersonnel.saveTraining")]})})]})]}),e.jsxs("div",{className:"card p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between gap-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4 text-hse-primary"}),e.jsx("h2",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:r("qualifiedPersonnel.trainingListTitle")})]})}),pe?e.jsx("div",{className:"flex items-center justify-center py-6",children:e.jsx(P,{className:"w-5 h-5 animate-spin text-hse-primary"})}):Z.length===0?e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:r("qualifiedPersonnel.noTrainings")}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("qualifiedPersonnel.colType")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("qualifiedPersonnel.colStartDate")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("qualifiedPersonnel.colEndDate")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("common.status")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("qualifiedPersonnel.colCertificate")})]})}),e.jsx("tbody",{children:Z.map(a=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsx("td",{className:"py-2 pr-3 text-gray-900 dark:text-gray-100",children:X(a)}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:T(a.training_date)}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:T(a.expiry_date)}),e.jsx("td",{className:"py-2 pr-3",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] ${q[a.status]||q.valid}`,children:[a.status==="expired"&&e.jsx(f,{className:"w-3 h-3"}),a.status==="expiring"&&e.jsx(f,{className:"w-3 h-3"}),a.status==="valid"&&e.jsx(se,{className:"w-3 h-3"}),J(a.status)]})}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:a.certificate_url?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>Y(a),className:"text-[11px] text-hse-primary hover:underline",children:r("qualifiedPersonnel.viewCertificate")}),e.jsxs("a",{href:a.certificate_url,download:!0,className:"text-[11px] text-gray-500 hover:underline flex items-center gap-1",children:[e.jsx(ie,{className:"w-3 h-3"}),r("qualifiedPersonnel.downloadCertificate")]})]}):e.jsx("span",{className:"text-[11px] text-gray-400",children:"-"})})]},a.id))})]})})]})]}):e.jsxs("div",{className:"card p-6 flex flex-col items-center justify-center text-center gap-3 h-full min-h-[260px]",children:[e.jsx(A,{className:"w-10 h-10 text-gray-300 dark:text-gray-700"}),e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:r("qualifiedPersonnel.noWorkerSelected")}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 max-w-md",children:r("qualifiedPersonnel.noWorkerSelectedHelp")})]}),u&&e.jsxs("div",{className:"card p-4 space-y-3 mt-4",children:[e.jsx("div",{className:"flex items-center justify-between gap-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"w-4 h-4 text-amber-500"}),e.jsx("h2",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:r("qualifiedPersonnel.expiringListTitle")})]})}),ue?e.jsx("div",{className:"flex items-center justify-center py-6",children:e.jsx(P,{className:"w-5 h-5 animate-spin text-hse-primary"})}):$.length===0?e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:r("qualifiedPersonnel.noExpiring")||r("qualifiedPersonnel.noTrainings")}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsxs("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:[r("workers.nom"),"/",r("workers.prenom")]}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("workers.cin")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("workers.projet")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("qualifiedPersonnel.colType")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("qualifiedPersonnel.colEndDate")}),e.jsx("th",{className:"py-2 pr-3 font-medium text-gray-500 dark:text-gray-400",children:r("common.status")})]})}),e.jsx("tbody",{children:$.map(a=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsxs("td",{className:"py-2 pr-3 text-gray-900 dark:text-gray-100",children:[a.worker?.prenom," ",a.worker?.nom]}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200 font-mono",children:a.worker?.cin?.toUpperCase()}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:a.worker?.project?.name||"-"}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:X(a)}),e.jsx("td",{className:"py-2 pr-3 text-gray-700 dark:text-gray-200",children:T(a.expiry_date)}),e.jsx("td",{className:"py-2 pr-3",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] ${q[a.status]||q.valid}`,children:[a.status==="expired"&&e.jsx(f,{className:"w-3 h-3"}),a.status==="expiring"&&e.jsx(f,{className:"w-3 h-3"}),a.status==="valid"&&e.jsx(se,{className:"w-3 h-3"}),J(a.status)]})})]},a.id))})]})})]})]})]}),w&&e.jsx(ke,{isOpen:!!w,onClose:()=>Y(null),title:r("qualifiedPersonnel.viewCertificate"),size:"xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-[70vh]",children:e.jsx("iframe",{src:w.certificate_url,title:r("qualifiedPersonnel.viewCertificate"),className:"w-full h-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("a",{href:w.certificate_url,download:!0,className:"btn-primary inline-flex items-center gap-2 text-sm",children:[e.jsx(ie,{className:"w-4 h-4"}),r("qualifiedPersonnel.downloadCertificate")]})})]})})]})}export{Fe as default};

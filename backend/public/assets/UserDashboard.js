import{u as V,a as Z,e as ee,j as e,p as ae}from"./index.js";import{r as i,L as v}from"./vendor-react.js";import{z as te,s as se,a4 as re,P as de,F as q,e as B,p as G,A as le,J as ne,c as ie,T as M,R as ce,ac as oe,o as me,X as xe,a6 as ge,a7 as be}from"./vendor-ui.js";import{a as A}from"./weekHelper.js";import{s as ue,g as he}from"./projectList.js";import"./vendor-utils.js";function Ne(){const[n,k]=i.useState(null),[u,x]=i.useState(!0),[l,h]=i.useState(new Date().getFullYear()),[c,S]=i.useState("all"),[g,X]=i.useState(""),[R,T]=i.useState([]),[m,F]=i.useState(null),{user:E}=V(),{t}=Z(),b=i.useRef(null);i.useEffect(()=>{J()},[l,c,g]),i.useEffect(()=>{(async()=>{try{const s=await ae.getPoles(),d=s.data?.data?.poles??s.data?.poles??[];T(Array.isArray(d)?d:[])}catch{T([])}})()},[]),i.useEffect(()=>{n&&b.current&&requestAnimationFrame(()=>{b.current&&b.current.scrollTo({left:b.current.scrollWidth,behavior:"auto"})})},[n,l]);const J=async()=>{try{x(!0);const a={year:l};g&&(a.pole=g),c!=="all"&&(a.project_id=c);const s=await ee.getUserDashboard(a);k(s.data.data)}catch{te.error(t("errors.failedToLoad"))}finally{x(!1)}},I=t("datePicker.months"),w=n?.stats??{},P=n?.kpi_summary??{},H=n?.training_data??{},O=n?.inspection_data??{},p={...P,total_trainings:H?.total??P.total_trainings??0,total_inspections:O?.stats?.total??P.total_inspections??0},f=n?.projects??[],Y=E?.project_list_preference??"code",Q=i.useMemo(()=>ue(f,Y),[f,Y]),D=n?.recent_reports??[];return i.useEffect(()=>{if(!g||c==="all")return;f.some(s=>String(s.id)===String(c)&&s?.pole===g)||S("all")},[g,c,f]),u?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(se,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:[t("dashboard.welcome"),", ",E?.name?.split(" ")[0],"!"]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:t("dashboard.overview")})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 px-3 py-2",children:[e.jsx(re,{className:"w-4 h-4 text-gray-400"}),e.jsx("select",{value:l,onChange:a=>h(Number(a.target.value)),className:"bg-transparent border-none focus:ring-0 text-sm font-medium dark:text-gray-200",children:[...Array(5)].map((a,s)=>{const d=new Date().getFullYear()-s;return e.jsx("option",{value:d,children:d},d)})})]}),R.length>0&&e.jsx("div",{className:"flex items-center gap-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 px-3 py-2",children:e.jsxs("select",{value:g,onChange:a=>{X(a.target.value),S("all")},className:"bg-transparent border-none focus:ring-0 text-sm font-medium dark:text-gray-200",children:[e.jsx("option",{value:"",children:"All Poles"}),R.map(a=>e.jsx("option",{value:a,children:a},a))]})}),e.jsxs(v,{to:"/kpi/submit",className:"btn-primary flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),t("kpi.submission")]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(C,{title:t("nav.myProjects"),value:w.assigned_projects??0,icon:q,color:"blue"}),e.jsx(C,{title:t("dashboard.recentSubmissions"),value:w.reports_submitted??0,subtitle:`${l}`,icon:B,color:"green"}),e.jsx(C,{title:t("dashboard.pendingReports"),value:w.pending_approval??0,icon:G,color:"amber"}),e.jsx(C,{title:t("kpi.status.draft"),value:w.draft_reports??0,icon:B,color:"purple"})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(N,{title:t("kpi.accidents.title"),value:p.total_accidents??0,icon:le,color:p.total_accidents>0?"red":"green"}),e.jsx(N,{title:t("kpi.training.title"),value:p.total_trainings??0,icon:ne,color:"blue"}),e.jsx(N,{title:t("kpi.inspections.title"),value:p.total_inspections??0,icon:ie,color:"green"}),e.jsx(N,{title:t("dashboard.avgTf"),value:Number(p.avg_tf??0).toFixed(2),icon:M,color:"amber"}),e.jsx(N,{title:t("dashboard.avgTg"),value:Number(p.avg_tg??0).toFixed(2),icon:M,color:"purple"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("nav.myProjects")}),e.jsx(v,{to:"/my-projects",className:"text-sm text-hse-primary hover:underline",children:t("common.view")})]}),e.jsxs("div",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:[f.slice(0,4).map(a=>e.jsx("div",{className:"p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary/10 dark:bg-hse-primary/20 rounded-lg flex items-center justify-center",children:e.jsx(q,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a.code})]})]}),e.jsx(v,{to:`/kpi/submit/${a.id}`,className:"btn-outline text-xs py-1 px-3",children:t("kpi.submission")})]})},a.id)),f.length===0&&e.jsx("div",{className:"p-8 text-center text-gray-500 dark:text-gray-400",children:t("projects.noProjects")})]})]}),(()=>{const a=D.filter(s=>s.status==="draft");return a.length===0?null:e.jsxs("div",{className:"card border-amber-200 dark:border-amber-700 bg-amber-50/30 dark:bg-amber-900/20",children:[e.jsxs("div",{className:"card-header flex items-center justify-between bg-amber-50 dark:bg-amber-900/30 border-b border-amber-200 dark:border-amber-700",children:[e.jsxs("h3",{className:"font-semibold text-amber-900 dark:text-amber-300 flex items-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4"}),t("dashboard.draftsToComplete")]}),e.jsxs("span",{className:"bg-amber-100 dark:bg-amber-800 text-amber-800 dark:text-amber-100 text-xs font-medium px-2 py-1 rounded-full",children:[a.length," ",a.length>1?t("dashboard.draftLabelPlural"):t("dashboard.draftLabel")]})]}),e.jsx("div",{className:"divide-y divide-amber-100 dark:divide-amber-800",children:a.map(s=>e.jsx("div",{className:"p-4 hover:bg-amber-50/50 dark:hover:bg-amber-900/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.project?.name}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s.week_number?t("dashboard.weekLabel").replace("{{week}}",s.week_number).replace("{{year}}",s.report_year):t("dashboard.monthYearLabel").replace("{{month}}",I[s.report_month-1]).replace("{{year}}",s.report_year)}),s.rejection_reason&&e.jsxs("div",{className:"mt-2 p-2 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded text-xs text-red-700 dark:text-red-300",children:[e.jsxs("strong",{children:[t("kpi.rejectionReason"),":"]})," ",s.rejection_reason]})]}),e.jsxs(v,{to:`/kpi/edit/${s.id}`,className:"btn-primary text-sm py-2 px-4 flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4"}),t("common.edit")]})]})},s.id))})]})})(),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("dashboard.recentSubmissions")}),e.jsx(v,{to:"/kpi/history",className:"text-sm text-hse-primary hover:underline",children:t("common.view")})]}),e.jsxs("div",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:[D.filter(a=>a.status!=="draft").slice(0,4).map(a=>e.jsx("div",{className:"p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.project?.name??""}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a.week_number?t("dashboard.weekLabel").replace("{{week}}",a.week_number).replace("{{year}}",a.report_year):t("dashboard.monthYearLabel").replace("{{month}}",I[a.report_month-1]).replace("{{year}}",a.report_year)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a.status==="approved"&&e.jsx(me,{className:"w-5 h-5 text-green-500"}),a.status==="rejected"&&e.jsx(xe,{className:"w-5 h-5 text-red-500"}),a.status==="submitted"&&e.jsx(G,{className:"w-5 h-5 text-amber-500"}),e.jsx("span",{className:`badge ${a.status==="approved"?"badge-success":a.status==="submitted"?"badge-warning":a.status==="rejected"?"badge-danger":"badge-info"}`,children:t(`kpi.status.${a.status}`)})]})]})},a.id)),D.filter(a=>a.status!=="draft").length===0&&e.jsx("div",{className:"p-8 text-center text-gray-500 dark:text-gray-400",children:t("kpi.noReports")})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t("dashboard.submissionStatus")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:c,onChange:a=>S(a.target.value),className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-sm font-medium dark:text-gray-200 focus:ring-2 focus:ring-hse-primary",children:[e.jsx("option",{value:"all",children:t("common.allProjects")}),Q.map(a=>e.jsx("option",{value:a.id,children:he(a)},a.id))]}),e.jsx("select",{value:l,onChange:a=>h(Number(a.target.value)),className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-sm font-medium dark:text-gray-200 focus:ring-2 focus:ring-hse-primary",children:[...Array(5)].map((a,s)=>{const d=new Date().getFullYear()-s;return e.jsx("option",{value:d,children:d},d)})})]})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>b.current?.scrollBy({left:-300,behavior:"smooth"}),className:"absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-gray-700/90 hover:bg-white dark:hover:bg-gray-600 shadow-lg rounded-full p-2 border dark:border-gray-600",children:e.jsx(ge,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"})}),e.jsx("button",{onClick:()=>b.current?.scrollBy({left:300,behavior:"smooth"}),className:"absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-gray-700/90 hover:bg-white dark:hover:bg-gray-600 shadow-lg rounded-full p-2 border dark:border-gray-600",children:e.jsx(be,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"})}),e.jsx("div",{ref:b,className:"flex gap-2 overflow-x-auto scroll-smooth px-10 py-3 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",style:{scrollbarWidth:"thin"},children:(()=>{const a=A(),s=l<a.year?52:a.week;return Array.from({length:s},(d,j)=>j+1)})().map(a=>{const s=n?.weekly_status?.find(o=>o.week===a),d=A(),j=l<d.year||l===d.year&&a<d.week,L=a===d.week&&l===d.year;let r="not_submitted",z=s?.projects??[];c==="all"?r=s?.status??"not_submitted":r=z.find(U=>U.project_id===parseInt(c))?.status??"not_submitted";const y=s?.approved_count??0,$=s?.submitted_count??0,K=s?.draft_count??0,_=s?.total_projects??0;let W="";if(r==="partial"&&_>0){const o=[];y>0&&o.push("rgb(34, 197, 94)"),$>0&&o.push("rgb(251, 191, 36)"),K>0&&o.push("rgb(96, 165, 250)"),_-y-$-K>0&&o.push("rgb(254, 202, 202)"),W=o.length>1?`linear-gradient(135deg, ${o.join(", ")})`:""}return e.jsxs("div",{"data-week":a,className:`relative flex-shrink-0 w-14 p-2 rounded-lg text-center transition-all cursor-pointer ${m===a?"ring-2 ring-gray-900 ring-offset-2 scale-110":""} ${L&&m!==a?"ring-2 ring-hse-primary ring-offset-2":""} ${r==="approved"?"bg-green-500 text-white":r==="partial"?"text-white":r==="submitted"?"bg-amber-400 text-white":r==="draft"?"bg-blue-400 text-white":j?"bg-red-100 text-red-600 hover:bg-red-200":"bg-gray-100 text-gray-500"}`,style:r==="partial"&&W?{background:W}:{},onClick:()=>F(m===a?null:a),children:[e.jsxs("p",{className:"text-xs font-medium",children:[t("dashboard.weekShortPrefix"),a]}),c==="all"&&_>1?e.jsxs("p",{className:"text-xs font-bold mt-0.5",children:[y+$,"/",_]}):e.jsx("p",{className:"text-lg font-bold mt-0.5",children:r==="approved"?"âœ“":r==="partial"?"â—":r==="submitted"?"â³":r==="draft"?"ðŸ“":j?"!":"-"})]},`week-${l}-${a}`)})})]}),m&&(()=>{const s=n?.weekly_status?.find(r=>r.week===m)?.projects||[],d=A(),j=m===d.week&&l===d.year,L=l<d.year||l===d.year&&m<d.week;return s.length===0?null:e.jsxs("div",{className:"mt-3 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-700 pb-2 mb-2",children:[e.jsxs("p",{className:"font-semibold",children:[t("dashboard.weekDetailsTitle").replace("{{week}}",m),j&&e.jsxs("span",{className:"ml-2 text-hse-primary",children:["(",t("dashboard.currentWeekLabel"),")"]})]}),e.jsx("button",{onClick:()=>F(null),className:"text-gray-400 hover:text-white",children:"âœ•"})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.map(r=>{const y=r.status==="not_submitted"&&L;return e.jsxs("div",{className:"flex items-center justify-between gap-2 bg-gray-800 rounded px-2 py-1.5",children:[e.jsx("span",{className:"truncate font-medium",children:r.project_code}),e.jsx("span",{className:`flex-shrink-0 px-1.5 py-0.5 rounded text-[10px] font-medium ${r.status==="approved"?"bg-green-500":r.status==="submitted"?"bg-amber-400":r.status==="draft"?"bg-blue-400":y?"bg-red-400":"bg-gray-500"}`,children:r.status==="approved"?t("status.approved"):r.status==="submitted"?t("status.pending"):r.status==="draft"?t("status.draft"):t(y?"status.missing":"status.notSubmitted")})]},r.project_id)})})]})})(),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4 pt-4 mt-2 border-t dark:border-gray-700 text-xs text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-green-500"})," ",t("status.approved")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-gradient-to-br from-green-400 to-amber-400"})," ",t("status.partial")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-amber-400"})," ",t("status.pending")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-blue-400"})," ",t("status.draft")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-red-100 border border-red-200"})," ",t("status.missing")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded ring-2 ring-hse-primary ring-offset-1"})," ",t("dashboard.currentWeekLabel")]})]})]})]})]})}function C({title:n,value:k,subtitle:u,icon:x,color:l}){const h={blue:"bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400",green:"bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400",amber:"bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400",purple:"bg-purple-50 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400"};return e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:n}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1",children:k}),u&&e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:u})]}),e.jsx("div",{className:`p-3 rounded-lg ${h[l]}`,children:e.jsx(x,{className:"w-5 h-5"})})]})})}function N({title:n,value:k,icon:u,color:x}){const l={red:"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/50",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50",blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50"},h={red:"text-red-600 dark:text-red-400",green:"text-green-600 dark:text-green-400",blue:"text-blue-600 dark:text-blue-400",amber:"text-amber-600 dark:text-amber-400",purple:"text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${l[x]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(u,{className:`w-5 h-5 ${h[x]}`}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:n})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:k})]})}export{Ne as default};

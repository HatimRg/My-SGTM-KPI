import{u as Z,m as ee,a as ae,D as U,e as se,j as e,g as re}from"./index.js";import{r as i,L as w}from"./vendor-react.js";import{z as te,a0 as de,ap as le,aG as ne,F as q,ar as ie,Y as B,T as ce,A as oe,j as me,$ as xe,ab as O,R as ge,ax as be,V as ue,X as he,as as pe,at as fe}from"./vendor-ui.js";import{g as k}from"./weekHelper.js";import{s as je,g as ye}from"./projectList.js";import"./vendor-utils.js";function Ce(){const[n,v]=i.useState(null),[h,g]=i.useState(!0),[l,p]=i.useState(k().year),[c,L]=i.useState("all"),[b,V]=i.useState(""),[R,I]=i.useState([]),[x,F]=i.useState(null),{user:N}=Z(),{projectScope:S}=ee(),{t:s}=ae(),u=i.useRef(null);i.useEffect(()=>{X()},[l,c,b,S]),i.useEffect(()=>{(async()=>{try{const r={};N?.role==="dev"&&S===U.ASSIGNED&&(r.scope="assigned");const d=await re.getPoles(r),o=d.data?.data?.poles??d.data?.poles??[];I(Array.isArray(o)?o:[])}catch{I([])}})()},[N?.role,S]),i.useEffect(()=>{n&&u.current&&requestAnimationFrame(()=>{u.current&&u.current.scrollTo({left:u.current.scrollWidth,behavior:"auto"})})},[n,l]);const X=async()=>{try{g(!0);const a={year:l};b&&(a.pole=b),c!=="all"&&(a.project_id=c),N?.role==="dev"&&S===U.ASSIGNED&&(a.scope="assigned");const r=await se.getUserDashboard(a);v(r.data.data)}catch{te.error(s("errors.failedToLoad"))}finally{g(!1)}},G=s("datePicker.months"),C=n?.stats??{},$=n?.kpi_summary??{},J=n?.training_data??{},H=n?.inspection_data??{},f={...$,total_trainings:J?.total??$.total_trainings??0,total_inspections:H?.stats?.total??$.total_inspections??0},j=n?.projects??[],z=N?.project_list_preference??"code",Q=i.useMemo(()=>je(j,z),[j,z]),W=n?.recent_reports??[];return i.useEffect(()=>{if(!b||c==="all")return;j.some(r=>String(r.id)===String(c)&&r?.pole===b)||L("all")},[b,c,j]),h?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(de,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:[s("dashboard.welcome"),", ",N?.name?.split(" ")[0],"!"]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:s("dashboard.overview")})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 px-3 py-2",children:[e.jsx(le,{className:"w-4 h-4 text-gray-400"}),e.jsx("select",{value:l,onChange:a=>p(Number(a.target.value)),className:"bg-transparent border-none focus:ring-0 text-sm font-medium dark:text-gray-200",children:[...Array(5)].map((a,r)=>{const d=k().year+1-r;return e.jsx("option",{value:d,children:d},d)})})]}),R.length>0&&e.jsx("div",{className:"flex items-center gap-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 px-3 py-2",children:e.jsxs("select",{value:b,onChange:a=>{V(a.target.value),L("all")},className:"bg-transparent border-none focus:ring-0 text-sm font-medium dark:text-gray-200",children:[e.jsx("option",{value:"",children:s("common.allPoles")}),R.map(a=>e.jsx("option",{value:a,children:a},a))]})}),e.jsxs(w,{to:"/kpi/submit",className:"btn-primary flex items-center gap-2",children:[e.jsx(ne,{className:"w-4 h-4"}),s("kpi.submission")]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(D,{title:s("nav.myProjects"),value:C.assigned_projects??0,icon:q,color:"blue"}),e.jsx(D,{title:s("dashboard.recentSubmissions"),value:C.reports_submitted??0,subtitle:`${l}`,icon:ie,color:"green"}),e.jsx(D,{title:s("dashboard.pendingReports"),value:C.pending_approval??0,icon:B,color:"amber"}),e.jsx(D,{title:s("dashboard.activeMachines"),value:C.active_machines??0,icon:ce,color:"purple"})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(_,{title:s("kpi.accidents.title"),value:f.total_accidents??0,icon:oe,color:f.total_accidents>0?"red":"green"}),e.jsx(_,{title:s("kpi.training.title"),value:f.total_trainings??0,icon:me,color:"blue"}),e.jsx(_,{title:s("kpi.inspections.title"),value:f.total_inspections??0,icon:xe,color:"green"}),e.jsx(_,{title:s("dashboard.avgTf"),value:Number(f.avg_tf??0).toFixed(2),icon:O,color:"amber"}),e.jsx(_,{title:s("dashboard.avgTg"),value:Number(f.avg_tg??0).toFixed(2),icon:O,color:"purple"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("nav.myProjects")}),e.jsx(w,{to:"/my-projects",className:"text-sm text-hse-primary hover:underline",children:s("common.view")})]}),e.jsxs("div",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:[j.slice(0,4).map(a=>e.jsx("div",{className:"p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary/10 dark:bg-hse-primary/20 rounded-lg flex items-center justify-center",children:e.jsx(q,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a.code})]})]}),e.jsx(w,{to:`/kpi/submit/${a.id}`,className:"btn-outline text-xs py-1 px-3",children:s("kpi.submission")})]})},a.id)),j.length===0&&e.jsx("div",{className:"p-8 text-center text-gray-500 dark:text-gray-400",children:s("projects.noProjects")})]})]}),(()=>{const a=W.filter(r=>r.status==="draft");return a.length===0?null:e.jsxs("div",{className:"card border-amber-200 dark:border-amber-700 bg-amber-50/30 dark:bg-amber-900/20",children:[e.jsxs("div",{className:"card-header flex items-center justify-between bg-amber-50 dark:bg-amber-900/30 border-b border-amber-200 dark:border-amber-700",children:[e.jsxs("h3",{className:"font-semibold text-amber-900 dark:text-amber-300 flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4"}),s("dashboard.draftsToComplete")]}),e.jsxs("span",{className:"bg-amber-100 dark:bg-amber-800 text-amber-800 dark:text-amber-100 text-xs font-medium px-2 py-1 rounded-full",children:[a.length," ",a.length>1?s("dashboard.draftLabelPlural"):s("dashboard.draftLabel")]})]}),e.jsx("div",{className:"divide-y divide-amber-100 dark:divide-amber-800",children:a.map(r=>e.jsx("div",{className:"p-4 hover:bg-amber-50/50 dark:hover:bg-amber-900/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:r.project?.name}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:r.week_number?s("dashboard.weekLabel").replace("{{week}}",r.week_number).replace("{{year}}",r.report_year):s("dashboard.monthYearLabel").replace("{{month}}",G[r.report_month-1]).replace("{{year}}",r.report_year)}),r.rejection_reason&&e.jsxs("div",{className:"mt-2 p-2 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded text-xs text-red-700 dark:text-red-300",children:[e.jsxs("strong",{children:[s("kpi.rejectionReason"),":"]})," ",r.rejection_reason]})]}),e.jsxs(w,{to:`/kpi/edit/${r.id}`,className:"btn-primary text-sm py-2 px-4 flex items-center gap-2",children:[e.jsx(be,{className:"w-4 h-4"}),s("common.edit")]})]})},r.id))})]})})(),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.recentSubmissions")}),e.jsx(w,{to:"/kpi/history",className:"text-sm text-hse-primary hover:underline",children:s("common.view")})]}),e.jsxs("div",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:[W.filter(a=>a.status!=="draft").slice(0,4).map(a=>e.jsx("div",{className:"p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.project?.name??""}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a.week_number?s("dashboard.weekLabel").replace("{{week}}",a.week_number).replace("{{year}}",a.report_year):s("dashboard.monthYearLabel").replace("{{month}}",G[a.report_month-1]).replace("{{year}}",a.report_year)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a.status==="approved"&&e.jsx(ue,{className:"w-5 h-5 text-green-500"}),a.status==="rejected"&&e.jsx(he,{className:"w-5 h-5 text-red-500"}),a.status==="submitted"&&e.jsx(B,{className:"w-5 h-5 text-amber-500"}),e.jsx("span",{className:`badge ${a.status==="approved"?"badge-success":a.status==="submitted"?"badge-warning":a.status==="rejected"?"badge-danger":"badge-info"}`,children:s(`kpi.status.${a.status}`)})]})]})},a.id)),W.filter(a=>a.status!=="draft").length===0&&e.jsx("div",{className:"p-8 text-center text-gray-500 dark:text-gray-400",children:s("kpi.noReports")})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:s("dashboard.submissionStatus")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:c,onChange:a=>L(a.target.value),className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-sm font-medium dark:text-gray-200 focus:ring-2 focus:ring-hse-primary",children:[e.jsx("option",{value:"all",children:s("common.allProjects")}),Q.map(a=>e.jsx("option",{value:a.id,children:ye(a)},a.id))]}),e.jsx("select",{value:l,onChange:a=>p(Number(a.target.value)),className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-sm font-medium dark:text-gray-200 focus:ring-2 focus:ring-hse-primary",children:[...Array(5)].map((a,r)=>{const d=k().year+1-r;return e.jsx("option",{value:d,children:d},d)})})]})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>u.current?.scrollBy({left:-300,behavior:"smooth"}),className:"absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-gray-700/90 hover:bg-white dark:hover:bg-gray-600 shadow-lg rounded-full p-2 border dark:border-gray-600",children:e.jsx(pe,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"})}),e.jsx("button",{onClick:()=>u.current?.scrollBy({left:300,behavior:"smooth"}),className:"absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-gray-700/90 hover:bg-white dark:hover:bg-gray-600 shadow-lg rounded-full p-2 border dark:border-gray-600",children:e.jsx(fe,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"})}),e.jsx("div",{ref:u,className:"flex gap-2 overflow-x-auto scroll-smooth px-10 py-3 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",style:{scrollbarWidth:"thin"},children:(()=>{const a=k(),r=l<a.year?52:a.week;return Array.from({length:r},(d,o)=>o+1)})().map(a=>{const r=n?.weekly_status?.find(m=>m.week===a),d=k(),o=l<d.year||l===d.year&&a<d.week,A=a===d.week&&l===d.year;let t="not_submitted",Y=r?.projects??[];c==="all"?t=r?.status??"not_submitted":t=Y.find(M=>M.project_id===parseInt(c))?.status??"not_submitted";const y=r?.approved_count??0,T=r?.submitted_count??0,K=r?.draft_count??0,P=r?.total_projects??0;let E="";if(t==="partial"&&P>0){const m=[];y>0&&m.push("rgb(34, 197, 94)"),T>0&&m.push("rgb(251, 191, 36)"),K>0&&m.push("rgb(96, 165, 250)"),P-y-T-K>0&&m.push("rgb(254, 202, 202)"),E=m.length>1?`linear-gradient(135deg, ${m.join(", ")})`:""}return e.jsxs("div",{"data-week":a,className:`relative flex-shrink-0 w-14 p-2 rounded-lg text-center transition-all cursor-pointer ${x===a?"ring-2 ring-gray-900 ring-offset-2 scale-110":""} ${A&&x!==a?"ring-2 ring-hse-primary ring-offset-2":""} ${t==="approved"?"bg-green-500 text-white":t==="partial"?"text-white":t==="submitted"?"bg-amber-400 text-white":t==="draft"?"bg-blue-400 text-white":o?"bg-red-100 text-red-600 hover:bg-red-200":"bg-gray-100 text-gray-500"}`,style:t==="partial"&&E?{background:E}:{},onClick:()=>F(x===a?null:a),children:[e.jsxs("p",{className:"text-xs font-medium",children:[s("dashboard.weekShortPrefix"),a]}),c==="all"&&P>1?e.jsxs("p",{className:"text-xs font-bold mt-0.5",children:[y+T,"/",P]}):e.jsx("p",{className:"text-lg font-bold mt-0.5",children:t==="approved"?"âœ“":t==="partial"?"â—":t==="submitted"?"â³":t==="draft"?"ðŸ“":o?"!":"-"})]},`week-${l}-${a}`)})})]}),x&&(()=>{const r=n?.weekly_status?.find(t=>t.week===x)?.projects||[],d=k(),o=x===d.week&&l===d.year,A=l<d.year||l===d.year&&x<d.week;return r.length===0?null:e.jsxs("div",{className:"mt-3 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-700 pb-2 mb-2",children:[e.jsxs("p",{className:"font-semibold",children:[s("dashboard.weekDetailsTitle").replace("{{week}}",x),o&&e.jsxs("span",{className:"ml-2 text-hse-primary",children:["(",s("dashboard.currentWeekLabel"),")"]})]}),e.jsx("button",{onClick:()=>F(null),className:"text-gray-400 hover:text-white",children:"âœ•"})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:r.map(t=>{const y=t.status==="not_submitted"&&A;return e.jsxs("div",{className:"flex items-center justify-between gap-2 bg-gray-800 rounded px-2 py-1.5",children:[e.jsx("span",{className:"truncate font-medium",children:t.project_code}),e.jsx("span",{className:`flex-shrink-0 px-1.5 py-0.5 rounded text-[10px] font-medium ${t.status==="approved"?"bg-green-500":t.status==="submitted"?"bg-amber-400":t.status==="draft"?"bg-blue-400":y?"bg-red-400":"bg-gray-500"}`,children:t.status==="approved"?s("status.approved"):t.status==="submitted"?s("status.pending"):t.status==="draft"?s("status.draft"):s(y?"status.missing":"status.notSubmitted")})]},t.project_id)})})]})})(),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4 pt-4 mt-2 border-t dark:border-gray-700 text-xs text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-green-500"})," ",s("status.approved")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-gradient-to-br from-green-400 to-amber-400"})," ",s("status.partial")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-amber-400"})," ",s("status.pending")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-blue-400"})," ",s("status.draft")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-red-100 border border-red-200"})," ",s("status.missing")]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-3 h-3 rounded ring-2 ring-hse-primary ring-offset-1"})," ",s("dashboard.currentWeekLabel")]})]})]})]})]})}function D({title:n,value:v,subtitle:h,icon:g,color:l}){const p={blue:"bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400",green:"bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400",amber:"bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400",purple:"bg-purple-50 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400"};return e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:n}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1",children:v}),h&&e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:h})]}),e.jsx("div",{className:`p-3 rounded-lg ${p[l]}`,children:e.jsx(g,{className:"w-5 h-5"})})]})})}function _({title:n,value:v,icon:h,color:g}){const l={red:"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/50",green:"border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/50",blue:"border-blue-200 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/50",amber:"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/50",purple:"border-purple-200 bg-purple-50 dark:border-purple-700 dark:bg-purple-900/50"},p={red:"text-red-600 dark:text-red-400",green:"text-green-600 dark:text-green-400",blue:"text-blue-600 dark:text-blue-400",amber:"text-amber-600 dark:text-amber-400",purple:"text-purple-600 dark:text-purple-400"};return e.jsxs("div",{className:`rounded-xl border-2 p-4 ${l[g]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{className:`w-5 h-5 ${p[g]}`}),e.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-300",children:n})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:v})]})}export{Ce as default};

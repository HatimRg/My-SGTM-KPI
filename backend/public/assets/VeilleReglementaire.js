import{a as M,j as e,p as R,C as _}from"./index.js";import{r as c}from"./vendor-react.js";import{S as D}from"./Select.js";import{h as T,v as E,aw as V,q as z,X as B,z as j}from"./vendor-ui.js";import"./vendor-utils.js";const F="v1",v={section_id:"code_travail_titre_iv_ch1",title:"1. Loi Code du travail",subtitle:"Titre IV : De l'hygiène et de la sécurité des salariés · Chapitre I : Dispositions générales",articles:[{article_id:"281",code:"Article 281",text:"Locaux propres. Bonne conditions d'hygiène, de propreté et de salubrité nécessaires à la santé des salariés (prévention incendie, éclairage, eau potable, chauffage, aération, insonorisation, ventilation, fosses d'aisances, évacuation des eaux résiduaires et de lavage, poussières et vapeurs, vestiaires, toilette et couchage). Approvisionnement normal en eau potable des chantiers et logements salubres."},{article_id:"282",code:"Article 282",text:"Aménagement des locaux pour garantir la sécurité des salariés handicapés. Mise en place de dispositifs de protection afin que leur utilisation ne présente pas de danger."},{article_id:"283",code:"Article 283",text:"Interdiction d'acquisition ou de location de machines présentant un danger sans dispositifs de protection dont elles ont été pourvues à l'origine."},{article_id:"284",code:"Article 284",text:"Obligation de port de ceinture ou autres dispositifs de sécurité et de masques de protection pour les salariés appelés à réaliser ce genre de travaux."},{article_id:"285",code:"Article 285",text:"Obligation de clôture des puits, trappes ou ouvertures de descente. Barrières de protection/cloisons pour les moteurs. Escaliers solides munis de fortes rampes. Échafaudages munis de garde-corps rigides d'au moins 90 cm."},{article_id:"286",code:"Article 286",text:"Mettre en place des dispositifs de sécurité intégrés et éviter le contact avec les courroies."},{article_id:"287",code:"Article 287",text:"Interdiction d'utilisation de produits/substances/appareils/machines reconnus comme susceptibles de porter atteinte à la santé ou à la sécurité. Interdiction de permettre l'utilisation dans des conditions contraires à la réglementation."},{article_id:"288",code:"Article 288",text:"Signaler sur les emballages des substances et préparations dangereuses un avertissement des dangers."},{article_id:"289",code:"Article 289",text:"Informer les salariés des dispositions légales concernant la protection contre les dangers des machines. Afficher un avis lisible indiquant les dangers et précautions. Interdiction d'utiliser des machines sans dispositifs de protection, d'inopérer les dispositifs, et d'imposer le transport manuel de charges compromettant la santé/sécurité."},{article_id:"290",code:"Article 290",text:"Réalisation de visite médicale avant recrutement avec renouvellement périodique."},{article_id:"294",code:"Article 294",text:"Garantir les conditions d'hygiène et de sécurité."}]},N=()=>({sections:[{section_id:v.section_id,title:v.title,subtitle:v.subtitle,articles:v.articles.map(s=>({article_id:s.article_id,code:s.code,text:s.text,applicable:!0,compliant:!0,corrective_action:"",comment:""}))}]}),X=s=>{const w=Array.isArray(s?.articles)?s.articles:[];let n=0,u=0;for(const l of w)l?.applicable&&(n+=1,l?.compliant&&(u+=1));const h=n>0?Math.round(u/n*1e4)/100:null;return{totalApplicable:n,totalConforme:u,score:h}};function Q(){const{t:s}=M(),[w,n]=c.useState([]),[u,h]=c.useState(!0),[l,A]=c.useState(""),[S,C]=c.useState(!1),[W,L]=c.useState(!1),[P,f]=c.useState(null),[b,y]=c.useState(()=>N());c.useEffect(()=>{(async()=>{try{h(!0);const t=await R.getAllList({status:"active"});n(Array.isArray(t)?t:[]),!l&&Array.isArray(t)&&t.length===1&&A(String(t[0].id))}catch(t){n([]),j.error(t.response?.data?.message??s("errors.somethingWentWrong"))}finally{h(!1)}})()},[]),c.useEffect(()=>{(async()=>{if(!l){f(null),y(N());return}try{C(!0);const i=(await _.getLatest({project_id:Number(l)})).data?.data??null;f(i);const a=i?.answers;y(a&&typeof a=="object"?a:N())}catch{f(null),y(N())}finally{C(!1)}})()},[l]);const k=c.useMemo(()=>(Array.isArray(b?.sections)?b.sections:[]).map(t=>({section_id:t.section_id,...X(t)})),[b]),O=c.useMemo(()=>{const r=k.map(t=>t.score).filter(t=>typeof t=="number"&&Number.isFinite(t));return r.length===0?null:Math.round(r.reduce((t,i)=>t+i,0)/r.length*100)/100},[k]),g=(r,t,i)=>{y(a=>{const o={...a},d=Array.isArray(o.sections)?[...o.sections]:[],p={...d[r]??{}},m=Array.isArray(p.articles)?[...p.articles]:[],$={...m[t]??{}},x={...$,...i};return Object.prototype.hasOwnProperty.call(i,"applicable")&&i.applicable===!1&&(x.compliant=!1,x.corrective_action="",x.comment=""),Object.prototype.hasOwnProperty.call(i,"applicable")&&i.applicable===!0&&$.applicable===!1&&(x.compliant=!0),Object.prototype.hasOwnProperty.call(i,"compliant")&&i.compliant===!0&&(x.corrective_action=""),m[t]=x,p.articles=m,d[r]=p,o.sections=d,o})},q=async()=>{if(!l){j.error(s("regulatoryWatch.projectRequired"));return}try{L(!0);const r={project_id:Number(l),schema_version:F,answers:b};await _.submit(r),j.success(s("regulatoryWatch.submitSuccess"));const t=await _.getLatest({project_id:Number(l)});f(t.data?.data??null)}catch(r){j.error(r.response?.data?.message??s("errors.somethingWentWrong"))}finally{L(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 flex-col sm:flex-row",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:e.jsx(T,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s("regulatoryWatch.title")}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s("regulatoryWatch.subtitle")})]})]}),e.jsx("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:e.jsxs("button",{type:"button",onClick:q,disabled:W||!l,className:"btn-primary flex items-center justify-center gap-2 w-full sm:w-auto",children:[W?e.jsx(E,{className:"w-4 h-4 animate-spin"}):e.jsx(V,{className:"w-4 h-4"}),s("common.submit")]})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:s("regulatoryWatch.selectProject")}),e.jsxs(D,{value:l,onChange:r=>A(r.target.value),disabled:u,children:[e.jsxs("option",{value:"",children:[s(u?"common.loading":"common.select"),"..."]}),w.map(r=>e.jsx("option",{value:String(r.id),children:r.name},r.id))]})]}),e.jsx("div",{className:"md:col-span-1",children:e.jsxs("div",{className:"p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("regulatoryWatch.overallScore")}),e.jsx("div",{className:"text-lg font-bold text-gray-900 dark:text-gray-100",children:O===null?"-":`${O}%`})]})})]}),S&&e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx(E,{className:"w-4 h-4 animate-spin"}),s("common.loading")]}),!S&&P?.submitted_at&&e.jsxs("div",{className:"mt-3 text-xs text-gray-500 dark:text-gray-400",children:[s("regulatoryWatch.lastSubmission"),": ",new Date(P.submitted_at).toLocaleString()]})]}),(b?.sections??[]).map((r,t)=>{const i=k.find(a=>a.section_id===r.section_id);return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold text-gray-900 dark:text-gray-100",children:r.title}),r.subtitle&&e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:r.subtitle})]}),e.jsxs("div",{className:"p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("regulatoryWatch.sectionScore")}),e.jsxs("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:[i?`${i.totalConforme} / ${i.totalApplicable}`:"-",i?.score===null?"":` (${i.score}%)`]})]})]})}),e.jsx("div",{className:"p-4 space-y-3",children:(r.articles??[]).map((a,o)=>{const d=!a.applicable,p=d?"border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/40 opacity-70":"border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800";return e.jsxs("div",{className:`rounded-xl border ${p} p-3`,children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.code}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1",children:a.text})]}),e.jsxs("div",{className:"flex flex-col gap-2 min-w-[240px]",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>g(t,o,{applicable:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${a.applicable?"bg-hse-primary text-white border-hse-primary":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:s("regulatoryWatch.applicable")}),e.jsx("button",{type:"button",onClick:()=>g(t,o,{applicable:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${a.applicable?"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200":"bg-gray-500 text-white border-gray-500"}`,children:s("regulatoryWatch.notApplicable")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",disabled:d,onClick:()=>g(t,o,{compliant:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${a.applicable&&a.compliant?"bg-green-600 text-white border-green-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:e.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[e.jsx(z,{className:"w-4 h-4"}),s("regulatoryWatch.conforme")]})}),e.jsx("button",{type:"button",disabled:d,onClick:()=>g(t,o,{compliant:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${a.applicable&&!a.compliant?"bg-red-600 text-white border-red-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:e.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[e.jsx(B,{className:"w-4 h-4"}),s("regulatoryWatch.nonConforme")]})})]})]})]}),a.applicable&&a.compliant===!1&&e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.correctiveAction")}),e.jsx("textarea",{value:a.corrective_action??"",onChange:m=>g(t,o,{corrective_action:m.target.value}),rows:2,className:"input"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.comment")}),e.jsx("textarea",{value:a.comment??"",onChange:m=>g(t,o,{comment:m.target.value}),rows:2,className:"input",disabled:!a.applicable})]})]},a.article_id)})})]},r.section_id)})]})}export{Q as default};

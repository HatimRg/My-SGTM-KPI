import{a as Pe,u as _e,x as N,j as e,M as Ae,h as Oe}from"./index.js";import{r}from"./vendor-react.js";import{u as Ee}from"./projectStore.js";import{D as B}from"./DatePicker.js";import{S as W}from"./Select.js";import{C as Le}from"./ConfirmDialog.js";import{aq as ce,au as Ie,av as Ue,aN as Me,C as Re,w as Be,c as We,a as ie,aw as de,aA as me,z as c}from"./vendor-ui.js";import{c as He}from"./weekHelper.js";import{s as qe,g as xe}from"./projectList.js";import"./vendor-utils.js";const ze=[15,30,45,60],H=10;function as(){const{t:a}=Pe(),{user:w}=_e(),{projects:P,isLoading:q,fetchProjects:z}=Ee(),[$,_]=r.useState(!1),[u,A]=r.useState(null),[G,K]=r.useState(!1),X=w?.project_list_preference??"code",J=r.useMemo(()=>qe(P,X),[P,X]),[x,he]=r.useState([]),[Q,V]=r.useState(!1),[v,Y]=r.useState(""),[y,Z]=r.useState(""),[ee,pe]=r.useState(""),[g,O]=r.useState(""),[o,E]=r.useState(""),[k,se]=r.useState(""),[j,ae]=r.useState(15),[te,re]=r.useState(""),[d,ue]=r.useState(""),[m,ye]=r.useState(""),[h,ge]=r.useState(""),[p,je]=r.useState(""),[L,be]=r.useState(!1),[b,f]=r.useState(1),[fe,ne]=r.useState(!1),[I,U]=r.useState(null);r.useEffect(()=>{w?.name&&pe(w.name)},[w?.name]);const Ne=s=>{if(!s)return null;const t=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(s),n=decodeURIComponent(t?.[1]??t?.[2]??"");return n!==""?n:null},we=(s,t)=>{const n=URL.createObjectURL(s),l=document.createElement("a");l.href=n,l.download=t??"template.xlsx",document.body.appendChild(l),l.click(),l.remove(),setTimeout(()=>URL.revokeObjectURL(n),5e3)},ve=()=>{A(null),_(!0)},ke=async()=>{try{const s=await N.downloadTemplate(),t=Ne(s.headers?.["content-disposition"])??"SGTM-Awareness-Template.xlsx";we(s.data,t)}catch(s){c.error(s.response?.data?.message??a("common.downloadTemplateFailed"))}},Se=async()=>{if(!u){c.error(a("common.chooseFile"));return}try{K(!0);const s=new FormData;s.append("file",u);const n=(await N.bulkImport(s)).data?.data??{},l=n.imported??0,i=n.updated??0,D=n.errors??[];c.success(a("common.importSummary",{imported:l,updated:i})),D.length>0&&c.error(a("common.importIssues",{count:D.length})),A(null),_(!1),S()}catch(s){c.error(s.response?.data?.message??a("common.importFailed"))}finally{K(!1)}};r.useEffect(()=>{(async()=>{try{const t=await z();t.length===1&&Y(t[0].id)}catch(t){console.error("Failed to load projects",t)}})()},[z]),r.useEffect(()=>{S()},[d,m]);const S=async()=>{try{V(!0);const s={};d&&(s.project_id=d),m&&(s.week=m);const t=await N.getAll(s);he(t.data?.data??t.data??[])}catch(s){console.error("Failed to load awareness sessions",s)}finally{V(!1)}},M=r.useMemo(()=>{const s=a("awareness.themes");return Array.isArray(s)?s:[]},[a]),Ce=r.useMemo(()=>{if(!g)return M;const s=g.toLowerCase();return M.filter(t=>t.toLowerCase().includes(s))},[M,g]),C=parseInt(te,10),R=j/60*C,F=r.useMemo(()=>Array.isArray(x)?x.filter(s=>{const t=s.date?s.date.substring(0,10):"";return!(h&&(!t||t<h)||p&&(!t||t>p))}):[],[x,h,p]),T=Math.max(1,Math.ceil((F.length??0)/H)),le=r.useMemo(()=>{if(!Array.isArray(F))return[];const s=(b-1)*H;return F.slice(s,s+H)},[F,b]);r.useEffect(()=>{f(1)},[d,m]);const Fe=async()=>{try{ne(!0);const s={};d&&(s.project_id=d),m&&(s.week=m),h&&(s.from_date=h),p&&(s.to_date=p);const t=await Oe.exportAwareness(s),n=new Blob([t.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),l=window.URL.createObjectURL(n),i=document.createElement("a");i.href=l,i.download="awareness_sessions.xlsx",i.click(),window.URL.revokeObjectURL(l)}catch(s){console.error("Error exporting awareness sessions:",s),c.error(a("errors.somethingWentWrong")??a("common.exportFailed"))}finally{ne(!1)}},Te=s=>{if(s.preventDefault(),!v||!y||!o||!C||o==="Other"&&!k.trim())return;const{week:t,year:n}=He(y),l={project_id:v,date:y,week_number:t,week_year:n,by_name:ee,theme:o==="Other"?k:o,duration_minutes:j,participants:C,session_hours:R};N.create(l).then(()=>{c.success(a("awareness.created")??"Session saved"),Z(""),O(""),E(""),se(""),ae(15),re(""),S()}).catch(i=>{console.error("Failed to create awareness session",i);const D=i.response?.data?.message??a("errors.somethingWentWrong")??"Failed to save session";c.error(D)})},oe=s=>{U(s)},De=async()=>{if(I?.id)try{await N.delete(I.id),c.success(a("common.saved")??"Saved"),S()}catch(s){console.error("Failed to delete awareness session",s),c.error(a("errors.failedToDelete")??a("common.error")??"Error")}finally{U(null)}};return e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[a("nav.dashboard")," / ",a("awareness.navLabel")]}),$&&e.jsx(Ae,{isOpen:$,onClose:()=>_(!1),title:"Massive Add",size:"xl",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("button",{type:"button",onClick:ke,className:"btn-secondary flex items-center justify-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{children:a("common.downloadTemplate")??"Download template"})]}),e.jsxs("label",{className:"flex items-center justify-between border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-xs cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-200",children:u?u.name:a("common.chooseFile")??"Choose Excel file"})]}),e.jsx("input",{type:"file",accept:".xlsx,.xls",className:"hidden",onChange:s=>A(s.target.files?.[0]??null)})]}),e.jsx("button",{type:"button",onClick:Se,disabled:G||!u,className:"btn-primary",children:G?a("common.loading")??"Importing...":a("common.import")??"Import"})]})})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:a("awareness.pageTitle")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:a("awareness.pageSubtitle")})]}),e.jsxs("div",{className:"card",children:[e.jsxs("button",{type:"button",onClick:s=>{if(s?.ctrlKey){ve();return}be(!L)},className:"w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(Ue,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:a("awareness.addSession")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("awareness.clickToExpand")})]})]}),L?e.jsx(Me,{className:"w-5 h-5 text-gray-400"}):e.jsx(Re,{className:"w-5 h-5 text-gray-400"})]}),L&&e.jsxs("form",{onSubmit:Te,className:"p-6 pt-2 space-y-6 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("awareness.project")}),e.jsxs(W,{value:v,onChange:s=>Y(s.target.value),disabled:q||P.length===1,required:!0,children:[e.jsx("option",{value:"",children:a(q?"common.loading":"awareness.selectProject")}),J.map(s=>e.jsx("option",{value:s.id,children:xe(s)},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("awareness.date")}),e.jsx(B,{value:y,onChange:Z,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("awareness.by")}),e.jsx("input",{type:"text",className:"input bg-gray-50 dark:bg-gray-800",value:ee,readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"label",children:a("awareness.theme")}),e.jsxs("div",{className:"relative",children:[e.jsx(Be,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",className:"input pl-9",placeholder:a("awareness.searchTheme"),value:g,onChange:s=>O(s.target.value)}),g&&e.jsx("button",{type:"button",onClick:()=>O(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx(We,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg divide-y divide-gray-100 dark:divide-gray-700 bg-white dark:bg-gray-800",children:[Ce.map((s,t)=>e.jsxs("button",{type:"button",onClick:()=>E(s),className:`w-full text-left px-3 py-2.5 text-sm flex items-center justify-between gap-2 transition-colors ${o===s?"bg-hse-primary/10 text-hse-primary font-medium border-l-4 border-hse-primary":"text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 border-l-4 border-transparent"}`,children:[e.jsx("span",{children:s}),o===s&&e.jsx(ie,{className:"w-4 h-4 text-hse-primary flex-shrink-0"})]},t)),e.jsxs("button",{type:"button",onClick:()=>E("Other"),className:`w-full text-left px-3 py-2.5 text-sm flex items-center justify-between gap-2 transition-colors ${o==="Other"?"bg-hse-primary/10 text-hse-primary font-medium border-l-4 border-hse-primary":"text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 border-l-4 border-transparent"}`,children:[e.jsx("span",{className:"font-medium",children:a("awareness.other")}),o==="Other"&&e.jsx(ie,{className:"w-4 h-4 text-hse-primary flex-shrink-0"})]})]}),o==="Other"&&e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"label text-sm",children:a("awareness.otherTheme")}),e.jsx("input",{type:"text",placeholder:a("awareness.otherTheme"),className:"input",value:k,onChange:s=>se(s.target.value),required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("awareness.duration")}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"range",min:"15",max:"60",step:"15",value:j,onChange:s=>ae(parseInt(s.target.value,10)),className:"w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-hse-primary"}),e.jsx("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400",children:ze.map(s=>e.jsxs("span",{className:`${j===s?"text-hse-primary font-semibold":""}`,children:[s," min"]},s))}),e.jsx("div",{className:"text-center",children:e.jsxs("span",{className:"inline-block px-4 py-1 bg-hse-primary/10 text-hse-primary rounded-full text-sm font-medium",children:[j," ",a("awareness.minutes")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("awareness.participants")}),e.jsx("input",{type:"number",min:"1",className:"input",value:te,onChange:s=>re(s.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("awareness.sessionHours")}),e.jsxs("div",{className:"input bg-gray-50 dark:bg-gray-800 flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold text-hse-primary",children:Number.isFinite(R)?R.toFixed(2):0}),e.jsx("span",{className:"text-xs text-gray-400 ml-2",children:a("awareness.hoursUnit")})]})]})]}),e.jsx("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{type:"submit",className:"btn-primary",disabled:!v||!y||!C||!o||o==="Other"&&!k,children:a("awareness.submit")})})]})]}),e.jsxs("div",{className:"card p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-hse-primary"}),a("awareness.listTitle")]}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap items-center gap-3",children:[e.jsxs(W,{value:d,onChange:s=>ue(s.target.value),className:"h-10 text-sm min-w-[140px]",children:[e.jsx("option",{value:"",children:a("awareness.allProjects")}),J.map(s=>e.jsx("option",{value:s.id,children:xe(s)},s.id))]}),e.jsxs(W,{value:m,onChange:s=>ye(s.target.value),className:"h-10 text-sm min-w-[130px]",children:[e.jsx("option",{value:"",children:a("awareness.allWeeks")}),Array.from({length:52},(s,t)=>t+1).map(s=>e.jsx("option",{value:s,children:a("awareness.weekLabel").replace("{{week}}",s)},s))]}),e.jsx(B,{value:h,onChange:s=>{ge(s),f(1)},placeholder:"From date",className:"w-40 h-10"}),e.jsx(B,{value:p,onChange:s=>{je(s),f(1)},placeholder:"To date",className:"w-40 h-10"}),e.jsxs("button",{type:"button",onClick:Fe,disabled:fe||x.length===0,className:"btn-secondary flex items-center gap-2 text-sm",children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{children:a("dashboard.exportExcel")})]})]})]}),Q?e.jsxs("div",{className:"space-y-3 py-4",children:[e.jsx("div",{className:"hidden md:block space-y-2 animate-pulse",children:Array.from({length:4},(s,t)=>e.jsx("div",{className:"h-10 rounded-md bg-gray-100 dark:bg-gray-800"},t))}),e.jsx("div",{className:"md:hidden space-y-3 animate-pulse",children:Array.from({length:3},(s,t)=>e.jsx("div",{className:"h-24 rounded-lg bg-gray-100 dark:bg-gray-800"},t))})]}):x.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 rounded-full bg-hse-primary/10 mb-3",children:e.jsx(de,{className:"w-5 h-5 text-hse-primary"})}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:a("awareness.noSessions")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:le.map(s=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.project?.name??""}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:s.date?s.date.substring(0,10):""}),e.jsx("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-300",children:s.by_name??""})]}),e.jsxs("div",{className:"text-right text-xs text-gray-600 dark:text-gray-300 space-y-1",children:[e.jsx("p",{className:"font-medium truncate max-w-[140px]",children:s.theme}),e.jsxs("p",{children:[s.duration_minutes," min"]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:()=>oe(s),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:a("common.delete")??"Delete",children:e.jsx(me,{className:"w-4 h-4 text-red-600"})})})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-gray-50 dark:bg-gray-900",children:[a("awareness.participants"),": ",s.participants]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-hse-primary/10 text-hse-primary",children:[a("awareness.sessionHours"),": ",s.session_hours]})]})]},s.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 text-left",children:[e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("awareness.colDate")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("awareness.colProject")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("awareness.colBy")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("awareness.colTheme")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("awareness.colDuration")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("awareness.colParticipants")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("awareness.colHours")}),e.jsx("th",{className:"py-2 pr-4 font-medium text-gray-500 dark:text-gray-400",children:a("common.actions")??"Actions"})]})}),e.jsx("tbody",{children:le.map(s=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsx("td",{className:"py-2 pr-4 text-gray-900 dark:text-gray-100 text-xs",children:s.date?s.date.substring(0,10):""}),e.jsx("td",{className:"py-2 pr-4 text-gray-900 dark:text-gray-100",children:s.project?.name??""}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:s.by_name??""}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200 max-w-xs truncate",children:s.theme}),e.jsxs("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:[s.duration_minutes," min"]}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:s.participants}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:s.session_hours}),e.jsx("td",{className:"py-2 pr-4 text-gray-700 dark:text-gray-200",children:e.jsx("button",{type:"button",onClick:()=>oe(s),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:a("common.delete")??"Delete",children:e.jsx(me,{className:"w-4 h-4 text-red-600"})})})]},s.id))})]})})]}),!Q&&x.length>0&&T>1&&e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-100 dark:border-gray-800",children:[e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[a("common.page")," ",b," ",a("common.of")," ",T]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>f(s=>Math.max(1,s-1)),disabled:b===1,className:"btn-secondary text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:a("common.previous")??"Previous"}),e.jsx("button",{type:"button",onClick:()=>f(s=>Math.min(T,s+1)),disabled:b===T,className:"btn-secondary text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:a("common.next")??"Next"})]})]})]}),e.jsx(Le,{isOpen:!!I,title:a("common.delete")??"Delete",message:a("common.confirmDelete")??"Are you sure you want to delete this record?",confirmLabel:a("common.delete")??"Delete",cancelLabel:a("common.cancel")??"Cancel",onConfirm:De,onCancel:()=>U(null)})]})}export{as as default};

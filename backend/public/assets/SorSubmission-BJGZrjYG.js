import{j as e,a as Ee,u as Re,p as de,w as De,i as F,f as Ae}from"./index-Cj_Nywl_.js";import{r as n}from"./vendor-react-Bagy_njL.js";import{D as Y}from"./DatePicker-CFkBKDFz.js";import{o as be,al as me,C as xe,z as d,A as he,a4 as ze,ar as ge,c as pe,a1 as Le,r as q,D as Fe,a7 as Me,n as K,i as ee,ac as Oe,a0 as Te,ab as Ie,k as qe,as as V}from"./vendor-ui-ByylQ01J.js";import{A as ue}from"./AutocompleteInput-i2MfZjdv.js";import"./vendor-utils-MYqKZVQ3.js";function te({value:s,onChange:S,placeholder:X="HH:MM",className:U="",disabled:x=!1}){const[m,b]=n.useState(!1),M=n.useRef(null),[h,H]=n.useState(()=>s?parseInt(s.split(":")[0]):new Date().getHours()),[N,P]=n.useState(()=>s?parseInt(s.split(":")[1]):Math.floor(new Date().getMinutes()/5)*5);n.useEffect(()=>{if(s){const[i,l]=s.split(":");H(parseInt(i)||0),P(parseInt(l)||0)}},[s]),n.useEffect(()=>{const i=p=>{M.current&&!M.current.contains(p.target)&&b(!1)},l=p=>{p.key==="Escape"&&b(!1)};return m&&(document.addEventListener("mousedown",i),document.addEventListener("keydown",l)),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",l)}},[m]);const $=(i,l)=>`${String(i).padStart(2,"0")}:${String(l).padStart(2,"0")}`,E=(i,l)=>{const p=Math.max(0,Math.min(23,i)),D=Math.max(0,Math.min(59,l));H(p),P(D),S($(p,D))},w=()=>E((h+1)%24,N),g=()=>E((h-1+24)%24,N),R=()=>E(h,(N+5)%60),Z=()=>E(h,(N-5+60)%60),a=["06:00","08:00","10:00","12:00","14:00","16:00","18:00"];return e.jsxs("div",{ref:M,className:`relative ${U}`,children:[e.jsxs("div",{onClick:()=>!x&&b(!m),className:`input flex items-center justify-between cursor-pointer ${x?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx("span",{className:s?"text-gray-900 dark:text-gray-100":"text-gray-400 dark:text-gray-500",children:s||X}),e.jsx(be,{className:"w-4 h-4 text-gray-400"})]}),m&&e.jsxs("div",{className:"absolute z-[100] mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-3 w-56",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:w,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(me,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(h).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:g,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(xe,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]}),e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:":"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{type:"button",onClick:R,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(me,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),e.jsx("div",{className:"w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg",children:e.jsx("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:String(N).padStart(2,"0")})}),e.jsx("button",{type:"button",onClick:Z,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:e.jsx(xe,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})})]})]}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-2",children:e.jsx("div",{className:"flex flex-wrap gap-1 justify-center",children:a.map(i=>e.jsx("button",{type:"button",onClick:()=>{S(i),b(!1)},className:`px-2 py-1 text-xs rounded transition-colors
                    ${s===i?"bg-hse-primary text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:i},i))})}),e.jsx("div",{className:"mt-2 pt-2 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{type:"button",onClick:()=>{S($(h,N)),b(!1)},className:"w-full py-1.5 bg-hse-primary text-white rounded-lg hover:bg-hse-primary/90 transition-colors text-sm font-medium",children:"OK"})})]})]})}const W={nettoyage_rangement:"Nettoyage et Rangement",protection_chute:"Protection contre les chute",echafaudage:"Echafaudage/Echelles/Escaliers",epi:"Equipements de Protection Individuel",excavations:"Excavations",levage:"Levage",methode_travail:"Méthode de travail - SPA",manutention:"Manutention",vehicule_transport:"Vehicule/Transport",outils_equipements:"Outils/Equipements",chute_trebuchement:"Chute & Trébuchement",electricite:"Electricité",protection_incendie:"Protection Incendie",communication_attitude:"Communication/Attitude",acces_passage:"Accès/Passage/Issues de Secours",formation_toolbox:"Formation/Toolbox/Réunion",inspection_evaluation:"Inspection et Evaluation",documentation_hse:"Documentation HSE & Evaluation",gestion_sous_traitants:"Gestion des sous-traitants",autre:"Autre"};function Ke(){const{t:s}=Ee(),{user:S}=Re(),[X,U]=n.useState(!0),[x,m]=n.useState(!1),[b,M]=n.useState([]),[h,H]=n.useState([]),[N,P]=n.useState([]),[$,E]=n.useState([]),[w,g]=n.useState(!1),[R,Z]=n.useState(null),[a,i]=n.useState(null),[l,p]=n.useState({project_id:"",status:"",category:""}),[D,_]=n.useState(!1),[C,A]=n.useState(null),[J,z]=n.useState(!1),[u,k]=n.useState({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),[B,se]=n.useState(null),[Q,ye]=n.useState([]),[We,re]=n.useState(1),[je,ae]=n.useState(!1),[c,L]=n.useState({project_id:"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:S?.name||"",non_conformity:"",photo:null,category:"",responsible_person:""}),[oe,ne]=n.useState(null);n.useEffect(()=>{const t=r=>{r.key==="Escape"&&(w&&(g(!1),j()),D&&(_(!1),v(),j()),J&&(z(!1),v(),A(null)),a&&i(null))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[w,D,J,a]),n.useEffect(()=>{T()},[l]),n.useEffect(()=>{ve(),O()},[]),n.useEffect(()=>{w&&c.project_id&&G(c.project_id)},[w]);const ve=async()=>{try{const[t,r]=await Promise.all([de.getAll({per_page:100}),De.getEntreprises()]),o=t.data.data||[];if(H(o),E(r.data.data||[]),o.length===1){const f=o[0].id.toString();L(I=>({...I,project_id:f})),G(f)}}catch(t){console.error("Error fetching projects:",t)}},O=async()=>{try{const t=await F.getPinned();ye(t.data.data||[])}catch(t){console.error("Error fetching pinned reports:",t)}},G=async t=>{if(!t){P([]);return}try{const r=await de.getZones(t);P(r.data.data.zones||[])}catch(r){console.error("Error fetching project zones:",r),P([])}},T=async()=>{U(!0);try{const t={};l.project_id&&(t.project_id=l.project_id),l.status&&(t.status=l.status),l.category&&(t.category=l.category);const r=await F.getAll(t);M(r.data.data||[])}catch(t){console.error("Error fetching SOR reports:",t),d.error(s("errors.fetchFailed"))}finally{U(!1)}},y=(t,r)=>{L(o=>({...o,[t]:r})),t==="project_id"&&(G(r),L(o=>({...o,zone:""})))},fe=t=>{const r=t.target.files[0];if(r){L(f=>({...f,photo:r}));const o=new FileReader;o.onloadend=()=>ne(o.result),o.readAsDataURL(r)}},j=()=>{L({project_id:h.length===1?h[0].id.toString():"",company:"",observation_date:new Date().toISOString().split("T")[0],observation_time:"",zone:"",supervisor:S?.name||"",non_conformity:"",photo:null,category:"",responsible_person:""}),ne(null),Z(null)},Ne=async t=>{if(t.preventDefault(),!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(s("sor.fillRequired"));return}if(R){m(!0);try{await F.update(R.id,c),d.success(s("sor.updateSuccess")),j(),g(!1),T(),O()}catch(r){const o=r.response?.data?.message||s("errors.somethingWentWrong");d.error(o)}finally{m(!1)}}else g(!1),_(!0)},ke=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(s("sor.fillRequired")),_(!1),g(!0);return}m(!0);try{const t={...c,...u,submit_corrective_action:!0};await F.create(t),d.success(s("sor.createClosedSuccess")),j(),v(),_(!1),re(1),T(),O()}catch(t){console.error("SOR submit error:",t.response?.data);const r=t.response?.data?.errors;if(r){const o=Object.values(r)[0];d.error(Array.isArray(o)?o[0]:o)}else d.error(t.response?.data?.message||s("errors.somethingWentWrong"))}finally{m(!1)}},we=async()=>{if(!c.project_id||!c.observation_date||!c.non_conformity||!c.category){d.error(s("sor.fillRequired")),_(!1),g(!0);return}m(!0);try{const t={...c,submit_later:!0};console.log("Submitting SOR data:",t),await F.create(t),d.success(s("sor.createPinnedSuccess")),j(),_(!1),re(1),T(),O()}catch(t){console.error("SOR submit later error:",t.response?.data);const r=t.response?.data?.errors;if(r){const o=Object.values(r)[0];d.error(Array.isArray(o)?o[0]:o)}else d.error(t.response?.data?.message||s("errors.somethingWentWrong"))}finally{m(!1)}},_e=async t=>{if(t.preventDefault(),!u.corrective_action){d.error(s("sor.correctiveRequired"));return}m(!0);try{await F.submitCorrectiveAction(C.id,u),d.success(s("sor.correctiveSubmitted")),v(),A(null),z(!1),T(),O()}catch(r){const o=r.response?.data?.message||s("errors.somethingWentWrong");d.error(o)}finally{m(!1)}},v=()=>{k({corrective_action:"",corrective_action_date:new Date().toISOString().split("T")[0],corrective_action_time:"",corrective_action_photo:null}),se(null)},ce=t=>{const r=t.target.files[0];if(r){k(f=>({...f,corrective_action_photo:r}));const o=new FileReader;o.onloadend=()=>se(o.result),o.readAsDataURL(r)}},Ce=t=>{A(t),v(),z(!0)},le=t=>{G(t.project_id),L({project_id:t.project_id,company:t.company||"",observation_date:t.observation_date?.split("T")[0]||"",observation_time:t.observation_time||"",zone:t.zone||"",supervisor:t.supervisor||"",non_conformity:t.non_conformity||"",photo:null,category:t.category||"",responsible_person:t.responsible_person||""}),Z(t),g(!0)},Se=t=>{A(t),v(),z(!0)},ie=t=>{const r={open:"bg-red-100 text-red-700",in_progress:"bg-amber-100 text-amber-700",closed:"bg-green-100 text-green-700"},o={open:s("sor.status.open"),in_progress:s("sor.status.inProgress"),closed:s("sor.status.closed")};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${r[t]}`,children:o[t]})},Pe=async()=>{try{ae(!0);const t={};l.project_id&&(t.project_id=l.project_id),l.status&&(t.status=l.status),l.category&&(t.category=l.category);const r=await Ae.exportDeviations(t),o=new Blob([r.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=window.URL.createObjectURL(o),I=document.createElement("a");I.href=f,I.download="deviations.xlsx",I.click(),window.URL.revokeObjectURL(f)}catch(t){console.error("Error exporting deviations:",t),d.error(s("errors.somethingWentWrong"))}finally{ae(!1)}};return e.jsxs("div",{className:"p-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2",children:[e.jsx(he,{className:"w-7 h-7 text-amber-500"}),s("sor.title")]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:s("sor.subtitle")})]}),e.jsxs("button",{onClick:()=>{j(),g(!0)},className:"btn btn-primary flex items-center gap-2",children:[e.jsx(ze,{className:"w-5 h-5"}),s("sor.addNew")]})]}),Q.length>0&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(ge,{className:"w-5 h-5 text-amber-600 dark:text-amber-400"}),e.jsx("h3",{className:"font-semibold text-amber-800 dark:text-amber-300",children:s("sor.pendingCorrective")}),e.jsx("span",{className:"bg-amber-200 dark:bg-amber-700 text-amber-800 dark:text-amber-100 text-xs font-bold px-2 py-0.5 rounded-full",children:Q.length})]}),e.jsx("div",{className:"grid gap-2",children:Q.map(t=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-3 flex items-center justify-between border border-amber-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:new Date(t.observation_date).toLocaleDateString("fr-FR")})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 truncate max-w-md",children:t.non_conformity})]}),e.jsxs("button",{onClick:()=>Ce(t),className:"btn btn-primary btn-sm flex items-center gap-1",children:[e.jsx(pe,{className:"w-4 h-4"}),s("sor.addCorrective")]})]},t.id))})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.project")}),e.jsxs("select",{value:l.project_id,onChange:t=>p(r=>({...r,project_id:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:s("common.all")}),h.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.status.label")}),e.jsxs("select",{value:l.status,onChange:t=>p(r=>({...r,status:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:s("common.all")}),e.jsx("option",{value:"open",children:s("sor.status.open")}),e.jsx("option",{value:"in_progress",children:s("sor.status.inProgress")}),e.jsx("option",{value:"closed",children:s("sor.status.closed")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.category")}),e.jsxs("select",{value:l.category,onChange:t=>p(r=>({...r,category:t.target.value})),className:"input",children:[e.jsx("option",{value:"",children:s("common.all")}),Object.entries(W).map(([t,r])=>e.jsx("option",{value:t,children:r},t))]})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{onClick:()=>p({project_id:"",status:"",category:""}),className:"btn btn-outline w-full",type:"button",children:s("common.reset")}),e.jsxs("button",{type:"button",onClick:Pe,disabled:je||b.length===0,className:"btn-secondary w-full flex items-center justify-center gap-2 text-sm",children:[e.jsx(Le,{className:"w-4 h-4"}),e.jsx("span",{children:s("dashboard.exportExcel")})]})]})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden",children:X?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(q,{className:"w-8 h-8 animate-spin text-hse-primary"})}):b.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(he,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:s("sor.noReports")})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:s("sor.date")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:s("sor.project")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:s("sor.zone")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:s("sor.category")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:s("sor.nonConformity")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:s("sor.status.label")}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase",children:s("common.actions")})]})}),e.jsx("tbody",{className:"divide-y dark:divide-gray-700",children:b.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:new Date(t.observation_date).toLocaleDateString("fr-FR")}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium dark:text-gray-100",children:t.project?.name}),e.jsx("td",{className:"px-4 py-3 text-sm dark:text-gray-300",children:t.zone||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("span",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 rounded text-xs",children:W[t.category]||t.category})}),e.jsx("td",{className:"px-4 py-3 text-sm max-w-xs truncate dark:text-gray-300",children:t.non_conformity}),e.jsx("td",{className:"px-4 py-3",children:ie(t.status)}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>i(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded",title:s("common.view"),children:e.jsx(Fe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>le(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-amber-600 hover:bg-amber-50 dark:hover:bg-amber-900/30 rounded",title:s("common.edit"),children:e.jsx(Me,{className:"w-4 h-4"})}),t.status!=="closed"&&e.jsx("button",{onClick:()=>Se(t),className:"p-1.5 text-gray-500 dark:text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 rounded",title:s("sor.markClosed"),children:e.jsx(K,{className:"w-4 h-4"})})]})})]},t.id))})]})})}),w&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"sticky top-0 z-[200] bg-white dark:bg-gray-800 border-b dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold dark:text-gray-100",children:s(R?"sor.editReport":"sor.newReport")}),e.jsx("button",{onClick:()=>{g(!1),j()},className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full dark:text-gray-300",children:e.jsx(ee,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:Ne,className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[s("sor.project")," *"]}),e.jsxs("select",{value:c.project_id,onChange:t=>y("project_id",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:s("sor.selectProject")}),h.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.company")}),e.jsx(ue,{value:c.company,onChange:t=>y("company",t),suggestions:$,placeholder:"SGTM, Sous-traitant...",defaultValue:"SGTM",icon:e.jsx(Oe,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Te,{className:"w-4 h-4"}),s("sor.date")," *"]}),e.jsx(Y,{value:c.observation_date,onChange:t=>y("observation_date",t),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(be,{className:"w-4 h-4"}),s("sor.time")]}),e.jsx(te,{value:c.observation_time,onChange:t=>y("observation_time",t)})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(Ie,{className:"w-4 h-4"}),s("sor.zone")]}),e.jsx(ue,{value:c.zone,onChange:t=>y("zone",t),suggestions:N,placeholder:s("sor.zonePlaceholder")||"Zone de travail...",disabled:!c.project_id})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 h-4"}),s("sor.supervisor")]}),e.jsx("input",{type:"text",value:c.supervisor,onChange:t=>y("supervisor",t.target.value),className:"input",placeholder:s("sor.supervisorPlaceholder")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[s("sor.nonConformity")," *"]}),e.jsx("textarea",{value:c.non_conformity,onChange:t=>y("non_conformity",t.target.value),className:"input min-h-[100px]",placeholder:s("sor.nonConformityPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(V,{className:"w-4 h-4"}),s("sor.photo")]}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-hse-primary hover:bg-hse-primary/5 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:fe,className:"hidden"}),oe?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:oe,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:s("sor.changePhoto")})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(V,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[s("sor.category")," *"]}),e.jsxs("select",{value:c.category,onChange:t=>y("category",t.target.value),className:"input",required:!0,children:[e.jsx("option",{value:"",children:s("sor.selectCategory")}),Object.entries(W).map(([t,r])=>e.jsx("option",{value:t,children:r},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.responsiblePerson")}),e.jsx("input",{type:"text",value:c.responsible_person,onChange:t=>y("responsible_person",t.target.value),className:"input",placeholder:s("sor.responsiblePersonPlaceholder")})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{g(!1),j()},className:"btn btn-outline",children:s("common.cancel")}),e.jsx("button",{type:"submit",disabled:x,className:"btn btn-primary flex items-center gap-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4 animate-spin"}),s("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-4 h-4"}),s(R?"common.update":"common.submit")]})})]})]})]})}),a&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"sticky top-0 z-[200] bg-white dark:bg-gray-800 border-b dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold dark:text-gray-100",children:s("sor.viewReport")}),e.jsx("button",{onClick:()=>i(null),className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full dark:text-gray-300",children:e.jsx(ee,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:s("sor.status.label")}),ie(a.status)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.project")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:a.project?.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.company")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:a.company||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.date")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:new Date(a.observation_date).toLocaleDateString("fr-FR")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.time")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:a.observation_time||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.zone")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:a.zone||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.supervisor")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:a.supervisor||"-"})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.category")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:W[a.category]||a.category})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.nonConformity")}),e.jsx("p",{className:"font-medium bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-3 rounded-lg",children:a.non_conformity})]}),a.photo_url&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.photo")}),e.jsx("img",{src:a.photo_url.replace(/^https?:\/\/[^\/]+/,""),alt:"Non-conformity",className:"mt-2 rounded-lg max-h-64 object-contain border dark:border-gray-600 cursor-pointer hover:opacity-90",onClick:()=>window.open(a.photo_url.replace(/^https?:\/\/[^\/]+/,""),"_blank")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:s("sor.responsiblePerson")}),e.jsx("p",{className:"font-medium dark:text-gray-100",children:a.responsible_person||"-"})]}),a.corrective_action&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4",children:[e.jsx("span",{className:"text-green-700 dark:text-green-400 text-sm font-medium",children:s("sor.correctiveAction")}),e.jsx("p",{className:"font-medium text-green-800 dark:text-green-200 mt-1",children:a.corrective_action}),a.corrective_action_date&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-2",children:[s("sor.correctiveDate"),": ",new Date(a.corrective_action_date).toLocaleDateString("fr-FR"),a.corrective_action_time&&` à ${a.corrective_action_time}`]}),a.closer_name&&e.jsxs("p",{className:"text-sm text-green-600 dark:text-green-400 mt-1",children:[s("sor.closedBy"),": ",e.jsx("span",{className:"font-medium",children:a.closer_name})]}),a.corrective_action_photo_url&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:a.corrective_action_photo_url.replace(/^https?:\/\/[^\/]+/,""),alt:"Corrective action",className:"rounded-lg max-h-48 object-contain border border-green-200 dark:border-green-700 cursor-pointer hover:opacity-90",onClick:()=>window.open(a.corrective_action_photo_url.replace(/^https?:\/\/[^\/]+/,""),"_blank")})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-gray-700",children:[e.jsx("button",{onClick:()=>i(null),className:"btn btn-outline",children:s("common.close")}),e.jsx("button",{onClick:()=>{le(a),i(null)},className:"btn btn-primary",children:s("common.edit")})]})]})]})}),D&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-2xl w-full max-w-lg",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-amber-100 dark:bg-amber-900/50 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(pe,{className:"w-8 h-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h2",{className:"text-xl font-bold mb-2 dark:text-gray-100",children:s("sor.correctivePromptTitle")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:s("sor.correctivePromptMessage")})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.correctiveDate")}),e.jsx(Y,{value:u.corrective_action_date,onChange:t=>k(r=>({...r,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.correctiveTime")}),e.jsx(te,{value:u.corrective_action_time,onChange:t=>k(r=>({...r,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[s("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:u.corrective_action,onChange:t=>k(r=>({...r,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:s("sor.correctiveActionPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:ce,className:"hidden"}),B?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:B,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:s("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:s("sor.uploadPhoto")})]})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{_(!1),v(),j()},className:"btn btn-outline flex-1",disabled:x,children:s("common.cancel")}),e.jsxs("button",{onClick:we,className:"btn bg-amber-500 hover:bg-amber-600 text-white flex-1 flex items-center justify-center gap-2",disabled:x,children:[x?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(ge,{className:"w-4 h-4"}),s("sor.submitLater")]}),e.jsxs("button",{onClick:ke,className:"btn btn-primary flex-1 flex items-center justify-center gap-2",disabled:x||!u.corrective_action,children:[x?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx(K,{className:"w-4 h-4"}),s("sor.submitAndClose")]})]})]})})}),J&&C&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl w-full max-w-lg",children:[e.jsxs("div",{className:"sticky top-0 z-[200] bg-white dark:bg-gray-800 border-b dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold dark:text-gray-100",children:s("sor.addCorrectiveTitle")}),e.jsx("button",{onClick:()=>{z(!1),v(),A(null)},className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full dark:text-gray-300",children:e.jsx(ee,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-500 dark:text-gray-400 mb-2",children:s("sor.problemSummary")}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[s("sor.project"),":"]})," ",C.project?.name]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[s("sor.date"),":"]})," ",new Date(C.observation_date).toLocaleDateString("fr-FR")]}),e.jsxs("p",{className:"text-sm dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[s("sor.category"),":"]})," ",W[C.category]||C.category]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-400 mt-2",children:C.non_conformity})]})]}),e.jsxs("form",{onSubmit:_e,className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.correctiveDate")}),e.jsx(Y,{value:u.corrective_action_date,onChange:t=>k(r=>({...r,corrective_action_date:t}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.correctiveTime")}),e.jsx(te,{value:u.corrective_action_time,onChange:t=>k(r=>({...r,corrective_action_time:t}))})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[s("sor.correctiveAction")," *"]}),e.jsx("textarea",{value:u.corrective_action,onChange:t=>k(r=>({...r,corrective_action:t.target.value})),className:"input min-h-[80px]",placeholder:s("sor.correctiveActionPlaceholder"),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("sor.correctivePhoto")}),e.jsxs("label",{className:"flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 cursor-pointer hover:border-hse-primary transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:ce,className:"hidden"}),B?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:B,alt:"Preview",className:"w-12 h-12 object-cover rounded"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:s("sor.changePhoto")})]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"w-5 h-5 text-gray-400 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:s("sor.uploadPhoto")})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{z(!1),v(),A(null)},className:"btn btn-outline",children:s("common.cancel")}),e.jsx("button",{type:"submit",disabled:x,className:"btn btn-primary flex items-center gap-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4 animate-spin"}),s("common.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-4 h-4"}),s("sor.submitAndClose")]})})]})]})]})})]})}export{Ke as default};

import{a as te,u as re,k as C,j as e,p as le,f as ne}from"./index.js";import{r as n}from"./vendor-react.js";import{u as ie}from"./projectStore.js";import{M as de}from"./Modal.js";import{D as O}from"./DatePicker.js";import{C as ce}from"./ConfirmDialog.js";import{S as y}from"./Select.js";import{D as oe}from"./DailyKpiPreview.js";import{s as xe,g as me}from"./projectList.js";import{z as u,a5 as ue,e as U,a4 as H,y as V,ac as $,af as J,s as he,X as ge,o as je,p as pe}from"./vendor-ui.js";import"./vendor-utils.js";function De(){const{t:x}=te(),{user:f}=re(),[m,z]=n.useState([]),{projects:P,fetchProjects:D}=ie(),[q,F]=n.useState(!0),[r,h]=n.useState({project_id:"",pole:"",status:"",year:new Date().getFullYear()}),[d,B]=n.useState({current_page:1,last_page:1}),[a,g]=n.useState(null),[G,b]=n.useState([]),[X,A]=n.useState(!1),[v,N]=n.useState(null),[c,Y]=n.useState(""),[o,Q]=n.useState(""),[W,R]=n.useState(!1),E=f?.project_list_preference??"code",_=n.useMemo(()=>xe(P,E),[P,E]),[Z,L]=n.useState([]);n.useEffect(()=>{(async()=>{try{const t=await le.getPoles(),i=t.data?.data?.poles??t.data?.poles??[];L(Array.isArray(i)?i:[])}catch{L([])}})()},[]);const ee=n.useMemo(()=>{const s=Array.isArray(_)?_:[];return r.pole?s.filter(t=>t?.pole===r.pole):s},[_,r.pole]);n.useEffect(()=>{D({per_page:100}).catch(()=>{})},[D]),n.useEffect(()=>{j()},[r]);const j=async(s=1)=>{try{F(!0);const t=await C.getAll({page:s,...r,per_page:10});z(t.data.data||[]),B(t.data.meta||{current_page:1,last_page:1})}catch{u.error("Failed to load reports")}finally{F(!1)}},T=async s=>{A(!0),g(s),b([]);try{const i=(await C.getById(s.id)).data.data;g(i.report||i),b(i.daily_snapshots||[])}catch(t){console.error("Failed to load report details:",t)}finally{A(!1)}},I=s=>{if(s.status!=="draft"){u.error("Only draft reports can be deleted");return}N(s)},se=async()=>{if(v)try{await C.delete(v.id),u.success("Report deleted successfully"),j()}catch{u.error("Failed to delete report")}finally{N(null)}},k=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],M={draft:e.jsx(U,{className:"w-4 h-4 text-gray-500"}),submitted:e.jsx(pe,{className:"w-4 h-4 text-amber-500"}),approved:e.jsx(je,{className:"w-4 h-4 text-green-500"}),rejected:e.jsx(ge,{className:"w-4 h-4 text-red-500"})},w={draft:"badge-info",submitted:"badge-warning",approved:"badge-success",rejected:"badge-danger"},p=n.useMemo(()=>Array.isArray(m)?!c&&!o?m:m.filter(s=>{let t="";if(s.start_date)t=s.start_date.substring(0,10);else if(s.created_at){const i=new Date(s.created_at);Number.isNaN(i.getTime())||(t=i.toISOString().substring(0,10))}return!(c&&(!t||t<c)||o&&(!t||t>o))}):[],[m,c,o]),ae=async()=>{try{R(!0);const s={project_id:r.project_id?r.project_id:void 0,status:r.status?r.status:void 0,year:r.year?r.year:void 0};c&&(s.from_date=c),o&&(s.to_date=o);const t=await ne.exportKpiHistory(s),i=new Blob([t.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),K=window.URL.createObjectURL(i),S=document.createElement("a");S.href=K,S.download=`kpi_history_${r.year}.xlsx`,S.click(),window.URL.revokeObjectURL(K)}catch(s){console.error("Error exporting KPI history:",s),u.error("Failed to export reports")}finally{R(!1)}};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[x("nav.dashboard")," / ",x("kpi.history")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:x("kpi.history")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"View and manage your submitted KPI reports"})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row flex-wrap gap-4",children:[e.jsx("div",{className:"w-44",children:e.jsxs(y,{value:r.pole,onChange:s=>h({...r,pole:s.target.value,project_id:""}),children:[e.jsx("option",{value:"",children:"All Poles"}),Z.map(s=>e.jsx("option",{value:s,children:s},s))]})}),e.jsx("div",{className:"flex-1 min-w-[180px]",children:e.jsxs(y,{value:r.project_id,onChange:s=>h({...r,project_id:s.target.value}),children:[e.jsx("option",{value:"",children:"All Projects"}),ee.map(s=>e.jsx("option",{value:s.id,children:me(s)},s.id))]})}),e.jsx("div",{className:"w-40",children:e.jsxs(y,{value:r.status,onChange:s=>h({...r,status:s.target.value}),children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"submitted",children:"Submitted"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"rejected",children:"Rejected"})]})}),e.jsx("div",{className:"w-32",children:e.jsx(y,{value:r.year,onChange:s=>h({...r,year:s.target.value}),children:[...Array(5)].map((s,t)=>{const i=new Date().getFullYear()-t;return e.jsx("option",{value:i,children:i},i)})})}),e.jsx("div",{className:"w-40",children:e.jsx(O,{value:c,onChange:s=>Y(s),placeholder:"From date"})}),e.jsx("div",{className:"w-40",children:e.jsx(O,{value:o,onChange:s=>Q(s),placeholder:"To date"})}),e.jsxs("button",{type:"button",onClick:ae,disabled:W||p.length===0,className:"btn-secondary flex items-center gap-2 text-sm",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx("span",{children:x("dashboard.exportExcel")})]})]})}),e.jsxs("div",{className:"card",children:[q?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("div",{className:"hidden md:block space-y-2 animate-pulse",children:Array.from({length:5},(s,t)=>e.jsx("div",{className:"h-10 rounded-md bg-gray-100 dark:bg-gray-800"},t))}),e.jsx("div",{className:"md:hidden space-y-3 animate-pulse",children:Array.from({length:3},(s,t)=>e.jsx("div",{className:"h-24 rounded-lg bg-gray-100 dark:bg-gray-800"},t))})]}):p.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx(U,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2",children:"No reports found"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Try adjusting your filters or submit a new KPI report."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:p.map(s=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.project?.name||"Unknown"}),s.project?.code&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.project.code}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-gray-600 dark:text-gray-300",children:[e.jsx(H,{className:"w-3 h-3 text-gray-400"}),e.jsxs("span",{children:[k[s.report_month-1]," ",s.report_year]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[M[s.status],e.jsx("span",{className:`badge ${w[s.status]}`,children:s.status})]}),e.jsxs("div",{className:"mt-1 flex flex-wrap gap-1 justify-end text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{className:s.accidents>0?"text-red-600 dark:text-red-400 font-semibold":"text-green-600",children:[s.accidents," acc."]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300",children:[s.trainings_conducted," tr."]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300",children:[s.inspections_completed," insp."]})]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>T(s),className:"inline-flex items-center gap-1 text-xs text-hse-primary hover:underline",title:"View Details",children:[e.jsx(V,{className:"w-4 h-4"}),e.jsx("span",{children:"View details"})]}),s.status==="draft"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700",title:"Edit",children:e.jsx($,{className:"w-4 h-4 text-gray-600 dark:text-gray-300"})}),e.jsx("button",{onClick:()=>I(s),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:"Delete",children:e.jsx(J,{className:"w-4 h-4 text-red-600"})})]})]})]},s.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"table w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Project"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Accidents"}),e.jsx("th",{children:"Trainings"}),e.jsx("th",{children:"Inspections"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:p.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.project?.name||"Unknown"}),e.jsx("p",{className:"text-xs text-gray-500",children:s.project?.code})]})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{children:[k[s.report_month-1]," ",s.report_year]})]})}),e.jsx("td",{children:e.jsx("span",{className:s.accidents>0?"text-red-600 font-semibold":"text-green-600",children:s.accidents})}),e.jsx("td",{children:s.trainings_conducted}),e.jsx("td",{children:s.inspections_completed}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[M[s.status],e.jsx("span",{className:`badge ${w[s.status]}`,children:s.status})]})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>T(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:"View Details",children:e.jsx(V,{className:"w-4 h-4 text-gray-600"})}),s.status==="draft"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"p-2 hover:bg-gray-100 rounded-lg",title:"Edit",children:e.jsx($,{className:"w-4 h-4 text-gray-600"})}),e.jsx("button",{onClick:()=>I(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:"Delete",children:e.jsx(J,{className:"w-4 h-4 text-red-600"})})]})]})})]},s.id))})]})})]}),d.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-gray-100",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Page ",d.current_page," of ",d.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>j(d.current_page-1),disabled:d.current_page===1,className:"btn-secondary text-sm",children:"Previous"}),e.jsx("button",{onClick:()=>j(d.current_page+1),disabled:d.current_page===d.last_page,className:"btn-secondary text-sm",children:"Next"})]})]})]}),e.jsx(de,{isOpen:!!a,onClose:()=>g(null),title:a?.project?.name||"Détails du rapport",size:"lg",children:a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[k[a.report_month-1]," ",a.report_year]}),e.jsx("span",{className:`badge ${w[a.status]}`,children:a.status})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs d'accidents"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:[e.jsx(l,{label:"Total",value:a.accidents,danger:a.accidents>0}),e.jsx(l,{label:"Mortels",value:a.accidents_fatal,danger:a.accidents_fatal>0}),e.jsx(l,{label:"Graves",value:a.accidents_serious}),e.jsx(l,{label:"Mineurs",value:a.accidents_minor}),e.jsx(l,{label:"Presqu'accidents",value:a.near_misses}),e.jsx(l,{label:"Premiers soins",value:a.first_aid_cases})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs de formation"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:[e.jsx(l,{label:"Réalisées",value:a.trainings_conducted}),e.jsx(l,{label:"Planifiées",value:a.trainings_planned}),e.jsx(l,{label:"Employés",value:a.employees_trained}),e.jsx(l,{label:"Heures",value:a.training_hours}),e.jsx(l,{label:"Sensibilisations",value:a.toolbox_talks})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs d'inspection"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[e.jsx(l,{label:"Réalisées",value:a.inspections_completed}),e.jsx(l,{label:"Planifiées",value:a.inspections_planned}),e.jsx(l,{label:"Écarts ouverts",value:a.findings_open}),e.jsx(l,{label:"Écarts fermés",value:a.findings_closed})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Taux de sécurité"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(l,{label:"TF",value:Number(a.tf_value).toFixed(4)}),e.jsx(l,{label:"TG",value:Number(a.tg_value).toFixed(4)}),e.jsx(l,{label:"Heures travaillées",value:Number(a.hours_worked).toLocaleString()}),e.jsx(l,{label:"Jours perdus",value:a.lost_workdays})]})]}),a.notes&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-2",children:"Notes"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg",children:a.notes})]}),X?e.jsxs("div",{className:"flex items-center justify-center py-4",children:[e.jsx(he,{className:"w-5 h-5 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-sm text-gray-500",children:"Chargement des données journalières..."})]}):e.jsx(oe,{dailySnapshots:G}),e.jsx("div",{className:"pt-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{onClick:()=>{g(null),b([])},className:"btn-secondary w-full",children:"Fermer"})})]})}),e.jsx(ce,{isOpen:!!v,title:"Confirm deletion",message:"Are you sure you want to delete this report?",confirmLabel:"Delete",cancelLabel:"Cancel",variant:"danger",onConfirm:se,onCancel:()=>N(null)})]})}function l({label:x,value:f,danger:m=!1}){return e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:x}),e.jsx("p",{className:`text-lg font-semibold ${m?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-gray-100"}`,children:f})]})}export{De as default};

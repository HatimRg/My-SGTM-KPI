import{a as re,u as le,k as S,j as e,p as ie,g as ne}from"./index.js";import{r as n}from"./vendor-react.js";import{u as de}from"./projectStore.js";import{M as ce}from"./Modal.js";import{D as K}from"./DatePicker.js";import{C as oe}from"./ConfirmDialog.js";import{S as y}from"./Select.js";import{D as xe}from"./DailyKpiPreview.js";import{s as me,g as ue}from"./projectList.js";import{g as U}from"./weekHelper.js";import{z as u,a9 as he,h as H,a8 as O,I as V,ag as q,aj as z,v as ge,X as je,q as pe,s as ye}from"./vendor-ui.js";import"./vendor-utils.js";function Re(){const{t:r}=re(),{user:f}=le(),[m,B]=n.useState([]),{projects:C,fetchProjects:D}=de(),[G,F]=n.useState(!0),[l,h]=n.useState({project_id:"",pole:"",status:"",year:U().year}),[c,W]=n.useState({current_page:1,last_page:1}),[a,g]=n.useState(null),[X,b]=n.useState([]),[J,R]=n.useState(!1),[v,N]=n.useState(null),[o,Y]=n.useState(""),[x,Q]=n.useState(""),[Z,A]=n.useState(!1),E=f?.project_list_preference??"code",k=n.useMemo(()=>me(C,E),[C,E]),[ee,L]=n.useState([]);n.useEffect(()=>{(async()=>{try{const t=await ie.getPoles(),d=t.data?.data?.poles??t.data?.poles??[];L(Array.isArray(d)?d:[])}catch{L([])}})()},[]);const se=n.useMemo(()=>{const s=Array.isArray(k)?k:[];return l.pole?s.filter(t=>t?.pole===l.pole):s},[k,l.pole]);n.useEffect(()=>{D({per_page:100}).catch(()=>{})},[D]),n.useEffect(()=>{j()},[l]);const j=async(s=1)=>{try{F(!0);const t=await S.getAll({page:s,...l,per_page:10});B(t.data.data||[]),W(t.data.meta||{current_page:1,last_page:1})}catch{u.error(r("kpi.historyPage.loadFailed"))}finally{F(!1)}},T=async s=>{R(!0),g(s),b([]);try{const d=(await S.getById(s.id)).data.data;g(d.report||d),b(d.daily_snapshots||[])}catch(t){console.error("Failed to load report details:",t)}finally{R(!1)}},I=s=>{if(s.status!=="draft"){u.error(r("kpi.historyPage.onlyDraftDeletable"));return}N(s)},ae=async()=>{if(v)try{await S.delete(v.id),u.success(r("kpi.historyPage.deleteSuccess")),j()}catch{u.error(r("errors.failedToDelete"))}finally{N(null)}},w=s=>s?.week_number?r("dashboard.weekLabel",{week:s.week_number,year:s.report_year}):s?.report_month&&s?.report_year?`${s.report_month}/${s.report_year}`:"",M={draft:e.jsx(H,{className:"w-4 h-4 text-gray-500"}),submitted:e.jsx(ye,{className:"w-4 h-4 text-amber-500"}),approved:e.jsx(pe,{className:"w-4 h-4 text-green-500"}),rejected:e.jsx(je,{className:"w-4 h-4 text-red-500"})},_={draft:"badge-info",submitted:"badge-warning",approved:"badge-success",rejected:"badge-danger"},p=n.useMemo(()=>Array.isArray(m)?!o&&!x?m:m.filter(s=>{let t="";if(s.start_date)t=s.start_date.substring(0,10);else if(s.created_at){const d=new Date(s.created_at);Number.isNaN(d.getTime())||(t=d.toISOString().substring(0,10))}return!(o&&(!t||t<o)||x&&(!t||t>x))}):[],[m,o,x]),te=async()=>{try{A(!0);const s={project_id:l.project_id?l.project_id:void 0,status:l.status?l.status:void 0,year:l.year?l.year:void 0};o&&(s.from_date=o),x&&(s.to_date=x);const t=await ne.exportKpiHistory(s),d=new Blob([t.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),$=window.URL.createObjectURL(d),P=document.createElement("a");P.href=$,P.download=`kpi_history_${l.year}.xlsx`,P.click(),window.URL.revokeObjectURL($)}catch(s){console.error("Error exporting KPI history:",s),u.error(r("kpi.historyPage.exportFailed"))}finally{A(!1)}};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[r("nav.dashboard")," / ",r("kpi.history")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:r("kpi.history")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:r("kpi.historyPage.subtitle")})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row flex-wrap gap-4",children:[e.jsx("div",{className:"w-full sm:w-44",children:e.jsxs(y,{value:l.pole,onChange:s=>h({...l,pole:s.target.value,project_id:""}),children:[e.jsx("option",{value:"",children:r("common.allPoles")}),ee.map(s=>e.jsx("option",{value:s,children:s},s))]})}),e.jsx("div",{className:"w-full sm:flex-1 sm:min-w-[180px]",children:e.jsxs(y,{value:l.project_id,onChange:s=>h({...l,project_id:s.target.value}),children:[e.jsx("option",{value:"",children:r("common.allProjects")}),se.map(s=>e.jsx("option",{value:s.id,children:ue(s)},s.id))]})}),e.jsx("div",{className:"w-full sm:w-40",children:e.jsxs(y,{value:l.status,onChange:s=>h({...l,status:s.target.value}),children:[e.jsx("option",{value:"",children:r("common.all")}),e.jsx("option",{value:"draft",children:r("kpi.status.draft")}),e.jsx("option",{value:"submitted",children:r("kpi.status.submitted")}),e.jsx("option",{value:"approved",children:r("kpi.status.approved")}),e.jsx("option",{value:"rejected",children:r("kpi.status.rejected")})]})}),e.jsx("div",{className:"w-full sm:w-32",children:e.jsx(y,{value:l.year,onChange:s=>h({...l,year:s.target.value}),children:[...Array(6)].map((s,t)=>{const d=U().year+1-t;return e.jsx("option",{value:d,children:d},d)})})}),e.jsx("div",{className:"w-full sm:w-40",children:e.jsx(K,{value:o,onChange:s=>Y(s),placeholder:"From date"})}),e.jsx("div",{className:"w-full sm:w-40",children:e.jsx(K,{value:x,onChange:s=>Q(s),placeholder:"To date"})}),e.jsxs("button",{type:"button",onClick:te,disabled:Z||p.length===0,className:"btn-secondary flex items-center justify-center gap-2 text-sm w-full sm:w-auto",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:r("dashboard.exportExcel")})]})]})}),e.jsxs("div",{className:"card",children:[G?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("div",{className:"hidden md:block space-y-2 animate-pulse",children:Array.from({length:5},(s,t)=>e.jsx("div",{className:"h-10 rounded-md bg-gray-100 dark:bg-gray-800"},t))}),e.jsx("div",{className:"md:hidden space-y-3 animate-pulse",children:Array.from({length:3},(s,t)=>e.jsx("div",{className:"h-24 rounded-lg bg-gray-100 dark:bg-gray-800"},t))})]}):p.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx(H,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2",children:"No reports found"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Try adjusting your filters or submit a new KPI report."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:p.map(s=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.project?.name||"Unknown"}),s.project?.code&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.project.code}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-gray-600 dark:text-gray-300",children:[e.jsx(O,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{children:w(s)})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[M[s.status],e.jsx("span",{className:`badge ${_[s.status]}`,children:s.status})]}),e.jsxs("div",{className:"mt-1 flex flex-wrap gap-1 justify-end text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{className:s.accidents>0?"text-red-600 dark:text-red-400 font-semibold":"text-green-600",children:[s.accidents," acc."]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300",children:[s.trainings_conducted," tr."]}),e.jsxs("span",{className:"px-1.5 py-0.5 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300",children:[s.inspections_completed," insp."]})]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>T(s),className:"inline-flex items-center gap-1 text-xs text-hse-primary hover:underline",title:"View Details",children:[e.jsx(V,{className:"w-4 h-4"}),e.jsx("span",{children:"View details"})]}),s.status==="draft"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700",title:"Edit",children:e.jsx(q,{className:"w-4 h-4 text-gray-600 dark:text-gray-300"})}),e.jsx("button",{onClick:()=>I(s),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:"Delete",children:e.jsx(z,{className:"w-4 h-4 text-red-600"})})]})]})]},s.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"table w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Project"}),e.jsx("th",{children:"Week / Year"}),e.jsx("th",{children:"Accidents"}),e.jsx("th",{children:"Trainings"}),e.jsx("th",{children:"Inspections"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:p.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.project?.name||"Unknown"}),e.jsx("p",{className:"text-xs text-gray-500",children:s.project?.code})]})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{children:w(s)})]})}),e.jsx("td",{children:e.jsx("span",{className:s.accidents>0?"text-red-600 font-semibold":"text-green-600",children:s.accidents})}),e.jsx("td",{children:s.trainings_conducted}),e.jsx("td",{children:s.inspections_completed}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[M[s.status],e.jsx("span",{className:`badge ${_[s.status]}`,children:s.status})]})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>T(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:"View Details",children:e.jsx(V,{className:"w-4 h-4 text-gray-600"})}),s.status==="draft"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"p-2 hover:bg-gray-100 rounded-lg",title:"Edit",children:e.jsx(q,{className:"w-4 h-4 text-gray-600"})}),e.jsx("button",{onClick:()=>I(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:"Delete",children:e.jsx(z,{className:"w-4 h-4 text-red-600"})})]})]})})]},s.id))})]})})]}),c.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-gray-100",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Page ",c.current_page," of ",c.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>j(c.current_page-1),disabled:c.current_page===1,className:"btn-secondary text-sm",children:"Previous"}),e.jsx("button",{onClick:()=>j(c.current_page+1),disabled:c.current_page===c.last_page,className:"btn-secondary text-sm",children:"Next"})]})]})]}),e.jsx(ce,{isOpen:!!a,onClose:()=>g(null),title:a?.project?.name||"Détails du rapport",size:"lg",children:a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:w(a)}),e.jsx("span",{className:`badge ${_[a.status]}`,children:a.status})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs d'accidents"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:[e.jsx(i,{label:"Total",value:a.accidents,danger:a.accidents>0}),e.jsx(i,{label:"Mortels",value:a.accidents_fatal,danger:a.accidents_fatal>0}),e.jsx(i,{label:"Graves",value:a.accidents_serious}),e.jsx(i,{label:"Mineurs",value:a.accidents_minor}),e.jsx(i,{label:"Presqu'accidents",value:a.near_misses}),e.jsx(i,{label:"Premiers soins",value:a.first_aid_cases})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs de formation"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:[e.jsx(i,{label:"Réalisées",value:a.trainings_conducted}),e.jsx(i,{label:"Planifiées",value:a.trainings_planned}),e.jsx(i,{label:"Employés",value:a.employees_trained}),e.jsx(i,{label:"Heures",value:a.training_hours}),e.jsx(i,{label:"Sensibilisations",value:a.toolbox_talks})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Indicateurs d'inspection"}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[e.jsx(i,{label:"Réalisées",value:a.inspections_completed}),e.jsx(i,{label:"Planifiées",value:a.inspections_planned}),e.jsx(i,{label:"Écarts ouverts",value:a.findings_open}),e.jsx(i,{label:"Écarts fermés",value:a.findings_closed})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Taux de sécurité"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(i,{label:"TF",value:Number(a.tf_value).toFixed(4)}),e.jsx(i,{label:"TG",value:Number(a.tg_value).toFixed(4)}),e.jsx(i,{label:"Heures travaillées",value:Number(a.hours_worked).toLocaleString()}),e.jsx(i,{label:"Jours perdus",value:a.lost_workdays})]})]}),a.notes&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-2",children:"Notes"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg",children:a.notes})]}),J?e.jsxs("div",{className:"flex items-center justify-center py-4",children:[e.jsx(ge,{className:"w-5 h-5 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-sm text-gray-500",children:"Chargement des données journalières..."})]}):e.jsx(xe,{dailySnapshots:X}),e.jsx("div",{className:"pt-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{onClick:()=>{g(null),b([])},className:"btn-secondary w-full",children:"Fermer"})})]})}),e.jsx(oe,{isOpen:!!v,title:"Confirm deletion",message:"Are you sure you want to delete this report?",confirmLabel:"Delete",cancelLabel:"Cancel",variant:"danger",onConfirm:ae,onCancel:()=>N(null)})]})}function i({label:r,value:f,danger:m=!1}){return e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:r}),e.jsx("p",{className:`text-lg font-semibold ${m?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-gray-100"}`,children:f})]})}export{Re as default};

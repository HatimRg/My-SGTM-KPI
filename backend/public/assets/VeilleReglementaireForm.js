import{a as ce,u as oe,j as e,p as le,C as Q}from"./index.js";import{u as de,b as me,h as ue,r as n}from"./vendor-react.js";import{S as L}from"./Select.js";import{h as ge,J as pe,v as Z,aw as xe,q as be,X as ye,z as v}from"./vendor-ui.js";import{m as ee,S as te,a as _,f as he,c as fe}from"./veilleReglementaireSchema.js";import{s as je,g as Ne}from"./projectList.js";import"./vendor-utils.js";const ve=o=>{const s=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate())),u=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-u);const b=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-b)/864e5+1)/7)},we=o=>o.startsWith("/admin/regulatory-watch")?"/admin/regulatory-watch":o.startsWith("/supervisor/regulatory-watch")?"/supervisor/regulatory-watch":"/regulatory-watch",ke=o=>{const s=Array.isArray(o?.articles)?o.articles:[];let u=0,b=0;for(const w of s)w?.applicable&&(u+=1,w?.compliant&&(b+=1));const p=u>0?Math.round(b/u*1e4)/100:null;return{totalApplicable:u,totalConforme:b,score:p}};function $e({mode:o}){const{t:s,language:u}=ce(),{user:b}=oe(),p=de(),w=me(),y=ue(),h=n.useMemo(()=>we(w.pathname),[w.pathname]),[F,E]=n.useState([]),[O,U]=n.useState(!0),[k,Y]=n.useState(""),B=b?.project_list_preference??"code",re=n.useMemo(()=>je(F,B),[F,B]),[f,z]=n.useState(o==="resubmit"),[M,R]=n.useState(!1),[g,q]=n.useState(()=>ee()),[S,se]=n.useState(0),A=n.useMemo(()=>{const t=y?.page,r=Number.parseInt(String(t??"1"),10);return!Number.isFinite(r)||r<1?1:r},[y?.page]),P=n.useMemo(()=>o==="resubmit"?y?.id?`${h}/${y.id}/resubmit`:`${h}/resubmit`:`${h}/new`,[h,o,y?.id]),[I,V]=n.useState(()=>new Date().getFullYear()),[T,X]=n.useState(()=>ve(new Date));n.useEffect(()=>{(async()=>{try{U(!0);const r=await le.getAllList({status:"active"});E(Array.isArray(r)?r:[])}catch(r){E([]),v.error(r.response?.data?.message??s("errors.somethingWentWrong"))}finally{U(!1)}})()},[]),n.useEffect(()=>{(async()=>{if(o!=="resubmit")return;const r=y?.id;if(r)try{z(!0);const l=(await Q.getById(r)).data?.data??null,d=l?.project_id;d&&Y(String(d)),l?.week_year&&V(Number(l.week_year)),l?.week_number&&X(Number(l.week_number));const i=l?.answers?.sections??[],c=(Array.isArray(i)?i:[]).flatMap(m=>Array.isArray(m?.articles)?m.articles:[]).filter(m=>m&&m.applicable===!1).map(m=>String(m.article_id));q(ee({previousNonApplicableArticleIds:c}))}catch(a){v.error(a.response?.data?.message??s("errors.somethingWentWrong"))}finally{z(!1)}})()},[o,y?.id]);const H=n.useMemo(()=>(Array.isArray(g?.sections)?g.sections:[]).map(r=>({section_id:r.section_id,...ke(r)})),[g]),J=n.useMemo(()=>{const t=H.map(r=>r.score).filter(r=>typeof r=="number"&&Number.isFinite(r));return t.length===0?null:Math.round(t.reduce((r,a)=>r+a,0)/t.length*100)/100},[H]),ae=n.useMemo(()=>{const t=Array.isArray(g?.sections)?g.sections:[],r=new Map;for(let a=0;a<t.length;a++)r.set(String(t[a]?.section_id),a);return r},[g]),C=te.length;n.useEffect(()=>{const t=Math.min(Math.max(1,A),C);if(t!==A){p(`${P}/${t}`,{replace:!0});return}se(t-1)},[A,p,C,P]);const j=n.useMemo(()=>te[S]??null,[S]),ne=n.useMemo(()=>{const t=Array.isArray(g?.sections)?g.sections:[],r=new Map;for(const a of t){const l=new Map,d=Array.isArray(a?.articles)?a.articles:[];for(let i=0;i<d.length;i++)l.set(String(d[i]?.article_id),i);r.set(String(a?.section_id),l)}return r},[g]),N=(t,r,a)=>{q(l=>{const d={...l},i=Array.isArray(d.sections)?[...d.sections]:[],c={...i[t]??{}},m=Array.isArray(c.articles)?[...c.articles]:[],$={...m[r]??{}},x={...$,...a};return Object.prototype.hasOwnProperty.call(a,"applicable")&&a.applicable===!1&&(x.compliant=!1,x.corrective_action="",x.comment=""),Object.prototype.hasOwnProperty.call(a,"applicable")&&a.applicable===!0&&$.applicable===!1&&(x.compliant=!0),Object.prototype.hasOwnProperty.call(a,"compliant")&&a.compliant===!0&&(x.corrective_action=""),m[r]=x,c.articles=m,i[t]=c,d.sections=i,d})},G=async()=>{if(!k){v.error(s("regulatoryWatch.projectRequired"));return}if(!I||!T){v.error(s("errors.somethingWentWrong"));return}try{R(!0);const t={project_id:Number(k),week_year:Number(I),week_number:Number(T),schema_version:fe,answers:g},r=await Q.submit(t);v.success(s("regulatoryWatch.submitSuccess"));const a=r.data?.data;if(a?.id){p(`${h}/${a.id}`);return}p(h)}catch(t){v.error(t.response?.data?.message??s("errors.somethingWentWrong"))}finally{R(!1)}},ie=()=>{const t=Math.max(1,A-1);p(`${P}/${t}`)},K=()=>{const t=Math.min(C,A+1);p(`${P}/${t}`)},W=S>=C-1;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 flex-col sm:flex-row",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:e.jsx(ge,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s(o==="resubmit"?"regulatoryWatch.resubmitTitle":"regulatoryWatch.newTitle")}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s("regulatoryWatch.subtitle")})]})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsxs("button",{type:"button",className:"btn-secondary flex items-center justify-center gap-2 w-full sm:w-auto",onClick:()=>p(h),children:[e.jsx(pe,{className:"w-4 h-4"}),s("common.back")]}),e.jsxs("button",{type:"button",onClick:W?G:K,disabled:M||!k||f,className:"btn-primary flex items-center justify-center gap-2 w-full sm:w-auto",children:[M?e.jsx(Z,{className:"w-4 h-4 animate-spin"}):W?e.jsx(xe,{className:"w-4 h-4"}):null,s(W?"common.submit":"common.next")]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:s("regulatoryWatch.selectProject")}),e.jsxs(L,{value:k,onChange:t=>Y(t.target.value),disabled:O||f,children:[e.jsxs("option",{value:"",children:[s(O?"common.loading":"common.select"),"..."]}),re.map(t=>e.jsx("option",{value:String(t.id),children:Ne(t)},t.id))]})]}),e.jsxs("div",{className:"md:col-span-1 grid grid-cols-2 md:grid-cols-1 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("regulatoryWatch.week")}),e.jsx(L,{value:String(T),onChange:t=>X(Number(t.target.value)),disabled:f,children:Array.from({length:53},(t,r)=>r+1).map(t=>e.jsx("option",{value:String(t),children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("regulatoryWatch.year")}),e.jsx(L,{value:String(I),onChange:t=>V(Number(t.target.value)),disabled:f,children:Array.from({length:6},(t,r)=>new Date().getFullYear()-2+r).map(t=>e.jsx("option",{value:String(t),children:t},t))})]})]}),e.jsx("div",{className:"md:col-span-1",children:e.jsxs("div",{className:"p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("regulatoryWatch.overallScore")}),e.jsx("div",{className:"text-lg font-bold text-gray-900 dark:text-gray-100",children:J===null?"-":`${J}%`})]})})]}),f&&e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx(Z,{className:"w-4 h-4 animate-spin"}),s("common.loading")]})]}),(()=>{if(!j)return null;const t=ae.get(String(j.section_id)),r=t!==void 0?(g?.sections??[])[t]:null,a=ne.get(String(j.section_id))??new Map;return r?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 text-sm text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{children:[s("common.page")," ",S+1," ",s("common.of")," ",C]}),e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:_(j.title,u)})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsx("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:_(j.title,u)})}),e.jsx("div",{className:"p-4 space-y-6",children:(j.chapters??[]).map(l=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:_(l.title,u)}),e.jsx("div",{className:"space-y-3",children:(l.articles??[]).map(d=>{const i=a.get(String(d.article_id)),c=i!==void 0?(r?.articles??[])[i]:null;if(!c)return null;const m=!c.applicable,$=m?"border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/40 opacity-70":"border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",x=he(_(d.text,u));return e.jsxs("div",{className:`rounded-xl border ${$} p-3`,children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:_(d.code,u)}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1 whitespace-pre-line",children:x})]}),e.jsxs("div",{className:"flex flex-col gap-2 min-w-[240px]",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>N(t,i,{applicable:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${c.applicable?"bg-hse-primary text-white border-hse-primary":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:s("regulatoryWatch.applicable")}),e.jsx("button",{type:"button",onClick:()=>N(t,i,{applicable:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${c.applicable?"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200":"bg-gray-500 text-white border-gray-500"}`,children:s("regulatoryWatch.notApplicable")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",disabled:m,onClick:()=>N(t,i,{compliant:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${c.applicable&&c.compliant?"bg-green-600 text-white border-green-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:e.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[e.jsx(be,{className:"w-4 h-4"}),s("regulatoryWatch.conforme")]})}),e.jsx("button",{type:"button",disabled:m,onClick:()=>N(t,i,{compliant:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${c.applicable&&!c.compliant?"bg-red-600 text-white border-red-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:e.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[e.jsx(ye,{className:"w-4 h-4"}),s("regulatoryWatch.nonConforme")]})})]})]})]}),c.applicable&&c.compliant===!1&&e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.correctiveAction")}),e.jsx("textarea",{value:c.corrective_action??"",onChange:D=>N(t,i,{corrective_action:D.target.value}),rows:2,className:"input"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.comment")}),e.jsx("textarea",{value:c.comment??"",onChange:D=>N(t,i,{comment:D.target.value}),rows:2,className:"input",disabled:!c.applicable})]})]},d.article_id)})})]},l.chapter_id))})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:ie,disabled:S===0||f||M,children:s("common.previous")}),e.jsx("button",{type:"button",className:"btn-primary",onClick:W?G:K,disabled:M||!k||f,children:s(W?"common.submit":"common.next")})]})]}):null})()]})}export{$e as default};

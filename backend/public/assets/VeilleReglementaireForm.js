import{a as J,j as e,p as G,C as Y}from"./index.js";import{u as K,b as Q,h as Z,r as o}from"./vendor-react.js";import{S as _}from"./Select.js";import{h as ee,J as re,v as B,aw as te,q as ae,X as se,z as h}from"./vendor-ui.js";import{m as R,S as ie,a as w,f as le,c as ne}from"./veilleReglementaireSchema.js";import"./vendor-utils.js";const oe=c=>{const a=new Date(Date.UTC(c.getFullYear(),c.getMonth(),c.getDate())),m=a.getUTCDay()||7;a.setUTCDate(a.getUTCDate()+4-m);const p=new Date(Date.UTC(a.getUTCFullYear(),0,1));return Math.ceil(((a-p)/864e5+1)/7)},ce=c=>c.startsWith("/admin/regulatory-watch")?"/admin/regulatory-watch":c.startsWith("/supervisor/regulatory-watch")?"/supervisor/regulatory-watch":"/regulatory-watch",de=c=>{const a=Array.isArray(c?.articles)?c.articles:[];let m=0,p=0;for(const f of a)f?.applicable&&(m+=1,f?.compliant&&(p+=1));const v=m>0?Math.round(p/m*1e4)/100:null;return{totalApplicable:m,totalConforme:p,score:v}};function be({mode:c}){const{t:a,language:m}=J(),p=K(),v=Q(),f=Z(),k=o.useMemo(()=>ce(v.pathname),[v.pathname]),[z,C]=o.useState([]),[M,P]=o.useState(!0),[N,I]=o.useState(""),[j,T]=o.useState(c==="resubmit"),[D,F]=o.useState(!1),[u,L]=o.useState(()=>R()),[S,O]=o.useState(()=>new Date().getFullYear()),[A,$]=o.useState(()=>oe(new Date));o.useEffect(()=>{(async()=>{try{P(!0);const t=await G.getAllList({status:"active"});C(Array.isArray(t)?t:[])}catch(t){C([]),h.error(t.response?.data?.message??a("errors.somethingWentWrong"))}finally{P(!1)}})()},[]),o.useEffect(()=>{(async()=>{if(c!=="resubmit")return;const t=f?.id;if(t)try{T(!0);const g=(await Y.getById(t)).data?.data??null,d=g?.project_id;d&&I(String(d)),g?.week_year&&O(Number(g.week_year)),g?.week_number&&$(Number(g.week_number));const l=g?.answers?.sections??[],n=(Array.isArray(l)?l:[]).flatMap(i=>Array.isArray(i?.articles)?i.articles:[]).filter(i=>i&&i.applicable===!1).map(i=>String(i.article_id));L(R({previousNonApplicableArticleIds:n}))}catch(s){h.error(s.response?.data?.message??a("errors.somethingWentWrong"))}finally{T(!1)}})()},[c,f?.id]);const E=o.useMemo(()=>(Array.isArray(u?.sections)?u.sections:[]).map(t=>({section_id:t.section_id,...de(t)})),[u]),U=o.useMemo(()=>{const r=E.map(t=>t.score).filter(t=>typeof t=="number"&&Number.isFinite(t));return r.length===0?null:Math.round(r.reduce((t,s)=>t+s,0)/r.length*100)/100},[E]),q=o.useMemo(()=>{const r=Array.isArray(u?.sections)?u.sections:[],t=new Map;for(let s=0;s<r.length;s++)t.set(String(r[s]?.section_id),s);return t},[u]),V=o.useMemo(()=>{const r=Array.isArray(u?.sections)?u.sections:[],t=new Map;for(const s of r){const g=new Map,d=Array.isArray(s?.articles)?s.articles:[];for(let l=0;l<d.length;l++)g.set(String(d[l]?.article_id),l);t.set(String(s?.section_id),g)}return t},[u]),x=(r,t,s)=>{L(g=>{const d={...g},l=Array.isArray(d.sections)?[...d.sections]:[],n={...l[r]??{}},i=Array.isArray(n.articles)?[...n.articles]:[],b={...i[t]??{}},y={...b,...s};return Object.prototype.hasOwnProperty.call(s,"applicable")&&s.applicable===!1&&(y.compliant=!1,y.corrective_action="",y.comment=""),Object.prototype.hasOwnProperty.call(s,"applicable")&&s.applicable===!0&&b.applicable===!1&&(y.compliant=!0),Object.prototype.hasOwnProperty.call(s,"compliant")&&s.compliant===!0&&(y.corrective_action=""),i[t]=y,n.articles=i,l[r]=n,d.sections=l,d})},X=async()=>{if(!N){h.error(a("regulatoryWatch.projectRequired"));return}if(!S||!A){h.error(a("errors.somethingWentWrong"));return}try{F(!0);const r={project_id:Number(N),week_year:Number(S),week_number:Number(A),schema_version:ne,answers:u},t=await Y.submit(r);h.success(a("regulatoryWatch.submitSuccess"));const s=t.data?.data;if(s?.id){p(`${k}/${s.id}`);return}p(k)}catch(r){h.error(r.response?.data?.message??a("errors.somethingWentWrong"))}finally{F(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 flex-col sm:flex-row",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:e.jsx(ee,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:a(c==="resubmit"?"regulatoryWatch.resubmitTitle":"regulatoryWatch.newTitle")}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:a("regulatoryWatch.subtitle")})]})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsxs("button",{type:"button",className:"btn-secondary flex items-center justify-center gap-2 w-full sm:w-auto",onClick:()=>p(k),children:[e.jsx(re,{className:"w-4 h-4"}),a("common.back")]}),e.jsxs("button",{type:"button",onClick:X,disabled:D||!N||j,className:"btn-primary flex items-center justify-center gap-2 w-full sm:w-auto",children:[D?e.jsx(B,{className:"w-4 h-4 animate-spin"}):e.jsx(te,{className:"w-4 h-4"}),a("common.submit")]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:a("regulatoryWatch.selectProject")}),e.jsxs(_,{value:N,onChange:r=>I(r.target.value),disabled:M||j,children:[e.jsxs("option",{value:"",children:[a(M?"common.loading":"common.select"),"..."]}),z.map(r=>e.jsx("option",{value:String(r.id),children:r.name},r.id))]})]}),e.jsxs("div",{className:"md:col-span-1 grid grid-cols-2 md:grid-cols-1 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("regulatoryWatch.week")}),e.jsx(_,{value:String(A),onChange:r=>$(Number(r.target.value)),disabled:j,children:Array.from({length:53},(r,t)=>t+1).map(r=>e.jsx("option",{value:String(r),children:r},r))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("regulatoryWatch.year")}),e.jsx(_,{value:String(S),onChange:r=>O(Number(r.target.value)),disabled:j,children:Array.from({length:6},(r,t)=>new Date().getFullYear()-2+t).map(r=>e.jsx("option",{value:String(r),children:r},r))})]})]}),e.jsx("div",{className:"md:col-span-1",children:e.jsxs("div",{className:"p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:a("regulatoryWatch.overallScore")}),e.jsx("div",{className:"text-lg font-bold text-gray-900 dark:text-gray-100",children:U===null?"-":`${U}%`})]})})]}),j&&e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx(B,{className:"w-4 h-4 animate-spin"}),a("common.loading")]})]}),ie.map(r=>{const t=q.get(String(r.section_id)),s=t!==void 0?(u?.sections??[])[t]:null,g=V.get(String(r.section_id))??new Map;return s?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsx("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:w(r.title,m)})}),e.jsx("div",{className:"p-4 space-y-6",children:(r.chapters??[]).map(d=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:w(d.title,m)}),e.jsx("div",{className:"space-y-3",children:(d.articles??[]).map(l=>{const n=g.get(String(l.article_id)),i=n!==void 0?(s?.articles??[])[n]:null;if(!i)return null;const b=!i.applicable,y=b?"border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/40 opacity-70":"border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",H=le(w(l.text,m));return e.jsxs("div",{className:`rounded-xl border ${y} p-3`,children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:w(l.code,m)}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1 whitespace-pre-line",children:H})]}),e.jsxs("div",{className:"flex flex-col gap-2 min-w-[240px]",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>x(t,n,{applicable:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${i.applicable?"bg-hse-primary text-white border-hse-primary":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:a("regulatoryWatch.applicable")}),e.jsx("button",{type:"button",onClick:()=>x(t,n,{applicable:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${i.applicable?"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200":"bg-gray-500 text-white border-gray-500"}`,children:a("regulatoryWatch.notApplicable")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",disabled:b,onClick:()=>x(t,n,{compliant:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${i.applicable&&i.compliant?"bg-green-600 text-white border-green-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:e.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[e.jsx(ae,{className:"w-4 h-4"}),a("regulatoryWatch.conforme")]})}),e.jsx("button",{type:"button",disabled:b,onClick:()=>x(t,n,{compliant:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${i.applicable&&!i.compliant?"bg-red-600 text-white border-red-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:e.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[e.jsx(se,{className:"w-4 h-4"}),a("regulatoryWatch.nonConforme")]})})]})]})]}),i.applicable&&i.compliant===!1&&e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"label text-xs",children:a("regulatoryWatch.correctiveAction")}),e.jsx("textarea",{value:i.corrective_action??"",onChange:W=>x(t,n,{corrective_action:W.target.value}),rows:2,className:"input"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"label text-xs",children:a("regulatoryWatch.comment")}),e.jsx("textarea",{value:i.comment??"",onChange:W=>x(t,n,{comment:W.target.value}),rows:2,className:"input",disabled:!i.applicable})]})]},l.article_id)})})]},d.chapter_id))})]},r.section_id):null})]})}export{be as default};

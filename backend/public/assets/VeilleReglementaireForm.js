import{a as pe,u as be,j as t,g as ye,G as J}from"./index.js";import{u as fe,b as he,h as xe,r as n}from"./vendor-react.js";import{S as Q}from"./Select.js";import{h as je,J as we,v as ce,ay as Ne,q as ve,X as Se,z as j}from"./vendor-ui.js";import{m as q,S as H,c as oe,a as D,f as ke}from"./veilleReglementaireSchema.js";import{s as _e,g as Ae}from"./projectList.js";import"./vendor-utils.js";const Pe=i=>{try{return JSON.parse(i)}catch{return null}},We=i=>{const s=new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate())),f=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-f);const h=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-h)/864e5+1)/7)},$e=i=>i.startsWith("/admin/regulatory-watch")?"/admin/regulatory-watch":i.startsWith("/supervisor/regulatory-watch")?"/supervisor/regulatory-watch":"/regulatory-watch",Ce=i=>{const s=Array.isArray(i?.articles)?i.articles:[];let f=0,h=0;for(const l of s)l?.applicable&&(f+=1,l?.compliant&&(h+=1));const b=f>0?Math.round(h/f*1e4)/100:null;return{totalApplicable:f,totalConforme:h,score:b}};function Oe({mode:i}){const{t:s,language:f}=pe(),{user:h}=be(),b=fe(),l=he(),p=xe(),A=n.useMemo(()=>$e(l.pathname),[l.pathname]),[V,X]=n.useState([]),[G,K]=n.useState(!0),[m,L]=n.useState(""),E=n.useMemo(()=>new URLSearchParams(l.search),[l.search]),Z=h?.project_list_preference??"code",le=n.useMemo(()=>_e(V,Z),[V,Z]),[w,N]=n.useState(!1),[$,ee]=n.useState(!1),[y,T]=n.useState(()=>q()),O=n.useRef({done:!1,key:""}),z=n.useRef(!1),[M,de]=n.useState(0),x=n.useMemo(()=>{const e=p?.page,r=Number.parseInt(String(e??"1"),10);return!Number.isFinite(r)||r<1?1:r},[p?.page]),C=n.useMemo(()=>i==="resubmit"?p?.id?`${A}/${p.id}/resubmit`:`${A}/resubmit`:`${A}/new`,[A,i,p?.id]),[v,R]=n.useState(()=>new Date().getFullYear()),[S,Y]=n.useState(()=>We(new Date)),te=()=>({schema_version:H,mode:i,submission_id:i==="resubmit"?String(p?.id||""):null,selectedProjectId:m?String(m):"",weekYear:v,weekNumber:S,page:x,answers:y,updated_at:Date.now()}),k=n.useMemo(()=>{const e=h?.id?String(h.id):"anonymous",r=p?.id?String(p.id):"";return`regulatory_watch_draft:${i}:${e}:${r||"new"}`},[i,p?.id,h?.id]);n.useEffect(()=>{if(!(typeof window>"u")&&!(O.current.done&&O.current.key===k)){O.current.done=!0,O.current.key=k;try{const e=window.localStorage.getItem(k);if(!e)return;const r=Pe(e);if(!r||typeof r!="object"||r.schema_version!==H||i==="resubmit"&&String(r.submission_id||"")!==String(p?.id||""))return;r.selectedProjectId&&L(String(r.selectedProjectId)),r.weekYear&&Number.isFinite(Number(r.weekYear))&&R(Number(r.weekYear)),r.weekNumber&&Number.isFinite(Number(r.weekNumber))&&Y(Number(r.weekNumber)),r.answers&&typeof r.answers=="object"&&(T(r.answers),z.current=!0,N(!1));const a=Number.parseInt(String(r.page??""),10);Number.isFinite(a)&&a>=1&&x===1&&a!==1&&b(`${C}/${a}${l.search||""}`,{replace:!0})}catch{}}},[x,k,l.search,i,b,p?.id,C]),n.useEffect(()=>{if(!(typeof window>"u"))try{const e=te();window.localStorage.setItem(k,JSON.stringify(e))}catch{}},[y,x,k,i,p?.id,m,S,v]);const re=()=>{if(!(typeof window>"u"))try{const e=te();window.localStorage.setItem(k,JSON.stringify(e)),j.success(s("regulatoryWatch.draftSaved"))}catch(e){j.error(e?.message??s("errors.somethingWentWrong"))}};n.useEffect(()=>{if(i==="resubmit")return;const e=E.get("project_id");e&&!m&&L(e);const r=E.get("week_number");r&&Number.isFinite(Number(r))&&Y(Number(r));const a=E.get("week_year");a&&Number.isFinite(Number(a))&&R(Number(a))},[i,E,m]),n.useEffect(()=>{if(i==="resubmit")return;const e=new URLSearchParams(l.search);m?e.set("project_id",String(m)):e.delete("project_id"),S?e.set("week_number",String(S)):e.delete("week_number"),v?e.set("week_year",String(v)):e.delete("week_year");const r=e.toString(),a=(l.search||"").replace(/^\?/,"");r!==a&&b({pathname:l.pathname,search:r?`?${r}`:""},{replace:!0})},[l.pathname,l.search,i,b,m,S,v]),n.useEffect(()=>{(async()=>{try{K(!0);const r=await ye.getAllList({status:"active"});X(Array.isArray(r)?r:[])}catch(r){X([]),j.error(r.response?.data?.message??s("errors.somethingWentWrong"))}finally{K(!1)}})()},[]),n.useEffect(()=>{(async()=>{if(i!=="resubmit")return;if(z.current){N(!1);return}const r=p?.id;if(r)try{N(!0);const u=(await J.getById(r)).data?.data??null,d=u?.project_id;d&&L(String(d)),u?.week_year&&R(Number(u.week_year)),u?.week_number&&Y(Number(u.week_number));const o=u?.answers?.sections??[],c=(Array.isArray(o)?o:[]).flatMap(g=>Array.isArray(g?.articles)?g.articles:[]).filter(g=>g&&g.applicable===!1).map(g=>String(g.article_id));T(q({previousNonApplicableArticleIds:c}))}catch(a){j.error(a.response?.data?.message??s("errors.somethingWentWrong"))}finally{N(!1)}})()},[i,p?.id]),n.useEffect(()=>{(async()=>{if(i==="resubmit")return;if(z.current){N(!1);return}const r=m?String(m):"";if(!r){N(!1);return}try{N(!0);const d=((await J.getLatest({project_id:r})).data?.data??null)?.answers?.sections??[],o=(Array.isArray(d)?d:[]).flatMap(c=>Array.isArray(c?.articles)?c.articles:[]).filter(c=>c&&c.applicable===!1).map(c=>String(c.article_id));T(q({previousNonApplicableArticleIds:o}))}catch(a){j.error(a.response?.data?.message??s("errors.somethingWentWrong"))}finally{N(!1)}})()},[i,m,s]);const se=n.useMemo(()=>(Array.isArray(y?.sections)?y.sections:[]).map(r=>({section_id:r.section_id,...Ce(r)})),[y]),ae=n.useMemo(()=>{const e=se.map(r=>r.score).filter(r=>typeof r=="number"&&Number.isFinite(r));return e.length===0?null:Math.round(e.reduce((r,a)=>r+a,0)/e.length*100)/100},[se]),ue=n.useMemo(()=>{const e=Array.isArray(y?.sections)?y.sections:[],r=new Map;for(let a=0;a<e.length;a++)r.set(String(e[a]?.section_id),a);return r},[y]),F=oe.length;n.useEffect(()=>{const e=Math.min(Math.max(1,x),F);if(e!==x){b(`${C}/${e}${l.search||""}`,{replace:!0});return}de(e-1)},[x,l.search,b,F,C]),n.useEffect(()=>{window.scrollTo({top:0,left:0,behavior:"smooth"})},[x]);const P=n.useMemo(()=>oe[M]??null,[M]),me=n.useMemo(()=>{const e=Array.isArray(y?.sections)?y.sections:[],r=new Map;for(const a of e){const u=new Map,d=Array.isArray(a?.articles)?a.articles:[];for(let o=0;o<d.length;o++)u.set(String(d[o]?.article_id),o);r.set(String(a?.section_id),u)}return r},[y]),I=(e,r,a)=>{T(u=>{const d={...u},o=Array.isArray(d.sections)?[...d.sections]:[],c={...o[e]??{}},g=Array.isArray(c.articles)?[...c.articles]:[],U={...g[r]??{}},_={...U,...a};return Object.prototype.hasOwnProperty.call(a,"applicable")&&a.applicable===!1&&(_.compliant=!1,_.corrective_action="",_.comment=""),Object.prototype.hasOwnProperty.call(a,"applicable")&&a.applicable===!0&&U.applicable===!1&&(_.compliant=!0),Object.prototype.hasOwnProperty.call(a,"compliant")&&a.compliant===!0&&(_.corrective_action=""),g[r]=_,c.articles=g,o[e]=c,d.sections=o,d})},ne=async()=>{if(!m){j.error(s("regulatoryWatch.projectRequired"));return}if(!v||!S){j.error(s("errors.somethingWentWrong"));return}try{ee(!0);const e={project_id:Number(m),week_year:Number(v),week_number:Number(S),schema_version:H,answers:y},r=await J.submit(e);j.success(s("regulatoryWatch.submitSuccess"));try{window.localStorage.removeItem(k)}catch{}const a=r.data?.data;if(a?.id){b(`${A}/${a.id}`);return}b(A)}catch(e){j.error(e.response?.data?.message??s("errors.somethingWentWrong"))}finally{ee(!1)}},ge=()=>{const e=Math.max(1,x-1);b(`${C}/${e}${l.search||""}`)},ie=()=>{const e=Math.min(F,x+1);b(`${C}/${e}${l.search||""}`)},W=M>=F-1;return t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"sticky top-0 z-20 bg-gray-50 dark:bg-gray-900 pt-2 pb-4",children:t.jsxs("div",{className:"flex items-start justify-between gap-4 flex-col sm:flex-row",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:t.jsx(je,{className:"w-5 h-5 text-hse-primary"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s(i==="resubmit"?"regulatoryWatch.resubmitTitle":"regulatoryWatch.newTitle")}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s("regulatoryWatch.subtitle")})]})]}),t.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[t.jsxs("button",{type:"button",className:"btn-secondary flex items-center justify-center gap-2 w-full sm:w-auto",onClick:()=>b(A),children:[t.jsx(we,{className:"w-4 h-4"}),s("common.back")]}),t.jsx("button",{type:"button",className:"btn-secondary flex items-center justify-center gap-2 w-full sm:w-auto",onClick:re,disabled:$||w,children:s("regulatoryWatch.saveDraft")}),t.jsxs("button",{type:"button",onClick:W?ne:ie,disabled:$||!m||W&&w,className:"btn-primary flex items-center justify-center gap-2 w-full sm:w-auto",children:[$?t.jsx(ce,{className:"w-4 h-4 animate-spin"}):W?t.jsx(Ne,{className:"w-4 h-4"}):null,s(W?"common.submit":"common.next")]})]})]})}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 items-end",children:[t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"label",children:s("regulatoryWatch.selectProject")}),t.jsxs(Q,{value:m,onChange:e=>L(e.target.value),disabled:G||w,children:[t.jsxs("option",{value:"",children:[s(G?"common.loading":"common.select"),"..."]}),le.map(e=>t.jsx("option",{value:String(e.id),children:Ae(e)},e.id))]})]}),t.jsxs("div",{className:"md:col-span-1 grid grid-cols-2 md:grid-cols-1 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("regulatoryWatch.week")}),t.jsx(Q,{value:String(S),onChange:e=>Y(Number(e.target.value)),disabled:w,children:Array.from({length:53},(e,r)=>r+1).map(e=>t.jsx("option",{value:String(e),children:e},e))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("regulatoryWatch.year")}),t.jsx(Q,{value:String(v),onChange:e=>R(Number(e.target.value)),disabled:w,children:Array.from({length:6},(e,r)=>new Date().getFullYear()-2+r).map(e=>t.jsx("option",{value:String(e),children:e},e))})]})]}),t.jsx("div",{className:"md:col-span-1",children:t.jsxs("div",{className:"p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:[t.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("regulatoryWatch.overallScore")}),t.jsx("div",{className:"text-lg font-bold text-gray-900 dark:text-gray-100",children:ae===null?"-":`${ae}%`})]})})]}),w&&t.jsxs("div",{className:"mt-3 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[t.jsx(ce,{className:"w-4 h-4 animate-spin"}),s("common.loading")]})]}),(()=>{if(!P)return null;const e=ue.get(String(P.section_id)),r=e!==void 0?(y?.sections??[])[e]:null,a=me.get(String(P.section_id))??new Map;return r?t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2 text-sm text-gray-600 dark:text-gray-300",children:[t.jsxs("div",{children:[s("common.page")," ",M+1," ",s("common.of")," ",F]}),t.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:D(P.title,f)})]}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[t.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:t.jsx("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:D(P.title,f)})}),t.jsx("div",{className:"p-4 space-y-6",children:(P.chapters??[]).map(u=>t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:D(u.title,f)}),t.jsx("div",{className:"space-y-3",children:(u.articles??[]).map(d=>{const o=a.get(String(d.article_id)),c=o!==void 0?(r?.articles??[])[o]:null;if(!c)return null;const g=!c.applicable,U=g?"border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/40 opacity-70":"border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",_=ke(D(d.text,f));return t.jsxs("div",{className:`rounded-xl border ${U} p-3`,children:[t.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:D(d.code,f)}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1 whitespace-pre-line",children:_})]}),t.jsxs("div",{className:"flex flex-col gap-2 min-w-[240px]",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsx("button",{type:"button",onClick:()=>I(e,o,{applicable:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${c.applicable?"bg-hse-primary text-white border-hse-primary":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:s("regulatoryWatch.applicable")}),t.jsx("button",{type:"button",onClick:()=>I(e,o,{applicable:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${c.applicable?"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200":"bg-gray-500 text-white border-gray-500"}`,children:s("regulatoryWatch.notApplicable")})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsx("button",{type:"button",disabled:g,onClick:()=>I(e,o,{compliant:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${c.applicable&&c.compliant?"bg-green-600 text-white border-green-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:t.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[t.jsx(ve,{className:"w-4 h-4"}),s("regulatoryWatch.conforme")]})}),t.jsx("button",{type:"button",disabled:g,onClick:()=>I(e,o,{compliant:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${c.applicable&&!c.compliant?"bg-red-600 text-white border-red-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:t.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[t.jsx(Se,{className:"w-4 h-4"}),s("regulatoryWatch.nonConforme")]})})]})]})]}),c.applicable&&c.compliant===!1&&t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.correctiveAction")}),t.jsx("textarea",{value:c.corrective_action??"",onChange:B=>I(e,o,{corrective_action:B.target.value}),rows:2,className:"input"})]}),t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.comment")}),t.jsx("textarea",{value:c.comment??"",onChange:B=>I(e,o,{comment:B.target.value}),rows:2,className:"input",disabled:!c.applicable})]})]},`${P.section_id}:${u.chapter_id}:${d.article_id}`)})})]},u.chapter_id))})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("button",{type:"button",className:"btn-secondary",onClick:ge,disabled:M===0||$,children:s("common.previous")}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{type:"button",className:"btn-secondary",onClick:re,disabled:$||w,children:s("regulatoryWatch.saveDraft")}),t.jsx("button",{type:"button",className:"btn-primary",onClick:W?ne:ie,disabled:$||!m||W&&w,children:s(W?"common.submit":"common.next")})]})]})]}):null})()]})}export{Oe as default};

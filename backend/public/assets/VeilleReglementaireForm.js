import{a as oe,u as le,j as e,p as de,C as R}from"./index.js";import{u as me,b as ue,h as ge,r as i}from"./vendor-react.js";import{S as B}from"./Select.js";import{h as pe,J as be,v as te,aw as ye,q as xe,X as he,z as w}from"./vendor-ui.js";import{m as Q,S as re,a as M,f as fe,c as je}from"./veilleReglementaireSchema.js";import{s as Ne,g as we}from"./projectList.js";import"./vendor-utils.js";const ve=c=>{const s=new Date(Date.UTC(c.getFullYear(),c.getMonth(),c.getDate())),p=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-p);const h=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-h)/864e5+1)/7)},Se=c=>c.startsWith("/admin/regulatory-watch")?"/admin/regulatory-watch":c.startsWith("/supervisor/regulatory-watch")?"/supervisor/regulatory-watch":"/regulatory-watch",ke=c=>{const s=Array.isArray(c?.articles)?c.articles:[];let p=0,h=0;for(const d of s)d?.applicable&&(p+=1,d?.compliant&&(h+=1));const b=p>0?Math.round(h/p*1e4)/100:null;return{totalApplicable:p,totalConforme:h,score:b}};function Ie({mode:c}){const{t:s,language:p}=oe(),{user:h}=le(),b=me(),d=ue(),f=ge(),j=i.useMemo(()=>Se(d.pathname),[d.pathname]),[z,q]=i.useState([]),[V,X]=i.useState(!0),[g,E]=i.useState(""),$=i.useMemo(()=>new URLSearchParams(d.search),[d.search]),H=h?.project_list_preference??"code",se=i.useMemo(()=>Ne(z,H),[z,H]),[N,I]=i.useState(c==="resubmit"),[F,J]=i.useState(!1),[y,D]=i.useState(()=>Q()),[W,ae]=i.useState(0),v=i.useMemo(()=>{const t=f?.page,r=Number.parseInt(String(t??"1"),10);return!Number.isFinite(r)||r<1?1:r},[f?.page]),L=i.useMemo(()=>c==="resubmit"?f?.id?`${j}/${f.id}/resubmit`:`${j}/resubmit`:`${j}/new`,[j,c,f?.id]),[S,O]=i.useState(()=>new Date().getFullYear()),[k,U]=i.useState(()=>ve(new Date));i.useEffect(()=>{if(c==="resubmit")return;const t=$.get("project_id");t&&!g&&E(t);const r=$.get("week_number");r&&Number.isFinite(Number(r))&&U(Number(r));const a=$.get("week_year");a&&Number.isFinite(Number(a))&&O(Number(a))},[c,$,g]),i.useEffect(()=>{if(c==="resubmit")return;const t=new URLSearchParams(d.search);g?t.set("project_id",String(g)):t.delete("project_id"),k?t.set("week_number",String(k)):t.delete("week_number"),S?t.set("week_year",String(S)):t.delete("week_year");const r=t.toString(),a=(d.search||"").replace(/^\?/,"");r!==a&&b({pathname:d.pathname,search:r?`?${r}`:""},{replace:!0})},[d.pathname,d.search,c,b,g,k,S]),i.useEffect(()=>{(async()=>{try{X(!0);const r=await de.getAllList({status:"active"});q(Array.isArray(r)?r:[])}catch(r){q([]),w.error(r.response?.data?.message??s("errors.somethingWentWrong"))}finally{X(!1)}})()},[]),i.useEffect(()=>{(async()=>{if(c!=="resubmit")return;const r=f?.id;if(r)try{I(!0);const m=(await R.getById(r)).data?.data??null,l=m?.project_id;l&&E(String(l)),m?.week_year&&O(Number(m.week_year)),m?.week_number&&U(Number(m.week_number));const o=m?.answers?.sections??[],n=(Array.isArray(o)?o:[]).flatMap(u=>Array.isArray(u?.articles)?u.articles:[]).filter(u=>u&&u.applicable===!1).map(u=>String(u.article_id));D(Q({previousNonApplicableArticleIds:n}))}catch(a){w.error(a.response?.data?.message??s("errors.somethingWentWrong"))}finally{I(!1)}})()},[c,f?.id]),i.useEffect(()=>{(async()=>{if(c==="resubmit")return;const r=g?String(g):"";if(r)try{I(!0);const l=((await R.getLatest({project_id:r})).data?.data??null)?.answers?.sections??[],o=(Array.isArray(l)?l:[]).flatMap(n=>Array.isArray(n?.articles)?n.articles:[]).filter(n=>n&&n.applicable===!1).map(n=>String(n.article_id));D(Q({previousNonApplicableArticleIds:o}))}catch(a){w.error(a.response?.data?.message??s("errors.somethingWentWrong"))}finally{I(!1)}})()},[c,g,s]);const G=i.useMemo(()=>(Array.isArray(y?.sections)?y.sections:[]).map(r=>({section_id:r.section_id,...ke(r)})),[y]),K=i.useMemo(()=>{const t=G.map(r=>r.score).filter(r=>typeof r=="number"&&Number.isFinite(r));return t.length===0?null:Math.round(t.reduce((r,a)=>r+a,0)/t.length*100)/100},[G]),ne=i.useMemo(()=>{const t=Array.isArray(y?.sections)?y.sections:[],r=new Map;for(let a=0;a<t.length;a++)r.set(String(t[a]?.section_id),a);return r},[y]),P=re.length;i.useEffect(()=>{const t=Math.min(Math.max(1,v),P);if(t!==v){b(`${L}/${t}${d.search||""}`,{replace:!0});return}ae(t-1)},[v,d.search,b,P,L]),i.useEffect(()=>{window.scrollTo({top:0,left:0,behavior:"smooth"})},[v]);const A=i.useMemo(()=>re[W]??null,[W]),ie=i.useMemo(()=>{const t=Array.isArray(y?.sections)?y.sections:[],r=new Map;for(const a of t){const m=new Map,l=Array.isArray(a?.articles)?a.articles:[];for(let o=0;o<l.length;o++)m.set(String(l[o]?.article_id),o);r.set(String(a?.section_id),m)}return r},[y]),_=(t,r,a)=>{D(m=>{const l={...m},o=Array.isArray(l.sections)?[...l.sections]:[],n={...o[t]??{}},u=Array.isArray(n.articles)?[...n.articles]:[],T={...u[r]??{}},x={...T,...a};return Object.prototype.hasOwnProperty.call(a,"applicable")&&a.applicable===!1&&(x.compliant=!1,x.corrective_action="",x.comment=""),Object.prototype.hasOwnProperty.call(a,"applicable")&&a.applicable===!0&&T.applicable===!1&&(x.compliant=!0),Object.prototype.hasOwnProperty.call(a,"compliant")&&a.compliant===!0&&(x.corrective_action=""),u[r]=x,n.articles=u,o[t]=n,l.sections=o,l})},Z=async()=>{if(!g){w.error(s("regulatoryWatch.projectRequired"));return}if(!S||!k){w.error(s("errors.somethingWentWrong"));return}try{J(!0);const t={project_id:Number(g),week_year:Number(S),week_number:Number(k),schema_version:je,answers:y},r=await R.submit(t);w.success(s("regulatoryWatch.submitSuccess"));const a=r.data?.data;if(a?.id){b(`${j}/${a.id}`);return}b(j)}catch(t){w.error(t.response?.data?.message??s("errors.somethingWentWrong"))}finally{J(!1)}},ce=()=>{const t=Math.max(1,v-1);b(`${L}/${t}${d.search||""}`)},ee=()=>{const t=Math.min(P,v+1);b(`${L}/${t}${d.search||""}`)},C=W>=P-1;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 flex-col sm:flex-row",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:e.jsx(pe,{className:"w-5 h-5 text-hse-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s(c==="resubmit"?"regulatoryWatch.resubmitTitle":"regulatoryWatch.newTitle")}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s("regulatoryWatch.subtitle")})]})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsxs("button",{type:"button",className:"btn-secondary flex items-center justify-center gap-2 w-full sm:w-auto",onClick:()=>b(j),children:[e.jsx(be,{className:"w-4 h-4"}),s("common.back")]}),e.jsxs("button",{type:"button",onClick:C?Z:ee,disabled:F||!g||N,className:"btn-primary flex items-center justify-center gap-2 w-full sm:w-auto",children:[F?e.jsx(te,{className:"w-4 h-4 animate-spin"}):C?e.jsx(ye,{className:"w-4 h-4"}):null,s(C?"common.submit":"common.next")]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:s("regulatoryWatch.selectProject")}),e.jsxs(B,{value:g,onChange:t=>E(t.target.value),disabled:V||N,children:[e.jsxs("option",{value:"",children:[s(V?"common.loading":"common.select"),"..."]}),se.map(t=>e.jsx("option",{value:String(t.id),children:we(t)},t.id))]})]}),e.jsxs("div",{className:"md:col-span-1 grid grid-cols-2 md:grid-cols-1 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("regulatoryWatch.week")}),e.jsx(B,{value:String(k),onChange:t=>U(Number(t.target.value)),disabled:N,children:Array.from({length:53},(t,r)=>r+1).map(t=>e.jsx("option",{value:String(t),children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:s("regulatoryWatch.year")}),e.jsx(B,{value:String(S),onChange:t=>O(Number(t.target.value)),disabled:N,children:Array.from({length:6},(t,r)=>new Date().getFullYear()-2+r).map(t=>e.jsx("option",{value:String(t),children:t},t))})]})]}),e.jsx("div",{className:"md:col-span-1",children:e.jsxs("div",{className:"p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("regulatoryWatch.overallScore")}),e.jsx("div",{className:"text-lg font-bold text-gray-900 dark:text-gray-100",children:K===null?"-":`${K}%`})]})})]}),N&&e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx(te,{className:"w-4 h-4 animate-spin"}),s("common.loading")]})]}),(()=>{if(!A)return null;const t=ne.get(String(A.section_id)),r=t!==void 0?(y?.sections??[])[t]:null,a=ie.get(String(A.section_id))??new Map;return r?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 text-sm text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{children:[s("common.page")," ",W+1," ",s("common.of")," ",P]}),e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:M(A.title,p)})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsx("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:M(A.title,p)})}),e.jsx("div",{className:"p-4 space-y-6",children:(A.chapters??[]).map(m=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:M(m.title,p)}),e.jsx("div",{className:"space-y-3",children:(m.articles??[]).map(l=>{const o=a.get(String(l.article_id)),n=o!==void 0?(r?.articles??[])[o]:null;if(!n)return null;const u=!n.applicable,T=u?"border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/40 opacity-70":"border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",x=fe(M(l.text,p));return e.jsxs("div",{className:`rounded-xl border ${T} p-3`,children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:M(l.code,p)}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1 whitespace-pre-line",children:x})]}),e.jsxs("div",{className:"flex flex-col gap-2 min-w-[240px]",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>_(t,o,{applicable:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${n.applicable?"bg-hse-primary text-white border-hse-primary":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:s("regulatoryWatch.applicable")}),e.jsx("button",{type:"button",onClick:()=>_(t,o,{applicable:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${n.applicable?"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200":"bg-gray-500 text-white border-gray-500"}`,children:s("regulatoryWatch.notApplicable")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{type:"button",disabled:u,onClick:()=>_(t,o,{compliant:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${n.applicable&&n.compliant?"bg-green-600 text-white border-green-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:e.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[e.jsx(xe,{className:"w-4 h-4"}),s("regulatoryWatch.conforme")]})}),e.jsx("button",{type:"button",disabled:u,onClick:()=>_(t,o,{compliant:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${n.applicable&&!n.compliant?"bg-red-600 text-white border-red-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:e.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[e.jsx(he,{className:"w-4 h-4"}),s("regulatoryWatch.nonConforme")]})})]})]})]}),n.applicable&&n.compliant===!1&&e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.correctiveAction")}),e.jsx("textarea",{value:n.corrective_action??"",onChange:Y=>_(t,o,{corrective_action:Y.target.value}),rows:2,className:"input"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.comment")}),e.jsx("textarea",{value:n.comment??"",onChange:Y=>_(t,o,{comment:Y.target.value}),rows:2,className:"input",disabled:!n.applicable})]})]},l.article_id)})})]},m.chapter_id))})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:ce,disabled:W===0||N||F,children:s("common.previous")}),e.jsx("button",{type:"button",className:"btn-primary",onClick:C?Z:ee,disabled:F||!g||N,children:s(C?"common.submit":"common.next")})]})]}):null})()]})}export{Ie as default};

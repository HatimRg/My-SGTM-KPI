import{a as me,u as ge,j as t,p as pe,G as z}from"./index.js";import{u as be,b as ye,h as xe,r as n}from"./vendor-react.js";import{S as J}from"./Select.js";import{h as he,J as fe,v as ne,aw as je,q as we,X as Ne,z as A}from"./vendor-ui.js";import{m as q,S as H,c as ie,a as I,f as ve}from"./veilleReglementaireSchema.js";import{s as Se,g as ke}from"./projectList.js";import"./vendor-utils.js";const _e=i=>{try{return JSON.parse(i)}catch{return null}},Ae=i=>{const s=new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate())),y=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-y);const h=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-h)/864e5+1)/7)},Pe=i=>i.startsWith("/admin/regulatory-watch")?"/admin/regulatory-watch":i.startsWith("/supervisor/regulatory-watch")?"/supervisor/regulatory-watch":"/regulatory-watch",We=i=>{const s=Array.isArray(i?.articles)?i.articles:[];let y=0,h=0;for(const u of s)u?.applicable&&(y+=1,u?.compliant&&(h+=1));const x=y>0?Math.round(h/y*1e4)/100:null;return{totalApplicable:y,totalConforme:h,score:x}};function Te({mode:i}){const{t:s,language:y}=me(),{user:h}=ge(),x=be(),u=ye(),p=xe(),v=n.useMemo(()=>Pe(u.pathname),[u.pathname]),[V,X]=n.useState([]),[G,K]=n.useState(!0),[m,F]=n.useState(""),L=n.useMemo(()=>new URLSearchParams(u.search),[u.search]),Z=h?.project_list_preference??"code",ce=n.useMemo(()=>Se(V,Z),[V,Z]),[P,f]=n.useState(!1),[E,ee]=n.useState(!1),[b,T]=n.useState(()=>q()),D=n.useRef({done:!1,key:""}),B=n.useRef(!1),[C,oe]=n.useState(0),W=n.useMemo(()=>{const e=p?.page,r=Number.parseInt(String(e??"1"),10);return!Number.isFinite(r)||r<1?1:r},[p?.page]),O=n.useMemo(()=>i==="resubmit"?p?.id?`${v}/${p.id}/resubmit`:`${v}/resubmit`:`${v}/new`,[v,i,p?.id]),[j,R]=n.useState(()=>new Date().getFullYear()),[w,Y]=n.useState(()=>Ae(new Date)),S=n.useMemo(()=>{const e=h?.id?String(h.id):"anonymous",r=p?.id?String(p.id):"";return`regulatory_watch_draft:${i}:${e}:${r||"new"}`},[i,p?.id,h?.id]);n.useEffect(()=>{if(!(typeof window>"u")&&!(D.current.done&&D.current.key===S)){D.current.done=!0,D.current.key=S;try{const e=window.sessionStorage.getItem(S);if(!e)return;const r=_e(e);if(!r||typeof r!="object"||r.schema_version!==H||i==="resubmit"&&String(r.submission_id||"")!==String(p?.id||""))return;r.selectedProjectId&&F(String(r.selectedProjectId)),r.weekYear&&Number.isFinite(Number(r.weekYear))&&R(Number(r.weekYear)),r.weekNumber&&Number.isFinite(Number(r.weekNumber))&&Y(Number(r.weekNumber)),r.answers&&typeof r.answers=="object"&&(T(r.answers),B.current=!0,f(!1))}catch{}}},[S,i,p?.id]),n.useEffect(()=>{if(!(typeof window>"u"))try{const e={schema_version:H,mode:i,submission_id:i==="resubmit"?String(p?.id||""):null,selectedProjectId:m?String(m):"",weekYear:j,weekNumber:w,answers:b,updated_at:Date.now()};window.sessionStorage.setItem(S,JSON.stringify(e))}catch{}},[b,S,i,p?.id,m,w,j]),n.useEffect(()=>{if(i==="resubmit")return;const e=L.get("project_id");e&&!m&&F(e);const r=L.get("week_number");r&&Number.isFinite(Number(r))&&Y(Number(r));const a=L.get("week_year");a&&Number.isFinite(Number(a))&&R(Number(a))},[i,L,m]),n.useEffect(()=>{if(i==="resubmit")return;const e=new URLSearchParams(u.search);m?e.set("project_id",String(m)):e.delete("project_id"),w?e.set("week_number",String(w)):e.delete("week_number"),j?e.set("week_year",String(j)):e.delete("week_year");const r=e.toString(),a=(u.search||"").replace(/^\?/,"");r!==a&&x({pathname:u.pathname,search:r?`?${r}`:""},{replace:!0})},[u.pathname,u.search,i,x,m,w,j]),n.useEffect(()=>{(async()=>{try{K(!0);const r=await pe.getAllList({status:"active"});X(Array.isArray(r)?r:[])}catch(r){X([]),A.error(r.response?.data?.message??s("errors.somethingWentWrong"))}finally{K(!1)}})()},[]),n.useEffect(()=>{(async()=>{if(i!=="resubmit")return;if(B.current){f(!1);return}const r=p?.id;if(r)try{f(!0);const d=(await z.getById(r)).data?.data??null,l=d?.project_id;l&&F(String(l)),d?.week_year&&R(Number(d.week_year)),d?.week_number&&Y(Number(d.week_number));const o=d?.answers?.sections??[],c=(Array.isArray(o)?o:[]).flatMap(g=>Array.isArray(g?.articles)?g.articles:[]).filter(g=>g&&g.applicable===!1).map(g=>String(g.article_id));T(q({previousNonApplicableArticleIds:c}))}catch(a){A.error(a.response?.data?.message??s("errors.somethingWentWrong"))}finally{f(!1)}})()},[i,p?.id]),n.useEffect(()=>{(async()=>{if(i==="resubmit")return;if(B.current){f(!1);return}const r=m?String(m):"";if(!r){f(!1);return}try{f(!0);const l=((await z.getLatest({project_id:r})).data?.data??null)?.answers?.sections??[],o=(Array.isArray(l)?l:[]).flatMap(c=>Array.isArray(c?.articles)?c.articles:[]).filter(c=>c&&c.applicable===!1).map(c=>String(c.article_id));T(q({previousNonApplicableArticleIds:o}))}catch(a){A.error(a.response?.data?.message??s("errors.somethingWentWrong"))}finally{f(!1)}})()},[i,m,s]);const te=n.useMemo(()=>(Array.isArray(b?.sections)?b.sections:[]).map(r=>({section_id:r.section_id,...We(r)})),[b]),re=n.useMemo(()=>{const e=te.map(r=>r.score).filter(r=>typeof r=="number"&&Number.isFinite(r));return e.length===0?null:Math.round(e.reduce((r,a)=>r+a,0)/e.length*100)/100},[te]),le=n.useMemo(()=>{const e=Array.isArray(b?.sections)?b.sections:[],r=new Map;for(let a=0;a<e.length;a++)r.set(String(e[a]?.section_id),a);return r},[b]),$=ie.length;n.useEffect(()=>{const e=Math.min(Math.max(1,W),$);if(e!==W){x(`${O}/${e}${u.search||""}`,{replace:!0});return}oe(e-1)},[W,u.search,x,$,O]),n.useEffect(()=>{window.scrollTo({top:0,left:0,behavior:"smooth"})},[W]);const k=n.useMemo(()=>ie[C]??null,[C]),de=n.useMemo(()=>{const e=Array.isArray(b?.sections)?b.sections:[],r=new Map;for(const a of e){const d=new Map,l=Array.isArray(a?.articles)?a.articles:[];for(let o=0;o<l.length;o++)d.set(String(l[o]?.article_id),o);r.set(String(a?.section_id),d)}return r},[b]),M=(e,r,a)=>{T(d=>{const l={...d},o=Array.isArray(l.sections)?[...l.sections]:[],c={...o[e]??{}},g=Array.isArray(c.articles)?[...c.articles]:[],U={...g[r]??{}},N={...U,...a};return Object.prototype.hasOwnProperty.call(a,"applicable")&&a.applicable===!1&&(N.compliant=!1,N.corrective_action="",N.comment=""),Object.prototype.hasOwnProperty.call(a,"applicable")&&a.applicable===!0&&U.applicable===!1&&(N.compliant=!0),Object.prototype.hasOwnProperty.call(a,"compliant")&&a.compliant===!0&&(N.corrective_action=""),g[r]=N,c.articles=g,o[e]=c,l.sections=o,l})},se=async()=>{if(!m){A.error(s("regulatoryWatch.projectRequired"));return}if(!j||!w){A.error(s("errors.somethingWentWrong"));return}try{ee(!0);const e={project_id:Number(m),week_year:Number(j),week_number:Number(w),schema_version:H,answers:b},r=await z.submit(e);A.success(s("regulatoryWatch.submitSuccess"));try{window.sessionStorage.removeItem(S)}catch{}const a=r.data?.data;if(a?.id){x(`${v}/${a.id}`);return}x(v)}catch(e){A.error(e.response?.data?.message??s("errors.somethingWentWrong"))}finally{ee(!1)}},ue=()=>{const e=Math.max(1,W-1);x(`${O}/${e}${u.search||""}`)},ae=()=>{const e=Math.min($,W+1);x(`${O}/${e}${u.search||""}`)},_=C>=$-1;return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-start justify-between gap-4 flex-col sm:flex-row",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"p-2 bg-hse-primary/10 rounded-lg",children:t.jsx(he,{className:"w-5 h-5 text-hse-primary"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s(i==="resubmit"?"regulatoryWatch.resubmitTitle":"regulatoryWatch.newTitle")}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s("regulatoryWatch.subtitle")})]})]}),t.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[t.jsxs("button",{type:"button",className:"btn-secondary flex items-center justify-center gap-2 w-full sm:w-auto",onClick:()=>x(v),children:[t.jsx(fe,{className:"w-4 h-4"}),s("common.back")]}),t.jsxs("button",{type:"button",onClick:_?se:ae,disabled:E||!m||_&&P,className:"btn-primary flex items-center justify-center gap-2 w-full sm:w-auto",children:[E?t.jsx(ne,{className:"w-4 h-4 animate-spin"}):_?t.jsx(je,{className:"w-4 h-4"}):null,s(_?"common.submit":"common.next")]})]})]}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 items-end",children:[t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"label",children:s("regulatoryWatch.selectProject")}),t.jsxs(J,{value:m,onChange:e=>F(e.target.value),disabled:G||P,children:[t.jsxs("option",{value:"",children:[s(G?"common.loading":"common.select"),"..."]}),ce.map(e=>t.jsx("option",{value:String(e.id),children:ke(e)},e.id))]})]}),t.jsxs("div",{className:"md:col-span-1 grid grid-cols-2 md:grid-cols-1 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("regulatoryWatch.week")}),t.jsx(J,{value:String(w),onChange:e=>Y(Number(e.target.value)),disabled:P,children:Array.from({length:53},(e,r)=>r+1).map(e=>t.jsx("option",{value:String(e),children:e},e))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("regulatoryWatch.year")}),t.jsx(J,{value:String(j),onChange:e=>R(Number(e.target.value)),disabled:P,children:Array.from({length:6},(e,r)=>new Date().getFullYear()-2+r).map(e=>t.jsx("option",{value:String(e),children:e},e))})]})]}),t.jsx("div",{className:"md:col-span-1",children:t.jsxs("div",{className:"p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:[t.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("regulatoryWatch.overallScore")}),t.jsx("div",{className:"text-lg font-bold text-gray-900 dark:text-gray-100",children:re===null?"-":`${re}%`})]})})]}),P&&t.jsxs("div",{className:"mt-3 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[t.jsx(ne,{className:"w-4 h-4 animate-spin"}),s("common.loading")]})]}),(()=>{if(!k)return null;const e=le.get(String(k.section_id)),r=e!==void 0?(b?.sections??[])[e]:null,a=de.get(String(k.section_id))??new Map;return r?t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2 text-sm text-gray-600 dark:text-gray-300",children:[t.jsxs("div",{children:[s("common.page")," ",C+1," ",s("common.of")," ",$]}),t.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:I(k.title,y)})]}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[t.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:t.jsx("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:I(k.title,y)})}),t.jsx("div",{className:"p-4 space-y-6",children:(k.chapters??[]).map(d=>t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:I(d.title,y)}),t.jsx("div",{className:"space-y-3",children:(d.articles??[]).map(l=>{const o=a.get(String(l.article_id)),c=o!==void 0?(r?.articles??[])[o]:null;if(!c)return null;const g=!c.applicable,U=g?"border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/40 opacity-70":"border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",N=ve(I(l.text,y));return t.jsxs("div",{className:`rounded-xl border ${U} p-3`,children:[t.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:I(l.code,y)}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1 whitespace-pre-line",children:N})]}),t.jsxs("div",{className:"flex flex-col gap-2 min-w-[240px]",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsx("button",{type:"button",onClick:()=>M(e,o,{applicable:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${c.applicable?"bg-hse-primary text-white border-hse-primary":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:s("regulatoryWatch.applicable")}),t.jsx("button",{type:"button",onClick:()=>M(e,o,{applicable:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors ${c.applicable?"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200":"bg-gray-500 text-white border-gray-500"}`,children:s("regulatoryWatch.notApplicable")})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsx("button",{type:"button",disabled:g,onClick:()=>M(e,o,{compliant:!0}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${c.applicable&&c.compliant?"bg-green-600 text-white border-green-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:t.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[t.jsx(we,{className:"w-4 h-4"}),s("regulatoryWatch.conforme")]})}),t.jsx("button",{type:"button",disabled:g,onClick:()=>M(e,o,{compliant:!1}),className:`px-3 py-2 rounded-lg text-sm border transition-colors disabled:opacity-60 ${c.applicable&&!c.compliant?"bg-red-600 text-white border-red-600":"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"}`,children:t.jsxs("span",{className:"inline-flex items-center gap-1 justify-center",children:[t.jsx(Ne,{className:"w-4 h-4"}),s("regulatoryWatch.nonConforme")]})})]})]})]}),c.applicable&&c.compliant===!1&&t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.correctiveAction")}),t.jsx("textarea",{value:c.corrective_action??"",onChange:Q=>M(e,o,{corrective_action:Q.target.value}),rows:2,className:"input"})]}),t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"label text-xs",children:s("regulatoryWatch.comment")}),t.jsx("textarea",{value:c.comment??"",onChange:Q=>M(e,o,{comment:Q.target.value}),rows:2,className:"input",disabled:!c.applicable})]})]},`${k.section_id}:${d.chapter_id}:${l.article_id}`)})})]},d.chapter_id))})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("button",{type:"button",className:"btn-secondary",onClick:ue,disabled:C===0||E,children:s("common.previous")}),t.jsx("button",{type:"button",className:"btn-primary",onClick:_?se:ae,disabled:E||!m||_&&P,children:s(_?"common.submit":"common.next")})]})]}):null})()]})}export{Te as default};

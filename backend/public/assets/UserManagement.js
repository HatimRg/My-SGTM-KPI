import{a as fe,u as be,g as x,p as G,j as e}from"./index.js";import{r as t}from"./vendor-react.js";import{M as ve}from"./Modal.js";import{C as ye}from"./ConfirmDialog.js";import{S as j}from"./Select.js";import{s as Ne,g as H}from"./projectList.js";import{z as c,a8 as we,s as K,a9 as ke,aa as _e,ab as Ce,F as J,ac as Q,ad as V,ae as W,af as Y}from"./vendor-ui.js";import"./vendor-utils.js";function Te(){const{t:a}=fe(),{user:Z}=be(),[F,ee]=t.useState([]),[L,se]=t.useState([]),[ae,E]=t.useState(!0),[b,re]=t.useState(""),[v,te]=t.useState(""),[y,R]=t.useState(""),[p,le]=t.useState(""),[A,T]=t.useState([]),[ne,M]=t.useState(!1),[h,N]=t.useState(null),[n,o]=t.useState({name:"",email:"",password:"",role:"hse_manager",pole:"",phone:"",project_ids:[]}),[O,D]=t.useState(!1),[i,ce]=t.useState({current_page:1,last_page:1}),[g,w]=t.useState(null),[oe,k]=t.useState(!1),[d,_]=t.useState(null),[$,B]=t.useState(!1),C=t.useRef(null),f=t.useRef(null),q=Z?.project_list_preference??"code",S=t.useMemo(()=>Ne(L,q),[L,q]);t.useEffect(()=>{m(),xe()},[b,v,y,p]),t.useEffect(()=>{(async()=>{try{const r=await G.getPoles(),l=r.data?.data?.poles??r.data?.poles??[];T(Array.isArray(l)?l:[])}catch{T([])}})()},[]),t.useEffect(()=>{const s=r=>{C.current&&!C.current.contains(r.target)&&k(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const ie=s=>{if(!s)return null;const r=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(s),l=decodeURIComponent(r?.[1]??r?.[2]??"");return l!==""?l:null},de=(s,r)=>{const l=URL.createObjectURL(s),u=document.createElement("a");u.href=l,u.download=r??"template.xlsx",document.body.appendChild(u),u.click(),u.remove(),setTimeout(()=>URL.revokeObjectURL(l),5e3)},me=async()=>{try{const s=await x.downloadTemplate(),r=ie(s.headers?.["content-disposition"])??"SGTM-Users-Template.xlsx";de(s.data,r)}catch{c.error("Failed to download template")}},ue=async()=>{if(!d){c.error("Please choose a file");return}try{B(!0);const s=new FormData;s.append("file",d);const l=(await x.bulkImport(s)).data?.data??{},u=l.imported??0,je=l.updated??0,X=l.errors??[];c.success(`Imported: ${u} / Updated: ${je}`),X.length>0&&c.error(`${X.length} row(s) had issues`),_(null),k(!1),m()}catch(s){c.error(s.response?.data?.message??"Failed to import users")}finally{B(!1)}},m=async(s=1)=>{try{E(!0);const r=await x.getAll({page:s,search:b,role:v,project_id:y,pole:p,per_page:10});ee(r.data.data??[]),ce(r.data.meta??{current_page:1,last_page:1})}catch{c.error(a("users.loadError"))}finally{E(!1)}},xe=async()=>{try{const s=await G.getAllList({status:"active"});se(s)}catch{console.error("Failed to load projects")}},U=(s=null)=>{s?(N(s),o({name:s.name,email:s.email,password:"",role:s.role,pole:s.pole??"",phone:s.phone??"",project_ids:s.role==="pole_director"?[]:s.projects?.map(r=>r.id)??[]})):(N(null),o({name:"",email:"",password:"",role:"hse_manager",pole:"",phone:"",project_ids:[]})),M(!0)},P=()=>{M(!1),N(null)},he=async s=>{s.preventDefault(),D(!0);try{h?(await x.update(h.id,n),c.success(a("users.updateSuccess"))):(await x.create(n),c.success(a("users.createSuccess"))),P(),m()}catch(r){const l=r.response?.data?.message??a("users.saveError");c.error(l)}finally{D(!1)}},z=s=>{w(s)},pe=async()=>{if(g)try{await x.delete(g.id),c.success(a("users.deleteSuccess")),m()}catch(s){c.error(s.response?.data?.message??a("users.deleteError"))}finally{w(null)}},I=async s=>{try{await x.toggleStatus(s.id),c.success(s.is_active?a("users.deactivateSuccess"):a("users.activateSuccess")),m()}catch(r){c.error(r.response?.data?.message??a("users.statusError"))}},ge=s=>{o(r=>({...r,project_ids:r.project_ids.includes(s)?r.project_ids.filter(l=>l!==s):[...r.project_ids,s]}))};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:a("users.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:a("users.subtitle")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{ref:C,className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>k(s=>!s),className:"btn-secondary flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),"Massive Add"]}),oe&&e.jsx("div",{className:"absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-4 z-50",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{type:"button",onClick:me,className:"btn-secondary w-full",children:"Download Template"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{ref:f,type:"file",accept:".xlsx,.xls",onChange:s=>_(s.target.files?.[0]??null),className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>f.current?.click(),className:"w-full rounded-lg border border-dashed border-gray-300 dark:border-gray-600 px-3 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700/50 transition",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:"Select XLSX file"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:d?d.name:"Choose the filled template (.xlsx)"})]}),e.jsx("div",{className:"text-xs font-semibold px-2 py-1 rounded-md bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",children:"Browse"})]})}),d&&e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-300 truncate",children:["Selected: ",e.jsx("span",{className:"font-semibold",children:d.name})]}),e.jsx("button",{type:"button",onClick:()=>{_(null),f.current&&(f.current.value="")},className:"text-xs font-semibold text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100",children:"Clear"})]})]}),e.jsx("button",{type:"button",onClick:ue,disabled:$||!d,className:"btn-primary w-full",children:$?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(K,{className:"w-4 h-4 animate-spin"}),"Uploading..."]}):"Upload"})]})})]}),e.jsxs("button",{onClick:()=>U(),className:"btn-primary flex items-center gap-2",children:[e.jsx(ke,{className:"w-4 h-4"}),a("users.addUser")]})]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(_e,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:a("users.searchPlaceholder"),value:b,onChange:s=>re(s.target.value),className:"input pl-10"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2",children:[e.jsx(Ce,{className:"hidden sm:block w-4 h-4 text-gray-400"}),e.jsxs(j,{value:p,onChange:s=>{le(s.target.value),R("")},className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:a("common.allPoles")}),A.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs(j,{value:y,onChange:s=>R(s.target.value),className:"w-full sm:w-44",children:[e.jsx("option",{value:"",children:a("common.allProjects")}),(p?S.filter(s=>s?.pole===p):S).map(s=>e.jsx("option",{value:s.id,children:H(s)},s.id))]}),e.jsxs(j,{value:v,onChange:s=>te(s.target.value),className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:a("users.allRoles")}),e.jsx("option",{value:"admin",children:a("users.roles.admin")}),e.jsx("option",{value:"pole_director",children:a("users.roles.pole_director")}),e.jsx("option",{value:"works_director",children:a("users.roles.works_director")}),e.jsx("option",{value:"hse_director",children:a("users.roles.hse_director")}),e.jsx("option",{value:"hr_director",children:a("users.roles.hr_director")}),e.jsx("option",{value:"hse_manager",children:a("users.roles.hse_manager")}),e.jsx("option",{value:"responsable",children:a("users.roles.responsable")}),e.jsx("option",{value:"supervisor",children:a("users.roles.supervisor")}),e.jsx("option",{value:"user",children:a("users.roles.user")}),e.jsx("option",{value:"hr",children:a("users.roles.hr")})]})]})]})}),e.jsxs("div",{className:"card",children:[ae?e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"hidden md:block space-y-2 animate-pulse",children:Array.from({length:6},(s,r)=>e.jsx("div",{className:"h-12 rounded-md bg-gray-100 dark:bg-gray-800"},r))}),e.jsx("div",{className:"md:hidden space-y-3 animate-pulse",children:Array.from({length:4},(s,r)=>e.jsx("div",{className:"h-20 rounded-lg bg-gray-100 dark:bg-gray-800"},r))})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:F.map(s=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-semibold",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.email})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1 text-xs",children:[e.jsx("span",{className:`badge ${s.role==="admin"?"badge-info":"badge-success"}`,children:s.role}),e.jsx("span",{className:`badge ${s.is_active?"badge-success":"badge-danger"}`,children:s.is_active?a("users.status.active"):a("users.status.inactive")})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(J,{className:"w-3 h-3 text-gray-400 dark:text-gray-500"}),e.jsx("span",{children:s.projects?.length??0})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>U(s),className:"p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700",title:a("common.edit"),children:e.jsx(Q,{className:"w-4 h-4 text-gray-600 dark:text-gray-200"})}),e.jsx("button",{onClick:()=>I(s),className:"p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700",title:s.is_active?a("users.deactivate"):a("users.activate"),children:s.is_active?e.jsx(V,{className:"w-4 h-4 text-amber-600"}):e.jsx(W,{className:"w-4 h-4 text-green-600"})}),e.jsx("button",{onClick:()=>z(s),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:a("common.delete"),children:e.jsx(Y,{className:"w-4 h-4 text-red-600"})})]})]})]},s.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:a("users.table.user")}),e.jsx("th",{children:a("users.table.role")}),e.jsx("th",{children:a("users.table.projects")}),e.jsx("th",{children:a("users.table.status")}),e.jsx("th",{children:a("users.table.actions")})]})}),e.jsx("tbody",{children:F.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-semibold",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s.email})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.role==="admin"?"badge-info":"badge-success"}`,children:s.role})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(J,{className:"w-4 h-4 text-gray-400 dark:text-gray-500"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:s.projects?.length??0})]})}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.is_active?"badge-success":"badge-danger"}`,children:s.is_active?a("users.status.active"):a("users.status.inactive")})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>U(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:a("common.edit"),children:e.jsx(Q,{className:"w-4 h-4 text-gray-600"})}),e.jsx("button",{onClick:()=>I(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:s.is_active?a("users.deactivate"):a("users.activate"),children:s.is_active?e.jsx(V,{className:"w-4 h-4 text-amber-600"}):e.jsx(W,{className:"w-4 h-4 text-green-600"})}),e.jsx("button",{onClick:()=>z(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:a("common.delete"),children:e.jsx(Y,{className:"w-4 h-4 text-red-600"})})]})})]},s.id))})]})})]}),i.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-gray-100",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:[a("common.page")," ",i.current_page," ",a("common.of")," ",i.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>m(i.current_page-1),disabled:i.current_page===1,className:"btn-secondary text-sm",children:a("common.previous")}),e.jsx("button",{onClick:()=>m(i.current_page+1),disabled:i.current_page===i.last_page,className:"btn-secondary text-sm",children:a("common.next")})]})]})]}),e.jsx(ve,{isOpen:ne,onClose:P,title:a(h?"users.editUser":"users.createUser"),size:"md",children:e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.fullName")}),e.jsx("input",{type:"text",value:n.name,onChange:s=>o({...n,name:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.email")}),e.jsx("input",{type:"email",value:n.email,onChange:s=>o({...n,email:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("users.form.password")," ",h&&`(${a("users.form.passwordHint")})`]}),e.jsx("input",{type:"password",value:n.password,onChange:s=>o({...n,password:s.target.value}),className:"input",...!h&&{required:!0},minLength:8})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.role")}),e.jsxs(j,{value:n.role,onChange:s=>{const r=s.target.value;o(l=>({...l,role:r,pole:r==="pole_director"?l.pole:"",project_ids:r==="pole_director"?[]:l.project_ids}))},children:[e.jsx("option",{value:"hse_manager",children:a("users.roles.hse_manager")}),e.jsx("option",{value:"responsable",children:a("users.roles.responsable")}),e.jsx("option",{value:"supervisor",children:a("users.roles.supervisor")}),e.jsx("option",{value:"user",children:a("users.roles.user")}),e.jsx("option",{value:"hr",children:a("users.roles.hr")}),e.jsx("option",{value:"admin",children:a("users.roles.admin")}),e.jsx("option",{value:"pole_director",children:a("users.roles.pole_director")}),e.jsx("option",{value:"works_director",children:a("users.roles.works_director")}),e.jsx("option",{value:"hse_director",children:a("users.roles.hse_director")}),e.jsx("option",{value:"hr_director",children:a("users.roles.hr_director")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.phone")}),e.jsx("input",{type:"tel",value:n.phone,onChange:s=>o({...n,phone:s.target.value}),className:"input"})]})]}),n.role==="pole_director"&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.pole")}),e.jsxs(j,{value:n.pole,onChange:s=>o({...n,pole:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:a("users.form.selectPole")}),A.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),n.role!=="pole_director"&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.assignProjects")}),e.jsx("div",{className:"max-h-40 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg p-2 space-y-1 bg-white dark:bg-gray-700",children:S.map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-600 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:n.project_ids.includes(s.id),onChange:()=>ge(s.id),className:"w-4 h-4 text-hse-primary border-gray-300 dark:border-gray-500 rounded focus:ring-hse-primary"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-gray-100",children:H(s)})]},s.id))})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:P,className:"btn-secondary w-full sm:w-auto",children:a("common.cancel")}),e.jsx("button",{type:"submit",disabled:O,className:"btn-primary w-full sm:w-auto",children:O?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(K,{className:"w-4 h-4 animate-spin"}),a("common.saving")]}):a(h?"users.updateUser":"users.createUserBtn")})]})]})}),e.jsx(ye,{isOpen:!!g,title:a("common.confirm"),message:g?a("users.deleteConfirm",{name:g.name}):"",confirmLabel:a("common.delete"),cancelLabel:a("common.cancel"),variant:"danger",onConfirm:pe,onCancel:()=>w(null)})]})}export{Te as default};

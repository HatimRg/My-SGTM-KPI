import{a as _e,u as ke,i as g,g as J,j as e,M as Se}from"./index.js";import{r as t}from"./vendor-react.js";import{C as Ce}from"./ConfirmDialog.js";import{S as b}from"./Select.js";import{g as Pe,P as Ue,c as Fe}from"./PasswordStrength.js";import{s as Le,g as Q}from"./projectList.js";import{z as c,au as Ae,a0 as W,av as Re,w as Ee,aw as Me,F as Y,ax as Z,ay as ee,az as se,aA as ae}from"./vendor-ui.js";import"./vendor-utils.js";function Xe(){const{t:a}=_e(),{user:re}=ke(),[E,te]=t.useState([]),[M,le]=t.useState([]),[ne,T]=t.useState(!0),[y,oe]=t.useState(""),[N,ce]=t.useState(""),[w,O]=t.useState(""),[j,ie]=t.useState(""),[D,B]=t.useState([]),[de,z]=t.useState(!1),[x,_]=t.useState(null),[n,d]=t.useState({name:"",email:"",password:"",role:"hse_manager",pole:"",phone:"",project_ids:[]}),[q,I]=t.useState(!1),[u,me]=t.useState({current_page:1,last_page:1}),[f,k]=t.useState(null),[ue,S]=t.useState(!1),[h,C]=t.useState(null),[$,X]=t.useState(!1),P=t.useRef(null),v=t.useRef(null),K=re?.project_list_preference??"code",U=t.useMemo(()=>Le(M,K),[M,K]),G=t.useMemo(()=>Pe(n.role),[n.role]),xe=s=>{const r=s?.response?.data,l=[r?.errors,r?.data?.errors,r?.error?.errors];for(const i of l)if(i&&typeof i=="object"){const m=Object.keys(i);if(m.length>0){const we=m[0],A=i[we],R=Array.isArray(A)?A[0]:A;if(typeof R=="string"&&R.trim()!=="")return R}}const o=r?.message??r?.data?.message;return typeof o=="string"&&o.trim()!==""?o:a("users.saveError")},he=(s,r)=>{const l=Array.isArray(s.project_ids)?s.project_ids.map(m=>Number(m)).filter(m=>Number.isFinite(m)):[],o=s.role==="pole_director"||s.role==="regional_hse_manager",i={...s,name:(s.name??"").trim(),email:(s.email??"").trim(),phone:(s.phone??"").trim()||null,pole:o&&(s.pole??"").trim()||null,project_ids:o?[]:l};return r&&!i.password&&delete i.password,i};t.useEffect(()=>{p(),be()},[y,N,w,j]),t.useEffect(()=>{(async()=>{try{const r=await J.getPoles(),l=r.data?.data?.poles??r.data?.poles??[];B(Array.isArray(l)?l:[])}catch{B([])}})()},[]),t.useEffect(()=>{const s=r=>{P.current&&!P.current.contains(r.target)&&S(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const pe=s=>{if(!s)return null;const r=/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(s),l=decodeURIComponent(r?.[1]??r?.[2]??"");return l!==""?l:null},ge=(s,r)=>{const l=URL.createObjectURL(s),o=document.createElement("a");o.href=l,o.download=r??"template.xlsx",document.body.appendChild(o),o.click(),o.remove(),setTimeout(()=>URL.revokeObjectURL(l),5e3)},je=async()=>{try{const s=await g.downloadTemplate(),r=pe(s.headers?.["content-disposition"])??"SGTM-Users-Template.xlsx";ge(s.data,r)}catch{c.error(a("users.bulk.downloadTemplateFailed"))}},fe=async()=>{if(!h){c.error(a("users.bulk.chooseFile"));return}try{X(!0);const s=new FormData;s.append("file",h);const l=(await g.bulkImport(s)).data?.data??{},o=l.imported??0,i=l.updated??0,m=l.errors??[];c.success(a("users.bulk.importSummary",{imported:o,updated:i})),m.length>0&&c.error(a("users.bulk.importIssues",{count:m.length})),C(null),S(!1),p()}catch(s){c.error(s.response?.data?.message??a("users.bulk.importFailed"))}finally{X(!1)}},p=async(s=1)=>{try{T(!0);const r=await g.getAll({page:s,search:y,role:N,project_id:w,pole:j,per_page:10});te(r.data.data??[]),me(r.data.meta??{current_page:1,last_page:1})}catch{c.error(a("users.loadError"))}finally{T(!1)}},be=async()=>{try{const s=await J.getAllList({status:"active"});le(s)}catch{console.error("Failed to load projects")}},F=(s=null)=>{s?(_(s),d({name:s.name,email:s.email,password:"",role:s.role,pole:s.pole??"",phone:s.phone??"",project_ids:s.role==="pole_director"||s.role==="regional_hse_manager"?[]:s.projects?.map(r=>r.id)??[]})):(_(null),d({name:"",email:"",password:"",role:"hse_manager",pole:"",phone:"",project_ids:[]})),z(!0)},L=()=>{z(!1),_(null)},ve=async s=>{s.preventDefault();const r=he(n,!!x);if(r.password&&!Fe(r.password,G).ok){c.error(a("auth.passwordPolicy.invalid"));return}I(!0);try{x?(await g.update(x.id,r),c.success(a("users.updateSuccess"))):(await g.create(r),c.success(a("users.createSuccess"))),L(),p()}catch(l){c.error(xe(l))}finally{I(!1)}},H=s=>{k(s)},ye=async()=>{if(f)try{await g.delete(f.id),c.success(a("users.deleteSuccess")),p()}catch(s){c.error(s.response?.data?.message??a("users.deleteError"))}finally{k(null)}},V=async s=>{try{await g.toggleStatus(s.id),c.success(s.is_active?a("users.deactivateSuccess"):a("users.activateSuccess")),p()}catch(r){c.error(r.response?.data?.message??a("users.statusError"))}},Ne=s=>{d(r=>({...r,project_ids:r.project_ids.includes(s)?r.project_ids.filter(l=>l!==s):[...r.project_ids,s]}))};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:a("users.title")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:a("users.subtitle")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{ref:P,className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>S(s=>!s),className:"btn-secondary flex items-center gap-2",children:[e.jsx(Ae,{className:"w-4 h-4"}),"Massive Add"]}),ue&&e.jsx("div",{className:"absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-4 z-50",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{type:"button",onClick:je,className:"btn-secondary w-full",children:"Download Template"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{ref:v,type:"file",accept:".xlsx,.xls",onChange:s=>C(s.target.files?.[0]??null),className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>v.current?.click(),className:"w-full rounded-lg border border-dashed border-gray-300 dark:border-gray-600 px-3 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700/50 transition",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:"Select XLSX file"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:h?h.name:"Choose the filled template (.xlsx)"})]}),e.jsx("div",{className:"text-xs font-semibold px-2 py-1 rounded-md bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",children:"Browse"})]})}),h&&e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-300 truncate",children:["Selected: ",e.jsx("span",{className:"font-semibold",children:h.name})]}),e.jsx("button",{type:"button",onClick:()=>{C(null),v.current&&(v.current.value="")},className:"text-xs font-semibold text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100",children:"Clear"})]})]}),e.jsx("button",{type:"button",onClick:fe,disabled:$||!h,className:"btn-primary w-full",children:$?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(W,{className:"w-4 h-4 animate-spin"}),"Uploading..."]}):"Upload"})]})})]}),e.jsxs("button",{onClick:()=>F(),className:"btn-primary flex items-center gap-2",children:[e.jsx(Re,{className:"w-4 h-4"}),a("users.addUser")]})]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ee,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:a("users.searchPlaceholder"),value:y,onChange:s=>oe(s.target.value),className:"input pl-10"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2",children:[e.jsx(Me,{className:"hidden sm:block w-4 h-4 text-gray-400"}),e.jsxs(b,{value:j,onChange:s=>{ie(s.target.value),O("")},className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:a("common.allPoles")}),D.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs(b,{value:w,onChange:s=>O(s.target.value),className:"w-full sm:w-44",children:[e.jsx("option",{value:"",children:a("common.allProjects")}),(j?U.filter(s=>s?.pole===j):U).map(s=>e.jsx("option",{value:s.id,children:Q(s)},s.id))]}),e.jsxs(b,{value:N,onChange:s=>ce(s.target.value),className:"w-full sm:w-40",children:[e.jsx("option",{value:"",children:a("users.allRoles")}),e.jsx("option",{value:"admin",children:a("users.roles.admin")}),e.jsx("option",{value:"consultation",children:a("users.roles.consultation")}),e.jsx("option",{value:"pole_director",children:a("users.roles.pole_director")}),e.jsx("option",{value:"works_director",children:a("users.roles.works_director")}),e.jsx("option",{value:"hse_director",children:a("users.roles.hse_director")}),e.jsx("option",{value:"hr_director",children:a("users.roles.hr_director")}),e.jsx("option",{value:"hse_manager",children:a("users.roles.hse_manager")}),e.jsx("option",{value:"regional_hse_manager",children:a("users.roles.regional_hse_manager")}),e.jsx("option",{value:"responsable",children:a("users.roles.responsable")}),e.jsx("option",{value:"supervisor",children:a("users.roles.supervisor")}),e.jsx("option",{value:"user",children:a("users.roles.user")}),e.jsx("option",{value:"hr",children:a("users.roles.hr")})]})]})]})}),e.jsxs("div",{className:"card",children:[ne?e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"hidden md:block space-y-2 animate-pulse",children:Array.from({length:6},(s,r)=>e.jsx("div",{className:"h-12 rounded-md bg-gray-100 dark:bg-gray-800"},r))}),e.jsx("div",{className:"md:hidden space-y-3 animate-pulse",children:Array.from({length:4},(s,r)=>e.jsx("div",{className:"h-20 rounded-lg bg-gray-100 dark:bg-gray-800"},r))})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 md:hidden",children:E.map(s=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-white dark:bg-gray-800",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-semibold",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.email})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1 text-xs",children:[e.jsx("span",{className:`badge ${s.role==="admin"?"badge-info":"badge-success"}`,children:s.role}),e.jsx("span",{className:`badge ${s.is_active?"badge-success":"badge-danger"}`,children:s.is_active?a("users.status.active"):a("users.status.inactive")})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-[11px] text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Y,{className:"w-3 h-3 text-gray-400 dark:text-gray-500"}),e.jsx("span",{children:s.projects?.length??0})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>F(s),className:"p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700",title:a("common.edit"),children:e.jsx(Z,{className:"w-4 h-4 text-gray-600 dark:text-gray-200"})}),e.jsx("button",{onClick:()=>V(s),className:"p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700",title:s.is_active?a("users.deactivate"):a("users.activate"),children:s.is_active?e.jsx(ee,{className:"w-4 h-4 text-amber-600"}):e.jsx(se,{className:"w-4 h-4 text-green-600"})}),e.jsx("button",{onClick:()=>H(s),className:"p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30",title:a("common.delete"),children:e.jsx(ae,{className:"w-4 h-4 text-red-600"})})]})]})]},s.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:a("users.table.user")}),e.jsx("th",{children:a("users.table.role")}),e.jsx("th",{children:a("users.table.projects")}),e.jsx("th",{children:a("users.table.status")}),e.jsx("th",{children:a("users.table.actions")})]})}),e.jsx("tbody",{children:E.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-hse-primary rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-semibold",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s.email})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.role==="admin"?"badge-info":"badge-success"}`,children:s.role})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Y,{className:"w-4 h-4 text-gray-400 dark:text-gray-500"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:s.projects?.length??0})]})}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.is_active?"badge-success":"badge-danger"}`,children:s.is_active?a("users.status.active"):a("users.status.inactive")})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>F(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:a("common.edit"),children:e.jsx(Z,{className:"w-4 h-4 text-gray-600"})}),e.jsx("button",{onClick:()=>V(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:s.is_active?a("users.deactivate"):a("users.activate"),children:s.is_active?e.jsx(ee,{className:"w-4 h-4 text-amber-600"}):e.jsx(se,{className:"w-4 h-4 text-green-600"})}),e.jsx("button",{onClick:()=>H(s),className:"p-2 hover:bg-gray-100 rounded-lg",title:a("common.delete"),children:e.jsx(ae,{className:"w-4 h-4 text-red-600"})})]})})]},s.id))})]})})]}),u.last_page>1&&e.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-gray-100",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:[a("common.page")," ",u.current_page," ",a("common.of")," ",u.last_page]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>p(u.current_page-1),disabled:u.current_page===1,className:"btn-secondary text-sm",children:a("common.previous")}),e.jsx("button",{onClick:()=>p(u.current_page+1),disabled:u.current_page===u.last_page,className:"btn-secondary text-sm",children:a("common.next")})]})]})]}),e.jsx(Se,{isOpen:de,onClose:L,title:a(x?"users.editUser":"users.createUser"),size:"md",children:e.jsxs("form",{onSubmit:ve,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.fullName")}),e.jsx("input",{type:"text",value:n.name,onChange:s=>d({...n,name:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.email")}),e.jsx("input",{type:"email",value:n.email,onChange:s=>d({...n,email:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("users.form.password")," ",x&&`(${a("users.form.passwordHint")})`]}),e.jsx("input",{type:"password",value:n.password,onChange:s=>d({...n,password:s.target.value}),className:"input",...!x&&{required:!0},minLength:G.minLength}),e.jsx(Ue,{password:n.password,role:n.role})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.role")}),e.jsx(b,{value:n.role,onChange:s=>{const r=s.target.value,l=r==="pole_director"||r==="regional_hse_manager";d(o=>({...o,role:r,pole:l?o.pole:"",project_ids:l?[]:o.project_ids}))},children:e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"hse_manager",children:a("users.roles.hse_manager")}),e.jsx("option",{value:"regional_hse_manager",children:a("users.roles.regional_hse_manager")}),e.jsx("option",{value:"responsable",children:a("users.roles.responsable")}),e.jsx("option",{value:"supervisor",children:a("users.roles.supervisor")}),e.jsx("option",{value:"user",children:a("users.roles.user")}),e.jsx("option",{value:"hr",children:a("users.roles.hr")}),e.jsx("option",{value:"admin",children:a("users.roles.admin")}),e.jsx("option",{value:"consultation",children:a("users.roles.consultation")}),e.jsx("option",{value:"pole_director",children:a("users.roles.pole_director")}),e.jsx("option",{value:"works_director",children:a("users.roles.works_director")}),e.jsx("option",{value:"hse_director",children:a("users.roles.hse_director")}),e.jsx("option",{value:"hr_director",children:a("users.roles.hr_director")})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.phone")}),e.jsx("input",{type:"tel",value:n.phone,onChange:s=>d({...n,phone:s.target.value}),className:"input"})]})]}),(n.role==="pole_director"||n.role==="regional_hse_manager")&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.pole")}),e.jsxs(b,{value:n.pole,onChange:s=>d({...n,pole:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:a("users.form.selectPole")}),D.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),n.role!=="pole_director"&&n.role!=="regional_hse_manager"&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("users.form.assignProjects")}),e.jsx("div",{className:"max-h-40 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg p-2 space-y-1 bg-white dark:bg-gray-700",children:U.map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-600 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:n.project_ids.includes(s.id),onChange:()=>Ne(s.id),className:"w-4 h-4 text-hse-primary border-gray-300 dark:border-gray-500 rounded focus:ring-hse-primary"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-gray-100",children:Q(s)})]},s.id))})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:L,className:"btn-secondary w-full sm:w-auto",children:a("common.cancel")}),e.jsx("button",{type:"submit",disabled:q,className:"btn-primary w-full sm:w-auto",children:q?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(W,{className:"w-4 h-4 animate-spin"}),a("common.saving")]}):a(x?"users.updateUser":"users.createUserBtn")})]})]})}),e.jsx(Ce,{isOpen:!!f,title:a("common.confirm"),message:f?a("users.deleteConfirm",{name:f.name}):"",confirmLabel:a("common.delete"),cancelLabel:a("common.cancel"),variant:"danger",onConfirm:ye,onCancel:()=>k(null)})]})}export{Xe as default};

import{a as Ce,u as Se,p as Le,q as u,j as e}from"./index.js";import{r}from"./vendor-react.js";import{C as se}from"./ConfirmDialog.js";import{M as We}from"./Modal.js";import{D as ae}from"./DatePicker.js";import{S as Ee}from"./Select.js";import{s as ze,g as De}from"./projectList.js";import{z as i,s as y,a6 as $e,a7 as Fe,a9 as te,aD as Ke,ah as Te,aE as Me,aa as re,a as z,l as Re,aq as Ae,u as Ue,ag as Be,B as Ie,a4 as Oe,ax as qe,af as Ye,am as He}from"./vendor-ui.js";import"./vendor-utils.js";const le=[{key:"type_cold",labelKey:"cold",alwaysChecked:!0},{key:"type_work_at_height",labelKey:"workAtHeight"},{key:"type_hot_work",labelKey:"hotWork"},{key:"type_confined_spaces",labelKey:"confinedSpaces"},{key:"type_electrical_isolation",labelKey:"electricalIsolation"},{key:"type_energized_work",labelKey:"energizedWork"},{key:"type_excavation",labelKey:"excavation"},{key:"type_mechanical_isolation",labelKey:"mechanicalIsolation"},{key:"type_7inch_grinder",labelKey:"grinder7inch"}],ne=a=>{if(!a)return"-";const v=a.substring(0,10),[f,P,c]=v.split("-");return`${c}-${P}-${f}`};function ts(){const{t:a}=Ce(),{user:v}=Se(),[f,P]=r.useState([]),[c,D]=r.useState(null),[o,$]=r.useState(null),[d,F]=r.useState(null),[x,K]=r.useState(null),[C,ce]=r.useState([]),[ie,oe]=r.useState([]),[de,me]=r.useState(!0),[T,M]=r.useState(!1),[b,j]=r.useState(!1),[k,R]=r.useState(null),[n,m]=r.useState(J()),[A,U]=r.useState(!1),[h,N]=r.useState([]),[B,I]=r.useState(!1),[O,q]=r.useState(!1),[S,L]=r.useState(null),Y=v?.project_list_preference??"code",xe=r.useMemo(()=>ze(f,Y),[f,Y]),[he,_]=r.useState(!1),[H,ue]=r.useState(""),[G,pe]=r.useState("");function J(){return{type_cold:!0,type_work_at_height:!1,type_hot_work:!1,type_confined_spaces:!1,type_electrical_isolation:!1,type_energized_work:!1,type_excavation:!1,type_mechanical_isolation:!1,type_7inch_grinder:!1,description:"",area:"",permit_user:"",signed_by:"",authorizer:"",commence_date:"",end_date:"",enterprise:""}}r.useEffect(()=>{ge(),ye()},[]),r.useEffect(()=>{const s=t=>{t.key==="Escape"&&b&&j(!1)};if(b)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[b]),r.useEffect(()=>{c&&o&&d&&w()},[c,o,d]);const ge=async()=>{try{const s=await Le.getAllList({status:"active"});P(s),s.length===1&&D(s[0])}catch{i.error("Failed to load projects")}finally{me(!1)}},ye=async()=>{try{const t=(await u.getWeekInfo()).data.data;$(t.current_week),F(t.current_year),K(t)}catch(s){console.error("Failed to get week info:",s)}},w=async()=>{if(c){M(!0);try{const t=(await u.getWeekPermits({project_id:c.id,week_number:o,year:d})).data.data;ce(t.current_week.permits??[]),oe(t.previous_week.permits??[]),K({...x,current:t.current_week,previous:t.previous_week})}catch{i.error("Failed to load permits")}finally{M(!1)}}},Q=s=>{let t=o+s,l=d;t>52?(t=1,l++):t<1&&(t=52,l--),$(t),F(l)},W=(s=null)=>{if(s)R(s),m({type_cold:s.type_cold,type_work_at_height:s.type_work_at_height,type_hot_work:s.type_hot_work,type_confined_spaces:s.type_confined_spaces,type_electrical_isolation:s.type_electrical_isolation,type_energized_work:s.type_energized_work,type_excavation:s.type_excavation,type_mechanical_isolation:s.type_mechanical_isolation,type_7inch_grinder:s.type_7inch_grinder,description:s.description??"",area:s.area??"",permit_user:s.permit_user,signed_by:s.signed_by??"",authorizer:s.authorizer??"",commence_date:s.commence_date,end_date:s.end_date,enterprise:s.enterprise??""});else{R(null);const t=x?.current??{};m({...J(),commence_date:t.start_date??"",end_date:t.end_date??""})}j(!0)},fe=async s=>{if(s.preventDefault(),!!c){U(!0);try{k?(await u.update(k.id,n),i.success(a("workPermits.updated"))):(await u.create({...n,project_id:c.id,week_number:o,year:d}),i.success(a("workPermits.created"))),j(!1),w()}catch(t){i.error(t.response?.data?.message||"Failed to save permit")}finally{U(!1)}}},je=s=>{L(s)},we=async()=>{if(S)try{await u.delete(S.id),i.success(a("workPermits.deleted")),w()}catch{i.error("Failed to delete permit")}finally{L(null)}},be=async()=>{if(h.length!==0){I(!0);try{const s=await u.copyFromPrevious({project_id:c.id,week_number:o,year:d,permit_ids:h});i.success(a("workPermits.copied",{count:s.data.data.copied_count})),N([]),w()}catch{i.error("Failed to copy permits")}finally{I(!1)}}},ke=()=>{_(!0)},Ne=async()=>{if(!c||!o||!d){_(!1);return}try{const s=await u.launchWeek({project_id:c.id,week_number:o,year:d});i.success(a("workPermits.weekLaunched",{count:s.data.data.activated_count})),w()}catch{i.error("Failed to launch week")}finally{_(!1)}},_e=async()=>{if(!(!c||!o||!d)){q(!0);try{const s=await u.export({project_id:c.id,week_number:o,year:d}),t=window.URL.createObjectURL(new Blob([s.data])),l=document.createElement("a");l.href=t;const g="S"+String(o).padStart(2,"0");l.setAttribute("download",`Permis_${c.code}_${g}_${d}.xlsx`),document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(t),i.success(a("workPermits.exported"))}catch(s){console.error("Export error:",s),i.error(a("workPermits.exportError"))}finally{q(!1)}}},ve=s=>{N(t=>t.includes(s)?t.filter(l=>l!==s):[...t,s])},V=s=>({draft:"badge-warning",active:"badge-success",closed:"badge-info",cancelled:"badge-danger"})[s]||"badge-info",X=s=>le.filter(t=>s[t.key]).map(t=>a(`workPermits.types.${t.labelKey}`)),Z=(s,t)=>{if(!t.trim())return s;const l=t.toLowerCase();return s.filter(g=>g.permit_number?.toLowerCase().includes(l)||g.permit_user?.toLowerCase().includes(l)||g.area?.toLowerCase().includes(l)||g.enterprise?.toLowerCase().includes(l)||g.description?.toLowerCase().includes(l))},p=Z(ie,H),E=Z(C,G),Pe=()=>{h.length===p.length?N([]):N(p.map(s=>s.id))},ee=p.length>0&&h.length===p.length;return de?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(y,{className:"w-8 h-8 animate-spin text-hse-primary"})}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:[a("nav.dashboard")," / ",a("workPermits.title")]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:a("workPermits.pageTitle")}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:a("workPermits.pageSubtitle")})]})}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("workPermits.project")}),e.jsxs(Ee,{value:c?.id??"",onChange:s=>{const t=f.find(l=>l.id===parseInt(s.target.value));D(t)},children:[e.jsx("option",{value:"",children:a("workPermits.selectProject")}),xe.map(s=>e.jsx("option",{value:s.id,children:De(s)},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("workPermits.week")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Q(-1),className:"btn-outline p-2",children:e.jsx($e,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 text-center font-semibold text-lg",children:["S",String(o).padStart(2,"0")," - ",d]}),e.jsx("button",{onClick:()=>Q(1),className:"btn-outline p-2",children:e.jsx(Fe,{className:"w-5 h-5"})})]}),x?.current&&e.jsxs("p",{className:"text-xs text-center text-gray-500 mt-1",children:[x.current.start_date," → ",x.current.end_date]})]}),e.jsxs("div",{className:"flex flex-wrap items-end gap-2 md:col-span-2 lg:col-span-1",children:[e.jsxs("button",{onClick:()=>W(),disabled:!c,className:"btn-primary flex items-center gap-2 whitespace-nowrap",children:[e.jsx(te,{className:"w-4 h-4"}),a("workPermits.newPermit")]}),e.jsxs("button",{onClick:ke,disabled:!c||C.length===0,className:"btn-success flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Ke,{className:"w-4 h-4"}),a("workPermits.launchWeek")]}),e.jsxs("button",{onClick:_e,disabled:!c||C.length===0||O,className:"btn-secondary flex items-center gap-2 whitespace-nowrap",children:[O?e.jsx(y,{className:"w-4 h-4 animate-spin"}):e.jsx(Te,{className:"w-4 h-4"}),a("workPermits.exportExcel")]})]})]})}),c?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:[a("workPermits.previousWeekPermits"),x?.previous&&e.jsxs("span",{className:"text-xs font-normal text-gray-500 ml-1",children:["(",x.previous.week_label,")"]})]}),h.length>0&&e.jsxs("button",{onClick:be,disabled:B,className:"btn-primary btn-xs flex items-center gap-1",children:[B?e.jsx(y,{className:"w-3 h-3 animate-spin"}):e.jsx(Me,{className:"w-3 h-3"}),a("workPermits.copySelected")," (",h.length,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"text",value:H,onChange:s=>ue(s.target.value),placeholder:a("common.search"),className:"input input-sm pl-8 h-8 text-xs"}),e.jsx(re,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"})]}),e.jsxs("button",{onClick:Pe,disabled:p.length===0,className:`btn-xs flex items-center gap-1 ${ee?"btn-primary":"btn-outline"}`,children:[e.jsx(z,{className:"w-3 h-3"}),a(ee?"common.none":"common.all")]})]})]}),e.jsx("div",{className:"card-body max-h-[600px] overflow-y-auto pt-2",children:T?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(y,{className:"w-5 h-5 animate-spin text-hse-primary"})}):p.length>0?e.jsx("div",{className:"space-y-2",children:p.map(s=>e.jsx("div",{onClick:()=>ve(s.id),className:`p-2 rounded border cursor-pointer transition-colors ${h.includes(s.id)?"border-hse-primary bg-hse-primary/5":"border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:`w-4 h-4 mt-0.5 rounded border flex-shrink-0 flex items-center justify-center ${h.includes(s.id)?"bg-hse-primary border-hse-primary":"border-gray-300 dark:border-gray-600"}`,children:h.includes(s.id)&&e.jsx(z,{className:"w-2.5 h-2.5 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx("span",{className:"font-mono text-xs font-semibold",children:s.permit_number}),e.jsx("span",{className:`badge badge-xs ${V(s.status)}`,children:a(`workPermits.status.${s.status}`)})]}),s.description&&e.jsx("p",{className:"text-sm font-medium text-gray-800 dark:text-gray-200 mt-1",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5 mt-1 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx("span",{children:s.permit_user}),s.area&&e.jsxs("span",{className:"text-gray-400",children:["• ",s.area]}),s.enterprise&&e.jsxs("span",{className:"text-gray-400",children:["• ",s.enterprise]})]}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:X(s).map((t,l)=>e.jsx("span",{className:"text-[10px] bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-1.5 py-0.5 rounded",children:t},l))})]})]})},s.id))}):e.jsx("div",{className:"text-center py-4 text-gray-500 text-sm",children:e.jsx("p",{children:a("workPermits.noPermits")})})})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 text-sm",children:[a("workPermits.currentWeekPermits"),x?.current&&e.jsxs("span",{className:"text-xs font-normal text-gray-500 ml-1",children:["(",x.current.week_label,")"]})]}),e.jsx("span",{className:"badge badge-info badge-xs",children:E.length})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:G,onChange:s=>pe(s.target.value),placeholder:a("common.search"),className:"input input-sm pl-8 h-8 text-xs w-full"}),e.jsx(re,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"})]})]}),e.jsx("div",{className:"card-body max-h-[600px] overflow-y-auto pt-2",children:T?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(y,{className:"w-5 h-5 animate-spin text-hse-primary"})}):E.length>0?e.jsx("div",{className:"space-y-2",children:E.map(s=>e.jsx("div",{className:"p-2 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx("span",{className:"font-mono text-xs font-semibold",children:s.permit_number}),e.jsx("span",{className:`badge badge-xs ${V(s.status)}`,children:a(`workPermits.status.${s.status}`)})]}),s.description&&e.jsx("p",{className:"text-sm font-medium text-gray-800 dark:text-gray-200 mt-1",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-0.5 mt-1 text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(Re,{className:"w-3 h-3"}),s.permit_user]}),s.signed_by&&e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(Ae,{className:"w-3 h-3"}),s.signed_by]}),s.authorizer&&e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(Ue,{className:"w-3 h-3"}),s.authorizer]}),s.area&&e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(Be,{className:"w-3 h-3"}),s.area]}),s.enterprise&&e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(Ie,{className:"w-3 h-3"}),s.enterprise]}),e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(Oe,{className:"w-3 h-3"}),ne(s.commence_date)," → ",ne(s.end_date)]})]}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:X(s).map((t,l)=>e.jsx("span",{className:"text-[10px] bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 px-1.5 py-0.5 rounded",children:t},l))})]}),e.jsxs("div",{className:"flex items-center gap-0.5 flex-shrink-0",children:[e.jsx("button",{onClick:()=>W(s),className:"p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors",title:a("workPermits.editPermit"),children:e.jsx(qe,{className:"w-3.5 h-3.5 text-gray-500"})}),e.jsx("button",{onClick:()=>je(s),className:"p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors",title:a("workPermits.deletePermit"),children:e.jsx(Ye,{className:"w-3.5 h-3.5 text-red-500"})})]})]})},s.id))}):e.jsxs("div",{className:"text-center py-4 text-gray-500 text-sm",children:[e.jsx("p",{children:a("workPermits.noPermits")}),e.jsxs("button",{onClick:()=>W(),className:"btn-primary btn-sm mt-2",children:[e.jsx(te,{className:"w-3 h-3 mr-1"}),a("workPermits.newPermit")]})]})})]})]}):e.jsxs("div",{className:"card p-12 text-center",children:[e.jsx(He,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:a("workPermits.selectProject")})]}),e.jsx(We,{isOpen:b,onClose:()=>j(!1),title:a(k?"workPermits.editPermit":"workPermits.newPermit"),size:"lg",children:e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("workPermits.permitTypes")}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:le.map(s=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:s.key,checked:n[s.key],onChange:t=>m({...n,[s.key]:t.target.checked}),disabled:s.alwaysChecked,className:"w-4 h-4 text-hse-primary rounded"}),e.jsx("label",{htmlFor:s.key,className:"text-sm",children:a(`workPermits.types.${s.labelKey}`)})]},s.key))})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("workPermits.permitUser")," *"]}),e.jsx("input",{type:"text",value:n.permit_user,onChange:s=>m({...n,permit_user:s.target.value}),placeholder:a("workPermits.permitUserPlaceholder"),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("workPermits.signedBy")}),e.jsx("input",{type:"text",value:n.signed_by,onChange:s=>m({...n,signed_by:s.target.value}),placeholder:a("workPermits.signedByPlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("workPermits.authorizer")}),e.jsx("input",{type:"text",value:n.authorizer,onChange:s=>m({...n,authorizer:s.target.value}),placeholder:a("workPermits.authorizerPlaceholder"),className:"input"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("workPermits.enterprise")}),e.jsx("input",{type:"text",value:n.enterprise,onChange:s=>m({...n,enterprise:s.target.value}),placeholder:a("workPermits.enterprisePlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("workPermits.area")}),e.jsx("input",{type:"text",value:n.area,onChange:s=>m({...n,area:s.target.value}),placeholder:a("workPermits.areaPlaceholder"),className:"input"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("workPermits.commenceDate")," *"]}),e.jsx(ae,{value:n.commence_date,onChange:s=>m({...n,commence_date:s}),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:[a("workPermits.endDate")," *"]}),e.jsx(ae,{value:n.end_date,onChange:s=>m({...n,end_date:s}),required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:a("workPermits.description")}),e.jsx("textarea",{value:n.description,onChange:s=>m({...n,description:s.target.value}),placeholder:a("workPermits.descriptionPlaceholder"),rows:3,className:"input"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("button",{type:"button",onClick:()=>j(!1),className:"btn-outline",children:a("common.cancel")}),e.jsxs("button",{type:"submit",disabled:A,className:"btn-primary flex items-center gap-2",children:[A?e.jsx(y,{className:"w-4 h-4 animate-spin"}):e.jsx(z,{className:"w-4 h-4"}),a(k?"common.update":"common.save")]})]})]})}),e.jsx(se,{isOpen:!!S,title:a("common.confirm"),message:a("workPermits.confirmDelete"),confirmLabel:a("common.delete"),cancelLabel:a("common.cancel"),variant:"danger",onConfirm:we,onCancel:()=>L(null)}),e.jsx(se,{isOpen:he,title:a("common.confirm"),message:a("workPermits.launchConfirm"),confirmLabel:a("workPermits.launchWeek"),cancelLabel:a("common.cancel"),variant:"primary",onConfirm:Ne,onCancel:()=>_(!1)})]})}export{ts as default};

import{a as le,u as re,j as t,g as ie,I as j}from"./index.js";import{r as i}from"./vendor-react.js";import{M as ne}from"./Modal.js";import{C as ce}from"./ConfirmDialog.js";import{s as oe}from"./projectList.js";import{A as de,af as he,v as Y,aD as me,al as ve,z as o}from"./vendor-ui.js";import"./vendor-utils.js";const f=[{value:"work_accident"},{value:"incident"},{value:"near_miss"},{value:"first_aid"},{value:"medical_consultation"},{value:"road_accident"},{value:"other"}],g=[{value:""},{value:"minor"},{value:"moderate"},{value:"major"},{value:"critical"},{value:"fatal"},{value:"other"}];function be(){const{t:s}=le(),{user:z}=re(),b=e=>s(`hseEvents.types.${e}`)??e,N=e=>e?s(`hseEvents.severities.${e}`)??e:s("common.all")??"All",[I,$]=i.useState([]),[M,E]=i.useState(!0),[q,v]=i.useState(!1),[_,w]=i.useState([]),[d,K]=i.useState(""),[h,V]=i.useState(""),[m,B]=i.useState(""),[p,G]=i.useState(""),[u,J]=i.useState(""),[y,Q]=i.useState(""),[x,U]=i.useState(""),[W,S]=i.useState(!1),[C,T]=i.useState(null),[k,D]=i.useState(null),R=z?.project_list_preference??"code",O=i.useMemo(()=>oe(I,R),[I,R]),A=()=>({project_id:"",event_date:new Date().toISOString().split("T")[0],type:"work_accident",type_other:"",description:"",severity:"",severity_other:"",lost_time:!1,lost_days:0,location:""}),[l,c]=i.useState(A());i.useEffect(()=>{(async()=>{try{const r=(await ie.getAll({per_page:200})).data?.data??[];$(Array.isArray(r)?r:[])}catch{$([])}finally{E(!1)}})()},[]);const P=async()=>{E(!0);try{const e={per_page:100};d&&(e.project_id=d),p&&(e.year=p),u&&(e.month=u),y&&(e.from_date=y),x&&(e.to_date=x);const r=(await j.getAll(e)).data,n=r?.data??r,F=Array.isArray(n)?n:n?.data??[];w(F)}catch{w([])}finally{E(!1)}};i.useEffect(()=>{P()},[d,p,u,y,x]);const X=()=>{T(null),c({...A(),project_id:d||""}),S(!0)},Z=e=>{const a=f.some(n=>n.value!=="other"&&n.value===e.type),r=g.some(n=>n.value&&n.value!=="other"&&n.value===e.severity);T(e),c({project_id:String(e.project_id??""),event_date:e.event_date?.substring(0,10)??new Date().toISOString().split("T")[0],type:a?e.type:"other",type_other:a?"":e.type??"",description:e.description??"",severity:r?e.severity:e.severity?"other":"",severity_other:r?"":e.severity??"",lost_time:!!e.lost_time,lost_days:e.lost_days??0,location:e.location??""}),S(!0)},L=()=>{S(!1),T(null),c(A())},ee=async e=>{e.preventDefault(),v(!0);try{const a=l.type==="other"?l.type_other||"":l.type,r=l.severity==="other"?l.severity_other||"":l.severity||"";if(!a){o.error(s("hseEvents.validation.typeRequired")??"Type is required");return}if(l.type==="other"&&!l.type_other){o.error(s("hseEvents.validation.specifyType")??"Please specify the type");return}if(l.severity==="other"&&!l.severity_other){o.error(s("hseEvents.validation.specifySeverity")??"Please specify the severity");return}const n={project_id:parseInt(l.project_id),event_date:l.event_date,type:a,description:l.description||null,severity:r||null,lost_time:!!l.lost_time,lost_days:Number(l.lost_days)||0,location:l.location||null};C?.id?(await j.update(C.id,n),o.success(s("common.saved")??"Saved")):(await j.create(n),o.success(s("common.saved")??"Saved")),L(),P()}catch{o.error(s("common.error")??"Error")}finally{v(!1)}},te=e=>D(e),se=async()=>{if(k?.id){v(!0);try{await j.delete(k.id),o.success(s("common.saved")??"Saved"),D(null),P()}catch{o.error(s("common.error")??"Error")}finally{v(!1)}}},ae=e=>{if(!e)return s("common.none")??"-";const a=e.substring(0,10),[r,n,F]=a.split("-");return`${F}/${n}/${r}`},H=i.useMemo(()=>{let e=Array.isArray(_)?_:[];return h&&(h==="other"?e=e.filter(a=>!f.some(r=>r.value!=="other"&&r.value===a.type)):e=e.filter(a=>a.type===h)),m&&(m==="other"?e=e.filter(a=>a.severity&&!g.some(r=>r.value&&r.value!=="other"&&r.value===a.severity)):e=e.filter(a=>(a.severity??"")===m)),e},[_,h,m]);return t.jsxs("div",{className:"max-w-7xl mx-auto p-6 space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-12 h-12 bg-red-50 dark:bg-red-900/30 rounded-xl flex items-center justify-center",children:t.jsx(de,{className:"w-6 h-6 text-red-500"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s("hseEvents.pageTitle")??"Accident / Incident Records"}),t.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s("hseEvents.pageSubtitle")??"Register and track HSE events (accidents, incidents, near misses, first aid, road accidents)"})]})]}),t.jsxs("button",{onClick:X,className:"btn-primary flex items-center gap-2",children:[t.jsx(he,{className:"w-4 h-4"}),s("common.new")??"New"]})]}),t.jsx("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-4",children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("projects.title")??"Project"}),t.jsxs("select",{className:"input",value:d,onChange:e=>K(e.target.value),children:[t.jsx("option",{value:"",children:s("common.all")??"All"}),O.map(e=>t.jsx("option",{value:String(e.id),children:e.code?`${e.code} - ${e.name}`:e.name},e.id))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.filters.type")??"Type"}),t.jsxs("select",{className:"input",value:h,onChange:e=>V(e.target.value),children:[t.jsx("option",{value:"",children:s("common.all")??"All"}),f.map(e=>t.jsx("option",{value:e.value,children:b(e.value)},e.value))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.filters.severity")??"Severity"}),t.jsx("select",{className:"input",value:m,onChange:e=>B(e.target.value),children:g.map(e=>t.jsx("option",{value:e.value,children:N(e.value)},e.value||"all"))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.filters.year")??"Year"}),t.jsx("input",{className:"input",type:"number",value:p,onChange:e=>G(e.target.value),placeholder:s("hseEvents.placeholders.year")??"2026"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.filters.month")??"Month"}),t.jsx("input",{className:"input",type:"number",min:"1",max:"12",value:u,onChange:e=>J(e.target.value),placeholder:s("hseEvents.placeholders.month")??"1-12"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.filters.from")??"From"}),t.jsx("input",{className:"input",type:"date",value:y,onChange:e=>Q(e.target.value)})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.filters.to")??"To"}),t.jsx("input",{className:"input",type:"date",value:x,onChange:e=>U(e.target.value)})]})]})}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl overflow-hidden",children:[t.jsxs("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between",children:[t.jsx("div",{className:"text-sm font-semibold text-gray-800 dark:text-gray-200",children:s("hseEvents.recordsTitle")??"Records"}),M&&t.jsxs("div",{className:"text-sm text-gray-500 flex items-center gap-2",children:[t.jsx(Y,{className:"w-4 h-4 animate-spin"}),s("common.loading")??"Loading"]})]}),t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900",children:t.jsxs("tr",{children:[t.jsx("th",{className:"text-left px-4 py-2",children:s("hseEvents.table.date")??"Date"}),t.jsx("th",{className:"text-left px-4 py-2",children:s("hseEvents.table.project")??"Project"}),t.jsx("th",{className:"text-left px-4 py-2",children:s("hseEvents.table.type")??"Type"}),t.jsx("th",{className:"text-left px-4 py-2",children:s("hseEvents.table.severity")??"Severity"}),t.jsx("th",{className:"text-left px-4 py-2",children:s("hseEvents.table.lostTime")??"Lost time"}),t.jsx("th",{className:"text-left px-4 py-2",children:s("hseEvents.table.lostDays")??"Lost days"}),t.jsx("th",{className:"text-left px-4 py-2",children:s("hseEvents.table.location")??"Location"}),t.jsx("th",{className:"text-left px-4 py-2",children:s("hseEvents.table.description")??"Description"}),t.jsx("th",{className:"text-right px-4 py-2",children:s("common.actions")??"Actions"})]})}),t.jsxs("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:[H.map(e=>t.jsxs("tr",{className:e.deleted_at?"opacity-60":"",children:[t.jsx("td",{className:"px-4 py-2",children:ae(e.event_date)}),t.jsx("td",{className:"px-4 py-2",children:e.project?.code?`${e.project.code} - ${e.project.name}`:e.project?.name??e.project_id}),t.jsx("td",{className:"px-4 py-2",children:b(e.type)}),t.jsx("td",{className:"px-4 py-2",children:e.severity?N(e.severity):s("common.none")??"-"}),t.jsx("td",{className:"px-4 py-2",children:e.lost_time?s("common.yes")??"Yes":s("common.no")??"No"}),t.jsx("td",{className:"px-4 py-2",children:e.lost_days??0}),t.jsx("td",{className:"px-4 py-2",children:e.location??s("common.none")??"-"}),t.jsx("td",{className:"px-4 py-2 max-w-xl",children:t.jsx("div",{className:"truncate",title:e.description??"",children:e.description??s("common.none")??"-"})}),t.jsx("td",{className:"px-4 py-2",children:t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{className:"btn-secondary",onClick:()=>Z(e),children:t.jsx(me,{className:"w-4 h-4"})}),t.jsx("button",{className:"btn-secondary",onClick:()=>te(e),children:t.jsx(ve,{className:"w-4 h-4"})})]})})]},e.id)),!M&&H.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:"9",className:"px-4 py-10 text-center text-gray-500",children:s("hseEvents.noRecords")??"No records"})})]})]})})]}),t.jsx(ne,{isOpen:W,onClose:L,title:C?s("hseEvents.modal.editTitle")??"Edit HSE Event":s("hseEvents.modal.newTitle")??"New HSE Event",children:t.jsxs("form",{onSubmit:ee,className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.project")??"Project"}),t.jsxs("select",{className:"input",value:l.project_id,onChange:e=>c(a=>({...a,project_id:e.target.value})),required:!0,children:[t.jsx("option",{value:"",children:s("hseEvents.fields.selectProject")??"Select..."}),O.map(e=>t.jsx("option",{value:String(e.id),children:e.code?`${e.code} - ${e.name}`:e.name},e.id))]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.date")??"Date"}),t.jsx("input",{type:"date",className:"input",value:l.event_date,onChange:e=>c(a=>({...a,event_date:e.target.value})),required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.type")??"Type"}),t.jsx("select",{className:"input",value:l.type,onChange:e=>c(a=>({...a,type:e.target.value})),required:!0,children:f.map(e=>t.jsx("option",{value:e.value,children:b(e.value)},e.value))})]})]}),l.type==="other"&&t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.specifyType")??"Specify type"}),t.jsx("input",{className:"input",value:l.type_other,onChange:e=>c(a=>({...a,type_other:e.target.value})),placeholder:s("hseEvents.placeholders.typeOther")??"e.g. property damage",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.description")??"Description"}),t.jsx("textarea",{className:"input",value:l.description,onChange:e=>c(a=>({...a,description:e.target.value})),rows:"3"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.severity")??"Severity"}),t.jsxs("select",{className:"input",value:l.severity,onChange:e=>c(a=>({...a,severity:e.target.value})),children:[t.jsx("option",{value:"",children:s("common.select")??"Select"}),g.filter(e=>e.value!=="").map(e=>t.jsx("option",{value:e.value,children:N(e.value)},e.value))]})]}),t.jsx("div",{className:"flex items-end",children:t.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300",children:[t.jsx("input",{type:"checkbox",checked:!!l.lost_time,onChange:e=>c(a=>({...a,lost_time:e.target.checked}))}),s("hseEvents.fields.lostTime")??"Lost time"]})}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.lostDays")??"Lost days"}),t.jsx("input",{type:"number",min:"0",className:"input",value:l.lost_days,onChange:e=>c(a=>({...a,lost_days:e.target.value}))})]})]}),l.severity==="other"&&t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.specifySeverity")??"Specify severity"}),t.jsx("input",{className:"input",value:l.severity_other,onChange:e=>c(a=>({...a,severity_other:e.target.value})),placeholder:s("hseEvents.placeholders.severityOther")??"e.g. moderate",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"label",children:s("hseEvents.fields.location")??"Location"}),t.jsx("input",{className:"input",value:l.location,onChange:e=>c(a=>({...a,location:e.target.value}))})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[t.jsx("button",{type:"button",className:"btn-secondary",onClick:L,children:s("common.cancel")??"Cancel"}),t.jsx("button",{type:"submit",className:"btn-primary",disabled:q,children:q?t.jsx(Y,{className:"w-4 h-4 animate-spin"}):s("common.save")??"Save"})]})]})}),t.jsx(ce,{isOpen:!!k,title:s("hseEvents.archive.title")??"Archive record",message:s("hseEvents.archive.message")??"This will archive (soft-delete) the record. Continue?",confirmLabel:s("common.confirm")??"Confirm",cancelLabel:s("common.cancel")??"Cancel",onConfirm:se,onCancel:()=>D(null)})]})}export{be as default};
